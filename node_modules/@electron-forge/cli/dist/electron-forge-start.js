"use strict";

require("source-map-support/register");

var _core = require("@electron-forge/core");

var _fsExtra = _interopRequireDefault(require("fs-extra"));

var _path = _interopRequireDefault(require("path"));

var _commander = _interopRequireDefault(require("commander"));

require("./util/terminate");

var _workingDir = _interopRequireDefault(require("./util/working-dir"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

(async () => {
  let commandArgs = process.argv;
  let appArgs;
  const doubleDashIndex = process.argv.indexOf('--');

  if (doubleDashIndex !== -1) {
    commandArgs = process.argv.slice(0, doubleDashIndex);
    appArgs = process.argv.slice(doubleDashIndex + 1);
  }

  let dir = process.cwd();

  _commander.default.version((await _fsExtra.default.readJson(_path.default.resolve(__dirname, '../package.json'))).version).arguments('[cwd]').option('-p, --app-path <path>', 'Override the path to the Electron app to launch (defaults to \'.\')').option('-l, --enable-logging', 'Enable advanced logging.  This will log internal Electron things').option('-n, --run-as-node', 'Run the Electron app as a Node.JS script').option('--vscode', 'Used to enable arg transformation for debugging Electron through VSCode.  Do not use yourself.').option('-i, --inspect-electron', 'Triggers inspect mode on Electron to allow debugging the main process.  Electron >1.7 only').action(cwd => {
    dir = (0, _workingDir.default)(dir, cwd);
  }).parse(commandArgs);

  _commander.default.on('--help', () => {
    console.log('  Any arguments found after "--" will be passed to the Electron app, e.g.');
    console.log('');
    console.log('    $ electron-forge /path/to/project -l -- -d -f foo.txt');
    console.log('');
    console.log('  will pass the arguments "-d -f foo.txt" to the Electron app');
  });

  const opts = {
    dir,
    interactive: true,
    enableLogging: !!_commander.default.enableLogging,
    runAsNode: !!_commander.default.runAsNode,
    inspect: !!_commander.default.inspectElectron
  };

  if (_commander.default.vscode && appArgs) {
    // Args are in the format ~arg~ so we need to strip the "~"
    appArgs = appArgs.map(arg => arg.substr(1, arg.length - 2)).filter(arg => arg.length > 0);
  }

  if (_commander.default.appPath) opts.appPath = _commander.default.appPath;
  if (appArgs) opts.args = appArgs;
  const spawned = await _core.api.start(opts);
  await new Promise(resolve => {
    const listenForExit = child => {
      let onExit;
      let onRestart;

      const removeListeners = () => {
        child.removeListener('exit', onExit);
        child.removeListener('restarted', onRestart);
      };

      onExit = code => {
        removeListeners();
        if (spawned.restarted) return;

        if (code !== 0) {
          process.exit(code);
        }

        resolve();
      };

      onRestart = newChild => {
        removeListeners();
        listenForExit(newChild);
      };

      child.on('exit', onExit);
      child.on('restarted', onRestart);
    };

    listenForExit(spawned);
  });
})();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9lbGVjdHJvbi1mb3JnZS1zdGFydC50cyJdLCJuYW1lcyI6WyJjb21tYW5kQXJncyIsInByb2Nlc3MiLCJhcmd2IiwiYXBwQXJncyIsImRvdWJsZURhc2hJbmRleCIsImluZGV4T2YiLCJzbGljZSIsImRpciIsImN3ZCIsInByb2dyYW0iLCJ2ZXJzaW9uIiwiZnMiLCJyZWFkSnNvbiIsInBhdGgiLCJyZXNvbHZlIiwiX19kaXJuYW1lIiwiYXJndW1lbnRzIiwib3B0aW9uIiwiYWN0aW9uIiwicGFyc2UiLCJvbiIsImNvbnNvbGUiLCJsb2ciLCJvcHRzIiwiaW50ZXJhY3RpdmUiLCJlbmFibGVMb2dnaW5nIiwicnVuQXNOb2RlIiwiaW5zcGVjdCIsImluc3BlY3RFbGVjdHJvbiIsInZzY29kZSIsIm1hcCIsImFyZyIsInN1YnN0ciIsImxlbmd0aCIsImZpbHRlciIsImFwcFBhdGgiLCJhcmdzIiwic3Bhd25lZCIsImFwaSIsInN0YXJ0IiwiUHJvbWlzZSIsImxpc3RlbkZvckV4aXQiLCJjaGlsZCIsIm9uRXhpdCIsIm9uUmVzdGFydCIsInJlbW92ZUxpc3RlbmVycyIsInJlbW92ZUxpc3RlbmVyIiwiY29kZSIsInJlc3RhcnRlZCIsImV4aXQiLCJuZXdDaGlsZCJdLCJtYXBwaW5ncyI6Ijs7OztBQUFBOztBQUVBOztBQUNBOztBQUNBOztBQUVBOztBQUNBOzs7O0FBRUEsQ0FBQyxZQUFZO0FBQ1gsTUFBSUEsV0FBVyxHQUFHQyxPQUFPLENBQUNDLElBQTFCO0FBQ0EsTUFBSUMsT0FBSjtBQUVBLFFBQU1DLGVBQWUsR0FBR0gsT0FBTyxDQUFDQyxJQUFSLENBQWFHLE9BQWIsQ0FBcUIsSUFBckIsQ0FBeEI7O0FBQ0EsTUFBSUQsZUFBZSxLQUFLLENBQUMsQ0FBekIsRUFBNEI7QUFDMUJKLElBQUFBLFdBQVcsR0FBR0MsT0FBTyxDQUFDQyxJQUFSLENBQWFJLEtBQWIsQ0FBbUIsQ0FBbkIsRUFBc0JGLGVBQXRCLENBQWQ7QUFDQUQsSUFBQUEsT0FB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T0FBTyxDQUFDZ0QsSUFBUixDQUFhRixJQUFiO0FBQ0Q7O0FBQ0RqQyxRQUFBQSxPQUFPO0FBQ1IsT0FQRDs7QUFRQThCLE1BQUFBLFNBQVMsR0FBSU0sUUFBRCxJQUErQjtBQUN6Q0wsUUFBQUEsZUFBZTtBQUNmSixRQUFBQSxhQUFhLENBQUNTLFFBQUQsQ0FBYjtBQUNELE9BSEQ7O0FBSUFSLE1BQUFBLEtBQUssQ0FBQ3RCLEVBQU4sQ0FBUyxNQUFULEVBQWlCdUIsTUFBakI7QUFDQUQsTUFBQUEsS0FBSyxDQUFDdEIsRUFBTixDQUFTLFdBQVQsRUFBc0J3QixTQUF0QjtBQUNELEtBckJEOztBQXNCQUgsSUFBQUEsYUFBYSxDQUFDSixPQUFELENBQWI7QUFDRCxHQXhCSyxDQUFOO0FBeUJELENBM0VEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgYXBpLCBTdGFydE9wdGlvbnMgfSBmcm9tICdAZWxlY3Ryb24tZm9yZ2UvY29yZSc7XG5pbXBvcnQgeyBFbGVjdHJvblByb2Nlc3MgfSBmcm9tICdAZWxlY3Ryb24tZm9yZ2Uvc2hhcmVkLXR5cGVzJztcbmltcG9ydCBmcyBmcm9tICdmcy1leHRyYSc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCBwcm9ncmFtIGZyb20gJ2NvbW1hbmRlcic7XG5cbmltcG9ydCAnLi91dGlsL3Rlcm1pbmF0ZSc7XG5pbXBvcnQgd29ya2luZ0RpciBmcm9tICcuL3V0aWwvd29ya2luZy1kaXInO1xuXG4oYXN5bmMgKCkgPT4ge1xuICBsZXQgY29tbWFuZEFyZ3MgPSBwcm9jZXNzLmFyZ3Y7XG4gIGxldCBhcHBBcmdzO1xuXG4gIGNvbnN0IGRvdWJsZURhc2hJbmRleCA9IHByb2Nlc3MuYXJndi5pbmRleE9mKCctLScpO1xuICBpZiAoZG91YmxlRGFzaEluZGV4ICE9PSAtMSkge1xuICAgIGNvbW1hbmRBcmdzID0gcHJvY2Vzcy5hcmd2LnNsaWNlKDAsIGRvdWJsZURhc2hJbmRleCk7XG4gICAgYXBwQXJncyA9IHByb2Nlc3MuYXJndi5zbGljZShkb3VibGVEYXNoSW5kZXggKyAxKTtcbiAgfVxuXG4gIGxldCBkaXIgPSBwcm9jZXNzLmN3ZCgpO1xuICBwcm9ncmFtXG4gICAgLnZlcnNpb24oKGF3YWl0IGZzLnJlYWRKc29uKHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsICcuLi9wYWNrYWdlLmpzb24nKSkpLnZlcnNpb24pXG4gICAgLmFyZ3VtZW50cygnW2N3ZF0nKVxuICAgIC5vcHRpb24oJy1wLCAtLWFwcC1wYXRoIDxwYXRoPicsICdPdmVycmlkZSB0aGUgcGF0aCB0byB0aGUgRWxlY3Ryb24gYXBwIHRvIGxhdW5jaCAoZGVmYXVsdHMgdG8gXFwnLlxcJyknKVxuICAgIC5vcHRpb24oJy1sLCAtLWVuYWJsZS1sb2dnaW5nJywgJ0VuYWJsZSBhZHZhbmNlZCBsb2dnaW5nLiAgVGhpcyB3aWxsIGxvZyBpbnRlcm5hbCBFbGVjdHJvbiB0aGluZ3MnKVxuICAgIC5vcHRpb24oJy1uLCAtLXJ1bi1hcy1ub2RlJywgJ1J1biB0aGUgRWxlY3Ryb24gYXBwIGFzIGEgTm9kZS5KUyBzY3JpcHQnKVxuICAgIC5vcHRpb24oJy0tdnNjb2RlJywgJ1VzZWQgdG8gZW5hYmxlIGFyZyB0cmFuc2Zvcm1hdGlvbiBmb3IgZGVidWdnaW5nIEVsZWN0cm9uIHRocm91Z2ggVlNDb2RlLiAgRG8gbm90IHVzZSB5b3Vyc2VsZi4nKVxuICAgIC5vcHRpb24oJy1pLCAtLWluc3BlY3QtZWxlY3Ryb24nLCAnVHJpZ2dlcnMgaW5zcGVjdCBtb2RlIG9uIEVsZWN0cm9uIHRvIGFsbG93IGRlYnVnZ2luZyB0aGUgbWFpbiBwcm9jZXNzLiAgRWxlY3Ryb24gPjEuNyBvbmx5JylcbiAgICAuYWN0aW9uKChjd2QpID0+IHsgZGlyID0gd29ya2luZ0RpcihkaXIsIGN3ZCk7IH0pXG4gICAgLnBhcnNlKGNvbW1hbmRBcmdzKTtcblxuICBwcm9ncmFtLm9uKCctLWhlbHAnLCAoKSA9PiB7XG4gICAgY29uc29sZS5sb2coJyAgQW55IGFyZ3VtZW50cyBmb3VuZCBhZnRlciBcIi0tXCIgd2lsbCBiZSBwYXNzZWQgdG8gdGhlIEVsZWN0cm9uIGFwcCwgZS5nLicpO1xuICAgIGNvbnNvbGUubG9nKCcnKTtcbiAgICBjb25zb2xlLmxvZygnICAgICQgZWxlY3Ryb24tZm9yZ2UgL3BhdGgvdG8vcHJvamVjdCAtbCAtLSAtZCAtZiBmb28udHh0Jyk7XG4gICAgY29uc29sZS5sb2coJycpO1xuICAgIGNvbnNvbGUubG9nKCcgIHdpbGwgcGFzcyB0aGUgYXJndW1lbnRzIFwiLWQgLWYgZm9vLnR4dFwiIHRvIHRoZSBFbGVjdHJvbiBhcHAnKTtcbiAgfSk7XG5cbiAgY29uc3Qgb3B0czogU3RhcnRPcHRpb25zID0ge1xuICAgIGRpcixcbiAgICBpbnRlcmFjdGl2ZTogdHJ1ZSxcbiAgICBlbmFibGVMb2dnaW5nOiAhIXByb2dyYW0uZW5hYmxlTG9nZ2luZyxcbiAgICBydW5Bc05vZGU6ICEhcHJvZ3JhbS5ydW5Bc05vZGUsXG4gICAgaW5zcGVjdDogISFwcm9ncmFtLmluc3BlY3RFbGVjdHJvbixcbiAgfTtcblxuICBpZiAocHJvZ3JhbS52c2NvZGUgJiYgYXBwQXJncykge1xuICAgIC8vIEFyZ3MgYXJlIGluIHRoZSBmb3JtYXQgfmFyZ34gc28gd2UgbmVlZCB0byBzdHJpcCB0aGUgXCJ+XCJcbiAgICBhcHBBcmdzID0gYXBwQXJnc1xuICAgICAgLm1hcCgoYXJnKSA9PiBhcmcuc3Vic3RyKDEsIGFyZy5sZW5ndGggLSAyKSlcbiAgICAgIC5maWx0ZXIoKGFyZykgPT4gYXJnLmxlbmd0aCA+IDApO1xuICB9XG5cbiAgaWYgKHByb2dyYW0uYXBwUGF0aCkgb3B0cy5hcHBQYXRoID0gcHJvZ3JhbS5hcHBQYXRoO1xuICBpZiAoYXBwQXJncykgb3B0cy5hcmdzID0gYXBwQXJncztcblxuICBjb25zdCBzcGF3bmVkID0gYXdhaXQgYXBpLnN0YXJ0KG9wdHMpO1xuXG4gIGF3YWl0IG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7XG4gICAgY29uc3QgbGlzdGVuRm9yRXhpdCA9IChjaGlsZDogRWxlY3Ryb25Qcm9jZXNzKSA9PiB7XG4gICAgICBsZXQgb25FeGl0OiBOb2RlSlMuRXhpdExpc3RlbmVyO1xuICAgICAgbGV0IG9uUmVzdGFydDogKG5ld0NoaWxkOiBFbGVjdHJvblByb2Nlc3MpID0+IHZvaWQ7XG4gICAgICBjb25zdCByZW1vdmVMaXN0ZW5lcnMgPSAoKSA9PiB7XG4gICAgICAgIGNoaWxkLnJlbW92ZUxpc3RlbmVyKCdleGl0Jywgb25FeGl0KTtcbiAgICAgICAgY2hpbGQucmVtb3ZlTGlzdGVuZXIoJ3Jlc3RhcnRlZCcsIG9uUmVzdGFydCk7XG4gICAgICB9O1xuICAgICAgb25FeGl0ID0gKGNvZGU6IG51bWJlcikgPT4ge1xuICAgICAgICByZW1vdmVMaXN0ZW5lcnMoKTtcbiAgICAgICAgaWYgKHNwYXduZWQucmVzdGFydGVkKSByZXR1cm47XG4gICAgICAgIGlmIChjb2RlICE9PSAwKSB7XG4gICAgICAgICAgcHJvY2Vzcy5leGl0KGNvZGUpO1xuICAgICAgICB9XG4gICAgICAgIHJlc29sdmUoKTtcbiAgICAgIH07XG4gICAgICBvblJlc3RhcnQgPSAobmV3Q2hpbGQ6IEVsZWN0cm9uUHJvY2VzcykgPT4ge1xuICAgICAgICByZW1vdmVMaXN0ZW5lcnMoKTtcbiAgICAgICAgbGlzdGVuRm9yRXhpdChuZXdDaGlsZCk7XG4gICAgICB9O1xuICAgICAgY2hpbGQub24oJ2V4aXQnLCBvbkV4aXQpO1xuICAgICAgY2hpbGQub24oJ3Jlc3RhcnRlZCcsIG9uUmVzdGFydCk7XG4gICAgfTtcbiAgICBsaXN0ZW5Gb3JFeGl0KHNwYXduZWQgYXMgRWxlY3Ryb25Qcm9jZXNzKTtcbiAgfSk7XG59KSgpO1xuIl19
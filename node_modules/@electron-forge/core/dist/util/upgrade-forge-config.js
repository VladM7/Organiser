"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = upgradeForgeConfig;
exports.updateUpgradedForgeDevDeps = updateUpgradedForgeDevDeps;

require("source-map-support/register");

var _path = _interopRequireDefault(require("path"));

var _initNpm = require("../api/init-scripts/init-npm");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function mapMakeTargets(forge5Config) {
  const makeTargets = new Map();

  if (forge5Config.makeTargets) {
    for (const [platform, targets] of Object.entries(forge5Config.makeTargets)) {
      for (const target of targets) {
        let platforms = makeTargets.get(target);

        if (platforms === undefined) {
          platforms = [];
          makeTargets.set(target, platforms);
        }

        platforms.push(platform);
      }
    }
  }

  return makeTargets;
}

const forge5MakerMappings = new Map([['electronInstallerDebian', 'deb'], ['electronInstallerDMG', 'dmg'], ['electronInstallerFlatpak', 'flatpak'], ['electronInstallerRedhat', 'rpm'], ['electronInstallerSnap', 'snap'], ['electronWinstallerConfig', 'squirrel'], ['electronWixMSIConfig', 'wix'], ['windowsStoreConfig', 'appx']]);
/**
 * Converts Forge v5 maker config to v6.
 */

function generateForgeMakerConfig(forge5Config) {
  const makeTargets = mapMakeTargets(forge5Config);
  const makers = [];

  for (const [forge5Key, makerType] of forge5MakerMappings) {
    const config = forge5Config[forge5Key];

    if (config) {
      makers.push({
        name: `@electron-forge/maker-${makerType}`,
        config: forge5Config[forge5Key],
        platforms: makeTargets.get(makerType) || null
      });
    }
  }

  const zipPlatforms = makeTargets.get('zip');

  if (zipPlatforms) {
    makers.push({
      name: '@electron-forge/maker-zip',
      platforms: zipPlatforms
    });
  }

  return makers;
}

const forge5PublisherMappings = new Map([['github_repository', 'github'], ['s3', 's3'], ['electron-release-server', 'electron-release-server'], ['snapStore', 'snapcraft']]);
/**
 * Transforms v5 GitHub publisher config to v6 syntax.
 */

function transformGitHubPublisherConfig(config) {
  const {
    name,
    owner,
    options,
    ...gitHubConfig
  } = config;
  gitHubConfig.repository = {
    name,
    owner
  };

  if (options) {
    gitHubConfig.octokitOptions = options;
  }

  return gitHubConfig;
}
/**
 * Converts Forge v5 publisher config to v6.
 */


function generateForgePublisherConfig(forge5Config) {
  const publishers = [];

  for (const [forge5Key, publisherType] of forge5PublisherMappings) {
    let config = forge5Config[forge5Key];

    if (config) {
      if (publisherType === 'github') {
        config = transformGitHubPublisherConfig(config);
      }

      publishers.push({
        config,
        name: `@electron-forge/publisher-${publisherType}`,
        platforms: null
      });
    }
  }

  return publishers;
}
/**
 * Upgrades Forge v5 config to v6.
 */


function upgradeForgeConfig(forge5Config) {
  const forgeConfig = {};

  if (forge5Config.electronPackagerConfig) {
    delete forge5Config.electronPackagerConfig.packageManager;
    forgeConfig.packagerConfig = forge5Config.electronPackagerConfig;
  }

  if (forge5Config.electronRebuildConfig) {
    forgeConfig.electronRebuildConfig = forge5Config.electronRebuildConfig;
  }

  forgeConfig.makers = generateForgeMakerConfig(forge5Config);
  forgeConfig.publishers = generateForgePublisherConfig(forge5Config);
  return forgeConfig;
}

function updateUpgradedForgeDevDeps(packageJSON, devDeps) {
  const forgeConfig = packageJSON.config.forge;
  devDeps = devDeps.filter(dep => !dep.startsWith('@electron-forge/maker-')); // eslint-disable-next-line max-len

  devDeps = devDeps.concat(forgeConfig.makers.map(maker => (0, _initNpm.siblingDep)(_path.default.basename(maker.name)))); // eslint-disable-next-line max-len

  devDeps = devDeps.concat(forgeConfig.publishers.map(publisher => (0, _initNpm.siblingDep)(_path.default.basename(publisher.name))));

  if (Object.keys(packageJSON.devDependencies).find(dep => dep === 'electron-prebuilt-compile')) {
    devDeps = devDeps.concat((0, _initNpm.siblingDep)('plugin-compile'));
  }

  return devDeps;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy91dGlsL3VwZ3JhZGUtZm9yZ2UtY29uZmlnLnRzIl0sIm5hbWVzIjpbIm1hcE1ha2VUYXJnZXRzIiwiZm9yZ2U1Q29uZmlnIiwibWFrZVRhcmdldHMiLCJNYXAiLCJwbGF0Zm9ybSIsInRhcmdldHMiLCJPYmplY3QiLCJlbnRyaWVzIiwidGFyZ2V0IiwicGxhdGZvcm1zIiwiZ2V0IiwidW5kZWZpbmVkIiwic2V0IiwicHVzaCIsImZvcmdlNU1ha2VyTWFwcGluZ3MiLCJnZW5lcmF0ZUZvcmdlTWFrZXJDb25maWciLCJtYWtlcnMiLCJmb3JnZTVLZXkiLCJtYWtlclR5cGUiLCJjb25maWciLCJuYW1lIiwiemlwUGxhdGZvcm1zIiwiZm9yZ2U1UHVibGlzaGVyTWFwcGluZ3MiLCJ0cmFuc2Zvcm1HaXRIdWJQdWJsaXNoZXJDb25maWciLCJvd25lciIsIm9wdGlvbnMiLCJnaXRIdWJDb25maWciLCJyZXBvc2l0b3J5Iiwib2N0b2tpdE9wdGlvbnMiLCJnZW5lcmF0ZUZvcmdlUHVibGlzaGVyQ29uZmlnIiwicHVibGlzaGVycyIsInB1Ymxpc2hlclR5cGUiLCJ1cGdyYWRlRm9yZ2VDb25maWciLCJmb3JnZUNvbmZpZyIsImVsZWN0cm9uUGFja2FnZXJDb25maWciLCJwYWNrYWdlTWFuYWdlciIsInBhY2thZ2VyQ29uZmlnIiwiZWxlY3Ryb25SZWJ1aWxkQ29uZmlnIiwidXBkYXRlVXBncmFkZWRGb3JnZURldkRlcHMiLCJwYWNrYWdlSlNPTiIsImRldkRlcHMiLCJmb3JnZSIsImZpbHRlciIsImRlcCIsInN0YXJ0c1dpdGgiLCJjb25jYXQiLCJtYXAiLCJtYWtlciIsInBhdGgiLCJiYXNlbmFtZSIsInB1Ymxpc2hlciIsImtleXMiLCJkZXZEZXBlbmRlbmNpZXMiLCJmaW5kIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7O0FBTUE7O0FBQ0E7Ozs7QUFJQSxTQUFTQSxjQUFULENBQXdCQyxZQUF4QixFQUF5RTtBQUN2RSxRQUFNQyxXQUFXLEdBQUcs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OztBQUVELFNBQU9MLE9BQVA7QUFDRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIEZvcmdlQ29uZmlnLFxuICBGb3JnZVBsYXRmb3JtLFxuICBJRm9yZ2VSZXNvbHZhYmxlTWFrZXIsXG4gIElGb3JnZVJlc29sdmFibGVQdWJsaXNoZXIsXG59IGZyb20gJ0BlbGVjdHJvbi1mb3JnZS9zaGFyZWQtdHlwZXMnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBzaWJsaW5nRGVwIH0gZnJvbSAnLi4vYXBpL2luaXQtc2NyaXB0cy9pbml0LW5wbSc7XG5cbnR5cGUgTWFrZVRhcmdldHMgPSB7IHN0cmluZzogc3RyaW5nW10gfTtcblxuZnVuY3Rpb24gbWFwTWFrZVRhcmdldHMoZm9yZ2U1Q29uZmlnOiBhbnkpOiBNYXA8c3RyaW5nLCBGb3JnZVBsYXRmb3JtW10+IHtcbiAgY29uc3QgbWFrZVRhcmdldHMgPSBuZXcgTWFwPHN0cmluZywgRm9yZ2VQbGF0Zm9ybVtdPigpO1xuICBpZiAoZm9yZ2U1Q29uZmlnLm1ha2VUYXJnZXRzKSB7XG4gICAgZm9yIChjb25zdCBbcGxhdGZvcm0sIHRhcmdldHNdIG9mIE9iamVjdC5lbnRyaWVzKGZvcmdlNUNvbmZpZy5tYWtlVGFyZ2V0cyBhcyBNYWtlVGFyZ2V0cykpIHtcbiAgICAgIGZvciAoY29uc3QgdGFyZ2V0IG9mIHRhcmdldHMpIHtcbiAgICAgICAgbGV0IHBsYXRmb3JtcyA9IG1ha2VUYXJnZXRzLmdldCh0YXJnZXQpO1xuICAgICAgICBpZiAocGxhdGZvcm1zID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICBwbGF0Zm9ybXMgPSBbXTtcbiAgICAgICAgICBtYWtlVGFyZ2V0cy5zZXQodGFyZ2V0LCBwbGF0Zm9ybXMpO1xuICAgICAgICB9XG4gICAgICAgIHBsYXRmb3Jtcy5wdXNoKHBsYXRmb3JtIGFzIEZvcmdlUGxhdGZvcm0pO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHJldHVybiBtYWtlVGFyZ2V0cztcbn1cblxuY29uc3QgZm9yZ2U1TWFrZXJNYXBwaW5ncyA9IG5ldyBNYXA8c3RyaW5nLCBzdHJpbmc+KFtcbiAgWydlbGVjdHJvbkluc3RhbGxlckRlYmlhbicsICdkZWInXSxcbiAgWydlbGVjdHJvbkluc3RhbGxlckRNRycsICdkbWcnXSxcbiAgWydlbGVjdHJvbkluc3RhbGxlckZsYXRwYWsnLCAnZmxhdHBhayddLFxuICBbJ2VsZWN0cm9uSW5zdGFsbGVyUmVkaGF0JywgJ3JwbSddLFxuICBbJ2VsZWN0cm9uSW5zdGFsbGVyU25hcCcsICdzbmFwJ10sXG4gIFsnZWxlY3Ryb25XaW5zdGFsbGVyQ29uZmlnJywgJ3NxdWlycmVsJ10sXG4gIFsnZWxlY3Ryb25XaXhNU0lDb25maWcnLCAnd2l4J10sXG4gIFsnd2luZG93c1N0b3JlQ29uZmlnJywgJ2FwcHgnXSxcbl0pO1xuXG4vKipcbiAqIENvbnZlcnRzIEZvcmdlIHY1IG1ha2VyIGNvbmZpZyB0byB2Ni5cbiAqL1xuZnVuY3Rpb24gZ2VuZXJhdGVGb3JnZU1ha2VyQ29uZmlnKGZvcmdlNUNvbmZpZzogYW55KTogSUZvcmdlUmVzb2x2YWJsZU1ha2VyW10ge1xuICBjb25zdCBtYWtlVGFyZ2V0cyA9IG1hcE1ha2VUYXJnZXRzKGZvcmdlNUNvbmZpZyk7XG4gIGNvbnN0IG1ha2VyczogSUZvcmdlUmVzb2x2YWJsZU1ha2VyW10gPSBbXTtcblxuICBmb3IgKGNvbnN0IFtmb3JnZTVLZXksIG1ha2VyVHlwZV0gb2YgZm9yZ2U1TWFrZXJNYXBwaW5ncykge1xuICAgIGNvbnN0IGNvbmZpZyA9IGZvcmdlNUNvbmZpZ1tmb3JnZTVLZXldO1xuICAgIGlmIChjb25maWcpIHtcbiAgICAgIG1ha2Vycy5wdXNoKHtcbiAgICAgICAgbmFtZTogYEBlbGVjdHJvbi1mb3JnZS9tYWtlci0ke21ha2VyVHlwZX1gLFxuICAgICAgICBjb25maWc6IGZvcmdlNUNvbmZpZ1tmb3JnZTVLZXldLFxuICAgICAgICBwbGF0Zm9ybXM6IG1ha2VUYXJnZXRzLmdldChtYWtlclR5cGUpIHx8IG51bGwsXG4gICAgICB9IGFzIElGb3JnZVJlc29sdmFibGVNYWtlcik7XG4gICAgfVxuICB9XG5cbiAgY29uc3QgemlwUGxhdGZvcm1zID0gbWFrZVRhcmdldHMuZ2V0KCd6aXAnKTtcbiAgaWYgKHppcFBsYXRmb3Jtcykge1xuICAgIG1ha2Vycy5wdXNoKHtcbiAgICAgIG5hbWU6ICdAZWxlY3Ryb24tZm9yZ2UvbWFrZXItemlwJyxcbiAgICAgIHBsYXRmb3JtczogemlwUGxhdGZvcm1zLFxuICAgIH0gYXMgSUZvcmdlUmVzb2x2YWJsZU1ha2VyKTtcbiAgfVxuXG4gIHJldHVybiBtYWtlcnM7XG59XG5cbmNvbnN0IGZvcmdlNVB1Ymxpc2hlck1hcHBpbmdzID0gbmV3IE1hcDxzdHJpbmcsIHN0cmluZz4oW1xuICBbJ2dpdGh1Yl9yZXBvc2l0b3J5JywgJ2dpdGh1YiddLFxuICBbJ3MzJywgJ3MzJ10sXG4gIFsnZWxlY3Ryb24tcmVsZWFzZS1zZXJ2ZXInLCAnZWxlY3Ryb24tcmVsZWFzZS1zZXJ2ZXInXSxcbiAgWydzbmFwU3RvcmUnLCAnc25hcGNyYWZ0J10sXG5dKTtcblxuLyoqXG4gKiBUcmFuc2Zvcm1zIHY1IEdpdEh1YiBwdWJsaXNoZXIgY29uZmlnIHRvIHY2IHN5bnRheC5cbiAqL1xuZnVuY3Rpb24gdHJhbnNmb3JtR2l0SHViUHVibGlzaGVyQ29uZmlnKGNvbmZpZzogYW55KSB7XG4gIGNvbnN0IHtcbiAgICBuYW1lLCBvd25lciwgb3B0aW9ucywgLi4uZ2l0SHViQ29uZmlnXG4gIH0gPSBjb25maWc7XG4gIGdpdEh1YkNvbmZpZy5yZXBvc2l0b3J5ID0geyBuYW1lLCBvd25lciB9O1xuICBpZiAob3B0aW9ucykge1xuICAgIGdpdEh1YkNvbmZpZy5vY3Rva2l0T3B0aW9ucyA9IG9wdGlvbnM7XG4gIH1cblxuICByZXR1cm4gZ2l0SHViQ29uZmlnO1xufVxuXG4vKipcbiAqIENvbnZlcnRzIEZvcmdlIHY1IHB1Ymxpc2hlciBjb25maWcgdG8gdjYuXG4gKi9cbmZ1bmN0aW9uIGdlbmVyYXRlRm9yZ2VQdWJsaXNoZXJDb25maWcoZm9yZ2U1Q29uZmlnOiBhbnkpOiBJRm9yZ2VSZXNvbHZhYmxlUHVibGlzaGVyW10ge1xuICBjb25zdCBwdWJsaXNoZXJzOiBJRm9yZ2VSZXNvbHZhYmxlUHVibGlzaGVyW10gPSBbXTtcblxuICBmb3IgKGNvbnN0IFtmb3JnZTVLZXksIHB1Ymxpc2hlclR5cGVdIG9mIGZvcmdlNVB1Ymxpc2hlck1hcHBpbmdzKSB7XG4gICAgbGV0IGNvbmZpZyA9IGZvcmdlNUNvbmZpZ1tmb3JnZTVLZXldO1xuICAgIGlmIChjb25maWcpIHtcbiAgICAgIGlmIChwdWJsaXNoZXJUeXBlID09PSAnZ2l0aHViJykge1xuICAgICAgICBjb25maWcgPSB0cmFuc2Zvcm1HaXRIdWJQdWJsaXNoZXJDb25maWcoY29uZmlnKTtcbiAgICAgIH1cbiAgICAgIHB1Ymxpc2hlcnMucHVzaCh7XG4gICAgICAgIGNvbmZpZyxcbiAgICAgICAgbmFtZTogYEBlbGVjdHJvbi1mb3JnZS9wdWJsaXNoZXItJHtwdWJsaXNoZXJUeXBlfWAsXG4gICAgICAgIHBsYXRmb3JtczogbnVsbCxcbiAgICAgIH0gYXMgSUZvcmdlUmVzb2x2YWJsZU1ha2VyKTtcbiAgICB9XG4gIH1cblxuICByZXR1cm4gcHVibGlzaGVycztcbn1cblxuLyoqXG4gKiBVcGdyYWRlcyBGb3JnZSB2NSBjb25maWcgdG8gdjYuXG4gKi9cbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uIHVwZ3JhZGVGb3JnZUNvbmZpZyhmb3JnZTVDb25maWc6IGFueSk6IEZvcmdlQ29uZmlnIHtcbiAgY29uc3QgZm9yZ2VDb25maWc6IEZvcmdlQ29uZmlnID0gKHt9IGFzIEZvcmdlQ29uZmlnKTtcblxuICBpZiAoZm9yZ2U1Q29uZmlnLmVsZWN0cm9uUGFja2FnZXJDb25maWcpIHtcbiAgICBkZWxldGUgZm9yZ2U1Q29uZmlnLmVsZWN0cm9uUGFja2FnZXJDb25maWcucGFja2FnZU1hbmFnZXI7XG4gICAgZm9yZ2VDb25maWcucGFja2FnZXJDb25maWcgPSBmb3JnZTVDb25maWcuZWxlY3Ryb25QYWNrYWdlckNvbmZpZztcbiAgfVxuICBpZiAoZm9yZ2U1Q29uZmlnLmVsZWN0cm9uUmVidWlsZENvbmZpZykge1xuICAgIGZvcmdlQ29uZmlnLmVsZWN0cm9uUmVidWlsZENvbmZpZyA9IGZvcmdlNUNvbmZpZy5lbGVjdHJvblJlYnVpbGRDb25maWc7XG4gIH1cbiAgZm9yZ2VDb25maWcubWFrZXJzID0gZ2VuZXJhdGVGb3JnZU1ha2VyQ29uZmlnKGZvcmdlNUNvbmZpZyk7XG4gIGZvcmdlQ29uZmlnLnB1Ymxpc2hlcnMgPSBnZW5lcmF0ZUZvcmdlUHVibGlzaGVyQ29uZmlnKGZvcmdlNUNvbmZpZyk7XG5cbiAgcmV0dXJuIGZvcmdlQ29uZmlnO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gdXBkYXRlVXBncmFkZWRGb3JnZURldkRlcHMocGFja2FnZUpTT046IGFueSwgZGV2RGVwczogc3RyaW5nW10pOiBzdHJpbmdbXSB7XG4gIGNvbnN0IGZvcmdlQ29uZmlnID0gcGFja2FnZUpTT04uY29uZmlnLmZvcmdlO1xuICBkZXZEZXBzID0gZGV2RGVwcy5maWx0ZXIoKGRlcCkgPT4gIWRlcC5zdGFydHNXaXRoKCdAZWxlY3Ryb24tZm9yZ2UvbWFrZXItJykpO1xuICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbWF4LWxlblxuICBkZXZEZXBzID0gZGV2RGVwcy5jb25jYXQoZm9yZ2VDb25maWcubWFrZXJzLm1hcCgobWFrZXI6IElGb3JnZVJlc29sdmFibGVNYWtlcikgPT4gc2libGluZ0RlcChwYXRoLmJhc2VuYW1lKG1ha2VyLm5hbWUpKSkpO1xuICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbWF4LWxlblxuICBkZXZEZXBzID0gZGV2RGVwcy5jb25jYXQoZm9yZ2VDb25maWcucHVibGlzaGVycy5tYXAoKHB1Ymxpc2hlcjogSUZvcmdlUmVzb2x2YWJsZVB1Ymxpc2hlcikgPT4gc2libGluZ0RlcChwYXRoLmJhc2VuYW1lKHB1Ymxpc2hlci5uYW1lKSkpKTtcblxuICBpZiAoT2JqZWN0LmtleXMocGFja2FnZUpTT04uZGV2RGVwZW5kZW5jaWVzKS5maW5kKChkZXA6IHN0cmluZykgPT4gZGVwID09PSAnZWxlY3Ryb24tcHJlYnVpbHQtY29tcGlsZScpKSB7XG4gICAgZGV2RGVwcyA9IGRldkRlcHMuY29uY2F0KHNpYmxpbmdEZXAoJ3BsdWdpbi1jb21waWxlJykpO1xuICB9XG5cbiAgcmV0dXJuIGRldkRlcHM7XG59XG4iXX0=
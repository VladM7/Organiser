"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = upgradeForgeConfig;
exports.updateUpgradedForgeDevDeps = updateUpgradedForgeDevDeps;

require("source-map-support/register");

var _path = _interopRequireDefault(require("path"));

var _initNpm = require("../api/init-scripts/init-npm");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function mapMakeTargets(forge5Config) {
  const makeTargets = new Map();

  if (forge5Config.make_targets) {
    for (const [platform, targets] of Object.entries(forge5Config.make_targets)) {
      for (const target of targets) {
        let platforms = makeTargets.get(target);

        if (platforms === undefined) {
          platforms = [];
          makeTargets.set(target, platforms);
        }

        platforms.push(platform);
      }
    }
  }

  return makeTargets;
}

const forge5MakerMappings = new Map([['electronInstallerDebian', 'deb'], ['electronInstallerDMG', 'dmg'], ['electronInstallerFlatpak', 'flatpak'], ['electronInstallerRedhat', 'rpm'], ['electronInstallerSnap', 'snap'], ['electronWinstallerConfig', 'squirrel'], ['electronWixMSIConfig', 'wix'], ['windowsStoreConfig', 'appx']]);
/**
 * Converts Forge v5 maker config to v6.
 */

function generateForgeMakerConfig(forge5Config) {
  const makeTargets = mapMakeTargets(forge5Config);
  const makers = [];

  for (const [forge5Key, makerType] of forge5MakerMappings) {
    const config = forge5Config[forge5Key];

    if (config) {
      makers.push({
        name: `@electron-forge/maker-${makerType}`,
        config: forge5Config[forge5Key],
        platforms: makeTargets.get(makerType) || null
      });
    }
  }

  const zipPlatforms = makeTargets.get('zip');

  if (zipPlatforms) {
    makers.push({
      name: '@electron-forge/maker-zip',
      platforms: zipPlatforms
    });
  }

  return makers;
}

const forge5PublisherMappings = new Map([['github_repository', 'github'], ['s3', 's3'], ['electron-release-server', 'electron-release-server'], ['snapStore', 'snapcraft']]);
/**
 * Transforms v5 GitHub publisher config to v6 syntax.
 */

function transformGitHubPublisherConfig(config) {
  const {
    name,
    owner,
    options,
    ...gitHubConfig
  } = config;
  gitHubConfig.repository = {
    name,
    owner
  };

  if (options) {
    gitHubConfig.octokitOptions = options;
  }

  return gitHubConfig;
}
/**
 * Converts Forge v5 publisher config to v6.
 */


function generateForgePublisherConfig(forge5Config) {
  const publishers = [];

  for (const [forge5Key, publisherType] of forge5PublisherMappings) {
    let config = forge5Config[forge5Key];

    if (config) {
      if (publisherType === 'github') {
        config = transformGitHubPublisherConfig(config);
      }

      publishers.push({
        config,
        name: `@electron-forge/publisher-${publisherType}`,
        platforms: null
      });
    }
  }

  return publishers;
}
/**
 * Upgrades Forge v5 config to v6.
 */


function upgradeForgeConfig(forge5Config) {
  const forgeConfig = {};

  if (forge5Config.electronPackagerConfig) {
    delete forge5Config.electronPackagerConfig.packageManager;
    forgeConfig.packagerConfig = forge5Config.electronPackagerConfig;
  }

  if (forge5Config.electronRebuildConfig) {
    forgeConfig.electronRebuildConfig = forge5Config.electronRebuildConfig;
  }

  forgeConfig.makers = generateForgeMakerConfig(forge5Config);
  forgeConfig.publishers = generateForgePublisherConfig(forge5Config);
  return forgeConfig;
}

function updateUpgradedForgeDevDeps(packageJSON, devDeps) {
  const forgeConfig = packageJSON.config.forge;
  devDeps = devDeps.filter(dep => !dep.startsWith('@electron-forge/maker-')); // eslint-disable-next-line max-len

  devDeps = devDeps.concat(forgeConfig.makers.map(maker => (0, _initNpm.siblingDep)(_path.default.basename(maker.name)))); // eslint-disable-next-line max-len

  devDeps = devDeps.concat(forgeConfig.publishers.map(publisher => (0, _initNpm.siblingDep)(_path.default.basename(publisher.name))));

  if (Object.keys(packageJSON.devDependencies).find(dep => dep === 'electron-prebuilt-compile')) {
    devDeps = devDeps.concat((0, _initNpm.siblingDep)('plugin-compile'));
  }

  return devDeps;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy91dGlsL3VwZ3JhZGUtZm9yZ2UtY29uZmlnLnRzIl0sIm5hbWVzIjpbIm1hcE1ha2VUYXJnZXRzIiwiZm9yZ2U1Q29uZmlnIiwibWFrZVRhcmdldHMiLCJNYXAiLCJtYWtlX3RhcmdldHMiLCJwbGF0Zm9ybSIsInRhcmdldHMiLCJPYmplY3QiLCJlbnRyaWVzIiwidGFyZ2V0IiwicGxhdGZvcm1zIiwiZ2V0IiwidW5kZWZpbmVkIiwic2V0IiwicHVzaCIsImZvcmdlNU1ha2VyTWFwcGluZ3MiLCJnZW5lcmF0ZUZvcmdlTWFrZXJDb25maWciLCJtYWtlcnMiLCJmb3JnZTVLZXkiLCJtYWtlclR5cGUiLCJjb25maWciLCJuYW1lIiwiemlwUGxhdGZvcm1zIiwiZm9yZ2U1UHVibGlzaGVyTWFwcGluZ3MiLCJ0cmFuc2Zvcm1HaXRIdWJQdWJsaXNoZXJDb25maWciLCJvd25lciIsIm9wdGlvbnMiLCJnaXRIdWJDb25maWciLCJyZXBvc2l0b3J5Iiwib2N0b2tpdE9wdGlvbnMiLCJnZW5lcmF0ZUZvcmdlUHVibGlzaGVyQ29uZmlnIiwicHVibGlzaGVycyIsInB1Ymxpc2hlclR5cGUiLCJ1cGdyYWRlRm9yZ2VDb25maWciLCJmb3JnZUNvbmZpZyIsImVsZWN0cm9uUGFja2FnZXJDb25maWciLCJwYWNrYWdlTWFuYWdlciIsInBhY2thZ2VyQ29uZmlnIiwiZWxlY3Ryb25SZWJ1aWxkQ29uZmlnIiwidXBkYXRlVXBncmFkZWRGb3JnZURldkRlcHMiLCJwYWNrYWdlSlNPTiIsImRldkRlcHMiLCJmb3JnZSIsImZpbHRlciIsImRlcCIsInN0YXJ0c1dpdGgiLCJjb25jYXQiLCJtYXAiLCJtYWtlciIsInBhdGgiLCJiYXNlbmFtZSIsInB1Ymxpc2hlciIsImtleXMiLCJkZXZEZXBlbmRlbmNpZXMiLCJmaW5kIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7O0FBQ0E7O0FBQ0E7Ozs7QUFzQ0EsU0FBU0EsY0FBVCxDQUF3QkMsWUFBeEIsRUFBa0Y7QUFDaEYs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Z0JBQVgsQ0FBZixDQUFWO0FBQ0Q7O0FBRUQsU0FBT0wsT0FBUDtBQUNEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRm9yZ2VDb25maWcsIEZvcmdlUGxhdGZvcm0sIElGb3JnZVJlc29sdmFibGVNYWtlciwgSUZvcmdlUmVzb2x2YWJsZVB1Ymxpc2hlciB9IGZyb20gJ0BlbGVjdHJvbi1mb3JnZS9zaGFyZWQtdHlwZXMnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBzaWJsaW5nRGVwIH0gZnJvbSAnLi4vYXBpL2luaXQtc2NyaXB0cy9pbml0LW5wbSc7XG5cbnR5cGUgTWFrZVRhcmdldHMgPSB7IHN0cmluZzogc3RyaW5nW10gfTtcblxudHlwZSBHaXRIdWI1Q29uZmlnID0gUmVjb3JkPHN0cmluZywgdW5rbm93bj4gJiB7XG4gIG5hbWU6IHN0cmluZztcbiAgb3duZXI6IHN0cmluZztcbiAgb3B0aW9uczogUmVjb3JkPHN0cmluZywgdW5rbm93bj47XG59O1xuXG50eXBlIEZvcmdlNUNvbmZpZyA9IHtcbiAgbWFrZV90YXJnZXRzPzogUmVjb3JkPEZvcmdlUGxhdGZvcm0sIHN0cmluZ1tdPjtcbiAgZWxlY3Ryb25QYWNrYWdlckNvbmZpZz86IFJlY29yZDxzdHJpbmcsIHVua25vd24+O1xuICBlbGVjdHJvblJlYnVpbGRDb25maWc/OiBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPjtcbiAgZWxlY3Ryb25XaW5zdGFsbGVyQ29uZmlnPzogUmVjb3JkPHN0cmluZywgdW5rbm93bj47XG4gIGVsZWN0cm9uSW5zdGFsbGVyRE1HPzogUmVjb3JkPHN0cmluZywgdW5rbm93bj47XG4gIGVsZWN0cm9uSW5zdGFsbGVyRmxhdHBhaz86IFJlY29yZDxzdHJpbmcsIHVua25vd24+O1xuICBlbGVjdHJvbkluc3RhbGxlckRlYmlhbj86IFJlY29yZDxzdHJpbmcsIHVua25vd24+O1xuICBlbGVjdHJvbkluc3RhbGxlclJlZGhhdD86IFJlY29yZDxzdHJpbmcsIHVua25vd24+O1xuICBlbGVjdHJvbkluc3RhbGxlclNuYXA/OiBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPjtcbiAgZWxlY3Ryb25XaXhNU0lDb25maWc/OiBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPjtcbiAgd2luZG93c1N0b3JlQ29uZmlnPzogUmVjb3JkPHN0cmluZywgdW5rbm93bj47XG5cbiAgZ2l0aHViX3JlcG9zaXRvcnk/OiBHaXRIdWI1Q29uZmlnO1xuICBzMz86IFJlY29yZDxzdHJpbmcsIHVua25vd24+O1xuICAnZWxlY3Ryb24tcmVsZWFzZS1zZXJ2ZXInPzogUmVjb3JkPHN0cmluZywgdW5rbm93bj47XG4gIHNuYXBTdG9yZT86IFJlY29yZDxzdHJpbmcsIHVua25vd24+O1xufTtcblxudHlwZSBGb3JnZTVDb25maWdLZXkgPSBrZXlvZiBGb3JnZTVDb25maWc7XG5cbnR5cGUgRm9yZ2VQYWNrYWdlSlNPTiA9IFJlY29yZDxzdHJpbmcsIHVua25vd24+ICYge1xuICBjb25maWc6IHtcbiAgICBmb3JnZTogRm9yZ2VDb25maWc7XG4gIH07XG4gIGRldkRlcGVuZGVuY2llczogUmVjb3JkPHN0cmluZywgc3RyaW5nPjtcbn07XG5cbmZ1bmN0aW9uIG1hcE1ha2VUYXJnZXRzKGZvcmdlNUNvbmZpZzogRm9yZ2U1Q29uZmlnKTogTWFwPHN0cmluZywgRm9yZ2VQbGF0Zm9ybVtdPiB7XG4gIGNvbnN0IG1ha2VUYXJnZXRzID0gbmV3IE1hcDxzdHJpbmcsIEZvcmdlUGxhdGZvcm1bXT4oKTtcbiAgaWYgKGZvcmdlNUNvbmZpZy5tYWtlX3RhcmdldHMpIHtcbiAgICBmb3IgKGNvbnN0IFtwbGF0Zm9ybSwgdGFyZ2V0c10gb2YgT2JqZWN0LmVudHJpZXMoZm9yZ2U1Q29uZmlnLm1ha2VfdGFyZ2V0cyBhcyBNYWtlVGFyZ2V0cykpIHtcbiAgICAgIGZvciAoY29uc3QgdGFyZ2V0IG9mIHRhcmdldHMpIHtcbiAgICAgICAgbGV0IHBsYXRmb3JtcyA9IG1ha2VUYXJnZXRzLmdldCh0YXJnZXQpO1xuICAgICAgICBpZiAocGxhdGZvcm1zID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICBwbGF0Zm9ybXMgPSBbXTtcbiAgICAgICAgICBtYWtlVGFyZ2V0cy5zZXQodGFyZ2V0LCBwbGF0Zm9ybXMpO1xuICAgICAgICB9XG4gICAgICAgIHBsYXRmb3Jtcy5wdXNoKHBsYXRmb3JtIGFzIEZvcmdlUGxhdGZvcm0pO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHJldHVybiBtYWtlVGFyZ2V0cztcbn1cblxuY29uc3QgZm9yZ2U1TWFrZXJNYXBwaW5ncyA9IG5ldyBNYXA8Rm9yZ2U1Q29uZmlnS2V5LCBzdHJpbmc+KFtcbiAgWydlbGVjdHJvbkluc3RhbGxlckRlYmlhbicsICdkZWInXSxcbiAgWydlbGVjdHJvbkluc3RhbGxlckRNRycsICdkbWcnXSxcbiAgWydlbGVjdHJvbkluc3RhbGxlckZsYXRwYWsnLCAnZmxhdHBhayddLFxuICBbJ2VsZWN0cm9uSW5zdGFsbGVyUmVkaGF0JywgJ3JwbSddLFxuICBbJ2VsZWN0cm9uSW5zdGFsbGVyU25hcCcsICdzbmFwJ10sXG4gIFsnZWxlY3Ryb25XaW5zdGFsbGVyQ29uZmlnJywgJ3NxdWlycmVsJ10sXG4gIFsnZWxlY3Ryb25XaXhNU0lDb25maWcnLCAnd2l4J10sXG4gIFsnd2luZG93c1N0b3JlQ29uZmlnJywgJ2FwcHgnXSxcbl0pO1xuXG4vKipcbiAqIENvbnZlcnRzIEZvcmdlIHY1IG1ha2VyIGNvbmZpZyB0byB2Ni5cbiAqL1xuZnVuY3Rpb24gZ2VuZXJhdGVGb3JnZU1ha2VyQ29uZmlnKGZvcmdlNUNvbmZpZzogRm9yZ2U1Q29uZmlnKTogSUZvcmdlUmVzb2x2YWJsZU1ha2VyW10ge1xuICBjb25zdCBtYWtlVGFyZ2V0cyA9IG1hcE1ha2VUYXJnZXRzKGZvcmdlNUNvbmZpZyk7XG4gIGNvbnN0IG1ha2VyczogSUZvcmdlUmVzb2x2YWJsZU1ha2VyW10gPSBbXTtcblxuICBmb3IgKGNvbnN0IFtmb3JnZTVLZXksIG1ha2VyVHlwZV0gb2YgZm9yZ2U1TWFrZXJNYXBwaW5ncykge1xuICAgIGNvbnN0IGNvbmZpZyA9IGZvcmdlNUNvbmZpZ1tmb3JnZTVLZXldO1xuICAgIGlmIChjb25maWcpIHtcbiAgICAgIG1ha2Vycy5wdXNoKHtcbiAgICAgICAgbmFtZTogYEBlbGVjdHJvbi1mb3JnZS9tYWtlci0ke21ha2VyVHlwZX1gLFxuICAgICAgICBjb25maWc6IGZvcmdlNUNvbmZpZ1tmb3JnZTVLZXldLFxuICAgICAgICBwbGF0Zm9ybXM6IG1ha2VUYXJnZXRzLmdldChtYWtlclR5cGUpIHx8IG51bGwsXG4gICAgICB9IGFzIElGb3JnZVJlc29sdmFibGVNYWtlcik7XG4gICAgfVxuICB9XG5cbiAgY29uc3QgemlwUGxhdGZvcm1zID0gbWFrZVRhcmdldHMuZ2V0KCd6aXAnKTtcbiAgaWYgKHppcFBsYXRmb3Jtcykge1xuICAgIG1ha2Vycy5wdXNoKHtcbiAgICAgIG5hbWU6ICdAZWxlY3Ryb24tZm9yZ2UvbWFrZXItemlwJyxcbiAgICAgIHBsYXRmb3JtczogemlwUGxhdGZvcm1zLFxuICAgIH0gYXMgSUZvcmdlUmVzb2x2YWJsZU1ha2VyKTtcbiAgfVxuXG4gIHJldHVybiBtYWtlcnM7XG59XG5cbmNvbnN0IGZvcmdlNVB1Ymxpc2hlck1hcHBpbmdzID0gbmV3IE1hcDxGb3JnZTVDb25maWdLZXksIHN0cmluZz4oW1xuICBbJ2dpdGh1Yl9yZXBvc2l0b3J5JywgJ2dpdGh1YiddLFxuICBbJ3MzJywgJ3MzJ10sXG4gIFsnZWxlY3Ryb24tcmVsZWFzZS1zZXJ2ZXInLCAnZWxlY3Ryb24tcmVsZWFzZS1zZXJ2ZXInXSxcbiAgWydzbmFwU3RvcmUnLCAnc25hcGNyYWZ0J10sXG5dKTtcblxuLyoqXG4gKiBUcmFuc2Zvcm1zIHY1IEdpdEh1YiBwdWJsaXNoZXIgY29uZmlnIHRvIHY2IHN5bnRheC5cbiAqL1xuZnVuY3Rpb24gdHJhbnNmb3JtR2l0SHViUHVibGlzaGVyQ29uZmlnKGNvbmZpZzogR2l0SHViNUNvbmZpZykge1xuICBjb25zdCB7IG5hbWUsIG93bmVyLCBvcHRpb25zLCAuLi5naXRIdWJDb25maWcgfSA9IGNvbmZpZztcbiAgZ2l0SHViQ29uZmlnLnJlcG9zaXRvcnkgPSB7IG5hbWUsIG93bmVyIH07XG4gIGlmIChvcHRpb25zKSB7XG4gICAgZ2l0SHViQ29uZmlnLm9jdG9raXRPcHRpb25zID0gb3B0aW9ucztcbiAgfVxuXG4gIHJldHVybiBnaXRIdWJDb25maWc7XG59XG5cbi8qKlxuICogQ29udmVydHMgRm9yZ2UgdjUgcHVibGlzaGVyIGNvbmZpZyB0byB2Ni5cbiAqL1xuZnVuY3Rpb24gZ2VuZXJhdGVGb3JnZVB1Ymxpc2hlckNvbmZpZyhmb3JnZTVDb25maWc6IEZvcmdlNUNvbmZpZyk6IElGb3JnZVJlc29sdmFibGVQdWJsaXNoZXJbXSB7XG4gIGNvbnN0IHB1Ymxpc2hlcnM6IElGb3JnZVJlc29sdmFibGVQdWJsaXNoZXJbXSA9IFtdO1xuXG4gIGZvciAoY29uc3QgW2ZvcmdlNUtleSwgcHVibGlzaGVyVHlwZV0gb2YgZm9yZ2U1UHVibGlzaGVyTWFwcGluZ3MpIHtcbiAgICBsZXQgY29uZmlnID0gZm9yZ2U1Q29uZmlnW2ZvcmdlNUtleV07XG4gICAgaWYgKGNvbmZpZykge1xuICAgICAgaWYgKHB1Ymxpc2hlclR5cGUgPT09ICdnaXRodWInKSB7XG4gICAgICAgIGNvbmZpZyA9IHRyYW5zZm9ybUdpdEh1YlB1Ymxpc2hlckNvbmZpZyhjb25maWcgYXMgR2l0SHViNUNvbmZpZyk7XG4gICAgICB9XG4gICAgICBwdWJsaXNoZXJzLnB1c2goe1xuICAgICAgICBjb25maWcsXG4gICAgICAgIG5hbWU6IGBAZWxlY3Ryb24tZm9yZ2UvcHVibGlzaGVyLSR7cHVibGlzaGVyVHlwZX1gLFxuICAgICAgICBwbGF0Zm9ybXM6IG51bGwsXG4gICAgICB9IGFzIElGb3JnZVJlc29sdmFibGVNYWtlcik7XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIHB1Ymxpc2hlcnM7XG59XG5cbi8qKlxuICogVXBncmFkZXMgRm9yZ2UgdjUgY29uZmlnIHRvIHY2LlxuICovXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiB1cGdyYWRlRm9yZ2VDb25maWcoZm9yZ2U1Q29uZmlnOiBGb3JnZTVDb25maWcpOiBGb3JnZUNvbmZpZyB7XG4gIGNvbnN0IGZvcmdlQ29uZmlnOiBGb3JnZUNvbmZpZyA9IHt9IGFzIEZvcmdlQ29uZmlnO1xuXG4gIGlmIChmb3JnZTVDb25maWcuZWxlY3Ryb25QYWNrYWdlckNvbmZpZykge1xuICAgIGRlbGV0ZSBmb3JnZTVDb25maWcuZWxlY3Ryb25QYWNrYWdlckNvbmZpZy5wYWNrYWdlTWFuYWdlcjtcbiAgICBmb3JnZUNvbmZpZy5wYWNrYWdlckNvbmZpZyA9IGZvcmdlNUNvbmZpZy5lbGVjdHJvblBhY2thZ2VyQ29uZmlnO1xuICB9XG4gIGlmIChmb3JnZTVDb25maWcuZWxlY3Ryb25SZWJ1aWxkQ29uZmlnKSB7XG4gICAgZm9yZ2VDb25maWcuZWxlY3Ryb25SZWJ1aWxkQ29uZmlnID0gZm9yZ2U1Q29uZmlnLmVsZWN0cm9uUmVidWlsZENvbmZpZztcbiAgfVxuICBmb3JnZUNvbmZpZy5tYWtlcnMgPSBnZW5lcmF0ZUZvcmdlTWFrZXJDb25maWcoZm9yZ2U1Q29uZmlnKTtcbiAgZm9yZ2VDb25maWcucHVibGlzaGVycyA9IGdlbmVyYXRlRm9yZ2VQdWJsaXNoZXJDb25maWcoZm9yZ2U1Q29uZmlnKTtcblxuICByZXR1cm4gZm9yZ2VDb25maWc7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiB1cGRhdGVVcGdyYWRlZEZvcmdlRGV2RGVwcyhwYWNrYWdlSlNPTjogRm9yZ2VQYWNrYWdlSlNPTiwgZGV2RGVwczogc3RyaW5nW10pOiBzdHJpbmdbXSB7XG4gIGNvbnN0IGZvcmdlQ29uZmlnID0gcGFja2FnZUpTT04uY29uZmlnLmZvcmdlO1xuICBkZXZEZXBzID0gZGV2RGVwcy5maWx0ZXIoKGRlcCkgPT4gIWRlcC5zdGFydHNXaXRoKCdAZWxlY3Ryb24tZm9yZ2UvbWFrZXItJykpO1xuICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbWF4LWxlblxuICBkZXZEZXBzID0gZGV2RGVwcy5jb25jYXQoKGZvcmdlQ29uZmlnLm1ha2VycyBhcyBJRm9yZ2VSZXNvbHZhYmxlTWFrZXJbXSkubWFwKChtYWtlcjogSUZvcmdlUmVzb2x2YWJsZU1ha2VyKSA9PiBzaWJsaW5nRGVwKHBhdGguYmFzZW5hbWUobWFrZXIubmFtZSkpKSk7XG4gIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBtYXgtbGVuXG4gIGRldkRlcHMgPSBkZXZEZXBzLmNvbmNhdChcbiAgICAoZm9yZ2VDb25maWcucHVibGlzaGVycyBhcyBJRm9yZ2VSZXNvbHZhYmxlUHVibGlzaGVyW10pLm1hcCgocHVibGlzaGVyOiBJRm9yZ2VSZXNvbHZhYmxlUHVibGlzaGVyKSA9PiBzaWJsaW5nRGVwKHBhdGguYmFzZW5hbWUocHVibGlzaGVyLm5hbWUpKSlcbiAgKTtcblxuICBpZiAoT2JqZWN0LmtleXMocGFja2FnZUpTT04uZGV2RGVwZW5kZW5jaWVzKS5maW5kKChkZXA6IHN0cmluZykgPT4gZGVwID09PSAnZWxlY3Ryb24tcHJlYnVpbHQtY29tcGlsZScpKSB7XG4gICAgZGV2RGVwcyA9IGRldkRlcHMuY29uY2F0KHNpYmxpbmdEZXAoJ3BsdWdpbi1jb21waWxlJykpO1xuICB9XG5cbiAgcmV0dXJuIGRldkRlcHM7XG59XG4iXX0=
"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _pluginBase = _interopRequireDefault(require("@electron-forge/plugin-base"));

var _debug = _interopRequireDefault(require("debug"));

var _requireSearch = _interopRequireDefault(require("./require-search"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

const d = (0, _debug.default)('electron-forge:plugins');

class PluginInterface {
  constructor(dir, forgeConfig) {
    _defineProperty(this, "plugins", void 0);

    _defineProperty(this, "config", void 0);

    this.plugins = forgeConfig.plugins.map(plugin => {
      // eslint-disable-next-line no-underscore-dangle
      if (plugin.__isElectronForgePlugin) {
        return plugin;
      }

      if (Array.isArray(plugin)) {
        const [pluginName, opts = {}] = plugin;

        if (typeof pluginName !== 'string') {
          throw new Error(`Expected plugin[0] to be a string but found ${pluginName}`);
        } // eslint-disable-next-line @typescript-eslint/no-explicit-any


        const Plugin = (0, _requireSearch.default)(dir, [pluginName]);

        if (!Plugin) {
          throw new Error(`Could not find module with name: ${plugin[0]}. Make sure it's listed in the devDependencies of your package.json`);
        }

        return new Plugin(opts);
      }

      throw new Error(`Expected plugin to either be a plugin instance or [string, object] but found ${plugin}`);
    }); // TODO: fix hack
    // eslint-disable-next-line @typescript-eslint/no-explicit-any

    this.config = null;
    Object.defineProperty(this, 'config', {
      value: forgeConfig,
      enumerable: false,
      configurable: false,
      writable: false
    });

    for (const plugin of this.plugins) {
      plugin.init(dir, forgeConfig);
    }

    this.triggerHook = this.triggerHook.bind(this);
    this.overrideStartLogic = this.overrideStartLogic.bind(this);
  } // eslint-disable-next-line @typescript-eslint/no-explicit-any


  async triggerHook(hookName, hookArgs) {
    for (const plugin of this.plugins) {
      if (typeof plugin.getHook === 'function') {
        const hook = plugin.getHook(hookName);
        if (hook) await hook(this.config, ...hookArgs);
      }
    }
  }

  async triggerMutatingHook(hookName, item) {
    for (const plugin of this.plugins) {
      if (typeof plugin.getHook === 'function') {
        const hook = plugin.getHook(hookName);

        if (hook) {
          item = await hook(this.config, item);
        }
      }
    }

    return item;
  }

  async overrideStartLogic(opts) {
    let newStartFn;
    const claimed = [];

    for (const plugin of this.plugins) {
      if (typeof plugin.startLogic === 'function' && plugin.startLogic !== _pluginBase.default.prototype.startLogic) {
        claimed.push(plugin.name);
        newStartFn = plugin.startLogic;
      }
    }

    if (claimed.length > 1) {
      throw new Error(`Multiple plugins tried to take control of the start command, please remove one of them\n --> ${claimed.join(', ')}`);
    }

    if (claimed.length === 1 && newStartFn) {
      d(`plugin: "${claimed[0]}" has taken control of the start command`);
      return newStartFn(opts);
    }

    return false;
  }

}

exports.default = PluginInterface;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy91dGlsL3BsdWdpbi1pbnRlcmZhY2UudHMiXSwibmFtZXMiOlsiZCIsIlBsdWdpbkludGVyZmFjZSIsImNvbnN0cnVjdG9yIiwiZGlyIiwiZm9yZ2VDb25maWciLCJwbHVnaW5zIiwibWFwIiwicGx1Z2luIiwiX19pc0VsZWN0cm9uRm9yZ2VQbHVnaW4iLCJBcnJheSIsImlzQXJyYXkiLCJwbHVnaW5OYW1lIiwib3B0cyIsIkVycm9yIiwiUGx1Z2luIiwiY29uZmlnIiwiT2JqZWN0IiwiZGVmaW5lUHJvcGVydHkiLCJ2YWx1ZSIsImVudW1lcmFibGUiLCJjb25maWd1cmFibGUiLCJ3cml0YWJsZSIsImluaXQiLCJ0cmlnZ2VySG9vayIsImJpbmQiLCJvdmVycmlkZVN0YXJ0TG9naWMiLCJob29rTmFtZSIsImhvb2tBcmdzIiwiZ2V0SG9vayIsImhvb2siLCJ0cmlnZ2VyTXV0YXRpbmdIb29rIiwiaXRlbSIsIm5ld1N0YXJ0Rm4iLCJjbGFpbWVkIiwic3RhcnRMb2dpYyIsIlBsdWdpbkJhc2UiLCJwcm90b3R5cGUiLCJwdXNoIiwibmFtZSIsImxlbmd0aCIsImpvaW4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQUFBOztBQUVBOztBQUdBOzs7Ozs7QUFFQSxNQUFNQSxDQUFDLEdBQUcsb0JBQU0sd0JBQU4sQ0FBVjs7QUFFZSxNQUFNQyxlQUFOLENBQXVEO0FBS3BFQyxFQUFBQSxXQUFXLENBQUNDLEdBQUQsRUFBY0MsV0FBZCxFQUF3QztBQUFBOztBQUFBOztBQUNqRCxTQUFLQyxPQUFMLEdBQWVELFdBQVcsQ0FBQ0MsT0FBWixDQUFvQkMsR0FBcEIsQ0FBeUJDLE1BQUQsSUFBWTtBQUNqRDtBQUNBLFVBQUtBLE1BQUQsQ0FBeUJDLHVCQUE3QixFQUFzRDtBQUNwRCxlQUFPRCxNQUFQO0FBQ0Q7O0FBRUQsVUFBSUUsS0FBSyxDQUFDQyxPQUFOLENBQWNILE1BQWQsQ0FBSixFQUEyQjtBQUN6QixjQUFNLENBQUNJLFVBQUQsRUFBYUMsSUFBSSxHQUFHLEVBQXBCLElBQTBCTCxNQUFoQzs7QUFDQSxZQUFJLE9BQU9JLFVBQVAsS0FBc0IsUUFBMUIsRUFBb0M7QUFDbEMsZ0JBQU0sSUFBSUUsS0FBSixDQUFXLCtDQUE4Q0YsVUFBVyxFQUFwRSxDQUFOO0FBQ0QsU0FKd0IsQ0FLekI7OztBQUNBLGNBQU1HLE1BQU0sR0FBRyw0QkFBbUJYLEdBQW5CLEVBQXdCLENBQUNRLFVBQUQsQ0FBeEIsQ0FBZjs7QUFDQSxZQUFJLENBQUNHLE1BQUwsRUFBYTtBQUNYLGdCQUFNLElBQUlELEtBQUosQ0FBVyxvQ0FBbUNOLE1BQU0sQ0FBQyxDQUFELENBQUkscUVBQXhELENBQU47QUFDRDs7QUFDRCxlQUFPLElBQUlPLE1BQUosQ0FBV0YsSUFBWCxDQUFQO0FBQ0Q7O0FBQ0QsWUFBTSxJQUFJQyxLQUFKLENBQVcsZ0ZBQStFTixNQUFPLEVBQWpHLENBQU47QUFDRCxLQW5CYyxDQUFmLENBRGlELENBcUJqRDtBQUNBOztBQUNBLFNBQUtRLE1BQUwsR0FBYyxJQUFkO0FBQ0FDLElBQUFBLE1BQU0sQ0FBQ0MsY0FBUCxDQUFzQixJQUF0QixFQUE0QixRQUE1QixFQUFzQztBQUNwQ0MsTUFBQUEsS0FBSyxFQUFFZCxXQUQ2QjtBQUVwQ2UsTUFBQUEsVUFBVSxFQUFFLEtBRndCO0FBR3BDQyxNQUFBQSxZQUFZLEVBQUUsS0FIc0I7QUFJcENDLE1BQUFBLFFBQVEsRUFBRTtBQUowQixLQUF0Qzs7QUFPQSxTQUFLLE1BQU1kLE1BQVgsSUFBcUIsS0FBS0YsT0FBMUIsRUFBbUM7QUFDakNFLE1BQUFBLE1BQU0sQ0FBQ2UsSUFBUCxDQUFZbkIsR0FBWixFQUFpQkMsV0FBakI7QUFDRDs7QUFFRCxTQUFLbUIsV0FBTCxHQUFtQixLQUFLQSxXQUFMLENBQWlCQyxJQUFqQixDQUFzQixJQUF0QixDQUFuQjtBQUNBLFNBQUtDLGtCQUFMLEdBQTBCLEtBQUtBLGtCQUFMLENBQXdCRCxJQUF4QixDQUE2QixJQUE3QixDQUExQjtBQUNELEdBMUNtRSxDQTRDcEU7OztBQUNpQixRQUFYRCxXQUFXLENBQUNHLFFBQUQsRUFBbUJDLFFBQW5CLEVBQW1EO0FBQ2xFLFNBQUssTUFBTXBCLE1BQVgsSUFBcUIsS0FBS0YsT0FBMUIsRUFBbUM7QUFDakMsVUFBSSxPQUFPRSxNQUFNLENBQUNxQixPQUFkLEtBQTBCLFVBQTlCLEVBQTBDO0FBQ3hDLGNBQU1DLElBQUksR0FBR3RCLE1BQU0sQ0FBQ3FCLE9BQVAsQ0FBZUYsUUFBZixDQUFiO0FBQ0EsWUFBSUcsSUFBSixFQUFVLE1BQU1BLElBQUksQ0FBQyxLQUFLZCxNQUFOLEVBQWMsR0FBR1ksUUFBakIsQ0FBVjtBQUNYO0FBQ0Y7QUFDRjs7QUFFd0IsUUFBbkJHLG1CQUFtQixDQUFJSixRQUFKLEVBQXNCSyxJQUF0QixFQUEyQztBQUNsRSxTQUFLLE1BQU14QixNQUFYLElBQXFCLEtBQUtGLE9BQTFCLEVBQW1DO0FBQ2pDLFVBQUksT0FBT0UsTUFBTSxDQUFDcUIsT0FBZCxLQUEwQixVQUE5QixFQUEwQztBQUN4QyxjQUFNQyxJQUFJLEdBQUd0QixNQUFNLENBQUNxQixPQUFQLENBQWVGLFFBQWYsQ0FBYjs7QUFDQSxZQUFJRyxJQUFKLEVBQVU7QUFDUkUsVUFBQUEsSUFBSSxHQUFHLE1BQU1GLElBQUksQ0FBQyxLQUFLZCxNQUFOLEVBQWNnQixJQUFkLENBQWpCO0FBQ0Q7QUFDRjtBQUNGOztBQUNELFdBQU9BLElBQVA7QUFDRDs7QUFFdUIsUUFBbEJOLGtCQUFrQixDQUFDYixJQUFELEVBQTJDO0FBQ2pFLFFBQUlvQixVQUFKO0FBQ0EsVUFBTUMsT0FBTyxHQUFHLEVBQWhCOztBQUNBLFNBQUssTUFBTTFCLE1BQVgsSUFBcUIsS0FBS0YsT0FBMUIsRUFBbUM7QUFDakMsVUFBSSxPQUFPRSxNQUFNLENBQUMyQixVQUFkLEtBQTZCLFVBQTdCLElBQTJDM0IsTUFBTSxDQUFDMkIsVUFBUCxLQUFzQkMsb0JBQVdDLFNBQVgsQ0FBcUJGLFVBQTFGLEVBQXNHO0FBQ3BHRCxRQUFBQSxPQUFPLENBQUNJLElBQVIsQ0FBYTlCLE1BQU0sQ0FBQytCLElBQXBCO0FBQ0FOLFFBQUFBLFVBQVUsR0FBR3pCLE1BQU0sQ0FBQzJCLFVBQXBCO0FBQ0Q7QUFDRjs7QUFDRCxRQUFJRCxPQUFPLENBQUNNLE1BQVIsR0FBaUIsQ0FBckIsRUFBd0I7QUFDdEIsWUFBTSxJQUFJMUIsS0FBSixDQUFXLGdHQUErRm9CLE9BQU8sQ0FBQ08sSUFBUixDQUFhLElBQWIsQ0FBbUIsRUFBN0gsQ0FBTjtBQUNEOztBQUNELFFBQUlQLE9BQU8sQ0FBQ00sTUFBUixLQUFtQixDQUFuQixJQUF3QlAsVUFBNUIsRUFBd0M7QUFDdENoQyxNQUFBQSxDQUFDLENBQUUsWUFBV2lDLE9BQU8sQ0FBQyxDQUFELENBQUksMENBQXhCLENBQUQ7QUFDQSxhQUFPRCxVQUFVLENBQUNwQixJQUFELENBQWpCO0FBQ0Q7O0FBQ0QsV0FBTyxLQUFQO0FBQ0Q7O0FBbkZtRSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBQbHVnaW5CYXNlIGZyb20gJ0BlbGVjdHJvbi1mb3JnZS9wbHVnaW4tYmFzZSc7XG5pbXBvcnQgeyBJRm9yZ2VQbHVnaW5JbnRlcmZhY2UsIEZvcmdlQ29uZmlnLCBJRm9yZ2VQbHVnaW4sIFN0YXJ0UmVzdWx0IH0gZnJvbSAnQGVsZWN0cm9uLWZvcmdlL3NoYXJlZC10eXBlcyc7XG5pbXBvcnQgZGVidWcgZnJvbSAnZGVidWcnO1xuXG5pbXBvcnQgeyBTdGFydE9wdGlvbnMgfSBmcm9tICcuLi9hcGknO1xuaW1wb3J0IHJlcXVpcmVTZWFyY2ggZnJvbSAnLi9yZXF1aXJlLXNlYXJjaCc7XG5cbmNvbnN0IGQgPSBkZWJ1ZygnZWxlY3Ryb24tZm9yZ2U6cGx1Z2lucycpO1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBQbHVnaW5JbnRlcmZhY2UgaW1wbGVtZW50cyBJRm9yZ2VQbHVnaW5JbnRlcmZhY2Uge1xuICBwcml2YXRlIHBsdWdpbnM6IElGb3JnZVBsdWdpbltdO1xuXG4gIHByaXZhdGUgY29uZmlnOiBGb3JnZUNvbmZpZztcblxuICBjb25zdHJ1Y3RvcihkaXI6IHN0cmluZywgZm9yZ2VDb25maWc6IEZvcmdlQ29uZmlnKSB7XG4gICAgdGhpcy5wbHVnaW5zID0gZm9yZ2VDb25maWcucGx1Z2lucy5tYXAoKHBsdWdpbikgPT4ge1xuICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXVuZGVyc2NvcmUtZGFuZ2xlXG4gICAgICBpZiAoKHBsdWdpbiBhcyBJRm9yZ2VQbHVnaW4pLl9faXNFbGVjdHJvbkZvcmdlUGx1Z2luKSB7XG4gICAgICAgIHJldHVybiBwbHVnaW47XG4gICAgICB9XG5cbiAgICAgIGlmIChBcnJheS5pc0FycmF5KHBsdWdpbikpIHtcbiAgICAgICAgY29uc3QgW3BsdWdpbk5hbWUsIG9wdHMgPSB7fV0gPSBwbHVnaW47XG4gICAgICAgIGlmICh0eXBlb2YgcGx1Z2luTmFtZSAhPT0gJ3N0cmluZycpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEV4cGVjdGVkIHBsdWdpblswXSB0byBiZSBhIHN0cmluZyBidXQgZm91bmQgJHtwbHVnaW5OYW1lfWApO1xuICAgICAgICB9XG4gICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tZXhwbGljaXQtYW55XG4gICAgICAgIGNvbnN0IFBsdWdpbiA9IHJlcXVpcmVTZWFyY2g8YW55PihkaXIsIFtwbHVnaW5OYW1lXSk7XG4gICAgICAgIGlmICghUGx1Z2luKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBDb3VsZCBub3QgZmluZCBtb2R1bGUgd2l0aCBuYW1lOiAke3BsdWdpblswXX0uIE1ha2Ugc3VyZSBpdCdzIGxpc3RlZCBpbiB0aGUgZGV2RGVwZW5kZW5jaWVzIG9mIHlvdXIgcGFja2FnZS5qc29uYCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIG5ldyBQbHVnaW4ob3B0cyk7XG4gICAgICB9XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYEV4cGVjdGVkIHBsdWdpbiB0byBlaXRoZXIgYmUgYSBwbHVnaW4gaW5zdGFuY2Ugb3IgW3N0cmluZywgb2JqZWN0XSBidXQgZm91bmQgJHtwbHVnaW59YCk7XG4gICAgfSk7XG4gICAgLy8gVE9ETzogZml4IGhhY2tcbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLWV4cGxpY2l0LWFueVxuICAgIHRoaXMuY29uZmlnID0gbnVsbCBhcyBhbnk7XG4gICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRoaXMsICdjb25maWcnLCB7XG4gICAgICB2YWx1ZTogZm9yZ2VDb25maWcsXG4gICAgICBlbnVtZXJhYmxlOiBmYWxzZSxcbiAgICAgIGNvbmZpZ3VyYWJsZTogZmFsc2UsXG4gICAgICB3cml0YWJsZTogZmFsc2UsXG4gICAgfSk7XG5cbiAgICBmb3IgKGNvbnN0IHBsdWdpbiBvZiB0aGlzLnBsdWdpbnMpIHtcbiAgICAgIHBsdWdpbi5pbml0KGRpciwgZm9yZ2VDb25maWcpO1xuICAgIH1cblxuICAgIHRoaXMudHJpZ2dlckhvb2sgPSB0aGlzLnRyaWdnZXJIb29rLmJpbmQodGhpcyk7XG4gICAgdGhpcy5vdmVycmlkZVN0YXJ0TG9naWMgPSB0aGlzLm92ZXJyaWRlU3RhcnRMb2dpYy5iaW5kKHRoaXMpO1xuICB9XG5cbiAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1leHBsaWNpdC1hbnlcbiAgYXN5bmMgdHJpZ2dlckhvb2soaG9va05hbWU6IHN0cmluZywgaG9va0FyZ3M6IGFueVtdKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgZm9yIChjb25zdCBwbHVnaW4gb2YgdGhpcy5wbHVnaW5zKSB7XG4gICAgICBpZiAodHlwZW9mIHBsdWdpbi5nZXRIb29rID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgIGNvbnN0IGhvb2sgPSBwbHVnaW4uZ2V0SG9vayhob29rTmFtZSk7XG4gICAgICAgIGlmIChob29rKSBhd2FpdCBob29rKHRoaXMuY29uZmlnLCAuLi5ob29rQXJncyk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgdHJpZ2dlck11dGF0aW5nSG9vazxUPihob29rTmFtZTogc3RyaW5nLCBpdGVtOiBUKTogUHJvbWlzZTxUPiB7XG4gICAgZm9yIChjb25zdCBwbHVnaW4gb2YgdGhpcy5wbHVnaW5zKSB7XG4gICAgICBpZiAodHlwZW9mIHBsdWdpbi5nZXRIb29rID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgIGNvbnN0IGhvb2sgPSBwbHVnaW4uZ2V0SG9vayhob29rTmFtZSk7XG4gICAgICAgIGlmIChob29rKSB7XG4gICAgICAgICAgaXRlbSA9IGF3YWl0IGhvb2sodGhpcy5jb25maWcsIGl0ZW0pO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBpdGVtO1xuICB9XG5cbiAgYXN5bmMgb3ZlcnJpZGVTdGFydExvZ2ljKG9wdHM6IFN0YXJ0T3B0aW9ucyk6IFByb21pc2U8U3RhcnRSZXN1bHQ+IHtcbiAgICBsZXQgbmV3U3RhcnRGbjtcbiAgICBjb25zdCBjbGFpbWVkID0gW107XG4gICAgZm9yIChjb25zdCBwbHVnaW4gb2YgdGhpcy5wbHVnaW5zKSB7XG4gICAgICBpZiAodHlwZW9mIHBsdWdpbi5zdGFydExvZ2ljID09PSAnZnVuY3Rpb24nICYmIHBsdWdpbi5zdGFydExvZ2ljICE9PSBQbHVnaW5CYXNlLnByb3RvdHlwZS5zdGFydExvZ2ljKSB7XG4gICAgICAgIGNsYWltZWQucHVzaChwbHVnaW4ubmFtZSk7XG4gICAgICAgIG5ld1N0YXJ0Rm4gPSBwbHVnaW4uc3RhcnRMb2dpYztcbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKGNsYWltZWQubGVuZ3RoID4gMSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBNdWx0aXBsZSBwbHVnaW5zIHRyaWVkIHRvIHRha2UgY29udHJvbCBvZiB0aGUgc3RhcnQgY29tbWFuZCwgcGxlYXNlIHJlbW92ZSBvbmUgb2YgdGhlbVxcbiAtLT4gJHtjbGFpbWVkLmpvaW4oJywgJyl9YCk7XG4gICAgfVxuICAgIGlmIChjbGFpbWVkLmxlbmd0aCA9PT0gMSAmJiBuZXdTdGFydEZuKSB7XG4gICAgICBkKGBwbHVnaW46IFwiJHtjbGFpbWVkWzBdfVwiIGhhcyB0YWtlbiBjb250cm9sIG9mIHRoZSBzdGFydCBjb21tYW5kYCk7XG4gICAgICByZXR1cm4gbmV3U3RhcnRGbihvcHRzKTtcbiAgICB9XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG59XG4iXX0=
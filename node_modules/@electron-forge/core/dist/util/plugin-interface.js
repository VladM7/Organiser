"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _pluginBase = _interopRequireDefault(require("@electron-forge/plugin-base"));

var _debug = _interopRequireDefault(require("debug"));

var _requireSearch = _interopRequireDefault(require("./require-search"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

const d = (0, _debug.default)('electron-forge:plugins');

class PluginInterface {
  constructor(dir, forgeConfig) {
    _defineProperty(this, "plugins", void 0);

    _defineProperty(this, "config", void 0);

    this.plugins = forgeConfig.plugins.map(plugin => {
      // eslint-disable-next-line no-underscore-dangle
      if (plugin.__isElectronForgePlugin) {
        return plugin;
      }

      if (Array.isArray(plugin)) {
        const [pluginName, opts = {}] = plugin;

        if (typeof pluginName !== 'string') {
          throw new Error(`Expected plugin[0] to be a string but found ${pluginName}`);
        }

        const Plugin = (0, _requireSearch.default)(dir, [pluginName]);

        if (!Plugin) {
          throw new Error(`Could not find module with name: ${plugin[0]}. Make sure it's listed in the devDependencies of your package.json`);
        }

        return new Plugin(opts);
      }

      throw new Error(`Expected plugin to either be a plugin instance or [string, object] but found ${plugin}`);
    }); // Fix linting

    this.config = null;
    Object.defineProperty(this, 'config', {
      value: forgeConfig,
      enumerable: false,
      configurable: false,
      writable: false
    });

    for (const plugin of this.plugins) {
      plugin.init(dir, forgeConfig);
    }

    this.triggerHook = this.triggerHook.bind(this);
    this.overrideStartLogic = this.overrideStartLogic.bind(this);
  }

  async triggerHook(hookName, hookArgs) {
    for (const plugin of this.plugins) {
      if (typeof plugin.getHook === 'function') {
        const hook = plugin.getHook(hookName);
        if (hook) await hook(this.config, ...hookArgs);
      }
    }
  }

  async triggerMutatingHook(hookName, item) {
    for (const plugin of this.plugins) {
      if (typeof plugin.getHook === 'function') {
        const hook = plugin.getHook(hookName);

        if (hook) {
          item = await hook(this.config, item);
        }
      }
    }

    return item;
  }

  async overrideStartLogic(opts) {
    let newStartFn;
    const claimed = [];

    for (const plugin of this.plugins) {
      if (typeof plugin.startLogic === 'function' && plugin.startLogic !== _pluginBase.default.prototype.startLogic) {
        claimed.push(plugin.name);
        newStartFn = plugin.startLogic;
      }
    }

    if (claimed.length > 1) {
      throw new Error(`Multiple plugins tried to take control of the start command, please remove one of them\n --> ${claimed.join(', ')}`);
    }

    if (claimed.length === 1 && newStartFn) {
      d(`plugin: "${claimed[0]}" has taken control of the start command`);
      return newStartFn(opts);
    }

    return false;
  }

}

exports.default = PluginInterface;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy91dGlsL3BsdWdpbi1pbnRlcmZhY2UudHMiXSwibmFtZXMiOlsiZCIsIlBsdWdpbkludGVyZmFjZSIsImNvbnN0cnVjdG9yIiwiZGlyIiwiZm9yZ2VDb25maWciLCJwbHVnaW5zIiwibWFwIiwicGx1Z2luIiwiX19pc0VsZWN0cm9uRm9yZ2VQbHVnaW4iLCJBcnJheSIsImlzQXJyYXkiLCJwbHVnaW5OYW1lIiwib3B0cyIsIkVycm9yIiwiUGx1Z2luIiwiY29uZmlnIiwiT2JqZWN0IiwiZGVmaW5lUHJvcGVydHkiLCJ2YWx1ZSIsImVudW1lcmFibGUiLCJjb25maWd1cmFibGUiLCJ3cml0YWJsZSIsImluaXQiLCJ0cmlnZ2VySG9vayIsImJpbmQiLCJvdmVycmlkZVN0YXJ0TG9naWMiLCJob29rTmFtZSIsImhvb2tBcmdzIiwiZ2V0SG9vayIsImhvb2siLCJ0cmlnZ2VyTXV0YXRpbmdIb29rIiwiaXRlbSIsIm5ld1N0YXJ0Rm4iLCJjbGFpbWVkIiwic3RhcnRMb2dpYyIsIlBsdWdpbkJhc2UiLCJwcm90b3R5cGUiLCJwdXNoIiwibmFtZSIsImxlbmd0aCIsImpvaW4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQUFBOztBQUVBOztBQUdBOzs7Ozs7QUFFQSxNQUFNQSxDQUFDLEdBQUcsb0JBQU0sd0JBQU4sQ0FBVjs7QUFFZSxNQUFNQyxlQUFOLENBQXVEO0FBS3BFQyxFQUFBQSxXQUFXLENBQUNDLEdBQUQsRUFBY0MsV0FBZCxFQUF3QztBQUFBOztBQUFBOztBQUNqRCxTQUFLQyxPQUFMLEdBQWVELFdBQVcsQ0FBQ0MsT0FBWixDQUFvQkMsR0FBcEIsQ0FBeUJDLE1BQUQsSUFBWTtBQUNqRDtBQUNBLFVBQUtBLE1BQUQsQ0FBeUJDLHVCQUE3QixFQUFzRDtBQUNwRCxlQUFPRCxNQUFQO0FBQ0Q7O0FBRUQsVUFBSUUsS0FBSyxDQUFDQyxPQUFOLENBQWNILE1BQWQsQ0FBSixFQUEyQjtBQUN6QixjQUFNLENBQUNJLFVBQUQsRUFBYUMsSUFB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QU0sQ0FBQzJCLFVBQXBCO0FBQ0Q7QUFDRjs7QUFDRCxRQUFJRCxPQUFPLENBQUNNLE1BQVIsR0FBaUIsQ0FBckIsRUFBd0I7QUFDdEIsWUFBTSxJQUFJMUIsS0FBSixDQUFXLGdHQUErRm9CLE9BQU8sQ0FBQ08sSUFBUixDQUFhLElBQWIsQ0FBbUIsRUFBN0gsQ0FBTjtBQUNEOztBQUNELFFBQUlQLE9BQU8sQ0FBQ00sTUFBUixLQUFtQixDQUFuQixJQUF3QlAsVUFBNUIsRUFBd0M7QUFDdENoQyxNQUFBQSxDQUFDLENBQUUsWUFBV2lDLE9BQU8sQ0FBQyxDQUFELENBQUksMENBQXhCLENBQUQ7QUFDQSxhQUFPRCxVQUFVLENBQUNwQixJQUFELENBQWpCO0FBQ0Q7O0FBQ0QsV0FBTyxLQUFQO0FBQ0Q7O0FBaEZtRSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBQbHVnaW5CYXNlIGZyb20gJ0BlbGVjdHJvbi1mb3JnZS9wbHVnaW4tYmFzZSc7XG5pbXBvcnQgeyBJRm9yZ2VQbHVnaW5JbnRlcmZhY2UsIEZvcmdlQ29uZmlnLCBJRm9yZ2VQbHVnaW4gfSBmcm9tICdAZWxlY3Ryb24tZm9yZ2Uvc2hhcmVkLXR5cGVzJztcbmltcG9ydCBkZWJ1ZyBmcm9tICdkZWJ1Zyc7XG5cbmltcG9ydCB7IFN0YXJ0T3B0aW9ucyB9IGZyb20gJy4uL2FwaSc7XG5pbXBvcnQgcmVxdWlyZVNlYXJjaCBmcm9tICcuL3JlcXVpcmUtc2VhcmNoJztcblxuY29uc3QgZCA9IGRlYnVnKCdlbGVjdHJvbi1mb3JnZTpwbHVnaW5zJyk7XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFBsdWdpbkludGVyZmFjZSBpbXBsZW1lbnRzIElGb3JnZVBsdWdpbkludGVyZmFjZSB7XG4gIHByaXZhdGUgcGx1Z2luczogSUZvcmdlUGx1Z2luW107XG5cbiAgcHJpdmF0ZSBjb25maWc6IEZvcmdlQ29uZmlnO1xuXG4gIGNvbnN0cnVjdG9yKGRpcjogc3RyaW5nLCBmb3JnZUNvbmZpZzogRm9yZ2VDb25maWcpIHtcbiAgICB0aGlzLnBsdWdpbnMgPSBmb3JnZUNvbmZpZy5wbHVnaW5zLm1hcCgocGx1Z2luKSA9PiB7XG4gICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tdW5kZXJzY29yZS1kYW5nbGVcbiAgICAgIGlmICgocGx1Z2luIGFzIElGb3JnZVBsdWdpbikuX19pc0VsZWN0cm9uRm9yZ2VQbHVnaW4pIHtcbiAgICAgICAgcmV0dXJuIHBsdWdpbjtcbiAgICAgIH1cblxuICAgICAgaWYgKEFycmF5LmlzQXJyYXkocGx1Z2luKSkge1xuICAgICAgICBjb25zdCBbcGx1Z2luTmFtZSwgb3B0cyA9IHt9XSA9IHBsdWdpbjtcbiAgICAgICAgaWYgKHR5cGVvZiBwbHVnaW5OYW1lICE9PSAnc3RyaW5nJykge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgRXhwZWN0ZWQgcGx1Z2luWzBdIHRvIGJlIGEgc3RyaW5nIGJ1dCBmb3VuZCAke3BsdWdpbk5hbWV9YCk7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgUGx1Z2luID0gcmVxdWlyZVNlYXJjaDxhbnk+KGRpciwgW3BsdWdpbk5hbWVdKTtcbiAgICAgICAgaWYgKCFQbHVnaW4pIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYENvdWxkIG5vdCBmaW5kIG1vZHVsZSB3aXRoIG5hbWU6ICR7cGx1Z2luWzBdfS4gTWFrZSBzdXJlIGl0J3MgbGlzdGVkIGluIHRoZSBkZXZEZXBlbmRlbmNpZXMgb2YgeW91ciBwYWNrYWdlLmpzb25gKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbmV3IFBsdWdpbihvcHRzKTtcbiAgICAgIH1cbiAgICAgIHRocm93IG5ldyBFcnJvcihgRXhwZWN0ZWQgcGx1Z2luIHRvIGVpdGhlciBiZSBhIHBsdWdpbiBpbnN0YW5jZSBvciBbc3RyaW5nLCBvYmplY3RdIGJ1dCBmb3VuZCAke3BsdWdpbn1gKTtcbiAgICB9KTtcbiAgICAvLyBGaXggbGludGluZ1xuICAgIHRoaXMuY29uZmlnID0gbnVsbCBhcyBhbnk7XG4gICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRoaXMsICdjb25maWcnLCB7XG4gICAgICB2YWx1ZTogZm9yZ2VDb25maWcsXG4gICAgICBlbnVtZXJhYmxlOiBmYWxzZSxcbiAgICAgIGNvbmZpZ3VyYWJsZTogZmFsc2UsXG4gICAgICB3cml0YWJsZTogZmFsc2UsXG4gICAgfSk7XG5cbiAgICBmb3IgKGNvbnN0IHBsdWdpbiBvZiB0aGlzLnBsdWdpbnMpIHtcbiAgICAgIHBsdWdpbi5pbml0KGRpciwgZm9yZ2VDb25maWcpO1xuICAgIH1cblxuICAgIHRoaXMudHJpZ2dlckhvb2sgPSB0aGlzLnRyaWdnZXJIb29rLmJpbmQodGhpcyk7XG4gICAgdGhpcy5vdmVycmlkZVN0YXJ0TG9naWMgPSB0aGlzLm92ZXJyaWRlU3RhcnRMb2dpYy5iaW5kKHRoaXMpO1xuICB9XG5cbiAgYXN5bmMgdHJpZ2dlckhvb2soaG9va05hbWU6IHN0cmluZywgaG9va0FyZ3M6IGFueVtdKSB7XG4gICAgZm9yIChjb25zdCBwbHVnaW4gb2YgdGhpcy5wbHVnaW5zKSB7XG4gICAgICBpZiAodHlwZW9mIHBsdWdpbi5nZXRIb29rID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgIGNvbnN0IGhvb2sgPSBwbHVnaW4uZ2V0SG9vayhob29rTmFtZSk7XG4gICAgICAgIGlmIChob29rKSBhd2FpdCBob29rKHRoaXMuY29uZmlnLCAuLi5ob29rQXJncyk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgdHJpZ2dlck11dGF0aW5nSG9vazxUPihob29rTmFtZTogc3RyaW5nLCBpdGVtOiBUKSB7XG4gICAgZm9yIChjb25zdCBwbHVnaW4gb2YgdGhpcy5wbHVnaW5zKSB7XG4gICAgICBpZiAodHlwZW9mIHBsdWdpbi5nZXRIb29rID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgIGNvbnN0IGhvb2sgPSBwbHVnaW4uZ2V0SG9vayhob29rTmFtZSk7XG4gICAgICAgIGlmIChob29rKSB7XG4gICAgICAgICAgaXRlbSA9IGF3YWl0IGhvb2sodGhpcy5jb25maWcsIGl0ZW0pO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBpdGVtO1xuICB9XG5cbiAgYXN5bmMgb3ZlcnJpZGVTdGFydExvZ2ljKG9wdHM6IFN0YXJ0T3B0aW9ucykge1xuICAgIGxldCBuZXdTdGFydEZuO1xuICAgIGNvbnN0IGNsYWltZWQgPSBbXTtcbiAgICBmb3IgKGNvbnN0IHBsdWdpbiBvZiB0aGlzLnBsdWdpbnMpIHtcbiAgICAgIGlmICh0eXBlb2YgcGx1Z2luLnN0YXJ0TG9naWMgPT09ICdmdW5jdGlvbicgJiYgcGx1Z2luLnN0YXJ0TG9naWMgIT09IFBsdWdpbkJhc2UucHJvdG90eXBlLnN0YXJ0TG9naWMpIHtcbiAgICAgICAgY2xhaW1lZC5wdXNoKHBsdWdpbi5uYW1lKTtcbiAgICAgICAgbmV3U3RhcnRGbiA9IHBsdWdpbi5zdGFydExvZ2ljO1xuICAgICAgfVxuICAgIH1cbiAgICBpZiAoY2xhaW1lZC5sZW5ndGggPiAxKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYE11bHRpcGxlIHBsdWdpbnMgdHJpZWQgdG8gdGFrZSBjb250cm9sIG9mIHRoZSBzdGFydCBjb21tYW5kLCBwbGVhc2UgcmVtb3ZlIG9uZSBvZiB0aGVtXFxuIC0tPiAke2NsYWltZWQuam9pbignLCAnKX1gKTtcbiAgICB9XG4gICAgaWYgKGNsYWltZWQubGVuZ3RoID09PSAxICYmIG5ld1N0YXJ0Rm4pIHtcbiAgICAgIGQoYHBsdWdpbjogXCIke2NsYWltZWRbMF19XCIgaGFzIHRha2VuIGNvbnRyb2wgb2YgdGhlIHN0YXJ0IGNvbW1hbmRgKTtcbiAgICAgIHJldHVybiBuZXdTdGFydEZuKG9wdHMpO1xuICAgIH1cbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cbn1cbiJdfQ==
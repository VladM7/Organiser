"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.getElectronModulePath = getElectronModulePath;
exports.getElectronVersion = getElectronVersion;
exports.updateElectronDependency = updateElectronDependency;
exports.PackageNotFoundError = void 0;

require("source-map-support/register");

var _debug = _interopRequireDefault(require("debug"));

var _findUp = _interopRequireDefault(require("find-up"));

var _fsExtra = _interopRequireDefault(require("fs-extra"));

var _path = _interopRequireDefault(require("path"));

var _semver = _interopRequireDefault(require("semver"));

var _yarnOrNpm = _interopRequireDefault(require("./yarn-or-npm"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const d = (0, _debug.default)('electron-forge:electron-version');
const electronPackageNames = ['electron-prebuilt-compile', 'electron-prebuilt', 'electron-nightly', 'electron'];

function findElectronDep(dep) {
  return electronPackageNames.includes(dep);
}

async function findAncestorNodeModulesPath(dir, packageName) {
  d('Looking for a lock file to indicate the root of the repo');
  const lockPath = await (0, _findUp.default)(['package-lock.json', 'yarn.lock', 'pnpm-lock.yaml'], {
    cwd: dir,
    type: 'file'
  });

  if (lockPath) {
    d(`Found lock file: ${lockPath}`);

    const nodeModulesPath = _path.default.join(_path.default.dirname(lockPath), 'node_modules', packageName);

    if (await _fsExtra.default.pathExists(nodeModulesPath)) {
      return nodeModulesPath;
    }
  }

  return Promise.resolve(undefined);
}

async function determineNodeModulesPath(dir, packageName) {
  const nodeModulesPath = _path.default.join(dir, 'node_modules', packageName);

  if (await _fsExtra.default.pathExists(nodeModulesPath)) {
    return nodeModulesPath;
  }

  return findAncestorNodeModulesPath(dir, packageName);
}

class PackageNotFoundError extends Error {
  constructor(packageName, dir) {
    super(`Cannot find the package "${packageName}". Perhaps you need to run "${(0, _yarnOrNpm.default)()} install" in "${dir}"?`);
  }

}

exports.PackageNotFoundError = PackageNotFoundError;

function getElectronModuleName(packageJSON) {
  if (!packageJSON.devDependencies) {
    throw new Error('package.json for app does not have any devDependencies');
  }

  const packageName = electronPackageNames.find(pkg => packageJSON.devDependencies[pkg]);

  if (packageName === undefined) {
    throw new Error('Could not find any Electron packages in devDependencies');
  }

  return packageName;
}

async function getElectronPackageJSONPath(dir, packageName) {
  const nodeModulesPath = await determineNodeModulesPath(dir, packageName);

  if (!nodeModulesPath) {
    throw new PackageNotFoundError(packageName, dir);
  }

  const electronPackageJSONPath = _path.default.join(nodeModulesPath, 'package.json');

  if (await _fsExtra.default.pathExists(electronPackageJSONPath)) {
    return electronPackageJSONPath;
  }

  return undefined;
}

async function getElectronModulePath(dir, packageJSON) {
  const moduleName = getElectronModuleName(packageJSON);
  const packageJSONPath = await getElectronPackageJSONPath(dir, moduleName);

  if (packageJSONPath) {
    return _path.default.dirname(packageJSONPath);
  }

  return undefined;
}

async function getElectronVersion(dir, packageJSON) {
  const packageName = getElectronModuleName(packageJSON);
  let version = packageJSON.devDependencies[packageName];

  if (!_semver.default.valid(version)) {
    // It's not an exact version, find it in the actual module
    const electronPackageJSONPath = await getElectronPackageJSONPath(dir, packageName);

    if (electronPackageJSONPath) {
      const electronPackageJSON = await _fsExtra.default.readJson(electronPackageJSONPath); // eslint-disable-next-line prefer-destructuring

      version = electronPackageJSON.version;
    } else {
      throw new PackageNotFoundError(packageName, dir);
    }
  }

  return version;
}

function updateElectronDependency(packageJSON, dev, exact) {
  const alteredDev = [].concat(dev);
  let alteredExact = [].concat(exact);

  if (Object.keys(packageJSON.devDependencies).find(findElectronDep)) {
    alteredExact = alteredExact.filter(dep => dep !== 'electron');
  } else {
    const electronKey = Object.keys(packageJSON.dependencies).find(findElectronDep);

    if (electronKey) {
      alteredExact = alteredExact.filter(dep => dep !== 'electron');
      d(`Moving ${electronKey} from dependencies to devDependencies`);
      alteredDev.push(`${electronKey}@${packageJSON.dependencies[electronKey]}`);
      delete packageJSON.dependencies[electronKey];
    }
  }

  return [alteredDev, alteredExact];
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy91dGlsL2VsZWN0cm9uLXZlcnNpb24udHMiXSwibmFtZXMiOlsiZCIsImVsZWN0cm9uUGFja2FnZU5hbWVzIiwiZmluZEVsZWN0cm9uRGVwIiwiZGVwIiwiaW5jbHVkZXMiLCJmaW5kQW5jZXN0b3JOb2RlTW9kdWxlc1BhdGgiLCJkaXIiLCJwYWNrYWdlTmFtZSIsImxvY2tQYXRoIiwiY3dkIiwidHlwZSIsIm5vZGVNb2R1bGVzUGF0aCIsInBhdGgiLCJqb2luIiwiZGlybmFtZSIsImZzIiwicGF0aEV4aXN0cyIsIlByb21pc2UiLCJyZXNvbHZlIiwidW5kZWZpbmVkIiwiZGV0ZXJtaW5lTm9kZU1vZHVsZXNQYXRoIiwiUGFja2FnZU5vdEZvdW5kRXJyb3IiLCJFcnJvciIsImNvbnN0cnVjdG9yIiwiZ2V0RWxlY3Ryb25Nb2R1bGVOYW1lIiwicGFja2FnZUpTT04iLCJkZXZEZXBlbmRlbmNpZXMiLCJmaW5kIiwicGtnIiwiZ2V0RWxlY3Ryb25QYWNrYWdlSlNPTlBhdGgiLCJlbGVjdHJvblBhY2thZ2VKU09OUGF0aCIsImdldEVsZWN0cm9uTW9kdWxlUGF0aCIsIm1vZHVsZU5hbWUiLCJwYWNrYWdlSlNPTlBhdGgiLCJnZXRFbGVjdHJvblZlcnNpb24iLCJ2ZXJzaW9uIiwic2VtdmVyIiwidmFsaWQiLCJlbGVjdHJvblBhY2thZ2VKU09OIiwicmVhZEpzb24iLCJ1cGRhdGVFbGVjdHJvbkRlcGVuZGVuY3kiLCJkZXYiLCJleGFjdCIsImFsdGVyZWREZXYiLCJjb25jYXQiLCJhbHRlcmVkRXhhY3QiLCJPYmplY3QiLCJrZXlzIiwiZmlsdGVyIiwiZWxlY3Ryb25LZXkiLCJkZXBlbmRlbmNpZXMiLCJwdXNoIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7OztBQUVBLE1BQU1BLENBQUMsR0FBRyxvQkFBTSxpQ0FBTixDQUFWO0FBRUEsTUFBTUMsb0JBQW9CLEdBQUcsQ0FDM0Is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OztBQUNBLE1BQUlJLE1BQU0sQ0FBQ0MsSUFBUCxDQUFZdEIsV0FBVyxDQUFDQyxlQUF4QixFQUF5Q0MsSUFBekMsQ0FBOEN6QixlQUE5QyxDQUFKLEVBQW9FO0FBQ2xFMkMsSUFBQUEsWUFBWSxHQUFHQSxZQUFZLENBQUNHLE1BQWIsQ0FBcUI3QyxHQUFELElBQVNBLEdBQUcsS0FBSyxVQUFyQyxDQUFmO0FBQ0QsR0FGRCxNQUVPO0FBQ0wsVUFBTThDLFdBQVcsR0FBR0gsTUFBTSxDQUFDQyxJQUFQLENBQVl0QixXQUFXLENBQUN5QixZQUF4QixFQUFzQ3ZCLElBQXRDLENBQTJDekIsZUFBM0MsQ0FBcEI7O0FBQ0EsUUFBSStDLFdBQUosRUFBaUI7QUFDZkosTUFBQUEsWUFBWSxHQUFHQSxZQUFZLENBQUNHLE1BQWIsQ0FBcUI3QyxHQUFELElBQVNBLEdBQUcsS0FBSyxVQUFyQyxDQUFmO0FBQ0FILE1BQUFBLENBQUMsQ0FBRSxVQUFTaUQsV0FBWSx1Q0FBdkIsQ0FBRDtBQUNBTixNQUFBQSxVQUFVLENBQUNRLElBQVgsQ0FBaUIsR0FBRUYsV0FBWSxJQUFHeEIsV0FBVyxDQUFDeUIsWUFBWixDQUF5QkQsV0FBekIsQ0FBc0MsRUFBeEU7QUFDQSxhQUFPeEIsV0FBVyxDQUFDeUIsWUFBWixDQUF5QkQsV0FBekIsQ0FBUDtBQUNEO0FBQ0Y7O0FBRUQsU0FBTyxDQUFDTixVQUFELEVBQWFFLFlBQWIsQ0FBUDtBQUNEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGRlYnVnIGZyb20gJ2RlYnVnJztcbmltcG9ydCBmaW5kVXAgZnJvbSAnZmluZC11cCc7XG5pbXBvcnQgZnMgZnJvbSAnZnMtZXh0cmEnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgc2VtdmVyIGZyb20gJ3NlbXZlcic7XG5pbXBvcnQgeWFybk9yTnBtIGZyb20gJy4veWFybi1vci1ucG0nO1xuXG5jb25zdCBkID0gZGVidWcoJ2VsZWN0cm9uLWZvcmdlOmVsZWN0cm9uLXZlcnNpb24nKTtcblxuY29uc3QgZWxlY3Ryb25QYWNrYWdlTmFtZXMgPSBbXG4gICdlbGVjdHJvbi1wcmVidWlsdC1jb21waWxlJyxcbiAgJ2VsZWN0cm9uLXByZWJ1aWx0JyxcbiAgJ2VsZWN0cm9uLW5pZ2h0bHknLFxuICAnZWxlY3Ryb24nLFxuXTtcblxuZnVuY3Rpb24gZmluZEVsZWN0cm9uRGVwKGRlcDogc3RyaW5nKTogYm9vbGVhbiB7XG4gIHJldHVybiBlbGVjdHJvblBhY2thZ2VOYW1lcy5pbmNsdWRlcyhkZXApO1xufVxuXG5hc3luYyBmdW5jdGlvbiBmaW5kQW5jZXN0b3JOb2RlTW9kdWxlc1BhdGgoXG4gIGRpcjogc3RyaW5nLFxuICBwYWNrYWdlTmFtZTogc3RyaW5nLFxuKTogUHJvbWlzZTxzdHJpbmcgfCB1bmRlZmluZWQ+IHtcbiAgZCgnTG9va2luZyBmb3IgYSBsb2NrIGZpbGUgdG8gaW5kaWNhdGUgdGhlIHJvb3Qgb2YgdGhlIHJlcG8nKTtcbiAgY29uc3QgbG9ja1BhdGggPSBhd2FpdCBmaW5kVXAoWydwYWNrYWdlLWxvY2suanNvbicsICd5YXJuLmxvY2snLCAncG5wbS1sb2NrLnlhbWwnXSwgeyBjd2Q6IGRpciwgdHlwZTogJ2ZpbGUnIH0pO1xuICBpZiAobG9ja1BhdGgpIHtcbiAgICBkKGBGb3VuZCBsb2NrIGZpbGU6ICR7bG9ja1BhdGh9YCk7XG4gICAgY29uc3Qgbm9kZU1vZHVsZXNQYXRoID0gcGF0aC5qb2luKHBhdGguZGlybmFtZShsb2NrUGF0aCksICdub2RlX21vZHVsZXMnLCBwYWNrYWdlTmFtZSk7XG4gICAgaWYgKGF3YWl0IGZzLnBhdGhFeGlzdHMobm9kZU1vZHVsZXNQYXRoKSkge1xuICAgICAgcmV0dXJuIG5vZGVNb2R1bGVzUGF0aDtcbiAgICB9XG4gIH1cblxuICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHVuZGVmaW5lZCk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGRldGVybWluZU5vZGVNb2R1bGVzUGF0aChcbiAgZGlyOiBzdHJpbmcsXG4gIHBhY2thZ2VOYW1lOiBzdHJpbmcsXG4pOiBQcm9taXNlPHN0cmluZyB8IHVuZGVmaW5lZD4ge1xuICBjb25zdCBub2RlTW9kdWxlc1BhdGg6IHN0cmluZyB8IHVuZGVmaW5lZCA9IHBhdGguam9pbihkaXIsICdub2RlX21vZHVsZXMnLCBwYWNrYWdlTmFtZSk7XG4gIGlmIChhd2FpdCBmcy5wYXRoRXhpc3RzKG5vZGVNb2R1bGVzUGF0aCkpIHtcbiAgICByZXR1cm4gbm9kZU1vZHVsZXNQYXRoO1xuICB9XG4gIHJldHVybiBmaW5kQW5jZXN0b3JOb2RlTW9kdWxlc1BhdGgoZGlyLCBwYWNrYWdlTmFtZSk7XG59XG5cbmV4cG9ydCBjbGFzcyBQYWNrYWdlTm90Rm91bmRFcnJvciBleHRlbmRzIEVycm9yIHtcbiAgY29uc3RydWN0b3IocGFja2FnZU5hbWU6IHN0cmluZywgZGlyOiBzdHJpbmcpIHtcbiAgICBzdXBlcihgQ2Fubm90IGZpbmQgdGhlIHBhY2thZ2UgXCIke3BhY2thZ2VOYW1lfVwiLiBQZXJoYXBzIHlvdSBuZWVkIHRvIHJ1biBcIiR7eWFybk9yTnBtKCl9IGluc3RhbGxcIiBpbiBcIiR7ZGlyfVwiP2ApO1xuICB9XG59XG5cbmZ1bmN0aW9uIGdldEVsZWN0cm9uTW9kdWxlTmFtZShwYWNrYWdlSlNPTjogYW55KTogc3RyaW5nIHtcbiAgaWYgKCFwYWNrYWdlSlNPTi5kZXZEZXBlbmRlbmNpZXMpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ3BhY2thZ2UuanNvbiBmb3IgYXBwIGRvZXMgbm90IGhhdmUgYW55IGRldkRlcGVuZGVuY2llcycpO1xuICB9XG5cbiAgY29uc3QgcGFja2FnZU5hbWUgPSBlbGVjdHJvblBhY2thZ2VOYW1lcy5maW5kKChwa2cpID0+IHBhY2thZ2VKU09OLmRldkRlcGVuZGVuY2llc1twa2ddKTtcbiAgaWYgKHBhY2thZ2VOYW1lID09PSB1bmRlZmluZWQpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ0NvdWxkIG5vdCBmaW5kIGFueSBFbGVjdHJvbiBwYWNrYWdlcyBpbiBkZXZEZXBlbmRlbmNpZXMnKTtcbiAgfVxuXG4gIHJldHVybiBwYWNrYWdlTmFtZTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZ2V0RWxlY3Ryb25QYWNrYWdlSlNPTlBhdGgoXG4gIGRpcjogc3RyaW5nLFxuICBwYWNrYWdlTmFtZTogc3RyaW5nLFxuKTogUHJvbWlzZTxzdHJpbmcgfCB1bmRlZmluZWQ+IHtcbiAgY29uc3Qgbm9kZU1vZHVsZXNQYXRoID0gYXdhaXQgZGV0ZXJtaW5lTm9kZU1vZHVsZXNQYXRoKGRpciwgcGFja2FnZU5hbWUpO1xuICBpZiAoIW5vZGVNb2R1bGVzUGF0aCkge1xuICAgIHRocm93IG5ldyBQYWNrYWdlTm90Rm91bmRFcnJvcihwYWNrYWdlTmFtZSwgZGlyKTtcbiAgfVxuXG4gIGNvbnN0IGVsZWN0cm9uUGFja2FnZUpTT05QYXRoID0gcGF0aC5qb2luKG5vZGVNb2R1bGVzUGF0aCwgJ3BhY2thZ2UuanNvbicpO1xuICBpZiAoYXdhaXQgZnMucGF0aEV4aXN0cyhlbGVjdHJvblBhY2thZ2VKU09OUGF0aCkpIHtcbiAgICByZXR1cm4gZWxlY3Ryb25QYWNrYWdlSlNPTlBhdGg7XG4gIH1cblxuICByZXR1cm4gdW5kZWZpbmVkO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2V0RWxlY3Ryb25Nb2R1bGVQYXRoKFxuICBkaXI6IHN0cmluZyxcbiAgcGFja2FnZUpTT046IGFueSxcbik6IFByb21pc2U8c3RyaW5nIHwgdW5kZWZpbmVkPiB7XG4gIGNvbnN0IG1vZHVsZU5hbWUgPSBnZXRFbGVjdHJvbk1vZHVsZU5hbWUocGFja2FnZUpTT04pO1xuICBjb25zdCBwYWNrYWdlSlNPTlBhdGggPSBhd2FpdCBnZXRFbGVjdHJvblBhY2thZ2VKU09OUGF0aChkaXIsIG1vZHVsZU5hbWUpO1xuICBpZiAocGFja2FnZUpTT05QYXRoKSB7XG4gICAgcmV0dXJuIHBhdGguZGlybmFtZShwYWNrYWdlSlNPTlBhdGgpO1xuICB9XG5cbiAgcmV0dXJuIHVuZGVmaW5lZDtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldEVsZWN0cm9uVmVyc2lvbihkaXI6IHN0cmluZywgcGFja2FnZUpTT046IGFueSk6IFByb21pc2U8c3RyaW5nPiB7XG4gIGNvbnN0IHBhY2thZ2VOYW1lID0gZ2V0RWxlY3Ryb25Nb2R1bGVOYW1lKHBhY2thZ2VKU09OKTtcblxuICBsZXQgdmVyc2lvbiA9IHBhY2thZ2VKU09OLmRldkRlcGVuZGVuY2llc1twYWNrYWdlTmFtZV07XG4gIGlmICghc2VtdmVyLnZhbGlkKHZlcnNpb24pKSB7IC8vIEl0J3Mgbm90IGFuIGV4YWN0IHZlcnNpb24sIGZpbmQgaXQgaW4gdGhlIGFjdHVhbCBtb2R1bGVcbiAgICBjb25zdCBlbGVjdHJvblBhY2thZ2VKU09OUGF0aCA9IGF3YWl0IGdldEVsZWN0cm9uUGFja2FnZUpTT05QYXRoKGRpciwgcGFja2FnZU5hbWUpO1xuICAgIGlmIChlbGVjdHJvblBhY2thZ2VKU09OUGF0aCkge1xuICAgICAgY29uc3QgZWxlY3Ryb25QYWNrYWdlSlNPTiA9IGF3YWl0IGZzLnJlYWRKc29uKGVsZWN0cm9uUGFja2FnZUpTT05QYXRoKTtcbiAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBwcmVmZXItZGVzdHJ1Y3R1cmluZ1xuICAgICAgdmVyc2lvbiA9IGVsZWN0cm9uUGFja2FnZUpTT04udmVyc2lvbjtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhyb3cgbmV3IFBhY2thZ2VOb3RGb3VuZEVycm9yKHBhY2thZ2VOYW1lLCBkaXIpO1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiB2ZXJzaW9uO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gdXBkYXRlRWxlY3Ryb25EZXBlbmRlbmN5KFxuICBwYWNrYWdlSlNPTjogYW55LFxuICBkZXY6IHN0cmluZ1tdLFxuICBleGFjdDogc3RyaW5nW10sXG4pOiBbc3RyaW5nW10sIHN0cmluZ1tdXSB7XG4gIGNvbnN0IGFsdGVyZWREZXYgPSAoW10gYXMgc3RyaW5nW10pLmNvbmNhdChkZXYpO1xuICBsZXQgYWx0ZXJlZEV4YWN0ID0gKFtdIGFzIHN0cmluZ1tdKS5jb25jYXQoZXhhY3QpO1xuICBpZiAoT2JqZWN0LmtleXMocGFja2FnZUpTT04uZGV2RGVwZW5kZW5jaWVzKS5maW5kKGZpbmRFbGVjdHJvbkRlcCkpIHtcbiAgICBhbHRlcmVkRXhhY3QgPSBhbHRlcmVkRXhhY3QuZmlsdGVyKChkZXApID0+IGRlcCAhPT0gJ2VsZWN0cm9uJyk7XG4gIH0gZWxzZSB7XG4gICAgY29uc3QgZWxlY3Ryb25LZXkgPSBPYmplY3Qua2V5cyhwYWNrYWdlSlNPTi5kZXBlbmRlbmNpZXMpLmZpbmQoZmluZEVsZWN0cm9uRGVwKTtcbiAgICBpZiAoZWxlY3Ryb25LZXkpIHtcbiAgICAgIGFsdGVyZWRFeGFjdCA9IGFsdGVyZWRFeGFjdC5maWx0ZXIoKGRlcCkgPT4gZGVwICE9PSAnZWxlY3Ryb24nKTtcbiAgICAgIGQoYE1vdmluZyAke2VsZWN0cm9uS2V5fSBmcm9tIGRlcGVuZGVuY2llcyB0byBkZXZEZXBlbmRlbmNpZXNgKTtcbiAgICAgIGFsdGVyZWREZXYucHVzaChgJHtlbGVjdHJvbktleX1AJHtwYWNrYWdlSlNPTi5kZXBlbmRlbmNpZXNbZWxlY3Ryb25LZXldfWApO1xuICAgICAgZGVsZXRlIHBhY2thZ2VKU09OLmRlcGVuZGVuY2llc1tlbGVjdHJvbktleV07XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIFthbHRlcmVkRGV2LCBhbHRlcmVkRXhhY3RdO1xufVxuIl19
"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.PackageNotFoundError = void 0;
exports.getElectronModulePath = getElectronModulePath;
exports.getElectronVersion = getElectronVersion;
exports.updateElectronDependency = updateElectronDependency;

require("source-map-support/register");

var _debug = _interopRequireDefault(require("debug"));

var _findUp = _interopRequireDefault(require("find-up"));

var _fsExtra = _interopRequireDefault(require("fs-extra"));

var _path = _interopRequireDefault(require("path"));

var _semver = _interopRequireDefault(require("semver"));

var _yarnOrNpm = _interopRequireDefault(require("./yarn-or-npm"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const d = (0, _debug.default)('electron-forge:electron-version');
const electronPackageNames = ['electron-prebuilt-compile', 'electron-prebuilt', 'electron-nightly', 'electron'];

function findElectronDep(dep) {
  return electronPackageNames.includes(dep);
}

async function findAncestorNodeModulesPath(dir, packageName) {
  d('Looking for a lock file to indicate the root of the repo');
  const lockPath = await (0, _findUp.default)(['package-lock.json', 'yarn.lock', 'pnpm-lock.yaml'], {
    cwd: dir,
    type: 'file'
  });

  if (lockPath) {
    d(`Found lock file: ${lockPath}`);

    const nodeModulesPath = _path.default.join(_path.default.dirname(lockPath), 'node_modules', packageName);

    if (await _fsExtra.default.pathExists(nodeModulesPath)) {
      return nodeModulesPath;
    }
  }

  return Promise.resolve(undefined);
}

async function determineNodeModulesPath(dir, packageName) {
  const nodeModulesPath = _path.default.join(dir, 'node_modules', packageName);

  if (await _fsExtra.default.pathExists(nodeModulesPath)) {
    return nodeModulesPath;
  }

  return findAncestorNodeModulesPath(dir, packageName);
}

class PackageNotFoundError extends Error {
  constructor(packageName, dir) {
    super(`Cannot find the package "${packageName}". Perhaps you need to run "${(0, _yarnOrNpm.default)()} install" in "${dir}"?`);
  }

}

exports.PackageNotFoundError = PackageNotFoundError;

function getElectronModuleName(packageJSON) {
  if (!packageJSON.devDependencies) {
    throw new Error('package.json for app does not have any devDependencies');
  } // Why: checked above
  // eslint-disable-next-line @typescript-eslint/no-non-null-assertion


  const packageName = electronPackageNames.find(pkg => packageJSON.devDependencies[pkg]);

  if (packageName === undefined) {
    throw new Error('Could not find any Electron packages in devDependencies');
  }

  return packageName;
}

async function getElectronPackageJSONPath(dir, packageName) {
  const nodeModulesPath = await determineNodeModulesPath(dir, packageName);

  if (!nodeModulesPath) {
    throw new PackageNotFoundError(packageName, dir);
  }

  const electronPackageJSONPath = _path.default.join(nodeModulesPath, 'package.json');

  if (await _fsExtra.default.pathExists(electronPackageJSONPath)) {
    return electronPackageJSONPath;
  }

  return undefined;
}

async function getElectronModulePath(dir, packageJSON) {
  const moduleName = getElectronModuleName(packageJSON);
  const packageJSONPath = await getElectronPackageJSONPath(dir, moduleName);

  if (packageJSONPath) {
    return _path.default.dirname(packageJSONPath);
  }

  return undefined;
}

async function getElectronVersion(dir, packageJSON) {
  const packageName = getElectronModuleName(packageJSON); // Why: checked in getElectronModuleName
  // eslint-disable-next-line @typescript-eslint/no-non-null-assertion

  let version = packageJSON.devDependencies[packageName];

  if (!_semver.default.valid(version)) {
    // It's not an exact version, find it in the actual module
    const electronPackageJSONPath = await getElectronPackageJSONPath(dir, packageName);

    if (electronPackageJSONPath) {
      const electronPackageJSON = await _fsExtra.default.readJson(electronPackageJSONPath); // eslint-disable-next-line prefer-destructuring

      version = electronPackageJSON.version;
    } else {
      throw new PackageNotFoundError(packageName, dir);
    }
  }

  return version;
}

function updateElectronDependency(packageJSON, dev, exact) {
  const alteredDev = [].concat(dev);
  let alteredExact = [].concat(exact); // Why: checked in getElectronModuleName
  // eslint-disable-next-line @typescript-eslint/no-non-null-assertion

  if (Object.keys(packageJSON.devDependencies).find(findElectronDep)) {
    alteredExact = alteredExact.filter(dep => dep !== 'electron');
  } else if (packageJSON.dependencies) {
    const electronKey = Object.keys(packageJSON.dependencies).find(findElectronDep);

    if (electronKey) {
      alteredExact = alteredExact.filter(dep => dep !== 'electron');
      d(`Moving ${electronKey} from dependencies to devDependencies`);
      alteredDev.push(`${electronKey}@${packageJSON.dependencies[electronKey]}`);
      delete packageJSON.dependencies[electronKey];
    }
  }

  return [alteredDev, alteredExact];
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy91dGlsL2VsZWN0cm9uLXZlcnNpb24udHMiXSwibmFtZXMiOlsiZCIsImVsZWN0cm9uUGFja2FnZU5hbWVzIiwiZmluZEVsZWN0cm9uRGVwIiwiZGVwIiwiaW5jbHVkZXMiLCJmaW5kQW5jZXN0b3JOb2RlTW9kdWxlc1BhdGgiLCJkaXIiLCJwYWNrYWdlTmFtZSIsImxvY2tQYXRoIiwiY3dkIiwidHlwZSIsIm5vZGVNb2R1bGVzUGF0aCIsInBhdGgiLCJqb2luIiwiZGlybmFtZSIsImZzIiwicGF0aEV4aXN0cyIsIlByb21pc2UiLCJyZXNvbHZlIiwidW5kZWZpbmVkIiwiZGV0ZXJtaW5lTm9kZU1vZHVsZXNQYXRoIiwiUGFja2FnZU5vdEZvdW5kRXJyb3IiLCJFcnJvciIsImNvbnN0cnVjdG9yIiwiZ2V0RWxlY3Ryb25Nb2R1bGVOYW1lIiwicGFja2FnZUpTT04iLCJkZXZEZXBlbmRlbmNpZXMiLCJmaW5kIiwicGtnIiwiZ2V0RWxlY3Ryb25QYWNrYWdlSlNPTlBhdGgiLCJlbGVjdHJvblBhY2thZ2VKU09OUGF0aCIsImdldEVsZWN0cm9uTW9kdWxlUGF0aCIsIm1vZHVsZU5hbWUiLCJwYWNrYWdlSlNPTlBhdGgiLCJnZXRFbGVjdHJvblZlcnNpb24iLCJ2ZXJzaW9uIiwic2VtdmVyIiwidmFsaWQiLCJlbGVjdHJvblBhY2thZ2VKU09OIiwicmVhZEpzb24iLCJ1cGRhdGVFbGVjdHJvbkRlcGVuZGVuY3kiLCJkZXYiLCJleGFjdCIsImFsdGVyZWREZXYiLCJjb25jYXQiLCJhbHRlcmVkRXhhY3QiLCJPYmplY3QiLCJrZXlzIiwiZmlsdGVyIiwiZGVwZW5kZW5jaWVzIiwiZWxlY3Ryb25LZXkiLCJwdXNoIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7OztBQUVBLE1BQU1BLENBQUMsR0FBRyxvQkFBTSxpQ0FBTixDQUFWO0FBRUEsTUFBTUMsb0JBQW9CLEdBQUcsQ0FBQywy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QUNBLE1BQUlJLFlBQVksR0FBSSxFQUFELENBQWlCRCxNQUFqQixDQUF3QkYsS0FBeEIsQ0FBbkIsQ0FGK0gsQ0FHL0g7QUFDQTs7QUFDQSxNQUFJSSxNQUFNLENBQUNDLElBQVAsQ0FBWXRCLFdBQVcsQ0FBQ0MsZUFBeEIsRUFBMENDLElBQTFDLENBQStDekIsZUFBL0MsQ0FBSixFQUFxRTtBQUNuRTJDLElBQUFBLFlBQVksR0FBR0EsWUFBWSxDQUFDRyxNQUFiLENBQXFCN0MsR0FBRCxJQUFTQSxHQUFHLEtBQUssVUFBckMsQ0FBZjtBQUNELEdBRkQsTUFFTyxJQUFJc0IsV0FBVyxDQUFDd0IsWUFBaEIsRUFBOEI7QUFDbkMsVUFBTUMsV0FBVyxHQUFHSixNQUFNLENBQUNDLElBQVAsQ0FBWXRCLFdBQVcsQ0FBQ3dCLFlBQXhCLEVBQXNDdEIsSUFBdEMsQ0FBMkN6QixlQUEzQyxDQUFwQjs7QUFDQSxRQUFJZ0QsV0FBSixFQUFpQjtBQUNmTCxNQUFBQSxZQUFZLEdBQUdBLFlBQVksQ0FBQ0csTUFBYixDQUFxQjdDLEdBQUQsSUFBU0EsR0FBRyxLQUFLLFVBQXJDLENBQWY7QUFDQUgsTUFBQUEsQ0FBQyxDQUFFLFVBQVNrRCxXQUFZLHVDQUF2QixDQUFEO0FBQ0FQLE1BQUFBLFVBQVUsQ0FBQ1EsSUFBWCxDQUFpQixHQUFFRCxXQUFZLElBQUd6QixXQUFXLENBQUN3QixZQUFaLENBQXlCQyxXQUF6QixDQUFzQyxFQUF4RTtBQUNBLGFBQU96QixXQUFXLENBQUN3QixZQUFaLENBQXlCQyxXQUF6QixDQUFQO0FBQ0Q7QUFDRjs7QUFFRCxTQUFPLENBQUNQLFVBQUQsRUFBYUUsWUFBYixDQUFQO0FBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgZGVidWcgZnJvbSAnZGVidWcnO1xuaW1wb3J0IGZpbmRVcCBmcm9tICdmaW5kLXVwJztcbmltcG9ydCBmcyBmcm9tICdmcy1leHRyYSc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCBzZW12ZXIgZnJvbSAnc2VtdmVyJztcbmltcG9ydCB5YXJuT3JOcG0gZnJvbSAnLi95YXJuLW9yLW5wbSc7XG5cbmNvbnN0IGQgPSBkZWJ1ZygnZWxlY3Ryb24tZm9yZ2U6ZWxlY3Ryb24tdmVyc2lvbicpO1xuXG5jb25zdCBlbGVjdHJvblBhY2thZ2VOYW1lcyA9IFsnZWxlY3Ryb24tcHJlYnVpbHQtY29tcGlsZScsICdlbGVjdHJvbi1wcmVidWlsdCcsICdlbGVjdHJvbi1uaWdodGx5JywgJ2VsZWN0cm9uJ107XG5cbnR5cGUgUGFja2FnZUpTT05XaXRoRGVwcyA9IHtcbiAgZGV2RGVwZW5kZW5jaWVzPzogUmVjb3JkPHN0cmluZywgc3RyaW5nPjtcbiAgZGVwZW5kZW5jaWVzPzogUmVjb3JkPHN0cmluZywgc3RyaW5nPjtcbn07XG5cbmZ1bmN0aW9uIGZpbmRFbGVjdHJvbkRlcChkZXA6IHN0cmluZyk6IGJvb2xlYW4ge1xuICByZXR1cm4gZWxlY3Ryb25QYWNrYWdlTmFtZXMuaW5jbHVkZXMoZGVwKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZmluZEFuY2VzdG9yTm9kZU1vZHVsZXNQYXRoKGRpcjogc3RyaW5nLCBwYWNrYWdlTmFtZTogc3RyaW5nKTogUHJvbWlzZTxzdHJpbmcgfCB1bmRlZmluZWQ+IHtcbiAgZCgnTG9va2luZyBmb3IgYSBsb2NrIGZpbGUgdG8gaW5kaWNhdGUgdGhlIHJvb3Qgb2YgdGhlIHJlcG8nKTtcbiAgY29uc3QgbG9ja1BhdGggPSBhd2FpdCBmaW5kVXAoWydwYWNrYWdlLWxvY2suanNvbicsICd5YXJuLmxvY2snLCAncG5wbS1sb2NrLnlhbWwnXSwgeyBjd2Q6IGRpciwgdHlwZTogJ2ZpbGUnIH0pO1xuICBpZiAobG9ja1BhdGgpIHtcbiAgICBkKGBGb3VuZCBsb2NrIGZpbGU6ICR7bG9ja1BhdGh9YCk7XG4gICAgY29uc3Qgbm9kZU1vZHVsZXNQYXRoID0gcGF0aC5qb2luKHBhdGguZGlybmFtZShsb2NrUGF0aCksICdub2RlX21vZHVsZXMnLCBwYWNrYWdlTmFtZSk7XG4gICAgaWYgKGF3YWl0IGZzLnBhdGhFeGlzdHMobm9kZU1vZHVsZXNQYXRoKSkge1xuICAgICAgcmV0dXJuIG5vZGVNb2R1bGVzUGF0aDtcbiAgICB9XG4gIH1cblxuICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHVuZGVmaW5lZCk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGRldGVybWluZU5vZGVNb2R1bGVzUGF0aChkaXI6IHN0cmluZywgcGFja2FnZU5hbWU6IHN0cmluZyk6IFByb21pc2U8c3RyaW5nIHwgdW5kZWZpbmVkPiB7XG4gIGNvbnN0IG5vZGVNb2R1bGVzUGF0aDogc3RyaW5nIHwgdW5kZWZpbmVkID0gcGF0aC5qb2luKGRpciwgJ25vZGVfbW9kdWxlcycsIHBhY2thZ2VOYW1lKTtcbiAgaWYgKGF3YWl0IGZzLnBhdGhFeGlzdHMobm9kZU1vZHVsZXNQYXRoKSkge1xuICAgIHJldHVybiBub2RlTW9kdWxlc1BhdGg7XG4gIH1cbiAgcmV0dXJuIGZpbmRBbmNlc3Rvck5vZGVNb2R1bGVzUGF0aChkaXIsIHBhY2thZ2VOYW1lKTtcbn1cblxuZXhwb3J0IGNsYXNzIFBhY2thZ2VOb3RGb3VuZEVycm9yIGV4dGVuZHMgRXJyb3Ige1xuICBjb25zdHJ1Y3RvcihwYWNrYWdlTmFtZTogc3RyaW5nLCBkaXI6IHN0cmluZykge1xuICAgIHN1cGVyKGBDYW5ub3QgZmluZCB0aGUgcGFja2FnZSBcIiR7cGFja2FnZU5hbWV9XCIuIFBlcmhhcHMgeW91IG5lZWQgdG8gcnVuIFwiJHt5YXJuT3JOcG0oKX0gaW5zdGFsbFwiIGluIFwiJHtkaXJ9XCI/YCk7XG4gIH1cbn1cblxuZnVuY3Rpb24gZ2V0RWxlY3Ryb25Nb2R1bGVOYW1lKHBhY2thZ2VKU09OOiBQYWNrYWdlSlNPTldpdGhEZXBzKTogc3RyaW5nIHtcbiAgaWYgKCFwYWNrYWdlSlNPTi5kZXZEZXBlbmRlbmNpZXMpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ3BhY2thZ2UuanNvbiBmb3IgYXBwIGRvZXMgbm90IGhhdmUgYW55IGRldkRlcGVuZGVuY2llcycpO1xuICB9XG5cbiAgLy8gV2h5OiBjaGVja2VkIGFib3ZlXG4gIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tbm9uLW51bGwtYXNzZXJ0aW9uXG4gIGNvbnN0IHBhY2thZ2VOYW1lID0gZWxlY3Ryb25QYWNrYWdlTmFtZXMuZmluZCgocGtnKSA9PiBwYWNrYWdlSlNPTi5kZXZEZXBlbmRlbmNpZXMhW3BrZ10pO1xuICBpZiAocGFja2FnZU5hbWUgPT09IHVuZGVmaW5lZCkge1xuICAgIHRocm93IG5ldyBFcnJvcignQ291bGQgbm90IGZpbmQgYW55IEVsZWN0cm9uIHBhY2thZ2VzIGluIGRldkRlcGVuZGVuY2llcycpO1xuICB9XG5cbiAgcmV0dXJuIHBhY2thZ2VOYW1lO1xufVxuXG5hc3luYyBmdW5jdGlvbiBnZXRFbGVjdHJvblBhY2thZ2VKU09OUGF0aChkaXI6IHN0cmluZywgcGFja2FnZU5hbWU6IHN0cmluZyk6IFByb21pc2U8c3RyaW5nIHwgdW5kZWZpbmVkPiB7XG4gIGNvbnN0IG5vZGVNb2R1bGVzUGF0aCA9IGF3YWl0IGRldGVybWluZU5vZGVNb2R1bGVzUGF0aChkaXIsIHBhY2thZ2VOYW1lKTtcbiAgaWYgKCFub2RlTW9kdWxlc1BhdGgpIHtcbiAgICB0aHJvdyBuZXcgUGFja2FnZU5vdEZvdW5kRXJyb3IocGFja2FnZU5hbWUsIGRpcik7XG4gIH1cblxuICBjb25zdCBlbGVjdHJvblBhY2thZ2VKU09OUGF0aCA9IHBhdGguam9pbihub2RlTW9kdWxlc1BhdGgsICdwYWNrYWdlLmpzb24nKTtcbiAgaWYgKGF3YWl0IGZzLnBhdGhFeGlzdHMoZWxlY3Ryb25QYWNrYWdlSlNPTlBhdGgpKSB7XG4gICAgcmV0dXJuIGVsZWN0cm9uUGFja2FnZUpTT05QYXRoO1xuICB9XG5cbiAgcmV0dXJuIHVuZGVmaW5lZDtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldEVsZWN0cm9uTW9kdWxlUGF0aChkaXI6IHN0cmluZywgcGFja2FnZUpTT046IFBhY2thZ2VKU09OV2l0aERlcHMpOiBQcm9taXNlPHN0cmluZyB8IHVuZGVmaW5lZD4ge1xuICBjb25zdCBtb2R1bGVOYW1lID0gZ2V0RWxlY3Ryb25Nb2R1bGVOYW1lKHBhY2thZ2VKU09OKTtcbiAgY29uc3QgcGFja2FnZUpTT05QYXRoID0gYXdhaXQgZ2V0RWxlY3Ryb25QYWNrYWdlSlNPTlBhdGgoZGlyLCBtb2R1bGVOYW1lKTtcbiAgaWYgKHBhY2thZ2VKU09OUGF0aCkge1xuICAgIHJldHVybiBwYXRoLmRpcm5hbWUocGFja2FnZUpTT05QYXRoKTtcbiAgfVxuXG4gIHJldHVybiB1bmRlZmluZWQ7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRFbGVjdHJvblZlcnNpb24oZGlyOiBzdHJpbmcsIHBhY2thZ2VKU09OOiBQYWNrYWdlSlNPTldpdGhEZXBzKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgY29uc3QgcGFja2FnZU5hbWUgPSBnZXRFbGVjdHJvbk1vZHVsZU5hbWUocGFja2FnZUpTT04pO1xuXG4gIC8vIFdoeTogY2hlY2tlZCBpbiBnZXRFbGVjdHJvbk1vZHVsZU5hbWVcbiAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1ub24tbnVsbC1hc3NlcnRpb25cbiAgbGV0IHZlcnNpb24gPSBwYWNrYWdlSlNPTi5kZXZEZXBlbmRlbmNpZXMhW3BhY2thZ2VOYW1lXTtcbiAgaWYgKCFzZW12ZXIudmFsaWQodmVyc2lvbikpIHtcbiAgICAvLyBJdCdzIG5vdCBhbiBleGFjdCB2ZXJzaW9uLCBmaW5kIGl0IGluIHRoZSBhY3R1YWwgbW9kdWxlXG4gICAgY29uc3QgZWxlY3Ryb25QYWNrYWdlSlNPTlBhdGggPSBhd2FpdCBnZXRFbGVjdHJvblBhY2thZ2VKU09OUGF0aChkaXIsIHBhY2thZ2VOYW1lKTtcbiAgICBpZiAoZWxlY3Ryb25QYWNrYWdlSlNPTlBhdGgpIHtcbiAgICAgIGNvbnN0IGVsZWN0cm9uUGFja2FnZUpTT04gPSBhd2FpdCBmcy5yZWFkSnNvbihlbGVjdHJvblBhY2thZ2VKU09OUGF0aCk7XG4gICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgcHJlZmVyLWRlc3RydWN0dXJpbmdcbiAgICAgIHZlcnNpb24gPSBlbGVjdHJvblBhY2thZ2VKU09OLnZlcnNpb247XG4gICAgfSBlbHNlIHtcbiAgICAgIHRocm93IG5ldyBQYWNrYWdlTm90Rm91bmRFcnJvcihwYWNrYWdlTmFtZSwgZGlyKTtcbiAgICB9XG4gIH1cblxuICByZXR1cm4gdmVyc2lvbjtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHVwZGF0ZUVsZWN0cm9uRGVwZW5kZW5jeShwYWNrYWdlSlNPTjogUGFja2FnZUpTT05XaXRoRGVwcywgZGV2OiBzdHJpbmdbXSwgZXhhY3Q6IHN0cmluZ1tdKTogW3N0cmluZ1tdLCBzdHJpbmdbXV0ge1xuICBjb25zdCBhbHRlcmVkRGV2ID0gKFtdIGFzIHN0cmluZ1tdKS5jb25jYXQoZGV2KTtcbiAgbGV0IGFsdGVyZWRFeGFjdCA9IChbXSBhcyBzdHJpbmdbXSkuY29uY2F0KGV4YWN0KTtcbiAgLy8gV2h5OiBjaGVja2VkIGluIGdldEVsZWN0cm9uTW9kdWxlTmFtZVxuICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLW5vbi1udWxsLWFzc2VydGlvblxuICBpZiAoT2JqZWN0LmtleXMocGFja2FnZUpTT04uZGV2RGVwZW5kZW5jaWVzISkuZmluZChmaW5kRWxlY3Ryb25EZXApKSB7XG4gICAgYWx0ZXJlZEV4YWN0ID0gYWx0ZXJlZEV4YWN0LmZpbHRlcigoZGVwKSA9PiBkZXAgIT09ICdlbGVjdHJvbicpO1xuICB9IGVsc2UgaWYgKHBhY2thZ2VKU09OLmRlcGVuZGVuY2llcykge1xuICAgIGNvbnN0IGVsZWN0cm9uS2V5ID0gT2JqZWN0LmtleXMocGFja2FnZUpTT04uZGVwZW5kZW5jaWVzKS5maW5kKGZpbmRFbGVjdHJvbkRlcCk7XG4gICAgaWYgKGVsZWN0cm9uS2V5KSB7XG4gICAgICBhbHRlcmVkRXhhY3QgPSBhbHRlcmVkRXhhY3QuZmlsdGVyKChkZXApID0+IGRlcCAhPT0gJ2VsZWN0cm9uJyk7XG4gICAgICBkKGBNb3ZpbmcgJHtlbGVjdHJvbktleX0gZnJvbSBkZXBlbmRlbmNpZXMgdG8gZGV2RGVwZW5kZW5jaWVzYCk7XG4gICAgICBhbHRlcmVkRGV2LnB1c2goYCR7ZWxlY3Ryb25LZXl9QCR7cGFja2FnZUpTT04uZGVwZW5kZW5jaWVzW2VsZWN0cm9uS2V5XX1gKTtcbiAgICAgIGRlbGV0ZSBwYWNrYWdlSlNPTi5kZXBlbmRlbmNpZXNbZWxlY3Ryb25LZXldO1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiBbYWx0ZXJlZERldiwgYWx0ZXJlZEV4YWN0XTtcbn1cbiJdfQ==
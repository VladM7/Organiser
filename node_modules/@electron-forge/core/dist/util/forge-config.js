"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;
exports.forgeConfigIsValidFilePath = forgeConfigIsValidFilePath;
exports.fromBuildIdentifier = fromBuildIdentifier;
exports.renderConfigTemplate = renderConfigTemplate;
exports.setInitialForgeConfig = setInitialForgeConfig;

require("source-map-support/register");

var _fsExtra = _interopRequireDefault(require("fs-extra"));

var _path = _interopRequireDefault(require("path"));

var _lodash = require("lodash");

var _readPackageJson = require("./read-package-json");

var _pluginInterface = _interopRequireDefault(require("./plugin-interface"));

var _hook = require("./hook");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const underscoreCase = str => str.replace(/(.)([A-Z][a-z]+)/g, '$1_$2').replace(/([a-z0-9])([A-Z])/g, '$1_$2').toUpperCase();

/* eslint-disable @typescript-eslint/no-explicit-any */
// eslint-disable-next-line arrow-parens
const proxify = (buildIdentifier, proxifiedObject, envPrefix) => {
  let newObject = {};

  if (Array.isArray(proxifiedObject)) {
    newObject = [];
  }

  for (const [key, val] of Object.entries(proxifiedObject)) {
    if (typeof val === 'object' && key !== 'pluginInterface' && !(val instanceof RegExp)) {
      newObject[key] = proxify(buildIdentifier, proxifiedObject[key], `${envPrefix}_${underscoreCase(key)}`);
    } else {
      newObject[key] = proxifiedObject[key];
    }
  }

  return new Proxy(newObject, {
    get(target, name, receiver) {
      // eslint-disable-next-line no-prototype-builtins
      if (!target.hasOwnProperty(name) && typeof name === 'string') {
        const envValue = process.env[`${envPrefix}_${underscoreCase(name)}`];
        if (envValue) return envValue;
      }

      const value = Reflect.get(target, name, receiver); // eslint-disable-next-line no-underscore-dangle

      if (value && typeof value === 'object' && value.__isMagicBuildIdentifierMap) {
        const identifier = typeof buildIdentifier === 'function' ? buildIdentifier() : buildIdentifier;
        return value.map[identifier];
      }

      return value;
    },

    getOwnPropertyDescriptor(target, name) {
      const envValue = process.env[`${envPrefix}_${underscoreCase(name)}`]; // eslint-disable-next-line no-prototype-builtins

      if (target.hasOwnProperty(name)) {
        return Reflect.getOwnPropertyDescriptor(target, name);
      }

      if (envValue) {
        return {
          writable: true,
          enumerable: true,
          configurable: true,
          value: envValue
        };
      }

      return undefined;
    }

  });
};
/* eslint-enable @typescript-eslint/no-explicit-any */

/**
 * Sets sensible defaults for the `config.forge` object.
 */


function setInitialForgeConfig(packageJSON) {
  // eslint-disable-line @typescript-eslint/no-explicit-any
  const {
    name = ''
  } = packageJSON;
  packageJSON.config.forge.makers[0].config.name = name.replace(/-/g, '_');
}

function fromBuildIdentifier(map) {
  return {
    map,
    __isMagicBuildIdentifierMap: true
  };
}

async function forgeConfigIsValidFilePath(dir, forgeConfig) {
  return typeof forgeConfig === 'string' && ((await _fsExtra.default.pathExists(_path.default.resolve(dir, forgeConfig))) || _fsExtra.default.pathExists(_path.default.resolve(dir, `${forgeConfig}.js`)));
} // eslint-disable-next-line @typescript-eslint/explicit-module-boundary-types, @typescript-eslint/no-explicit-any


function renderConfigTemplate(dir, templateObj, obj) {
  for (const [key, value] of Object.entries(obj)) {
    if (typeof value === 'object' && value !== null) {
      renderConfigTemplate(dir, templateObj, value);
    } else if (typeof value === 'string') {
      obj[key] = (0, _lodash.template)(value)(templateObj);

      if (obj[key].startsWith('require:')) {
        // eslint-disable-next-line global-require, import/no-dynamic-require
        obj[key] = require(_path.default.resolve(dir, obj[key].substr(8)));
      }
    }
  }
}

var _default = async dir => {
  const packageJSON = await (0, _readPackageJson.readRawPackageJson)(dir);
  let forgeConfig = packageJSON.config && packageJSON.config.forge ? packageJSON.config.forge : null;

  if (!forgeConfig) {
    if (await _fsExtra.default.pathExists(_path.default.resolve(dir, 'forge.config.js'))) {
      forgeConfig = 'forge.config.js';
    } else {
      forgeConfig = {};
    }
  }

  if (await forgeConfigIsValidFilePath(dir, forgeConfig)) {
    try {
      // eslint-disable-next-line @typescript-eslint/no-var-requires, global-require, import/no-dynamic-require
      forgeConfig = require(_path.default.resolve(dir, forgeConfig));
    } catch (err) {
      // eslint-disable-next-line no-console
      console.error(`Failed to load: ${_path.default.resolve(dir, forgeConfig)}`);
      throw err;
    }
  } else if (typeof forgeConfig !== 'object') {
    throw new Error('Expected packageJSON.config.forge to be an object or point to a requirable JS file');
  }

  const defaultForgeConfig = {
    electronRebuildConfig: {},
    packagerConfig: {},
    makers: [],
    publishers: [],
    plugins: []
  };
  forgeConfig = { ...defaultForgeConfig,
    ...forgeConfig
  };
  const templateObj = { ...packageJSON,
    year: new Date().getFullYear()
  };
  renderConfigTemplate(dir, templateObj, forgeConfig);
  forgeConfig.pluginInterface = new _pluginInterface.default(dir, forgeConfig);
  forgeConfig = await (0, _hook.runMutatingHook)(forgeConfig, 'resolveForgeConfig', forgeConfig);
  return proxify(forgeConfig.buildIdentifier || '', forgeConfig, 'ELECTRON_FORGE');
};

exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy91dGlsL2ZvcmdlLWNvbmZpZy50cyJdLCJuYW1lcyI6WyJ1bmRlcnNjb3JlQ2FzZSIsInN0ciIsInJlcGxhY2UiLCJ0b1VwcGVyQ2FzZSIsInByb3hpZnkiLCJidWlsZElkZW50aWZpZXIiLCJwcm94aWZpZWRPYmplY3QiLCJlbnZQcmVmaXgiLCJuZXdPYmplY3QiLCJBcnJheSIsImlzQXJyYXkiLCJrZXkiLCJ2YWwiLCJPYmplY3QiLCJlbnRyaWVzIiwiUmVnRXhwIiwiUHJveHkiLCJnZXQiLCJ0YXJnZXQiLCJuYW1lIiwicmVjZWl2ZXIiLCJoYXNPd25Qcm9wZXJ0eSIsImVudlZhbHVlIiwicHJvY2VzcyIsImVudiIsInZhbHVlIiwiUmVmbGVjdCIsIl9faXNNYWdpY0J1aWxkSWRlbnRpZmllck1hcCIsImlkZW50aWZpZXIiLCJtYXAiLCJnZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IiLCJ3cml0YWJsZSIsImVudW1lcmFibGUiLCJjb25maWd1cmFibGUiLCJ1bmRlZmluZWQiLCJzZXRJbml0aWFsRm9yZ2VDb25maWciLCJwYWNrYWdlSlNPTiIsImNvbmZpZyIsImZvcmdlIiwibWFrZXJzIiwiZnJvbUJ1aWxkSWRlbnRpZmllciIsImZvcmdlQ29uZmlnSXNWYWxpZEZpbGVQYXRoIiwiZGlyIiwiZm9yZ2VDb25maWciLCJmcyIsInBhdGhFeGlzdHMiLCJwYXRoIiwicmVzb2x2ZSIsInJlbmRlckNvbmZpZ1RlbXBsYXRlIiwidGVtcGxhdGVPYmoiLCJvYmoiLCJzdGFydHNXaXRoIiwicmVxdWlyZSIsInN1YnN0ciIsImVyciIsImNvbnNvbGUiLCJlcnJvciIsIkVycm9yIiwiZGVmYXVsdEZvcmdlQ29uZmlnIiwiZWxlY3Ryb25SZWJ1aWxkQ29uZmlnIiwicGFja2FnZXJDb25maWciLCJwdWJsaXNoZXJzIiwicGx1Z2lucyIsInllYXIiLCJEYXRlIiwiZ2V0RnVsbFllYXIiLCJwbHVnaW5JbnRlcmZhY2UiLCJQbHVnaW5JbnRlcmZhY2UiXSwi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V0FBbkQsQ0FBcEI7QUFFQSxTQUFPdkMsT0FBTyxDQUFjdUMsV0FBVyxDQUFDdEMsZUFBWixJQUErQixFQUE3QyxFQUFpRHNDLFdBQWpELEVBQThELGdCQUE5RCxDQUFkO0FBQ0QsQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEZvcmdlQ29uZmlnLCBJRm9yZ2VSZXNvbHZhYmxlTWFrZXIgfSBmcm9tICdAZWxlY3Ryb24tZm9yZ2Uvc2hhcmVkLXR5cGVzJztcbmltcG9ydCBmcyBmcm9tICdmcy1leHRyYSc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IHRlbXBsYXRlIH0gZnJvbSAnbG9kYXNoJztcblxuaW1wb3J0IHsgcmVhZFJhd1BhY2thZ2VKc29uIH0gZnJvbSAnLi9yZWFkLXBhY2thZ2UtanNvbic7XG5pbXBvcnQgUGx1Z2luSW50ZXJmYWNlIGZyb20gJy4vcGx1Z2luLWludGVyZmFjZSc7XG5pbXBvcnQgeyBydW5NdXRhdGluZ0hvb2sgfSBmcm9tICcuL2hvb2snO1xuXG5jb25zdCB1bmRlcnNjb3JlQ2FzZSA9IChzdHI6IHN0cmluZykgPT5cbiAgc3RyXG4gICAgLnJlcGxhY2UoLyguKShbQS1aXVthLXpdKykvZywgJyQxXyQyJylcbiAgICAucmVwbGFjZSgvKFthLXowLTldKShbQS1aXSkvZywgJyQxXyQyJylcbiAgICAudG9VcHBlckNhc2UoKTtcblxuZXhwb3J0IHR5cGUgUGFja2FnZUpTT05Gb3JJbml0aWFsRm9yZ2VDb25maWcgPSB7XG4gIG5hbWU/OiBzdHJpbmc7XG4gIGNvbmZpZzoge1xuICAgIGZvcmdlOiB7XG4gICAgICBtYWtlcnM6IFBpY2s8SUZvcmdlUmVzb2x2YWJsZU1ha2VyLCAnbmFtZScgfCAnY29uZmlnJz5bXTtcbiAgICB9O1xuICB9O1xufTtcblxuLy8gV2h5OiBuZWVkcyBhY2Nlc3MgdG8gT2JqZWN0IG1ldGhvZHMgYW5kIGFsc28gbmVlZHMgdG8gYmUgYWJsZSB0byBtYXRjaCBhbnkgaW50ZXJmYWNlLlxuLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9iYW4tdHlwZXNcbnR5cGUgUHJveGllZE9iamVjdCA9IG9iamVjdDtcblxuLyogZXNsaW50LWRpc2FibGUgQHR5cGVzY3JpcHQtZXNsaW50L25vLWV4cGxpY2l0LWFueSAqL1xuLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIGFycm93LXBhcmVuc1xuY29uc3QgcHJveGlmeSA9IDxUIGV4dGVuZHMgUHJveGllZE9iamVjdD4oYnVpbGRJZGVudGlmaWVyOiBzdHJpbmcgfCAoKCkgPT4gc3RyaW5nKSwgcHJveGlmaWVkT2JqZWN0OiBULCBlbnZQcmVmaXg6IHN0cmluZyk6IFQgPT4ge1xuICBsZXQgbmV3T2JqZWN0OiBUID0ge30gYXMgYW55O1xuICBpZiAoQXJyYXkuaXNBcnJheShwcm94aWZpZWRPYmplY3QpKSB7XG4gICAgbmV3T2JqZWN0ID0gW10gYXMgYW55O1xuICB9XG5cbiAgZm9yIChjb25zdCBba2V5LCB2YWxdIG9mIE9iamVjdC5lbnRyaWVzKHByb3hpZmllZE9iamVjdCkpIHtcbiAgICBpZiAodHlwZW9mIHZhbCA9PT0gJ29iamVjdCcgJiYga2V5ICE9PSAncGx1Z2luSW50ZXJmYWNlJyAmJiAhKHZhbCBpbnN0YW5jZW9mIFJlZ0V4cCkpIHtcbiAgICAgIChuZXdPYmplY3QgYXMgYW55KVtrZXldID0gcHJveGlmeShidWlsZElkZW50aWZpZXIsIChwcm94aWZpZWRPYmplY3QgYXMgYW55KVtrZXldLCBgJHtlbnZQcmVmaXh9XyR7dW5kZXJzY29yZUNhc2Uoa2V5KX1gKTtcbiAgICB9IGVsc2Uge1xuICAgICAgKG5ld09iamVjdCBhcyBhbnkpW2tleV0gPSAocHJveGlmaWVkT2JqZWN0IGFzIGFueSlba2V5XTtcbiAgICB9XG4gIH1cblxuICByZXR1cm4gbmV3IFByb3h5PFQ+KG5ld09iamVjdCwge1xuICAgIGdldCh0YXJnZXQsIG5hbWUsIHJlY2VpdmVyKSB7XG4gICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tcHJvdG90eXBlLWJ1aWx0aW5zXG4gICAgICBpZiAoIXRhcmdldC5oYXNPd25Qcm9wZXJ0eShuYW1lKSAmJiB0eXBlb2YgbmFtZSA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgY29uc3QgZW52VmFsdWUgPSBwcm9jZXNzLmVudltgJHtlbnZQcmVmaXh9XyR7dW5kZXJzY29yZUNhc2UobmFtZSl9YF07XG4gICAgICAgIGlmIChlbnZWYWx1ZSkgcmV0dXJuIGVudlZhbHVlO1xuICAgICAgfVxuICAgICAgY29uc3QgdmFsdWUgPSBSZWZsZWN0LmdldCh0YXJnZXQsIG5hbWUsIHJlY2VpdmVyKTtcblxuICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXVuZGVyc2NvcmUtZGFuZ2xlXG4gICAgICBpZiAodmFsdWUgJiYgdHlwZW9mIHZhbHVlID09PSAnb2JqZWN0JyAmJiB2YWx1ZS5fX2lzTWFnaWNCdWlsZElkZW50aWZpZXJNYXApIHtcbiAgICAgICAgY29uc3QgaWRlbnRpZmllciA9IHR5cGVvZiBidWlsZElkZW50aWZpZXIgPT09ICdmdW5jdGlvbicgPyBidWlsZElkZW50aWZpZXIoKSA6IGJ1aWxkSWRlbnRpZmllcjtcbiAgICAgICAgcmV0dXJuIHZhbHVlLm1hcFtpZGVudGlmaWVyXTtcbiAgICAgIH1cbiAgICAgIHJldHVybiB2YWx1ZTtcbiAgICB9LFxuICAgIGdldE93blByb3BlcnR5RGVzY3JpcHRvcih0YXJnZXQsIG5hbWUpIHtcbiAgICAgIGNvbnN0IGVudlZhbHVlID0gcHJvY2Vzcy5lbnZbYCR7ZW52UHJlZml4fV8ke3VuZGVyc2NvcmVDYXNlKG5hbWUgYXMgc3RyaW5nKX1gXTtcbiAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1wcm90b3R5cGUtYnVpbHRpbnNcbiAgICAgIGlmICh0YXJnZXQuaGFzT3duUHJvcGVydHkobmFtZSkpIHtcbiAgICAgICAgcmV0dXJuIFJlZmxlY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHRhcmdldCwgbmFtZSk7XG4gICAgICB9XG5cbiAgICAgIGlmIChlbnZWYWx1ZSkge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIHdyaXRhYmxlOiB0cnVlLFxuICAgICAgICAgIGVudW1lcmFibGU6IHRydWUsXG4gICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLFxuICAgICAgICAgIHZhbHVlOiBlbnZWYWx1ZSxcbiAgICAgICAgfTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9LFxuICB9KTtcbn07XG4vKiBlc2xpbnQtZW5hYmxlIEB0eXBlc2NyaXB0LWVzbGludC9uby1leHBsaWNpdC1hbnkgKi9cblxuLyoqXG4gKiBTZXRzIHNlbnNpYmxlIGRlZmF1bHRzIGZvciB0aGUgYGNvbmZpZy5mb3JnZWAgb2JqZWN0LlxuICovXG5leHBvcnQgZnVuY3Rpb24gc2V0SW5pdGlhbEZvcmdlQ29uZmlnKHBhY2thZ2VKU09OOiBQYWNrYWdlSlNPTkZvckluaXRpYWxGb3JnZUNvbmZpZyk6IHZvaWQge1xuICAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1leHBsaWNpdC1hbnlcbiAgY29uc3QgeyBuYW1lID0gJycgfSA9IHBhY2thZ2VKU09OO1xuXG4gICgocGFja2FnZUpTT04uY29uZmlnLmZvcmdlIGFzIEZvcmdlQ29uZmlnKS5tYWtlcnMgYXMgSUZvcmdlUmVzb2x2YWJsZU1ha2VyW10pWzBdLmNvbmZpZy5uYW1lID0gbmFtZS5yZXBsYWNlKC8tL2csICdfJyk7XG59XG5cbmV4cG9ydCB0eXBlIEJ1aWxkSWRlbnRpZmllck1hcDxUPiA9IFJlY29yZDxzdHJpbmcsIFQgfCB1bmRlZmluZWQ+O1xuZXhwb3J0IHR5cGUgQnVpbGRJZGVudGlmaWVyQ29uZmlnPFQ+ID0ge1xuICBtYXA6IEJ1aWxkSWRlbnRpZmllck1hcDxUPjtcbiAgX19pc01hZ2ljQnVpbGRJZGVudGlmaWVyTWFwOiB0cnVlO1xufTtcblxuZXhwb3J0IGZ1bmN0aW9uIGZyb21CdWlsZElkZW50aWZpZXI8VD4obWFwOiBCdWlsZElkZW50aWZpZXJNYXA8VD4pOiBCdWlsZElkZW50aWZpZXJDb25maWc8VD4ge1xuICByZXR1cm4ge1xuICAgIG1hcCxcbiAgICBfX2lzTWFnaWNCdWlsZElkZW50aWZpZXJNYXA6IHRydWUsXG4gIH07XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBmb3JnZUNvbmZpZ0lzVmFsaWRGaWxlUGF0aChkaXI6IHN0cmluZywgZm9yZ2VDb25maWc6IHN0cmluZyB8IEZvcmdlQ29uZmlnKTogUHJvbWlzZTxib29sZWFuPiB7XG4gIHJldHVybiB0eXBlb2YgZm9yZ2VDb25maWcgPT09ICdzdHJpbmcnICYmICgoYXdhaXQgZnMucGF0aEV4aXN0cyhwYXRoLnJlc29sdmUoZGlyLCBmb3JnZUNvbmZpZykpKSB8fCBmcy5wYXRoRXhpc3RzKHBhdGgucmVzb2x2ZShkaXIsIGAke2ZvcmdlQ29uZmlnfS5qc2ApKSk7XG59XG5cbi8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvZXhwbGljaXQtbW9kdWxlLWJvdW5kYXJ5LXR5cGVzLCBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tZXhwbGljaXQtYW55XG5leHBvcnQgZnVuY3Rpb24gcmVuZGVyQ29uZmlnVGVtcGxhdGUoZGlyOiBzdHJpbmcsIHRlbXBsYXRlT2JqOiBhbnksIG9iajogYW55KTogdm9pZCB7XG4gIGZvciAoY29uc3QgW2tleSwgdmFsdWVdIG9mIE9iamVjdC5lbnRyaWVzKG9iaikpIHtcbiAgICBpZiAodHlwZW9mIHZhbHVlID09PSAnb2JqZWN0JyAmJiB2YWx1ZSAhPT0gbnVsbCkge1xuICAgICAgcmVuZGVyQ29uZmlnVGVtcGxhdGUoZGlyLCB0ZW1wbGF0ZU9iaiwgdmFsdWUpO1xuICAgIH0gZWxzZSBpZiAodHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJykge1xuICAgICAgb2JqW2tleV0gPSB0ZW1wbGF0ZSh2YWx1ZSkodGVtcGxhdGVPYmopO1xuICAgICAgaWYgKG9ialtrZXldLnN0YXJ0c1dpdGgoJ3JlcXVpcmU6JykpIHtcbiAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIGdsb2JhbC1yZXF1aXJlLCBpbXBvcnQvbm8tZHluYW1pYy1yZXF1aXJlXG4gICAgICAgIG9ialtrZXldID0gcmVxdWlyZShwYXRoLnJlc29sdmUoZGlyLCBvYmpba2V5XS5zdWJzdHIoOCkpKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgYXN5bmMgKGRpcjogc3RyaW5nKTogUHJvbWlzZTxGb3JnZUNvbmZpZz4gPT4ge1xuICBjb25zdCBwYWNrYWdlSlNPTiA9IGF3YWl0IHJlYWRSYXdQYWNrYWdlSnNvbihkaXIpO1xuICBsZXQgZm9yZ2VDb25maWc6IEZvcmdlQ29uZmlnIHwgc3RyaW5nIHwgbnVsbCA9IHBhY2thZ2VKU09OLmNvbmZpZyAmJiBwYWNrYWdlSlNPTi5jb25maWcuZm9yZ2UgPyBwYWNrYWdlSlNPTi5jb25maWcuZm9yZ2UgOiBudWxsO1xuXG4gIGlmICghZm9yZ2VDb25maWcpIHtcbiAgICBpZiAoYXdhaXQgZnMucGF0aEV4aXN0cyhwYXRoLnJlc29sdmUoZGlyLCAnZm9yZ2UuY29uZmlnLmpzJykpKSB7XG4gICAgICBmb3JnZUNvbmZpZyA9ICdmb3JnZS5jb25maWcuanMnO1xuICAgIH0gZWxzZSB7XG4gICAgICBmb3JnZUNvbmZpZyA9IHt9IGFzIEZvcmdlQ29uZmlnO1xuICAgIH1cbiAgfVxuXG4gIGlmIChhd2FpdCBmb3JnZUNvbmZpZ0lzVmFsaWRGaWxlUGF0aChkaXIsIGZvcmdlQ29uZmlnKSkge1xuICAgIHRyeSB7XG4gICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLXZhci1yZXF1aXJlcywgZ2xvYmFsLXJlcXVpcmUsIGltcG9ydC9uby1keW5hbWljLXJlcXVpcmVcbiAgICAgIGZvcmdlQ29uZmlnID0gcmVxdWlyZShwYXRoLnJlc29sdmUoZGlyLCBmb3JnZUNvbmZpZyBhcyBzdHJpbmcpKSBhcyBGb3JnZUNvbmZpZztcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1jb25zb2xlXG4gICAgICBjb25zb2xlLmVycm9yKGBGYWlsZWQgdG8gbG9hZDogJHtwYXRoLnJlc29sdmUoZGlyLCBmb3JnZUNvbmZpZyBhcyBzdHJpbmcpfWApO1xuICAgICAgdGhyb3cgZXJyO1xuICAgIH1cbiAgfSBlbHNlIGlmICh0eXBlb2YgZm9yZ2VDb25maWcgIT09ICdvYmplY3QnKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdFeHBlY3RlZCBwYWNrYWdlSlNPTi5jb25maWcuZm9yZ2UgdG8gYmUgYW4gb2JqZWN0IG9yIHBvaW50IHRvIGEgcmVxdWlyYWJsZSBKUyBmaWxlJyk7XG4gIH1cbiAgY29uc3QgZGVmYXVsdEZvcmdlQ29uZmlnID0ge1xuICAgIGVsZWN0cm9uUmVidWlsZENvbmZpZzoge30sXG4gICAgcGFja2FnZXJDb25maWc6IHt9LFxuICAgIG1ha2VyczogW10sXG4gICAgcHVibGlzaGVyczogW10sXG4gICAgcGx1Z2luczogW10sXG4gIH07XG4gIGZvcmdlQ29uZmlnID0ge1xuICAgIC4uLmRlZmF1bHRGb3JnZUNvbmZpZyxcbiAgICAuLi5mb3JnZUNvbmZpZyxcbiAgfTtcblxuICBjb25zdCB0ZW1wbGF0ZU9iaiA9IHsgLi4ucGFja2FnZUpTT04sIHllYXI6IG5ldyBEYXRlKCkuZ2V0RnVsbFllYXIoKSB9O1xuICByZW5kZXJDb25maWdUZW1wbGF0ZShkaXIsIHRlbXBsYXRlT2JqLCBmb3JnZUNvbmZpZyk7XG5cbiAgZm9yZ2VDb25maWcucGx1Z2luSW50ZXJmYWNlID0gbmV3IFBsdWdpbkludGVyZmFjZShkaXIsIGZvcmdlQ29uZmlnKTtcblxuICBmb3JnZUNvbmZpZyA9IGF3YWl0IHJ1bk11dGF0aW5nSG9vayhmb3JnZUNvbmZpZywgJ3Jlc29sdmVGb3JnZUNvbmZpZycsIGZvcmdlQ29uZmlnKTtcblxuICByZXR1cm4gcHJveGlmeTxGb3JnZUNvbmZpZz4oZm9yZ2VDb25maWcuYnVpbGRJZGVudGlmaWVyIHx8ICcnLCBmb3JnZUNvbmZpZywgJ0VMRUNUUk9OX0ZPUkdFJyk7XG59O1xuIl19
"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.setInitialForgeConfig = setInitialForgeConfig;
exports.fromBuildIdentifier = fromBuildIdentifier;
exports.forgeConfigIsValidFilePath = forgeConfigIsValidFilePath;
exports.renderConfigTemplate = renderConfigTemplate;
exports.default = void 0;

require("source-map-support/register");

var _fsExtra = _interopRequireDefault(require("fs-extra"));

var _path = _interopRequireDefault(require("path"));

var _lodash = require("lodash");

var _readPackageJson = require("./read-package-json");

var _pluginInterface = _interopRequireDefault(require("./plugin-interface"));

var _hook = require("./hook");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const underscoreCase = str => str.replace(/(.)([A-Z][a-z]+)/g, '$1_$2').replace(/([a-z0-9])([A-Z])/g, '$1_$2').toUpperCase(); // eslint-disable-next-line arrow-parens


const proxify = (buildIdentifier, object, envPrefix) => {
  let newObject = {};

  if (Array.isArray(object)) {
    newObject = [];
  }

  for (const [key, val] of Object.entries(object)) {
    if (typeof val === 'object' && key !== 'pluginInterface' && !(val instanceof RegExp)) {
      newObject[key] = proxify(buildIdentifier, object[key], `${envPrefix}_${underscoreCase(key)}`);
    } else {
      newObject[key] = object[key];
    }
  }

  return new Proxy(newObject, {
    get(target, name, receiver) {
      // eslint-disable-next-line no-prototype-builtins
      if (!target.hasOwnProperty(name) && typeof name === 'string') {
        const envValue = process.env[`${envPrefix}_${underscoreCase(name)}`];
        if (envValue) return envValue;
      }

      const value = Reflect.get(target, name, receiver); // eslint-disable-next-line no-underscore-dangle

      if (value && typeof value === 'object' && value.__isMagicBuildIdentifierMap) {
        const identifier = typeof buildIdentifier === 'function' ? buildIdentifier() : buildIdentifier;
        return value.map[identifier];
      }

      return value;
    },

    getOwnPropertyDescriptor(target, name) {
      const envValue = process.env[`${envPrefix}_${underscoreCase(name)}`]; // eslint-disable-next-line no-prototype-builtins

      if (target.hasOwnProperty(name)) {
        return Reflect.getOwnPropertyDescriptor(target, name);
      }

      if (envValue) {
        return {
          writable: true,
          enumerable: true,
          configurable: true,
          value: envValue
        };
      }

      return undefined;
    }

  });
};
/**
 * Sets sensible defaults for the `config.forge` object.
 */


function setInitialForgeConfig(packageJSON) {
  const {
    name = ''
  } = packageJSON;
  packageJSON.config.forge.makers[0].config.name = name.replace(/-/g, '_');
}

function fromBuildIdentifier(map) {
  return {
    map,
    __isMagicBuildIdentifierMap: true
  };
}

async function forgeConfigIsValidFilePath(dir, forgeConfig) {
  return typeof forgeConfig === 'string' && ((await _fsExtra.default.pathExists(_path.default.resolve(dir, forgeConfig))) || _fsExtra.default.pathExists(_path.default.resolve(dir, `${forgeConfig}.js`)));
}

function renderConfigTemplate(dir, templateObj, obj) {
  for (const [key, value] of Object.entries(obj)) {
    if (typeof value === 'object' && value !== null) {
      renderConfigTemplate(dir, templateObj, value);
    } else if (typeof value === 'string') {
      obj[key] = (0, _lodash.template)(value)(templateObj);

      if (obj[key].startsWith('require:')) {
        // eslint-disable-next-line global-require, import/no-dynamic-require
        obj[key] = require(_path.default.resolve(dir, obj[key].substr(8)));
      }
    }
  }
}

var _default = async dir => {
  const packageJSON = await (0, _readPackageJson.readRawPackageJson)(dir);
  let forgeConfig = packageJSON.config && packageJSON.config.forge ? packageJSON.config.forge : null;

  if (!forgeConfig) {
    if (await _fsExtra.default.pathExists(_path.default.resolve(dir, 'forge.config.js'))) {
      forgeConfig = 'forge.config.js';
    } else {
      forgeConfig = {};
    }
  }

  if (await forgeConfigIsValidFilePath(dir, forgeConfig)) {
    try {
      // eslint-disable-next-line global-require, import/no-dynamic-require
      forgeConfig = require(_path.default.resolve(dir, forgeConfig));
    } catch (err) {
      // eslint-disable-next-line no-console
      console.error(`Failed to load: ${_path.default.resolve(dir, forgeConfig)}`);
      throw err;
    }
  } else if (typeof forgeConfig !== 'object') {
    throw new Error('Expected packageJSON.config.forge to be an object or point to a requirable JS file');
  }

  const defaultForgeConfig = {
    electronRebuildConfig: {},
    packagerConfig: {},
    makers: [],
    publishers: [],
    plugins: []
  };
  forgeConfig = { ...defaultForgeConfig,
    ...forgeConfig
  };
  const templateObj = { ...packageJSON,
    year: new Date().getFullYear()
  };
  renderConfigTemplate(dir, templateObj, forgeConfig);
  forgeConfig.pluginInterface = new _pluginInterface.default(dir, forgeConfig);
  forgeConfig = await (0, _hook.runMutatingHook)(forgeConfig, 'resolveForgeConfig', forgeConfig);
  return proxify(forgeConfig.buildIdentifier || '', forgeConfig, 'ELECTRON_FORGE');
};

exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy91dGlsL2ZvcmdlLWNvbmZpZy50cyJdLCJuYW1lcyI6WyJ1bmRlcnNjb3JlQ2FzZSIsInN0ciIsInJlcGxhY2UiLCJ0b1VwcGVyQ2FzZSIsInByb3hpZnkiLCJidWlsZElkZW50aWZpZXIiLCJvYmplY3QiLCJlbnZQcmVmaXgiLCJuZXdPYmplY3QiLCJBcnJheSIsImlzQXJyYXkiLCJrZXkiLCJ2YWwiLCJPYmplY3QiLCJlbnRyaWVzIiwiUmVnRXhwIiwiUHJveHkiLCJnZXQiLCJ0YXJnZXQiLCJuYW1lIiwicmVjZWl2ZXIiLCJoYXNPd25Qcm9wZXJ0eSIsImVudlZhbHVlIiwicHJvY2VzcyIsImVudiIsInZhbHVlIiwiUmVmbGVjdCIsIl9faXNNYWdpY0J1aWxkSWRlbnRpZmllck1hcCIsImlkZW50aWZpZXIiLCJtYXAiLCJnZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IiLCJ3cml0YWJsZSIsImVudW1lcmFibGUiLCJjb25maWd1cmFibGUiLCJ1bmRlZmluZWQiLCJzZXRJbml0aWFsRm9yZ2VDb25maWciLCJwYWNrYWdlSlNPTiIsImNvbmZpZyIsImZvcmdlIiwibWFrZXJzIiwiZnJvbUJ1aWxkSWRlbnRpZmllciIsImZvcmdlQ29uZmlnSXNWYWxpZEZpbGVQYXRoIiwiZGlyIiwiZm9yZ2VDb25maWciLCJmcyIsInBhdGhFeGlzdHMiLCJwYXRoIiwicmVzb2x2ZSIsInJlbmRlckNvbmZpZ1RlbXBsYXRlIiwidGVtcGxhdGVPYmoiLCJvYmoiLCJzdGFydHNXaXRoIiwicmVxdWlyZSIsInN1YnN0ciIsImVyciIsImNvbnNvbGUiLCJlcnJvciIsIkVycm9yIiwiZGVmYXVsdEZvcmdlQ29uZmlnIiwiZWxlY3Ryb25SZWJ1aWxkQ29uZmlnIiwicGFja2FnZXJDb25maWciLCJwdWJsaXNoZXJzIiwicGx1Z2lucyIsInllYXIiLCJEYXRlIiwiZ2V0RnVsbFllYXIiLCJwbHVnaW5JbnRlcmZhY2UiLCJQbHVnaW5JbnRlcmZhY2UiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQTs7QUFDQTs7QUFDQTs7OztBQUVBLE1BQU1BLGNBQWMsR0FBSUMsR0FBRCxJQUFpQkEsR0FBRyxDQUFDQyxPQUFKLENBQVksbUJBQVosRUFBaUMsT0FBakMsRUFBMENBLE9BQTFDLENBQWtELG9CQUFsRCxFQUF3RSxPQUF4RSxFQUFpRkMsV0FBakYsRUFBeEMsQyxDQUVBOzs7QUFDQSxNQUFNQyxPQUFPLEdBQUcsQ0FDZEMsZUFEYyxFQUVkQyxNQUZjLEVBR2RDLFNBSGMsS0FJUjtBQUNOLE1BQUlDLFNBQVksR0FBRyxFQUFuQjs7QUFDQSxNQUFJQyxLQUFLLENBQUNDLE9BQU4sQ0FBY0osTUFBZCxDQUFKLEVBQTJCO0FBQ3pCRSxJQUFBQSxTQUFTLEdBQUcsRUFBWjtBQUNEOztBQUVELE9BQUssTUFBTSxDQUFDRyxHQUFELEVBQU1DLEdBQU4sQ0FBWCxJQUF5QkMsTUFBTSxDQUFDQyxPQUFQLENBQWVSLE1BQWYsQ0FBekIsRUFBaUQ7QUFDL0MsUUFBSSxPQUFPTSxHQUFQLEtBQWUsUUFBZixJQUEyQkQsR0FBRyxLQUFLLGlCQUFuQyxJQUF3RCxFQUFFQyxHQUFHLFlBQVlHLE1BQWpCLENBQTVELEVBQXNGO0FBQ25GUCxNQUFBQSxTQUFELENBQW1CRyxHQUFuQixJQUEwQlAsT0FBTyxDQUFDQyxlQUFELEVBQW1CQyxNQUFELENBQWdCSyxHQUFoQixDQUFsQixFQUF5QyxHQUFFSixTQUFVLElBQUdQLGNBQWMsQ0FBQ1csR0FBRCxDQUFNLEVBQTVFLENBQWpDO0FBQ0QsS0FGRCxNQUVPO0FBQ0pILE1BQUFBLFNBQUQsQ0FBbUJHLEdBQW5CLElBQTJCTCxNQUFELENBQWdCSyxHQUFoQixDQUExQjtBQUNEO0FBQ0Y7O0FBRUQsU0FBTyxJQUFJSyxLQUFKLENBQWFSLFNBQWIsRUFBd0I7QUFDN0JTLElBQUFBLEdBQUcsQ0FBQ0MsTUFBRCxFQUFTQyxJQUFULEVBQWVDLFFBQWYsRUFBeUI7QUFDMUI7QUFDQSxVQUFJLENBQUNGLE1BQU0sQ0FBQ0csY0FBUCxDQUFzQkYsSUFBdEIsQ0FBRCxJQUFnQyxPQUFPQSxJQUFQLEtBQWdCLFFBQXBELEVBQThEO0FBQzVELGNBQU1HLFFBQVEsR0FBR0MsT0FBTyxDQUFDQyxHQUFSLENBQWEsR0FBRWpCLFNBQVUsSUFBR1AsY0FBYyxDQUFDbUIsSUFBRCxDQUFPLEVBQWpELENBQWpCO0FBQ0EsWUFBSUcsUUFBSixFQUFjLE9BQU9BLFFBQVA7QUFDZjs7QUFDRCxZQUFNRyxLQUFLLEdBQUdDLE9BQU8sQ0FBQ1QsR0FBUixDQUFZQyxNQUFaLEVBQW9CQyxJQUFwQixFQUEwQkMsUUFBMUIsQ0FBZCxDQU4wQixDQVExQjs7QUFDQSxVQUFJSyxLQUFLLElBQUksT0FBT0EsS0FBUCxLQUFpQixRQUExQixJQUFzQ0EsS0FBSyxDQUFDRSwyQkFBaEQsRUFBNkU7QUFDM0UsY0FBTUMsVUFBVSxHQUFHLE9BQU92QixlQUFQLEtBQTJCLFVBQTNCLEdBQXdDQSxlQUFlLEVBQXZELEdBQTREQSxlQUEvRTtBQUNBLGVBQU9vQixLQUFLLENBQUNJLEdBQU4sQ0FBVUQsVUFBVixDQUFQO0FBQ0Q7O0FBQ0QsYUFBT0gsS0FBUDtBQUNELEtBZjRCOztBQWdCN0JLLElBQUFBLHdCQUF3QixDQUFDWixNQUFELEVBQVNDLElBQVQsRUFBZTtBQUNyQyxZQUFNRyxRQUFRLEdBQUdDLE9BQU8sQ0FBQ0MsR0FBUixDQUFhLEdBQUVqQixTQUFVLElBQUdQLGNBQWMsQ0FBQ21CLElBQUQsQ0FBaUIsRUFBM0QsQ0FBakIsQ0FEcUMsQ0FFckM7O0FBQ0EsVUFBSUQsTUFBTSxDQUFDRyxjQUFQLENBQXNCRixJQUF0QixDQUFKLEVBQWlDO0FBQy9CLGVBQU9PLE9BQU8sQ0FBQ0ksd0JBQVIsQ0FBaUNaLE1BQWpDLEVBQXlDQyxJQUF6QyxDQUFQO0FBQ0Q7O0FBRUQsVUFBSUcsUUFBSixFQUFjO0FBQ1osZUFBTztBQUNMUyxVQUFBQSxRQUFRLEVBQUUsSUFETDtBQUVMQyxVQUFBQSxVQUFVLEVBQUUsSUFGUDtBQUdMQyxVQUFBQSxZQUFZLEVBQUUsSUFIVDtBQUlMUixVQUFBQSxLQUFLLEVBQUVIO0FBSkYsU0FBUDtBQU1EOztBQUVELGFBQU9ZLFNBQVA7QUFDRDs7QUFqQzRCLEdBQXhCLENBQVA7QUFtQ0QsQ0FyREQ7QUF1REE7QUFDQTtBQUNBOzs7QUFDTyxTQUFTQyxxQkFBVCxDQUErQkMsV0FBL0IsRUFBaUQ7QUFDdEQsUUFBTTtBQUFFakIsSUFBQUEsSUFBSSxHQUFHO0FBQVQsTUFBZ0JpQixXQUF0QjtBQUVBQSxFQUFBQSxXQUFXLENBQUNDLE1BQVosQ0FBbUJDLEtBQW5CLENBQXlCQyxNQUF6QixDQUFnQyxDQUFoQyxFQUFtQ0YsTUFBbkMsQ0FBMENsQixJQUExQyxHQUFpREEsSUFBSSxDQUFDakIsT0FBTCxDQUFhLElBQWIsRUFBbUIsR0FBbkIsQ0FBakQ7QUFDRDs7QUFFTSxTQUFTc0MsbUJBQVQsQ0FBZ0NYLEdBQWhDLEVBQXVFO0FBQzVFLFNBQU87QUFDTEEsSUFBQUEsR0FESztBQUVMRixJQUFBQSwyQkFBMkIsRUFBRTtBQUZ4QixHQUFQO0FBSUQ7O0FBRU0sZUFBZWMsMEJBQWYsQ0FBMENDLEdBQTFDLEVBQXVEQyxXQUF2RCxFQUEwRjtBQUMvRixTQUFPLE9BQU9BLFdBQVAsS0FBdUIsUUFBdkIsS0FFSCxPQUFNQyxpQkFBR0MsVUFBSCxDQUFjQyxjQUFLQyxPQUFMLENBQWFMLEdBQWIsRUFBa0JDLFdBQWxCLENBQWQsQ0FBTixLQUNHQyxpQkFBR0MsVUFBSCxDQUFjQyxjQUFLQyxPQUFMLENBQWFMLEdBQWIsRUFBbUIsR0FBRUMsV0FBWSxLQUFqQyxDQUFkLENBSEEsQ0FBUDtBQUtEOztBQUVNLFNBQVNLLG9CQUFULENBQThCTixHQUE5QixFQUEyQ08sV0FBM0MsRUFBNkRDLEdBQTdELEVBQXVFO0FBQzVFLE9BQUssTUFBTSxDQUFDdkMsR0FBRCxFQUFNYyxLQUFOLENBQVgsSUFBMkJaLE1BQU0sQ0FBQ0MsT0FBUCxDQUFlb0MsR0FBZixDQUEzQixFQUFnRDtBQUM5QyxRQUFJLE9BQU96QixLQUFQLEtBQWlCLFFBQWpCLElBQTZCQSxLQUFLLEtBQUssSUFBM0MsRUFBaUQ7QUFDL0N1QixNQUFBQSxvQkFBb0IsQ0FBQ04sR0FBRCxFQUFNTyxXQUFOLEVBQW1CeEIsS0FBbkIsQ0FBcEI7QUFDRCxLQUZELE1BRU8sSUFBSSxPQUFPQSxLQUFQLEtBQWlCLFFBQXJCLEVBQStCO0FBQ3BDeUIsTUFBQUEsR0FBRyxDQUFDdkMsR0FBRCxDQUFILEdBQVcsc0JBQVNjLEtBQVQsRUFBZ0J3QixXQUFoQixDQUFYOztBQUNBLFVBQUlDLEdBQUcsQ0FBQ3ZDLEdBQUQsQ0FBSCxDQUFTd0MsVUFBVCxDQUFvQixVQUFwQixDQUFKLEVBQXFDO0FBQ25DO0FBQ0FELFFBQUFBLEdBQUcsQ0FBQ3ZDLEdBQUQsQ0FBSCxHQUFXeUMsT0FBTyxDQUFDTixjQUFLQyxPQUFMLENBQWFMLEdBQWIsRUFBa0JRLEdBQUcsQ0FBQ3ZDLEdBQUQsQ0FBSCxDQUFTMEMsTUFBVCxDQUFnQixDQUFoQixDQUFsQixDQUFELENBQWxCO0FBQ0Q7QUFDRjtBQUNGO0FBQ0Y7O2VBRWMsTUFBT1gsR0FBUCxJQUF1QjtBQUNwQyxRQUFNTixXQUFXLEdBQUcsTUFBTSx5Q0FBbUJNLEdBQW5CLENBQTFCO0FBQ0EsTUFBSUMsV0FBd0MsR0FBSVAsV0FBVyxDQUFDQyxNQUFaLElBQXNCRCxXQUFXLENBQUNDLE1BQVosQ0FBbUJDLEtBQTFDLEdBQzNDRixXQUFXLENBQUNDLE1BQVosQ0FBbUJDLEtBRHdCLEdBRTNDLElBRko7O0FBSUEsTUFBSSxDQUFDSyxXQUFMLEVBQWtCO0FBQ2hCLFFBQUksTUFBTUMsaUJBQUdDLFVBQUgsQ0FBY0MsY0FBS0MsT0FBTCxDQUFhTCxHQUFiLEVBQWtCLGlCQUFsQixDQUFkLENBQVYsRUFBK0Q7QUFDN0RDLE1BQUFBLFdBQVcsR0FBRyxpQkFBZDtBQUNELEtBRkQsTUFFTztBQUNMQSxNQUFBQSxXQUFXLEdBQUcsRUFBZDtBQUNEO0FBQ0Y7O0FBRUQsTUFBSSxNQUFNRiwwQkFBMEIsQ0FBQ0MsR0FBRCxFQUFNQyxXQUFOLENBQXBDLEVBQXdEO0FBQ3RELFFBQUk7QUFDRjtBQUNBQSxNQUFBQSxXQUFXLEdBQUdTLE9BQU8sQ0FBQ04sY0FBS0MsT0FBTCxDQUFhTCxHQUFiLEVBQWtCQyxXQUFsQixDQUFELENBQXJCO0FBQ0QsS0FIRCxDQUdFLE9BQU9XLEdBQVAsRUFBWTtBQUNaO0FBQ0FDLE1BQUFBLE9BQU8sQ0FBQ0MsS0FBUixDQUFlLG1CQUFrQlYsY0FBS0MsT0FBTCxDQUFhTCxHQUFiLEVBQWtCQyxXQUFsQixDQUF5QyxFQUExRTtBQUNBLFlBQU1XLEdBQU47QUFDRDtBQUNGLEdBVEQsTUFTTyxJQUFJLE9BQU9YLFdBQVAsS0FBdUIsUUFBM0IsRUFBcUM7QUFDMUMsVUFBTSxJQUFJYyxLQUFKLENBQVUsb0ZBQVYsQ0FBTjtBQUNEOztBQUNELFFBQU1DLGtCQUFrQixHQUFHO0FBQ3pCQyxJQUFBQSxxQkFBcUIsRUFBRSxFQURFO0FBRXpCQyxJQUFBQSxjQUFjLEVBQUUsRUFGUztBQUd6QnJCLElBQUFBLE1BQU0sRUFBRSxFQUhpQjtBQUl6QnNCLElBQUFBLFVBQVUsRUFBRSxFQUphO0FBS3pCQyxJQUFBQSxPQUFPLEVBQUU7QUFMZ0IsR0FBM0I7QUFPQW5CLEVBQUFBLFdBQVcsR0FBRyxFQUNaLEdBQUdlLGtCQURTO0FBRVosT0FBR2Y7QUFGUyxHQUFkO0FBS0EsUUFBTU0sV0FBVyxHQUFHLEVBQUUsR0FBR2IsV0FBTDtBQUFrQjJCLElBQUFBLElBQUksRUFBRyxJQUFJQyxJQUFKLEVBQUQsQ0FBYUMsV0FBYjtBQUF4QixHQUFwQjtBQUNBakIsRUFBQUEsb0JBQW9CLENBQUNOLEdBQUQsRUFBTU8sV0FBTixFQUFtQk4sV0FBbkIsQ0FBcEI7QUFFQUEsRUFBQUEsV0FBVyxDQUFDdUIsZUFBWixHQUE4QixJQUFJQyx3QkFBSixDQUFvQnpCLEdBQXBCLEVBQXlCQyxXQUF6QixDQUE5QjtBQUVBQSxFQUFBQSxXQUFXLEdBQUcsTUFBTSwyQkFBZ0JBLFdBQWhCLEVBQTZCLG9CQUE3QixFQUFtREEsV0FBbkQsQ0FBcEI7QUFFQSxTQUFPdkMsT0FBTyxDQUFjdUMsV0FBVyxDQUFDdEMsZUFBWixJQUErQixFQUE3QyxFQUFpRHNDLFdBQWpELEVBQThELGdCQUE5RCxDQUFkO0FBQ0QsQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEZvcmdlQ29uZmlnIH0gZnJvbSAnQGVsZWN0cm9uLWZvcmdlL3NoYXJlZC10eXBlcyc7XG5pbXBvcnQgZnMgZnJvbSAnZnMtZXh0cmEnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgeyB0ZW1wbGF0ZSB9IGZyb20gJ2xvZGFzaCc7XG5cbmltcG9ydCB7IHJlYWRSYXdQYWNrYWdlSnNvbiB9IGZyb20gJy4vcmVhZC1wYWNrYWdlLWpzb24nO1xuaW1wb3J0IFBsdWdpbkludGVyZmFjZSBmcm9tICcuL3BsdWdpbi1pbnRlcmZhY2UnO1xuaW1wb3J0IHsgcnVuTXV0YXRpbmdIb29rIH0gZnJvbSAnLi9ob29rJztcblxuY29uc3QgdW5kZXJzY29yZUNhc2UgPSAoc3RyOiBzdHJpbmcpID0+IHN0ci5yZXBsYWNlKC8oLikoW0EtWl1bYS16XSspL2csICckMV8kMicpLnJlcGxhY2UoLyhbYS16MC05XSkoW0EtWl0pL2csICckMV8kMicpLnRvVXBwZXJDYXNlKCk7XG5cbi8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBhcnJvdy1wYXJlbnNcbmNvbnN0IHByb3hpZnkgPSA8VCBleHRlbmRzIG9iamVjdD4oXG4gIGJ1aWxkSWRlbnRpZmllcjogc3RyaW5nIHwgKCgpID0+IHN0cmluZyksXG4gIG9iamVjdDogVCxcbiAgZW52UHJlZml4OiBzdHJpbmcsXG4pOiBUID0+IHtcbiAgbGV0IG5ld09iamVjdDogVCA9IHt9IGFzIGFueTtcbiAgaWYgKEFycmF5LmlzQXJyYXkob2JqZWN0KSkge1xuICAgIG5ld09iamVjdCA9IFtdIGFzIGFueTtcbiAgfVxuXG4gIGZvciAoY29uc3QgW2tleSwgdmFsXSBvZiBPYmplY3QuZW50cmllcyhvYmplY3QpKSB7XG4gICAgaWYgKHR5cGVvZiB2YWwgPT09ICdvYmplY3QnICYmIGtleSAhPT0gJ3BsdWdpbkludGVyZmFjZScgJiYgISh2YWwgaW5zdGFuY2VvZiBSZWdFeHApKSB7XG4gICAgICAobmV3T2JqZWN0IGFzIGFueSlba2V5XSA9IHByb3hpZnkoYnVpbGRJZGVudGlmaWVyLCAob2JqZWN0IGFzIGFueSlba2V5XSwgYCR7ZW52UHJlZml4fV8ke3VuZGVyc2NvcmVDYXNlKGtleSl9YCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIChuZXdPYmplY3QgYXMgYW55KVtrZXldID0gKG9iamVjdCBhcyBhbnkpW2tleV07XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIG5ldyBQcm94eTxUPihuZXdPYmplY3QsIHtcbiAgICBnZXQodGFyZ2V0LCBuYW1lLCByZWNlaXZlcikge1xuICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXByb3RvdHlwZS1idWlsdGluc1xuICAgICAgaWYgKCF0YXJnZXQuaGFzT3duUHJvcGVydHkobmFtZSkgJiYgdHlwZW9mIG5hbWUgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgIGNvbnN0IGVudlZhbHVlID0gcHJvY2Vzcy5lbnZbYCR7ZW52UHJlZml4fV8ke3VuZGVyc2NvcmVDYXNlKG5hbWUpfWBdO1xuICAgICAgICBpZiAoZW52VmFsdWUpIHJldHVybiBlbnZWYWx1ZTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IHZhbHVlID0gUmVmbGVjdC5nZXQodGFyZ2V0LCBuYW1lLCByZWNlaXZlcik7XG5cbiAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby11bmRlcnNjb3JlLWRhbmdsZVxuICAgICAgaWYgKHZhbHVlICYmIHR5cGVvZiB2YWx1ZSA9PT0gJ29iamVjdCcgJiYgdmFsdWUuX19pc01hZ2ljQnVpbGRJZGVudGlmaWVyTWFwKSB7XG4gICAgICAgIGNvbnN0IGlkZW50aWZpZXIgPSB0eXBlb2YgYnVpbGRJZGVudGlmaWVyID09PSAnZnVuY3Rpb24nID8gYnVpbGRJZGVudGlmaWVyKCkgOiBidWlsZElkZW50aWZpZXI7XG4gICAgICAgIHJldHVybiB2YWx1ZS5tYXBbaWRlbnRpZmllcl07XG4gICAgICB9XG4gICAgICByZXR1cm4gdmFsdWU7XG4gICAgfSxcbiAgICBnZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodGFyZ2V0LCBuYW1lKSB7XG4gICAgICBjb25zdCBlbnZWYWx1ZSA9IHByb2Nlc3MuZW52W2Ake2VudlByZWZpeH1fJHt1bmRlcnNjb3JlQ2FzZShuYW1lIGFzIHN0cmluZyl9YF07XG4gICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tcHJvdG90eXBlLWJ1aWx0aW5zXG4gICAgICBpZiAodGFyZ2V0Lmhhc093blByb3BlcnR5KG5hbWUpKSB7XG4gICAgICAgIHJldHVybiBSZWZsZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0YXJnZXQsIG5hbWUpO1xuICAgICAgfVxuXG4gICAgICBpZiAoZW52VmFsdWUpIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICB3cml0YWJsZTogdHJ1ZSxcbiAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLFxuICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSxcbiAgICAgICAgICB2YWx1ZTogZW52VmFsdWUsXG4gICAgICAgIH07XG4gICAgICB9XG5cbiAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgfSxcbiAgfSk7XG59O1xuXG4vKipcbiAqIFNldHMgc2Vuc2libGUgZGVmYXVsdHMgZm9yIHRoZSBgY29uZmlnLmZvcmdlYCBvYmplY3QuXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBzZXRJbml0aWFsRm9yZ2VDb25maWcocGFja2FnZUpTT046IGFueSkge1xuICBjb25zdCB7IG5hbWUgPSAnJyB9ID0gcGFja2FnZUpTT047XG5cbiAgcGFja2FnZUpTT04uY29uZmlnLmZvcmdlLm1ha2Vyc1swXS5jb25maWcubmFtZSA9IG5hbWUucmVwbGFjZSgvLS9nLCAnXycpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZnJvbUJ1aWxkSWRlbnRpZmllcjxUPihtYXA6IHsgW2tleTogc3RyaW5nXTogVCB8IHVuZGVmaW5lZCB9KSB7XG4gIHJldHVybiB7XG4gICAgbWFwLFxuICAgIF9faXNNYWdpY0J1aWxkSWRlbnRpZmllck1hcDogdHJ1ZSxcbiAgfTtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGZvcmdlQ29uZmlnSXNWYWxpZEZpbGVQYXRoKGRpcjogc3RyaW5nLCBmb3JnZUNvbmZpZzogc3RyaW5nIHwgRm9yZ2VDb25maWcpIHtcbiAgcmV0dXJuIHR5cGVvZiBmb3JnZUNvbmZpZyA9PT0gJ3N0cmluZydcbiAgICAmJiAoXG4gICAgICBhd2FpdCBmcy5wYXRoRXhpc3RzKHBhdGgucmVzb2x2ZShkaXIsIGZvcmdlQ29uZmlnKSlcbiAgICAgIHx8IGZzLnBhdGhFeGlzdHMocGF0aC5yZXNvbHZlKGRpciwgYCR7Zm9yZ2VDb25maWd9LmpzYCkpXG4gICAgKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHJlbmRlckNvbmZpZ1RlbXBsYXRlKGRpcjogc3RyaW5nLCB0ZW1wbGF0ZU9iajogYW55LCBvYmo6IGFueSkge1xuICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiBPYmplY3QuZW50cmllcyhvYmopKSB7XG4gICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ29iamVjdCcgJiYgdmFsdWUgIT09IG51bGwpIHtcbiAgICAgIHJlbmRlckNvbmZpZ1RlbXBsYXRlKGRpciwgdGVtcGxhdGVPYmosIHZhbHVlKTtcbiAgICB9IGVsc2UgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycpIHtcbiAgICAgIG9ialtrZXldID0gdGVtcGxhdGUodmFsdWUpKHRlbXBsYXRlT2JqKTtcbiAgICAgIGlmIChvYmpba2V5XS5zdGFydHNXaXRoKCdyZXF1aXJlOicpKSB7XG4gICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBnbG9iYWwtcmVxdWlyZSwgaW1wb3J0L25vLWR5bmFtaWMtcmVxdWlyZVxuICAgICAgICBvYmpba2V5XSA9IHJlcXVpcmUocGF0aC5yZXNvbHZlKGRpciwgb2JqW2tleV0uc3Vic3RyKDgpKSk7XG4gICAgICB9XG4gICAgfVxuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IGFzeW5jIChkaXI6IHN0cmluZykgPT4ge1xuICBjb25zdCBwYWNrYWdlSlNPTiA9IGF3YWl0IHJlYWRSYXdQYWNrYWdlSnNvbihkaXIpO1xuICBsZXQgZm9yZ2VDb25maWc6IEZvcmdlQ29uZmlnIHwgc3RyaW5nIHwgbnVsbCA9IChwYWNrYWdlSlNPTi5jb25maWcgJiYgcGFja2FnZUpTT04uY29uZmlnLmZvcmdlKVxuICAgID8gcGFja2FnZUpTT04uY29uZmlnLmZvcmdlXG4gICAgOiBudWxsO1xuXG4gIGlmICghZm9yZ2VDb25maWcpIHtcbiAgICBpZiAoYXdhaXQgZnMucGF0aEV4aXN0cyhwYXRoLnJlc29sdmUoZGlyLCAnZm9yZ2UuY29uZmlnLmpzJykpKSB7XG4gICAgICBmb3JnZUNvbmZpZyA9ICdmb3JnZS5jb25maWcuanMnO1xuICAgIH0gZWxzZSB7XG4gICAgICBmb3JnZUNvbmZpZyA9IHt9IGFzIGFueSBhcyBGb3JnZUNvbmZpZztcbiAgICB9XG4gIH1cblxuICBpZiAoYXdhaXQgZm9yZ2VDb25maWdJc1ZhbGlkRmlsZVBhdGgoZGlyLCBmb3JnZUNvbmZpZykpIHtcbiAgICB0cnkge1xuICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIGdsb2JhbC1yZXF1aXJlLCBpbXBvcnQvbm8tZHluYW1pYy1yZXF1aXJlXG4gICAgICBmb3JnZUNvbmZpZyA9IHJlcXVpcmUocGF0aC5yZXNvbHZlKGRpciwgZm9yZ2VDb25maWcgYXMgc3RyaW5nKSkgYXMgRm9yZ2VDb25maWc7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tY29uc29sZVxuICAgICAgY29uc29sZS5lcnJvcihgRmFpbGVkIHRvIGxvYWQ6ICR7cGF0aC5yZXNvbHZlKGRpciwgZm9yZ2VDb25maWcgYXMgc3RyaW5nKX1gKTtcbiAgICAgIHRocm93IGVycjtcbiAgICB9XG4gIH0gZWxzZSBpZiAodHlwZW9mIGZvcmdlQ29uZmlnICE9PSAnb2JqZWN0Jykge1xuICAgIHRocm93IG5ldyBFcnJvcignRXhwZWN0ZWQgcGFja2FnZUpTT04uY29uZmlnLmZvcmdlIHRvIGJlIGFuIG9iamVjdCBvciBwb2ludCB0byBhIHJlcXVpcmFibGUgSlMgZmlsZScpO1xuICB9XG4gIGNvbnN0IGRlZmF1bHRGb3JnZUNvbmZpZyA9IHtcbiAgICBlbGVjdHJvblJlYnVpbGRDb25maWc6IHt9LFxuICAgIHBhY2thZ2VyQ29uZmlnOiB7fSxcbiAgICBtYWtlcnM6IFtdLFxuICAgIHB1Ymxpc2hlcnM6IFtdLFxuICAgIHBsdWdpbnM6IFtdLFxuICB9O1xuICBmb3JnZUNvbmZpZyA9IHtcbiAgICAuLi5kZWZhdWx0Rm9yZ2VDb25maWcsXG4gICAgLi4uZm9yZ2VDb25maWcsXG4gIH07XG5cbiAgY29uc3QgdGVtcGxhdGVPYmogPSB7IC4uLnBhY2thZ2VKU09OLCB5ZWFyOiAobmV3IERhdGUoKSkuZ2V0RnVsbFllYXIoKSB9O1xuICByZW5kZXJDb25maWdUZW1wbGF0ZShkaXIsIHRlbXBsYXRlT2JqLCBmb3JnZUNvbmZpZyk7XG5cbiAgZm9yZ2VDb25maWcucGx1Z2luSW50ZXJmYWNlID0gbmV3IFBsdWdpbkludGVyZmFjZShkaXIsIGZvcmdlQ29uZmlnKTtcblxuICBmb3JnZUNvbmZpZyA9IGF3YWl0IHJ1bk11dGF0aW5nSG9vayhmb3JnZUNvbmZpZywgJ3Jlc29sdmVGb3JnZUNvbmZpZycsIGZvcmdlQ29uZmlnKTtcblxuICByZXR1cm4gcHJveGlmeTxGb3JnZUNvbmZpZz4oZm9yZ2VDb25maWcuYnVpbGRJZGVudGlmaWVyIHx8ICcnLCBmb3JnZUNvbmZpZywgJ0VMRUNUUk9OX0ZPUkdFJyk7XG59O1xuIl19
"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
Object.defineProperty(exports, "StartOptions", {
  enumerable: true,
  get: function () {
    return _sharedTypes.StartOptions;
  }
});
exports.default = void 0;

require("source-map-support/register");

var _asyncOra = require("@electron-forge/async-ora");

var _chalk = _interopRequireDefault(require("chalk"));

var _debug = _interopRequireDefault(require("debug"));

var _sharedTypes = require("@electron-forge/shared-types");

var _child_process = require("child_process");

var _electronVersion = require("../util/electron-version");

var _forgeConfig = _interopRequireDefault(require("../util/forge-config"));

var _electronExecutable = _interopRequireDefault(require("../util/electron-executable"));

var _readPackageJson = require("../util/read-package-json");

var _rebuild = _interopRequireDefault(require("../util/rebuild"));

var _resolveDir = _interopRequireDefault(require("../util/resolve-dir"));

var _hook = require("../util/hook");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const d = (0, _debug.default)('electron-forge:start');

var _default = async ({
  dir = process.cwd(),
  appPath = '.',
  interactive = false,
  enableLogging = false,
  args = [],
  runAsNode = false,
  inspect = false
}) => {
  _asyncOra.asyncOra.interactive = interactive;
  await (0, _asyncOra.asyncOra)('Locating Application', async () => {
    const resolvedDir = await (0, _resolveDir.default)(dir);

    if (!resolvedDir) {
      throw new Error('Failed to locate startable Electron application');
    }

    dir = resolvedDir;
  });
  const forgeConfig = await (0, _forgeConfig.default)(dir);
  const packageJSON = await (0, _readPackageJson.readMutatedPackageJson)(dir, forgeConfig);

  if (!packageJSON.version) {
    throw new Error(`Please set your application's 'version' in '${dir}/package.json'.`);
  }

  const platform = process.env.npm_config_platform || process.platform;
  const arch = process.env.npm_config_arch || process.arch;
  await (0, _rebuild.default)(dir, await (0, _electronVersion.getElectronVersion)(dir, packageJSON), platform, arch, forgeConfig.electronRebuildConfig);
  await (0, _hook.runHook)(forgeConfig, 'generateAssets', platform, arch);
  let lastSpawned = null;

  const forgeSpawn = async () => {
    let electronExecPath = null; // If a plugin has taken over the start command let's stop here

    const spawnedPluginChild = await forgeConfig.pluginInterface.overrideStartLogic({
      dir,
      appPath,
      interactive,
      enableLogging,
      args,
      runAsNode,
      inspect
    });
    let prefixArgs = [];

    if (typeof spawnedPluginChild === 'string') {
      electronExecPath = spawnedPluginChild;
    } else if (Array.isArray(spawnedPluginChild)) {
      [electronExecPath, ...prefixArgs] = spawnedPluginChild;
    } else if (spawnedPluginChild) {
      await (0, _hook.runHook)(forgeConfig, 'postStart', spawnedPluginChild);
      return spawnedPluginChild;
    }

    if (!electronExecPath) {
      electronExecPath = await (0, _electronExecutable.default)(dir, packageJSON);
    }

    d('Electron binary path:', electronExecPath);
    const spawnOpts = {
      cwd: dir,
      stdio: 'inherit',
      env: { ...process.env,
        ...(enableLogging ? {
          ELECTRON_ENABLE_LOGGING: 'true',
          ELECTRON_ENABLE_STACK_DUMPING: 'true'
        } : {})
      }
    };

    if (runAsNode) {
      spawnOpts.env.ELECTRON_RUN_AS_NODE = 'true';
    } else {
      delete spawnOpts.env.ELECTRON_RUN_AS_NODE;
    }

    if (inspect) {
      args = ['--inspect'].concat(args);
    }

    let spawned;
    await (0, _asyncOra.asyncOra)('Launching Application', async () => {
      spawned = (0, _child_process.spawn)(electronExecPath, // eslint-disable-line @typescript-eslint/no-non-null-assertion
      prefixArgs.concat([appPath]).concat(args), spawnOpts);
    });
    await (0, _hook.runHook)(forgeConfig, 'postStart', spawned);
    return spawned;
  };

  const forgeSpawnWrapper = async () => {
    const spawned = await forgeSpawn(); // When the child app is closed we should stop listening for stdin

    if (spawned) {
      if (interactive && process.stdin.isPaused()) {
        process.stdin.resume();
      }

      spawned.on('exit', () => {
        if (spawned.restarted) return;
        if (!process.stdin.isPaused()) process.stdin.pause();
      });
    } else if (interactive && !process.stdin.isPaused()) {
      process.stdin.pause();
    }

    lastSpawned = spawned;
    return lastSpawned;
  };

  if (interactive) {
    process.stdin.on('data', async data => {
      if (data.toString().trim() === 'rs' && lastSpawned) {
        // eslint-disable-next-line no-console
        console.info(_chalk.default.cyan('\nRestarting App\n'));
        lastSpawned.restarted = true;
        lastSpawned.kill('SIGTERM');
        lastSpawned.emit('restarted', await forgeSpawnWrapper());
      }
    });
  }

  return forgeSpawnWrapper();
};

exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9hcGkvc3RhcnQudHMiXSwibmFtZXMiOlsiZCIsImRpciIsInByb2Nlc3MiLCJjd2QiLCJhcHBQYXRoIiwiaW50ZXJhY3RpdmUiLCJlbmFibGVMb2dnaW5nIiwiYXJncyIsInJ1bkFzTm9kZSIsImluc3BlY3QiLCJhc3luY09yYSIsInJlc29sdmVkRGlyIiwiRXJyb3IiLCJmb3JnZUNvbmZpZyIsInBhY2thZ2VKU09OIiwidmVyc2lvbiIsInBsYXRmb3JtIiwiZW52IiwibnBtX2NvbmZpZ19wbGF0Zm9ybSIsImFyY2giLCJucG1fY29uZmlnX2FyY2giLCJlbGVjdHJvblJlYnVpbGRDb25maWciLCJsYXN0U3Bhd25lZCIsImZvcmdlU3Bhd24iLCJlbGVjdHJvbkV4ZWNQYXRoIiwic3Bhd25lZFBsdWdpbkNoaWxkIiwicGx1Z2luSW50ZXJmYWNlIiwib3ZlcnJpZGVTdGFydExvZ2ljIiwicHJlZml4QXJncyIsIkFycmF5IiwiaXNBcnJheSIsInNwYXduT3B0cyIsInN0ZGlvIiwiRUxFQ1RST05fRU5BQkxFX0xPR0dJTkciLCJFTEVDVFJPTl9FTkFCTEVfU1RBQ0tfRFVNUElORyIsIkVMRUNUUk9OX1JVTl9BU19OT0RFIiwiY29uY2F0Iiwic3Bhd25lZCIsImZvcmdlU3Bhd25XcmFwcGVyIiwic3RkaW4iLCJpc1BhdXNlZCIsInJlc3VtZSIsIm9uIiwicmVzdGFydGVkIiwicGF1c2UiLCJkYXRhIiwidG9TdHJpbmciLCJ0cmltIiwiY29uc29sZSIsImluZm8iLCJjaGFsayIsImN5YW4iLCJraWxsIiwiZW1pdCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7QUFFQSxNQUFNQSxDQUFDLEdBQUcsb0JBQU0sc0JBQU4sQ0FBVjs7ZUFJZSxPQUFPO0FBQ3BCQyxFQUFBQSxHQUFHLEdBQUdDLE9BQU8sQ0FBQ0Ms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TUFBZDtBQUNEOztBQUNESixNQUFBQSxPQUFPLENBQUNLLEVBQVIsQ0FBVyxNQUFYLEVBQW1CLE1BQU07QUFDdkIsWUFBSUwsT0FBTyxDQUFDTSxTQUFaLEVBQXVCO0FBRXZCLFlBQUksQ0FBQ3pDLE9BQU8sQ0FBQ3FDLEtBQVIsQ0FBY0MsUUFBZCxFQUFMLEVBQStCdEMsT0FBTyxDQUFDcUMsS0FBUixDQUFjSyxLQUFkO0FBQ2hDLE9BSkQ7QUFLRCxLQVRELE1BU08sSUFBSXZDLFdBQVcsSUFBSSxDQUFDSCxPQUFPLENBQUNxQyxLQUFSLENBQWNDLFFBQWQsRUFBcEIsRUFBOEM7QUFDbkR0QyxNQUFBQSxPQUFPLENBQUNxQyxLQUFSLENBQWNLLEtBQWQ7QUFDRDs7QUFFRHRCLElBQUFBLFdBQVcsR0FBR2UsT0FBZDtBQUNBLFdBQU9mLFdBQVA7QUFDRCxHQWxCRDs7QUFvQkEsTUFBSWpCLFdBQUosRUFBaUI7QUFDZkgsSUFBQUEsT0FBTyxDQUFDcUMsS0FBUixDQUFjRyxFQUFkLENBQWlCLE1BQWpCLEVBQXlCLE1BQU9HLElBQVAsSUFBZ0I7QUFDdkMsVUFBSUEsSUFBSSxDQUFDQyxRQUFMLEdBQWdCQyxJQUFoQixPQUEyQixJQUEzQixJQUFtQ3pCLFdBQXZDLEVBQW9EO0FBQ2xEO0FBQ0EwQixRQUFBQSxPQUFPLENBQUNDLElBQVIsQ0FBYUMsZUFBTUMsSUFBTixDQUFXLG9CQUFYLENBQWI7QUFDQTdCLFFBQUFBLFdBQVcsQ0FBQ3FCLFNBQVosR0FBd0IsSUFBeEI7QUFDQXJCLFFBQUFBLFdBQVcsQ0FBQzhCLElBQVosQ0FBaUIsU0FBakI7QUFDQTlCLFFBQUFBLFdBQVcsQ0FBQytCLElBQVosQ0FBaUIsV0FBakIsRUFBOEIsTUFBTWYsaUJBQWlCLEVBQXJEO0FBQ0Q7QUFDRixLQVJEO0FBU0Q7O0FBRUQsU0FBT0EsaUJBQWlCLEVBQXhCO0FBQ0QsQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGFzeW5jT3JhIH0gZnJvbSAnQGVsZWN0cm9uLWZvcmdlL2FzeW5jLW9yYSc7XG5pbXBvcnQgY2hhbGsgZnJvbSAnY2hhbGsnO1xuaW1wb3J0IGRlYnVnIGZyb20gJ2RlYnVnJztcbmltcG9ydCB7IEVsZWN0cm9uUHJvY2VzcywgRm9yZ2VBcmNoLCBGb3JnZVBsYXRmb3JtLCBTdGFydE9wdGlvbnMgfSBmcm9tICdAZWxlY3Ryb24tZm9yZ2Uvc2hhcmVkLXR5cGVzJztcbmltcG9ydCB7IHNwYXduLCBTcGF3bk9wdGlvbnMgfSBmcm9tICdjaGlsZF9wcm9jZXNzJztcblxuaW1wb3J0IHsgZ2V0RWxlY3Ryb25WZXJzaW9uIH0gZnJvbSAnLi4vdXRpbC9lbGVjdHJvbi12ZXJzaW9uJztcbmltcG9ydCBnZXRGb3JnZUNvbmZpZyBmcm9tICcuLi91dGlsL2ZvcmdlLWNvbmZpZyc7XG5pbXBvcnQgbG9jYXRlRWxlY3Ryb25FeGVjdXRhYmxlIGZyb20gJy4uL3V0aWwvZWxlY3Ryb24tZXhlY3V0YWJsZSc7XG5pbXBvcnQgeyByZWFkTXV0YXRlZFBhY2thZ2VKc29uIH0gZnJvbSAnLi4vdXRpbC9yZWFkLXBhY2thZ2UtanNvbic7XG5pbXBvcnQgcmVidWlsZCBmcm9tICcuLi91dGlsL3JlYnVpbGQnO1xuaW1wb3J0IHJlc29sdmVEaXIgZnJvbSAnLi4vdXRpbC9yZXNvbHZlLWRpcic7XG5pbXBvcnQgeyBydW5Ib29rIH0gZnJvbSAnLi4vdXRpbC9ob29rJztcblxuY29uc3QgZCA9IGRlYnVnKCdlbGVjdHJvbi1mb3JnZTpzdGFydCcpO1xuXG5leHBvcnQgeyBTdGFydE9wdGlvbnMgfTtcblxuZXhwb3J0IGRlZmF1bHQgYXN5bmMgKHtcbiAgZGlyID0gcHJvY2Vzcy5jd2QoKSxcbiAgYXBwUGF0aCA9ICcuJyxcbiAgaW50ZXJhY3RpdmUgPSBmYWxzZSxcbiAgZW5hYmxlTG9nZ2luZyA9IGZhbHNlLFxuICBhcmdzID0gW10sXG4gIHJ1bkFzTm9kZSA9IGZhbHNlLFxuICBpbnNwZWN0ID0gZmFsc2UsXG59OiBTdGFydE9wdGlvbnMpOiBQcm9taXNlPEVsZWN0cm9uUHJvY2Vzcz4gPT4ge1xuICBhc3luY09yYS5pbnRlcmFjdGl2ZSA9IGludGVyYWN0aXZlO1xuXG4gIGF3YWl0IGFzeW5jT3JhKCdMb2NhdGluZyBBcHBsaWNhdGlvbicsIGFzeW5jICgpID0+IHtcbiAgICBjb25zdCByZXNvbHZlZERpciA9IGF3YWl0IHJlc29sdmVEaXIoZGlyKTtcbiAgICBpZiAoIXJlc29sdmVkRGlyKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ZhaWxlZCB0byBsb2NhdGUgc3RhcnRhYmxlIEVsZWN0cm9uIGFwcGxpY2F0aW9uJyk7XG4gICAgfVxuICAgIGRpciA9IHJlc29sdmVkRGlyO1xuICB9KTtcblxuICBjb25zdCBmb3JnZUNvbmZpZyA9IGF3YWl0IGdldEZvcmdlQ29uZmlnKGRpcik7XG4gIGNvbnN0IHBhY2thZ2VKU09OID0gYXdhaXQgcmVhZE11dGF0ZWRQYWNrYWdlSnNvbihkaXIsIGZvcmdlQ29uZmlnKTtcblxuICBpZiAoIXBhY2thZ2VKU09OLnZlcnNpb24pIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYFBsZWFzZSBzZXQgeW91ciBhcHBsaWNhdGlvbidzICd2ZXJzaW9uJyBpbiAnJHtkaXJ9L3BhY2thZ2UuanNvbicuYCk7XG4gIH1cblxuICBjb25zdCBwbGF0Zm9ybSA9IHByb2Nlc3MuZW52Lm5wbV9jb25maWdfcGxhdGZvcm0gfHwgcHJvY2Vzcy5wbGF0Zm9ybTtcbiAgY29uc3QgYXJjaCA9IHByb2Nlc3MuZW52Lm5wbV9jb25maWdfYXJjaCB8fCBwcm9jZXNzLmFyY2g7XG5cbiAgYXdhaXQgcmVidWlsZChkaXIsIGF3YWl0IGdldEVsZWN0cm9uVmVyc2lvbihkaXIsIHBhY2thZ2VKU09OKSwgcGxhdGZvcm0gYXMgRm9yZ2VQbGF0Zm9ybSwgYXJjaCBhcyBGb3JnZUFyY2gsIGZvcmdlQ29uZmlnLmVsZWN0cm9uUmVidWlsZENvbmZpZyk7XG5cbiAgYXdhaXQgcnVuSG9vayhmb3JnZUNvbmZpZywgJ2dlbmVyYXRlQXNzZXRzJywgcGxhdGZvcm0sIGFyY2gpO1xuXG4gIGxldCBsYXN0U3Bhd25lZDogRWxlY3Ryb25Qcm9jZXNzIHwgbnVsbCA9IG51bGw7XG5cbiAgY29uc3QgZm9yZ2VTcGF3biA9IGFzeW5jICgpID0+IHtcbiAgICBsZXQgZWxlY3Ryb25FeGVjUGF0aDogc3RyaW5nIHwgbnVsbCA9IG51bGw7XG5cbiAgICAvLyBJZiBhIHBsdWdpbiBoYXMgdGFrZW4gb3ZlciB0aGUgc3RhcnQgY29tbWFuZCBsZXQncyBzdG9wIGhlcmVcbiAgICBjb25zdCBzcGF3bmVkUGx1Z2luQ2hpbGQgPSBhd2FpdCBmb3JnZUNvbmZpZy5wbHVnaW5JbnRlcmZhY2Uub3ZlcnJpZGVTdGFydExvZ2ljKHtcbiAgICAgIGRpcixcbiAgICAgIGFwcFBhdGgsXG4gICAgICBpbnRlcmFjdGl2ZSxcbiAgICAgIGVuYWJsZUxvZ2dpbmcsXG4gICAgICBhcmdzLFxuICAgICAgcnVuQXNOb2RlLFxuICAgICAgaW5zcGVjdCxcbiAgICB9KTtcbiAgICBsZXQgcHJlZml4QXJnczogc3RyaW5nW10gPSBbXTtcbiAgICBpZiAodHlwZW9mIHNwYXduZWRQbHVnaW5DaGlsZCA9PT0gJ3N0cmluZycpIHtcbiAgICAgIGVsZWN0cm9uRXhlY1BhdGggPSBzcGF3bmVkUGx1Z2luQ2hpbGQ7XG4gICAgfSBlbHNlIGlmIChBcnJheS5pc0FycmF5KHNwYXduZWRQbHVnaW5DaGlsZCkpIHtcbiAgICAgIFtlbGVjdHJvbkV4ZWNQYXRoLCAuLi5wcmVmaXhBcmdzXSA9IHNwYXduZWRQbHVnaW5DaGlsZDtcbiAgICB9IGVsc2UgaWYgKHNwYXduZWRQbHVnaW5DaGlsZCkge1xuICAgICAgYXdhaXQgcnVuSG9vayhmb3JnZUNvbmZpZywgJ3Bvc3RTdGFydCcsIHNwYXduZWRQbHVnaW5DaGlsZCk7XG4gICAgICByZXR1cm4gc3Bhd25lZFBsdWdpbkNoaWxkO1xuICAgIH1cblxuICAgIGlmICghZWxlY3Ryb25FeGVjUGF0aCkge1xuICAgICAgZWxlY3Ryb25FeGVjUGF0aCA9IGF3YWl0IGxvY2F0ZUVsZWN0cm9uRXhlY3V0YWJsZShkaXIsIHBhY2thZ2VKU09OKTtcbiAgICB9XG5cbiAgICBkKCdFbGVjdHJvbiBiaW5hcnkgcGF0aDonLCBlbGVjdHJvbkV4ZWNQYXRoKTtcblxuICAgIGNvbnN0IHNwYXduT3B0cyA9IHtcbiAgICAgIGN3ZDogZGlyLFxuICAgICAgc3RkaW86ICdpbmhlcml0JyxcbiAgICAgIGVudjoge1xuICAgICAgICAuLi5wcm9jZXNzLmVudixcbiAgICAgICAgLi4uKGVuYWJsZUxvZ2dpbmdcbiAgICAgICAgICA/IHtcbiAgICAgICAgICAgICAgRUxFQ1RST05fRU5BQkxFX0xPR0dJTkc6ICd0cnVlJyxcbiAgICAgICAgICAgICAgRUxFQ1RST05fRU5BQkxFX1NUQUNLX0RVTVBJTkc6ICd0cnVlJyxcbiAgICAgICAgICAgIH1cbiAgICAgICAgICA6IHt9KSxcbiAgICAgIH0gYXMgTm9kZUpTLlByb2Nlc3NFbnYsXG4gICAgfTtcblxuICAgIGlmIChydW5Bc05vZGUpIHtcbiAgICAgIHNwYXduT3B0cy5lbnYuRUxFQ1RST05fUlVOX0FTX05PREUgPSAndHJ1ZSc7XG4gICAgfSBlbHNlIHtcbiAgICAgIGRlbGV0ZSBzcGF3bk9wdHMuZW52LkVMRUNUUk9OX1JVTl9BU19OT0RFO1xuICAgIH1cblxuICAgIGlmIChpbnNwZWN0KSB7XG4gICAgICBhcmdzID0gWyctLWluc3BlY3QnIGFzIHN0cmluZyB8IG51bWJlcl0uY29uY2F0KGFyZ3MpO1xuICAgIH1cblxuICAgIGxldCBzcGF3bmVkITogRWxlY3Ryb25Qcm9jZXNzO1xuXG4gICAgYXdhaXQgYXN5bmNPcmEoJ0xhdW5jaGluZyBBcHBsaWNhdGlvbicsIGFzeW5jICgpID0+IHtcbiAgICAgIHNwYXduZWQgPSBzcGF3bihcbiAgICAgICAgZWxlY3Ryb25FeGVjUGF0aCEsIC8vIGVzbGludC1kaXNhYmxlLWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLW5vbi1udWxsLWFzc2VydGlvblxuICAgICAgICBwcmVmaXhBcmdzLmNvbmNhdChbYXBwUGF0aF0pLmNvbmNhdChhcmdzIGFzIHN0cmluZ1tdKSxcbiAgICAgICAgc3Bhd25PcHRzIGFzIFNwYXduT3B0aW9uc1xuICAgICAgKSBhcyBFbGVjdHJvblByb2Nlc3M7XG4gICAgfSk7XG5cbiAgICBhd2FpdCBydW5Ib29rKGZvcmdlQ29uZmlnLCAncG9zdFN0YXJ0Jywgc3Bhd25lZCk7XG4gICAgcmV0dXJuIHNwYXduZWQ7XG4gIH07XG5cbiAgY29uc3QgZm9yZ2VTcGF3bldyYXBwZXIgPSBhc3luYyAoKSA9PiB7XG4gICAgY29uc3Qgc3Bhd25lZCA9IGF3YWl0IGZvcmdlU3Bhd24oKTtcbiAgICAvLyBXaGVuIHRoZSBjaGlsZCBhcHAgaXMgY2xvc2VkIHdlIHNob3VsZCBzdG9wIGxpc3RlbmluZyBmb3Igc3RkaW5cbiAgICBpZiAoc3Bhd25lZCkge1xuICAgICAgaWYgKGludGVyYWN0aXZlICYmIHByb2Nlc3Muc3RkaW4uaXNQYXVzZWQoKSkge1xuICAgICAgICBwcm9jZXNzLnN0ZGluLnJlc3VtZSgpO1xuICAgICAgfVxuICAgICAgc3Bhd25lZC5vbignZXhpdCcsICgpID0+IHtcbiAgICAgICAgaWYgKHNwYXduZWQucmVzdGFydGVkKSByZXR1cm47XG5cbiAgICAgICAgaWYgKCFwcm9jZXNzLnN0ZGluLmlzUGF1c2VkKCkpIHByb2Nlc3Muc3RkaW4ucGF1c2UoKTtcbiAgICAgIH0pO1xuICAgIH0gZWxzZSBpZiAoaW50ZXJhY3RpdmUgJiYgIXByb2Nlc3Muc3RkaW4uaXNQYXVzZWQoKSkge1xuICAgICAgcHJvY2Vzcy5zdGRpbi5wYXVzZSgpO1xuICAgIH1cblxuICAgIGxhc3RTcGF3bmVkID0gc3Bhd25lZDtcbiAgICByZXR1cm4gbGFzdFNwYXduZWQ7XG4gIH07XG5cbiAgaWYgKGludGVyYWN0aXZlKSB7XG4gICAgcHJvY2Vzcy5zdGRpbi5vbignZGF0YScsIGFzeW5jIChkYXRhKSA9PiB7XG4gICAgICBpZiAoZGF0YS50b1N0cmluZygpLnRyaW0oKSA9PT0gJ3JzJyAmJiBsYXN0U3Bhd25lZCkge1xuICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tY29uc29sZVxuICAgICAgICBjb25zb2xlLmluZm8oY2hhbGsuY3lhbignXFxuUmVzdGFydGluZyBBcHBcXG4nKSk7XG4gICAgICAgIGxhc3RTcGF3bmVkLnJlc3RhcnRlZCA9IHRydWU7XG4gICAgICAgIGxhc3RTcGF3bmVkLmtpbGwoJ1NJR1RFUk0nKTtcbiAgICAgICAgbGFzdFNwYXduZWQuZW1pdCgncmVzdGFydGVkJywgYXdhaXQgZm9yZ2VTcGF3bldyYXBwZXIoKSk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICByZXR1cm4gZm9yZ2VTcGF3bldyYXBwZXIoKTtcbn07XG4iXX0=
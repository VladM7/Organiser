"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
Object.defineProperty(exports, "StartOptions", {
  enumerable: true,
  get: function () {
    return _sharedTypes.StartOptions;
  }
});
exports.default = void 0;

require("source-map-support/register");

require("colors");

var _asyncOra = require("@electron-forge/async-ora");

var _debug = _interopRequireDefault(require("debug"));

var _sharedTypes = require("@electron-forge/shared-types");

var _child_process = require("child_process");

var _electronVersion = require("../util/electron-version");

var _forgeConfig = _interopRequireDefault(require("../util/forge-config"));

var _electronExecutable = _interopRequireDefault(require("../util/electron-executable"));

var _readPackageJson = require("../util/read-package-json");

var _rebuild = _interopRequireDefault(require("../util/rebuild"));

var _resolveDir = _interopRequireDefault(require("../util/resolve-dir"));

var _hook = require("../util/hook");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const d = (0, _debug.default)('electron-forge:start');

var _default = async ({
  dir = process.cwd(),
  appPath = '.',
  interactive = false,
  enableLogging = false,
  args = [],
  runAsNode = false,
  inspect = false
}) => {
  _asyncOra.asyncOra.interactive = interactive;
  await (0, _asyncOra.asyncOra)('Locating Application', async () => {
    const resolvedDir = await (0, _resolveDir.default)(dir);

    if (!resolvedDir) {
      throw new Error('Failed to locate startable Electron application');
    }

    dir = resolvedDir;
  });
  const forgeConfig = await (0, _forgeConfig.default)(dir);
  const packageJSON = await (0, _readPackageJson.readMutatedPackageJson)(dir, forgeConfig);

  if (!packageJSON.version) {
    throw new Error(`Please set your application's 'version' in '${dir}/package.json'.`);
  }

  const platform = process.env.npm_config_platform || process.platform;
  const arch = process.env.npm_config_arch || process.arch;
  await (0, _rebuild.default)(dir, await (0, _electronVersion.getElectronVersion)(dir, packageJSON), platform, arch, forgeConfig.electronRebuildConfig);
  await (0, _hook.runHook)(forgeConfig, 'generateAssets', platform, arch);
  let lastSpawned = null;

  const forgeSpawn = async () => {
    let electronExecPath = null; // If a plugin has taken over the start command let's stop here

    const spawnedPluginChild = await forgeConfig.pluginInterface.overrideStartLogic({
      dir,
      appPath,
      interactive,
      enableLogging,
      args,
      runAsNode,
      inspect
    });
    let prefixArgs = [];

    if (typeof spawnedPluginChild === 'string') {
      electronExecPath = spawnedPluginChild;
    } else if (Array.isArray(spawnedPluginChild)) {
      [electronExecPath, ...prefixArgs] = spawnedPluginChild;
    } else if (spawnedPluginChild) {
      await (0, _hook.runHook)(forgeConfig, 'postStart', spawnedPluginChild);
      return spawnedPluginChild;
    }

    if (!electronExecPath) {
      electronExecPath = await (0, _electronExecutable.default)(dir, packageJSON);
    }

    d('Electron binary path:', electronExecPath);
    const spawnOpts = {
      cwd: dir,
      stdio: 'inherit',
      env: { ...process.env,
        ...(enableLogging ? {
          ELECTRON_ENABLE_LOGGING: 'true',
          ELECTRON_ENABLE_STACK_DUMPING: 'true'
        } : {})
      }
    };

    if (runAsNode) {
      spawnOpts.env.ELECTRON_RUN_AS_NODE = 'true';
    } else {
      delete spawnOpts.env.ELECTRON_RUN_AS_NODE;
    }

    if (inspect) {
      args = ['--inspect'].concat(args);
    }

    let spawned;
    await (0, _asyncOra.asyncOra)('Launching Application', async () => {
      spawned = (0, _child_process.spawn)(electronExecPath, prefixArgs.concat([appPath]).concat(args), spawnOpts);
    });
    await (0, _hook.runHook)(forgeConfig, 'postStart', spawned);
    return spawned;
  };

  const forgeSpawnWrapper = async () => {
    const spawned = await forgeSpawn(); // When the child app is closed we should stop listening for stdin

    if (spawned) {
      if (interactive && process.stdin.isPaused()) {
        process.stdin.resume();
      }

      spawned.on('exit', () => {
        if (spawned.restarted) return;
        if (!process.stdin.isPaused()) process.stdin.pause();
      });
    } else if (interactive && !process.stdin.isPaused()) {
      process.stdin.pause();
    }

    lastSpawned = spawned;
    return lastSpawned;
  };

  if (interactive) {
    process.stdin.on('data', async data => {
      if (data.toString().trim() === 'rs' && lastSpawned) {
        // eslint-disable-next-line no-console
        console.info('\nRestarting App\n'.cyan);
        lastSpawned.restarted = true;
        lastSpawned.kill('SIGTERM');
        lastSpawned.emit('restarted', await forgeSpawnWrapper());
      }
    });
  }

  return forgeSpawnWrapper();
};

exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9hcGkvc3RhcnQudHMiXSwibmFtZXMiOlsiZCIsImRpciIsInByb2Nlc3MiLCJjd2QiLCJhcHBQYXRoIiwiaW50ZXJhY3RpdmUiLCJlbmFibGVMb2dnaW5nIiwiYXJncyIsInJ1bkFzTm9kZSIsImluc3BlY3QiLCJhc3luY09yYSIsInJlc29sdmVkRGlyIiwiRXJyb3IiLCJmb3JnZUNvbmZpZyIsInBhY2thZ2VKU09OIiwidmVyc2lvbiIsInBsYXRmb3JtIiwiZW52IiwibnBtX2NvbmZpZ19wbGF0Zm9ybSIsImFyY2giLCJucG1fY29uZmlnX2FyY2giLCJlbGVjdHJvblJlYnVpbGRDb25maWciLCJsYXN0U3Bhd25lZCIsImZvcmdlU3Bhd24iLCJlbGVjdHJvbkV4ZWNQYXRoIiwic3Bhd25lZFBsdWdpbkNoaWxkIiwicGx1Z2luSW50ZXJmYWNlIiwib3ZlcnJpZGVTdGFydExvZ2ljIiwicHJlZml4QXJncyIsIkFycmF5IiwiaXNBcnJheSIsInNwYXduT3B0cyIsInN0ZGlvIiwiRUxFQ1RST05fRU5BQkxFX0xPR0dJTkciLCJFTEVDVFJPTl9FTkFCTEVfU1RBQ0tfRFVNUElORyIsIkVMRUNUUk9OX1JVTl9BU19OT0RFIiwiY29uY2F0Iiwic3Bhd25lZCIsImZvcmdlU3Bhd25XcmFwcGVyIiwic3RkaW4iLCJpc1BhdXNlZCIsInJlc3VtZSIsIm9uIiwicmVzdGFydGVkIiwicGF1c2UiLCJkYXRhIiwidG9TdHJpbmciLCJ0cmltIiwiY29uc29sZSIsImluZm8iLCJjeWFuIiwia2lsbCIsImVtaXQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUdBOztBQUVBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOzs7O0FBRUEsTUFBTUEsQ0FBQyxHQUFHLG9CQUFNLHNCQUFOLENBQVY7O2VBSWUsT0FBTztBQUNwQkMsRUFBQUEsR0FBRyxHQUFHQyxPQUFPLENBQUNDLEdBQVIsRUFE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Q0FBQ0ssRUFBUixDQUFXLE1BQVgsRUFBbUIsTUFBTTtBQUN2QixZQUFJTCxPQUFPLENBQUNNLFNBQVosRUFBdUI7QUFFdkIsWUFBSSxDQUFDekMsT0FBTyxDQUFDcUMsS0FBUixDQUFjQyxRQUFkLEVBQUwsRUFBK0J0QyxPQUFPLENBQUNxQyxLQUFSLENBQWNLLEtBQWQ7QUFDaEMsT0FKRDtBQUtELEtBVEQsTUFTTyxJQUFJdkMsV0FBVyxJQUFJLENBQUNILE9BQU8sQ0FBQ3FDLEtBQVIsQ0FBY0MsUUFBZCxFQUFwQixFQUE4QztBQUNuRHRDLE1BQUFBLE9BQU8sQ0FBQ3FDLEtBQVIsQ0FBY0ssS0FBZDtBQUNEOztBQUVEdEIsSUFBQUEsV0FBVyxHQUFHZSxPQUFkO0FBQ0EsV0FBT2YsV0FBUDtBQUNELEdBbEJEOztBQW9CQSxNQUFJakIsV0FBSixFQUFpQjtBQUNmSCxJQUFBQSxPQUFPLENBQUNxQyxLQUFSLENBQWNHLEVBQWQsQ0FBaUIsTUFBakIsRUFBeUIsTUFBT0csSUFBUCxJQUFnQjtBQUN2QyxVQUFJQSxJQUFJLENBQUNDLFFBQUwsR0FBZ0JDLElBQWhCLE9BQTJCLElBQTNCLElBQW1DekIsV0FBdkMsRUFBb0Q7QUFDbEQ7QUFDQTBCLFFBQUFBLE9BQU8sQ0FBQ0MsSUFBUixDQUFhLHFCQUFxQkMsSUFBbEM7QUFDQTVCLFFBQUFBLFdBQVcsQ0FBQ3FCLFNBQVosR0FBd0IsSUFBeEI7QUFDQXJCLFFBQUFBLFdBQVcsQ0FBQzZCLElBQVosQ0FBaUIsU0FBakI7QUFDQTdCLFFBQUFBLFdBQVcsQ0FBQzhCLElBQVosQ0FBaUIsV0FBakIsRUFBOEIsTUFBTWQsaUJBQWlCLEVBQXJEO0FBQ0Q7QUFDRixLQVJEO0FBU0Q7O0FBRUQsU0FBT0EsaUJBQWlCLEVBQXhCO0FBQ0QsQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAnY29sb3JzJztcbmltcG9ydCB7IGFzeW5jT3JhIH0gZnJvbSAnQGVsZWN0cm9uLWZvcmdlL2FzeW5jLW9yYSc7XG5pbXBvcnQgZGVidWcgZnJvbSAnZGVidWcnO1xuaW1wb3J0IHtcbiAgRWxlY3Ryb25Qcm9jZXNzLCBGb3JnZUFyY2gsIEZvcmdlUGxhdGZvcm0sIFN0YXJ0T3B0aW9ucyxcbn0gZnJvbSAnQGVsZWN0cm9uLWZvcmdlL3NoYXJlZC10eXBlcyc7XG5pbXBvcnQgeyBzcGF3biwgU3Bhd25PcHRpb25zIH0gZnJvbSAnY2hpbGRfcHJvY2Vzcyc7XG5cbmltcG9ydCB7IGdldEVsZWN0cm9uVmVyc2lvbiB9IGZyb20gJy4uL3V0aWwvZWxlY3Ryb24tdmVyc2lvbic7XG5pbXBvcnQgZ2V0Rm9yZ2VDb25maWcgZnJvbSAnLi4vdXRpbC9mb3JnZS1jb25maWcnO1xuaW1wb3J0IGxvY2F0ZUVsZWN0cm9uRXhlY3V0YWJsZSBmcm9tICcuLi91dGlsL2VsZWN0cm9uLWV4ZWN1dGFibGUnO1xuaW1wb3J0IHsgcmVhZE11dGF0ZWRQYWNrYWdlSnNvbiB9IGZyb20gJy4uL3V0aWwvcmVhZC1wYWNrYWdlLWpzb24nO1xuaW1wb3J0IHJlYnVpbGQgZnJvbSAnLi4vdXRpbC9yZWJ1aWxkJztcbmltcG9ydCByZXNvbHZlRGlyIGZyb20gJy4uL3V0aWwvcmVzb2x2ZS1kaXInO1xuaW1wb3J0IHsgcnVuSG9vayB9IGZyb20gJy4uL3V0aWwvaG9vayc7XG5cbmNvbnN0IGQgPSBkZWJ1ZygnZWxlY3Ryb24tZm9yZ2U6c3RhcnQnKTtcblxuZXhwb3J0IHsgU3RhcnRPcHRpb25zIH07XG5cbmV4cG9ydCBkZWZhdWx0IGFzeW5jICh7XG4gIGRpciA9IHByb2Nlc3MuY3dkKCksXG4gIGFwcFBhdGggPSAnLicsXG4gIGludGVyYWN0aXZlID0gZmFsc2UsXG4gIGVuYWJsZUxvZ2dpbmcgPSBmYWxzZSxcbiAgYXJncyA9IFtdLFxuICBydW5Bc05vZGUgPSBmYWxzZSxcbiAgaW5zcGVjdCA9IGZhbHNlLFxufTogU3RhcnRPcHRpb25zKSA9PiB7XG4gIGFzeW5jT3JhLmludGVyYWN0aXZlID0gaW50ZXJhY3RpdmU7XG5cbiAgYXdhaXQgYXN5bmNPcmEoJ0xvY2F0aW5nIEFwcGxpY2F0aW9uJywgYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IHJlc29sdmVkRGlyID0gYXdhaXQgcmVzb2x2ZURpcihkaXIpO1xuICAgIGlmICghcmVzb2x2ZWREaXIpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignRmFpbGVkIHRvIGxvY2F0ZSBzdGFydGFibGUgRWxlY3Ryb24gYXBwbGljYXRpb24nKTtcbiAgICB9XG4gICAgZGlyID0gcmVzb2x2ZWREaXI7XG4gIH0pO1xuXG4gIGNvbnN0IGZvcmdlQ29uZmlnID0gYXdhaXQgZ2V0Rm9yZ2VDb25maWcoZGlyKTtcbiAgY29uc3QgcGFja2FnZUpTT04gPSBhd2FpdCByZWFkTXV0YXRlZFBhY2thZ2VKc29uKGRpciwgZm9yZ2VDb25maWcpO1xuXG4gIGlmICghcGFja2FnZUpTT04udmVyc2lvbikge1xuICAgIHRocm93IG5ldyBFcnJvcihgUGxlYXNlIHNldCB5b3VyIGFwcGxpY2F0aW9uJ3MgJ3ZlcnNpb24nIGluICcke2Rpcn0vcGFja2FnZS5qc29uJy5gKTtcbiAgfVxuXG4gIGNvbnN0IHBsYXRmb3JtID0gcHJvY2Vzcy5lbnYubnBtX2NvbmZpZ19wbGF0Zm9ybSB8fCBwcm9jZXNzLnBsYXRmb3JtO1xuICBjb25zdCBhcmNoID0gcHJvY2Vzcy5lbnYubnBtX2NvbmZpZ19hcmNoIHx8IHByb2Nlc3MuYXJjaDtcblxuICBhd2FpdCByZWJ1aWxkKFxuICAgIGRpcixcbiAgICBhd2FpdCBnZXRFbGVjdHJvblZlcnNpb24oZGlyLCBwYWNrYWdlSlNPTiksXG4gICAgcGxhdGZvcm0gYXMgRm9yZ2VQbGF0Zm9ybSxcbiAgICBhcmNoIGFzIEZvcmdlQXJjaCxcbiAgICBmb3JnZUNvbmZpZy5lbGVjdHJvblJlYnVpbGRDb25maWcsXG4gICk7XG5cbiAgYXdhaXQgcnVuSG9vayhmb3JnZUNvbmZpZywgJ2dlbmVyYXRlQXNzZXRzJywgcGxhdGZvcm0sIGFyY2gpO1xuXG4gIGxldCBsYXN0U3Bhd25lZDogRWxlY3Ryb25Qcm9jZXNzIHwgbnVsbCA9IG51bGw7XG5cbiAgY29uc3QgZm9yZ2VTcGF3biA9IGFzeW5jICgpID0+IHtcbiAgICBsZXQgZWxlY3Ryb25FeGVjUGF0aDogc3RyaW5nIHwgbnVsbCA9IG51bGw7XG5cbiAgICAvLyBJZiBhIHBsdWdpbiBoYXMgdGFrZW4gb3ZlciB0aGUgc3RhcnQgY29tbWFuZCBsZXQncyBzdG9wIGhlcmVcbiAgICBjb25zdCBzcGF3bmVkUGx1Z2luQ2hpbGQgPSBhd2FpdCBmb3JnZUNvbmZpZy5wbHVnaW5JbnRlcmZhY2Uub3ZlcnJpZGVTdGFydExvZ2ljKHtcbiAgICAgIGRpcixcbiAgICAgIGFwcFBhdGgsXG4gICAgICBpbnRlcmFjdGl2ZSxcbiAgICAgIGVuYWJsZUxvZ2dpbmcsXG4gICAgICBhcmdzLFxuICAgICAgcnVuQXNOb2RlLFxuICAgICAgaW5zcGVjdCxcbiAgICB9KTtcbiAgICBsZXQgcHJlZml4QXJnczogc3RyaW5nW10gPSBbXTtcbiAgICBpZiAodHlwZW9mIHNwYXduZWRQbHVnaW5DaGlsZCA9PT0gJ3N0cmluZycpIHtcbiAgICAgIGVsZWN0cm9uRXhlY1BhdGggPSBzcGF3bmVkUGx1Z2luQ2hpbGQ7XG4gICAgfSBlbHNlIGlmIChBcnJheS5pc0FycmF5KHNwYXduZWRQbHVnaW5DaGlsZCkpIHtcbiAgICAgIFtlbGVjdHJvbkV4ZWNQYXRoLCAuLi5wcmVmaXhBcmdzXSA9IHNwYXduZWRQbHVnaW5DaGlsZDtcbiAgICB9IGVsc2UgaWYgKHNwYXduZWRQbHVnaW5DaGlsZCkge1xuICAgICAgYXdhaXQgcnVuSG9vayhmb3JnZUNvbmZpZywgJ3Bvc3RTdGFydCcsIHNwYXduZWRQbHVnaW5DaGlsZCk7XG4gICAgICByZXR1cm4gc3Bhd25lZFBsdWdpbkNoaWxkO1xuICAgIH1cblxuICAgIGlmICghZWxlY3Ryb25FeGVjUGF0aCkge1xuICAgICAgZWxlY3Ryb25FeGVjUGF0aCA9IGF3YWl0IGxvY2F0ZUVsZWN0cm9uRXhlY3V0YWJsZShkaXIsIHBhY2thZ2VKU09OKTtcbiAgICB9XG5cbiAgICBkKCdFbGVjdHJvbiBiaW5hcnkgcGF0aDonLCBlbGVjdHJvbkV4ZWNQYXRoKTtcblxuICAgIGNvbnN0IHNwYXduT3B0cyA9IHtcbiAgICAgIGN3ZDogZGlyLFxuICAgICAgc3RkaW86ICdpbmhlcml0JyxcbiAgICAgIGVudjogKHtcbiAgICAgICAgLi4ucHJvY2Vzcy5lbnYsXG4gICAgICAgIC4uLihlbmFibGVMb2dnaW5nID8ge1xuICAgICAgICAgIEVMRUNUUk9OX0VOQUJMRV9MT0dHSU5HOiAndHJ1ZScsXG4gICAgICAgICAgRUxFQ1RST05fRU5BQkxFX1NUQUNLX0RVTVBJTkc6ICd0cnVlJyxcbiAgICAgICAgfSA6IHt9KSxcbiAgICAgIH0pIGFzIE5vZGVKUy5Qcm9jZXNzRW52LFxuICAgIH07XG5cbiAgICBpZiAocnVuQXNOb2RlKSB7XG4gICAgICBzcGF3bk9wdHMuZW52LkVMRUNUUk9OX1JVTl9BU19OT0RFID0gJ3RydWUnO1xuICAgIH0gZWxzZSB7XG4gICAgICBkZWxldGUgc3Bhd25PcHRzLmVudi5FTEVDVFJPTl9SVU5fQVNfTk9ERTtcbiAgICB9XG5cbiAgICBpZiAoaW5zcGVjdCkge1xuICAgICAgYXJncyA9IFsnLS1pbnNwZWN0JyBhcyAoc3RyaW5nfG51bWJlcildLmNvbmNhdChhcmdzKTtcbiAgICB9XG5cbiAgICBsZXQgc3Bhd25lZCE6IEVsZWN0cm9uUHJvY2VzcztcblxuICAgIGF3YWl0IGFzeW5jT3JhKCdMYXVuY2hpbmcgQXBwbGljYXRpb24nLCBhc3luYyAoKSA9PiB7XG4gICAgICBzcGF3bmVkID0gc3Bhd24oXG4gICAgICAgIGVsZWN0cm9uRXhlY1BhdGghLFxuICAgICAgICBwcmVmaXhBcmdzLmNvbmNhdChbYXBwUGF0aF0pLmNvbmNhdChhcmdzIGFzIHN0cmluZ1tdKSxcbiAgICAgICAgc3Bhd25PcHRzIGFzIFNwYXduT3B0aW9ucyxcbiAgICAgICkgYXMgRWxlY3Ryb25Qcm9jZXNzO1xuICAgIH0pO1xuXG4gICAgYXdhaXQgcnVuSG9vayhmb3JnZUNvbmZpZywgJ3Bvc3RTdGFydCcsIHNwYXduZWQpO1xuICAgIHJldHVybiBzcGF3bmVkO1xuICB9O1xuXG4gIGNvbnN0IGZvcmdlU3Bhd25XcmFwcGVyID0gYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IHNwYXduZWQgPSBhd2FpdCBmb3JnZVNwYXduKCk7XG4gICAgLy8gV2hlbiB0aGUgY2hpbGQgYXBwIGlzIGNsb3NlZCB3ZSBzaG91bGQgc3RvcCBsaXN0ZW5pbmcgZm9yIHN0ZGluXG4gICAgaWYgKHNwYXduZWQpIHtcbiAgICAgIGlmIChpbnRlcmFjdGl2ZSAmJiBwcm9jZXNzLnN0ZGluLmlzUGF1c2VkKCkpIHtcbiAgICAgICAgcHJvY2Vzcy5zdGRpbi5yZXN1bWUoKTtcbiAgICAgIH1cbiAgICAgIHNwYXduZWQub24oJ2V4aXQnLCAoKSA9PiB7XG4gICAgICAgIGlmIChzcGF3bmVkLnJlc3RhcnRlZCkgcmV0dXJuO1xuXG4gICAgICAgIGlmICghcHJvY2Vzcy5zdGRpbi5pc1BhdXNlZCgpKSBwcm9jZXNzLnN0ZGluLnBhdXNlKCk7XG4gICAgICB9KTtcbiAgICB9IGVsc2UgaWYgKGludGVyYWN0aXZlICYmICFwcm9jZXNzLnN0ZGluLmlzUGF1c2VkKCkpIHtcbiAgICAgIHByb2Nlc3Muc3RkaW4ucGF1c2UoKTtcbiAgICB9XG5cbiAgICBsYXN0U3Bhd25lZCA9IHNwYXduZWQ7XG4gICAgcmV0dXJuIGxhc3RTcGF3bmVkO1xuICB9O1xuXG4gIGlmIChpbnRlcmFjdGl2ZSkge1xuICAgIHByb2Nlc3Muc3RkaW4ub24oJ2RhdGEnLCBhc3luYyAoZGF0YSkgPT4ge1xuICAgICAgaWYgKGRhdGEudG9TdHJpbmcoKS50cmltKCkgPT09ICdycycgJiYgbGFzdFNwYXduZWQpIHtcbiAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLWNvbnNvbGVcbiAgICAgICAgY29uc29sZS5pbmZvKCdcXG5SZXN0YXJ0aW5nIEFwcFxcbicuY3lhbik7XG4gICAgICAgIGxhc3RTcGF3bmVkLnJlc3RhcnRlZCA9IHRydWU7XG4gICAgICAgIGxhc3RTcGF3bmVkLmtpbGwoJ1NJR1RFUk0nKTtcbiAgICAgICAgbGFzdFNwYXduZWQuZW1pdCgncmVzdGFydGVkJywgYXdhaXQgZm9yZ2VTcGF3bldyYXBwZXIoKSk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICByZXR1cm4gZm9yZ2VTcGF3bldyYXBwZXIoKTtcbn07XG4iXX0=
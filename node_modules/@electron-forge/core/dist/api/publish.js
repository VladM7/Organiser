"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _asyncOra = require("@electron-forge/async-ora");

var _chalk = _interopRequireDefault(require("chalk"));

var _debug = _interopRequireDefault(require("debug"));

var _fsExtra = _interopRequireDefault(require("fs-extra"));

var _path = _interopRequireDefault(require("path"));

var _forgeConfig = _interopRequireDefault(require("../util/forge-config"));

var _resolveDir = _interopRequireDefault(require("../util/resolve-dir"));

var _publishState = _interopRequireDefault(require("../util/publish-state"));

var _outDir = _interopRequireDefault(require("../util/out-dir"));

var _make = _interopRequireDefault(require("./make"));

var _requireSearch = _interopRequireDefault(require("../util/require-search"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const d = (0, _debug.default)('electron-forge:publish');

const publish = async ({
  dir = process.cwd(),
  interactive = false,
  makeOptions = {},
  publishTargets = undefined,
  dryRun = false,
  dryRunResume = false,
  makeResults = undefined,
  outDir
}) => {
  _asyncOra.asyncOra.interactive = interactive;

  if (dryRun && dryRunResume) {
    throw new Error("Can't dry run and resume a dry run at the same time");
  }

  if (dryRunResume && makeResults) {
    throw new Error("Can't resume a dry run and use the provided makeResults at the same time");
  }

  const forgeConfig = await (0, _forgeConfig.default)(dir);
  const calculatedOutDir = outDir || (0, _outDir.default)(dir, forgeConfig);

  const dryRunDir = _path.default.resolve(calculatedOutDir, 'publish-dry-run');

  if (dryRunResume) {
    d('attempting to resume from dry run');
    const publishes = await _publishState.default.loadFromDirectory(dryRunDir, dir);

    for (const publishStates of publishes) {
      d('publishing for given state set');
      await publish({
        dir,
        interactive,
        publishTargets,
        makeOptions,
        dryRun: false,
        dryRunResume: false,
        makeResults: publishStates.map(({
          state
        }) => state)
      });
    }

    return;
  }

  if (!makeResults) {
    d('triggering make');
    makeResults = await (0, _make.default)({
      dir,
      interactive,
      ...makeOptions
    });
  } else {
    // Restore values from dry run
    d('restoring publish settings from dry run');

    for (const makeResult of makeResults) {
      makeOptions.platform = makeResult.platform;
      makeOptions.arch = makeResult.arch;

      for (const makePath of makeResult.artifacts) {
        if (!(await _fsExtra.default.pathExists(makePath))) {
          throw new Error(`Attempted to resume a dry run but an artifact (${makePath}) could not be found`);
        }
      }
    }
  }

  if (dryRun) {
    d('saving results of make in dry run state', makeResults);
    await _fsExtra.default.remove(dryRunDir);
    await _publishState.default.saveToDirectory(dryRunDir, makeResults, dir);
    return;
  }

  const resolvedDir = await (0, _resolveDir.default)(dir);

  if (!resolvedDir) {
    throw new Error('Failed to locate publishable Electron application');
  }

  dir = resolvedDir; // const testPlatform = makeOptions.platform || process.platform as ForgePlatform;

  if (!publishTargets) {
    publishTargets = forgeConfig.publishers || []; // .filter(publisher => (typeof publisher !== 'string' && publisher.platforms)
    //   ? publisher.platforms.includes(testPlatform) : true);
  }

  publishTargets = publishTargets.map(target => {
    if (typeof target === 'string') {
      return (forgeConfig.publishers || []).find(p => {
        if (typeof p === 'string') return false; // eslint-disable-next-line no-underscore-dangle

        if (p.__isElectronForgePublisher) return false;
        return p.name === target;
      }) || {
        name: target
      };
    }

    return target;
  });

  for (const publishTarget of publishTargets) {
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    let publisher; // eslint-disable-next-line no-underscore-dangle

    if (publishTarget.__isElectronForgePublisher) {
      // eslint-disable-next-line @typescript-eslint/no-explicit-any
      publisher = publishTarget;
    } else {
      const resolvablePublishTarget = publishTarget; // eslint-disable-next-line @typescript-eslint/no-explicit-any

      let PublisherClass;
      await (0, _asyncOra.asyncOra)(`Resolving publish target: ${_chalk.default.cyan(resolvablePublishTarget.name)}`, async () => {
        // eslint-disable-line no-loop-func
        PublisherClass = (0, _requireSearch.default)(dir, [resolvablePublishTarget.name]);

        if (!PublisherClass) {
          throw new Error(`Could not find a publish target with the name: ${resolvablePublishTarget.name}. Make sure it's listed in the devDependencies of your package.json`);
        }
      });
      publisher = new PublisherClass(resolvablePublishTarget.config || {}, resolvablePublishTarget.platforms);
    }

    await publisher.publish({
      dir,
      makeResults,
      forgeConfig
    });
  }
};

var _default = publish;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9hcGkvcHVibGlzaC50cyJdLCJuYW1lcyI6WyJkIiwicHVibGlzaCIsImRpciIsInByb2Nlc3MiLCJjd2QiLCJpbnRlcmFjdGl2ZSIsIm1ha2VPcHRpb25zIiwicHVibGlzaFRhcmdldHMiLCJ1bmRlZmluZWQiLCJkcnlSdW4iLCJkcnlSdW5SZXN1bWUiLCJtYWtlUmVzdWx0cyIsIm91dERpciIsImFzeW5jT3JhIiwiRXJyb3IiLCJmb3JnZUNvbmZpZyIsImNhbGN1bGF0ZWRPdXREaXIiLCJkcnlSdW5EaXIiLCJwYXRoIiwicmVzb2x2ZSIsInB1Ymxpc2hlcyIsIlB1Ymxpc2hTdGF0ZSIsImxvYWRGcm9tRGlyZWN0b3J5IiwicHVibGlzaFN0YXRlcyIsIm1hcCIsInN0YXRlIiwibWFrZVJlc3VsdCIsInBsYXRmb3JtIiwiYXJjaCIsIm1ha2VQYXRoIiwiYXJ0aWZhY3RzIiwiZnMiLCJwYXRoRXhpc3RzIiwicmVtb3ZlIiwic2F2ZVRvRGlyZWN0b3J5IiwicmVzb2x2ZWREaXIiLCJwdWJsaXNoZXJzIiwidGFyZ2V0IiwiZmluZCIsInAiLCJfX2lzRWxlY3Ryb25Gb3JnZVB1Ymxpc2hlciIsIm5hbWUiLCJwdWJsaXNoVGFyZ2V0IiwicHVibGlzaGVyIiwicmVzb2x2YWJsZVB1Ymxpc2hUYXJnZXQiLCJQdWJsaXNoZXJDbGFzcyIsImNoYWxrIiwiY3lhbiIsImNvbmZpZyIsInBsYXRmb3JtcyJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBQUE7O0FBVUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUE7O0FBQ0E7Ozs7QUFFQSxNQUFNQSxDQUFDLEdBQUcsb0JBQU0sd0JBQU4sQ0FBVjs7QUF3Q0EsTUFBTUMsT0FBTyxHQUFHLE9BQU87QUFDckJDLEVBQUFBLEdBQUcsR0FBR0MsT0FBTyxDQUFDQyxHQUFSLEVBRGU7QUFFckJDLEVBQUFBLFdBQVcsR0FBRyxLQUZPO0FBR3JCQyxFQUFBQSxXQUFXLEdBQUcs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WUFBWTtBQUNsRztBQUNBSSxRQUFBQSxjQUFjLEdBQUcsNEJBQWMzQyxHQUFkLEVBQW1CLENBQUMwQyx1QkFBdUIsQ0FBQ0gsSUFBekIsQ0FBbkIsQ0FBakI7O0FBQ0EsWUFBSSxDQUFDSSxjQUFMLEVBQXFCO0FBQ25CLGdCQUFNLElBQUkvQixLQUFKLENBQ0gsa0RBQWlEOEIsdUJBQXVCLENBQUNILElBQUsscUVBRDNFLENBQU47QUFHRDtBQUNGLE9BUkssQ0FBTjtBQVVBRSxNQUFBQSxTQUFTLEdBQUcsSUFBSUUsY0FBSixDQUFtQkQsdUJBQXVCLENBQUNJLE1BQXhCLElBQWtDLEVBQXJELEVBQXlESix1QkFBdUIsQ0FBQ0ssU0FBakYsQ0FBWjtBQUNEOztBQUVELFVBQU1OLFNBQVMsQ0FBQzFDLE9BQVYsQ0FBa0I7QUFDdEJDLE1BQUFBLEdBRHNCO0FBRXRCUyxNQUFBQSxXQUZzQjtBQUd0QkksTUFBQUE7QUFIc0IsS0FBbEIsQ0FBTjtBQUtEO0FBQ0YsQ0FoSUQ7O2VBa0llZCxPIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgYXN5bmNPcmEgfSBmcm9tICdAZWxlY3Ryb24tZm9yZ2UvYXN5bmMtb3JhJztcbmltcG9ydCB7XG4gIElGb3JnZVJlc29sdmFibGVQdWJsaXNoZXIsXG4gIElGb3JnZVB1Ymxpc2hlcixcbiAgRm9yZ2VDb25maWdQdWJsaXNoZXIsXG4gIEZvcmdlTWFrZVJlc3VsdCxcbiAgLy8gRm9yZ2VQbGF0Zm9ybSxcbn0gZnJvbSAnQGVsZWN0cm9uLWZvcmdlL3NoYXJlZC10eXBlcyc7XG5pbXBvcnQgUHVibGlzaGVyQmFzZSBmcm9tICdAZWxlY3Ryb24tZm9yZ2UvcHVibGlzaGVyLWJhc2UnO1xuXG5pbXBvcnQgY2hhbGsgZnJvbSAnY2hhbGsnO1xuaW1wb3J0IGRlYnVnIGZyb20gJ2RlYnVnJztcbmltcG9ydCBmcyBmcm9tICdmcy1leHRyYSc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcblxuaW1wb3J0IGdldEZvcmdlQ29uZmlnIGZyb20gJy4uL3V0aWwvZm9yZ2UtY29uZmlnJztcbmltcG9ydCByZXNvbHZlRGlyIGZyb20gJy4uL3V0aWwvcmVzb2x2ZS1kaXInO1xuaW1wb3J0IFB1Ymxpc2hTdGF0ZSBmcm9tICcuLi91dGlsL3B1Ymxpc2gtc3RhdGUnO1xuaW1wb3J0IGdldEN1cnJlbnRPdXREaXIgZnJvbSAnLi4vdXRpbC9vdXQtZGlyJztcblxuaW1wb3J0IG1ha2UsIHsgTWFrZU9wdGlvbnMgfSBmcm9tICcuL21ha2UnO1xuaW1wb3J0IHJlcXVpcmVTZWFyY2ggZnJvbSAnLi4vdXRpbC9yZXF1aXJlLXNlYXJjaCc7XG5cbmNvbnN0IGQgPSBkZWJ1ZygnZWxlY3Ryb24tZm9yZ2U6cHVibGlzaCcpO1xuXG5leHBvcnQgaW50ZXJmYWNlIFB1Ymxpc2hPcHRpb25zIHtcbiAgLyoqXG4gICAqIFRoZSBwYXRoIHRvIHRoZSBhcHAgdG8gYmUgcHVibGlzaGVkXG4gICAqL1xuICBkaXI/OiBzdHJpbmc7XG4gIC8qKlxuICAgKiBXaGV0aGVyIHRvIHVzZSBzZW5zaWJsZSBkZWZhdWx0cyBvciBwcm9tcHQgdGhlIHVzZXIgdmlzdWFsbHlcbiAgICovXG4gIGludGVyYWN0aXZlPzogYm9vbGVhbjtcbiAgLyoqXG4gICAqIFRoZSBwdWJsaXNoIHRhcmdldHMsIGJ5IGRlZmF1bHQgcHVsbGVkIGZyb20gZm9yZ2UgY29uZmlnLCBzZXQgdGhpcyBwcm9wIHRvXG4gICAqIG92ZXJyaWRlIHRoYXQgbGlzdFxuICAgKi9cbiAgcHVibGlzaFRhcmdldHM/OiBGb3JnZUNvbmZpZ1B1Ymxpc2hlcltdO1xuICAvKipcbiAgICogT3B0aW9ucyBvYmplY3QgdG8gcGFzc2VkIHRocm91Z2ggdG8gbWFrZSgpXG4gICAqL1xuICBtYWtlT3B0aW9ucz86IE1ha2VPcHRpb25zO1xuICAvKipcbiAgICogVGhlIHBhdGggdG8gdGhlIGRpcmVjdG9yeSBjb250YWluaW5nIGdlbmVyYXRlZCBkaXN0cmlidXRhYmxlc1xuICAgKi9cbiAgb3V0RGlyPzogc3RyaW5nO1xuICAvKipcbiAgICogV2hldGhlciB0byBnZW5lcmF0ZSBkcnkgcnVuIG1ldGEgZGF0YSBidXQgbm90IGFjdHVhbGx5IHB1Ymxpc2hcbiAgICovXG4gIGRyeVJ1bj86IGJvb2xlYW47XG4gIC8qKlxuICAgKiBXaGV0aGVyIG9yIG5vdCB0byBhdHRlbXB0IHRvIHJlc3VtZSBhIHByZXZpb3VzbHkgc2F2ZWQgYGRyeVJ1bmAgYW5kIHB1Ymxpc2hcbiAgICpcbiAgICogWW91IGNhbid0IHVzZSB0aGlzIGNvbWJpbmF0aW9uIGF0IHRoZSBzYW1lIHRpbWUgYXMgZHJ5UnVuPXRydWVcbiAgICovXG4gIGRyeVJ1blJlc3VtZT86IGJvb2xlYW47XG4gIC8qKlxuICAgKiBQcm92aWRlIHJlc3VsdHMgZnJvbSBtYWtlIHNvIHRoYXQgdGhlIHB1Ymxpc2ggc3RlcCBkb2Vzbid0IHJ1biBtYWtlIGl0c2VsZlxuICAgKi9cbiAgbWFrZVJlc3VsdHM/OiBGb3JnZU1ha2VSZXN1bHRbXTtcbn1cblxuY29uc3QgcHVibGlzaCA9IGFzeW5jICh7XG4gIGRpciA9IHByb2Nlc3MuY3dkKCksXG4gIGludGVyYWN0aXZlID0gZmFsc2UsXG4gIG1ha2VPcHRpb25zID0ge30sXG4gIHB1Ymxpc2hUYXJnZXRzID0gdW5kZWZpbmVkLFxuICBkcnlSdW4gPSBmYWxzZSxcbiAgZHJ5UnVuUmVzdW1lID0gZmFsc2UsXG4gIG1ha2VSZXN1bHRzID0gdW5kZWZpbmVkLFxuICBvdXREaXIsXG59OiBQdWJsaXNoT3B0aW9ucyk6IFByb21pc2U8dm9pZD4gPT4ge1xuICBhc3luY09yYS5pbnRlcmFjdGl2ZSA9IGludGVyYWN0aXZlO1xuXG4gIGlmIChkcnlSdW4gJiYgZHJ5UnVuUmVzdW1lKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFwiQ2FuJ3QgZHJ5IHJ1biBhbmQgcmVzdW1lIGEgZHJ5IHJ1biBhdCB0aGUgc2FtZSB0aW1lXCIpO1xuICB9XG4gIGlmIChkcnlSdW5SZXN1bWUgJiYgbWFrZVJlc3VsdHMpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXCJDYW4ndCByZXN1bWUgYSBkcnkgcnVuIGFuZCB1c2UgdGhlIHByb3ZpZGVkIG1ha2VSZXN1bHRzIGF0IHRoZSBzYW1lIHRpbWVcIik7XG4gIH1cblxuICBjb25zdCBmb3JnZUNvbmZpZyA9IGF3YWl0IGdldEZvcmdlQ29uZmlnKGRpcik7XG5cbiAgY29uc3QgY2FsY3VsYXRlZE91dERpciA9IG91dERpciB8fCBnZXRDdXJyZW50T3V0RGlyKGRpciwgZm9yZ2VDb25maWcpO1xuICBjb25zdCBkcnlSdW5EaXIgPSBwYXRoLnJlc29sdmUoY2FsY3VsYXRlZE91dERpciwgJ3B1Ymxpc2gtZHJ5LXJ1bicpO1xuXG4gIGlmIChkcnlSdW5SZXN1bWUpIHtcbiAgICBkKCdhdHRlbXB0aW5nIHRvIHJlc3VtZSBmcm9tIGRyeSBydW4nKTtcbiAgICBjb25zdCBwdWJsaXNoZXMgPSBhd2FpdCBQdWJsaXNoU3RhdGUubG9hZEZyb21EaXJlY3RvcnkoZHJ5UnVuRGlyLCBkaXIpO1xuICAgIGZvciAoY29uc3QgcHVibGlzaFN0YXRlcyBvZiBwdWJsaXNoZXMpIHtcbiAgICAgIGQoJ3B1Ymxpc2hpbmcgZm9yIGdpdmVuIHN0YXRlIHNldCcpO1xuICAgICAgYXdhaXQgcHVibGlzaCh7XG4gICAgICAgIGRpcixcbiAgICAgICAgaW50ZXJhY3RpdmUsXG4gICAgICAgIHB1Ymxpc2hUYXJnZXRzLFxuICAgICAgICBtYWtlT3B0aW9ucyxcbiAgICAgICAgZHJ5UnVuOiBmYWxzZSxcbiAgICAgICAgZHJ5UnVuUmVzdW1lOiBmYWxzZSxcbiAgICAgICAgbWFrZVJlc3VsdHM6IHB1Ymxpc2hTdGF0ZXMubWFwKCh7IHN0YXRlIH0pID0+IHN0YXRlKSxcbiAgICAgIH0pO1xuICAgIH1cbiAgICByZXR1cm47XG4gIH1cblxuICBpZiAoIW1ha2VSZXN1bHRzKSB7XG4gICAgZCgndHJpZ2dlcmluZyBtYWtlJyk7XG4gICAgbWFrZVJlc3VsdHMgPSBhd2FpdCBtYWtlKHtcbiAgICAgIGRpcixcbiAgICAgIGludGVyYWN0aXZlLFxuICAgICAgLi4ubWFrZU9wdGlvbnMsXG4gICAgfSk7XG4gIH0gZWxzZSB7XG4gICAgLy8gUmVzdG9yZSB2YWx1ZXMgZnJvbSBkcnkgcnVuXG4gICAgZCgncmVzdG9yaW5nIHB1Ymxpc2ggc2V0dGluZ3MgZnJvbSBkcnkgcnVuJyk7XG5cbiAgICBmb3IgKGNvbnN0IG1ha2VSZXN1bHQgb2YgbWFrZVJlc3VsdHMpIHtcbiAgICAgIG1ha2VPcHRpb25zLnBsYXRmb3JtID0gbWFrZVJlc3VsdC5wbGF0Zm9ybTtcbiAgICAgIG1ha2VPcHRpb25zLmFyY2ggPSBtYWtlUmVzdWx0LmFyY2g7XG5cbiAgICAgIGZvciAoY29uc3QgbWFrZVBhdGggb2YgbWFrZVJlc3VsdC5hcnRpZmFjdHMpIHtcbiAgICAgICAgaWYgKCEoYXdhaXQgZnMucGF0aEV4aXN0cyhtYWtlUGF0aCkpKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBBdHRlbXB0ZWQgdG8gcmVzdW1lIGEgZHJ5IHJ1biBidXQgYW4gYXJ0aWZhY3QgKCR7bWFrZVBhdGh9KSBjb3VsZCBub3QgYmUgZm91bmRgKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGlmIChkcnlSdW4pIHtcbiAgICBkKCdzYXZpbmcgcmVzdWx0cyBvZiBtYWtlIGluIGRyeSBydW4gc3RhdGUnLCBtYWtlUmVzdWx0cyk7XG4gICAgYXdhaXQgZnMucmVtb3ZlKGRyeVJ1bkRpcik7XG4gICAgYXdhaXQgUHVibGlzaFN0YXRlLnNhdmVUb0RpcmVjdG9yeShkcnlSdW5EaXIsIG1ha2VSZXN1bHRzLCBkaXIpO1xuICAgIHJldHVybjtcbiAgfVxuXG4gIGNvbnN0IHJlc29sdmVkRGlyID0gYXdhaXQgcmVzb2x2ZURpcihkaXIpO1xuICBpZiAoIXJlc29sdmVkRGlyKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdGYWlsZWQgdG8gbG9jYXRlIHB1Ymxpc2hhYmxlIEVsZWN0cm9uIGFwcGxpY2F0aW9uJyk7XG4gIH1cbiAgZGlyID0gcmVzb2x2ZWREaXI7XG5cbiAgLy8gY29uc3QgdGVzdFBsYXRmb3JtID0gbWFrZU9wdGlvbnMucGxhdGZvcm0gfHwgcHJvY2Vzcy5wbGF0Zm9ybSBhcyBGb3JnZVBsYXRmb3JtO1xuICBpZiAoIXB1Ymxpc2hUYXJnZXRzKSB7XG4gICAgcHVibGlzaFRhcmdldHMgPSBmb3JnZUNvbmZpZy5wdWJsaXNoZXJzIHx8IFtdO1xuICAgIC8vIC5maWx0ZXIocHVibGlzaGVyID0+ICh0eXBlb2YgcHVibGlzaGVyICE9PSAnc3RyaW5nJyAmJiBwdWJsaXNoZXIucGxhdGZvcm1zKVxuICAgIC8vICAgPyBwdWJsaXNoZXIucGxhdGZvcm1zLmluY2x1ZGVzKHRlc3RQbGF0Zm9ybSkgOiB0cnVlKTtcbiAgfVxuICBwdWJsaXNoVGFyZ2V0cyA9IChwdWJsaXNoVGFyZ2V0cyBhcyBGb3JnZUNvbmZpZ1B1Ymxpc2hlcltdKS5tYXAoKHRhcmdldCkgPT4ge1xuICAgIGlmICh0eXBlb2YgdGFyZ2V0ID09PSAnc3RyaW5nJykge1xuICAgICAgcmV0dXJuIChcbiAgICAgICAgKGZvcmdlQ29uZmlnLnB1Ymxpc2hlcnMgfHwgW10pLmZpbmQoKHA6IEZvcmdlQ29uZmlnUHVibGlzaGVyKSA9PiB7XG4gICAgICAgICAgaWYgKHR5cGVvZiBwID09PSAnc3RyaW5nJykgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby11bmRlcnNjb3JlLWRhbmdsZVxuICAgICAgICAgIGlmICgocCBhcyBJRm9yZ2VQdWJsaXNoZXIpLl9faXNFbGVjdHJvbkZvcmdlUHVibGlzaGVyKSByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgcmV0dXJuIChwIGFzIElGb3JnZVJlc29sdmFibGVQdWJsaXNoZXIpLm5hbWUgPT09IHRhcmdldDtcbiAgICAgICAgfSkgfHwgeyBuYW1lOiB0YXJnZXQgfVxuICAgICAgKTtcbiAgICB9XG4gICAgcmV0dXJuIHRhcmdldDtcbiAgfSk7XG5cbiAgZm9yIChjb25zdCBwdWJsaXNoVGFyZ2V0IG9mIHB1Ymxpc2hUYXJnZXRzKSB7XG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1leHBsaWNpdC1hbnlcbiAgICBsZXQgcHVibGlzaGVyOiBQdWJsaXNoZXJCYXNlPGFueT47XG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXVuZGVyc2NvcmUtZGFuZ2xlXG4gICAgaWYgKChwdWJsaXNoVGFyZ2V0IGFzIElGb3JnZVB1Ymxpc2hlcikuX19pc0VsZWN0cm9uRm9yZ2VQdWJsaXNoZXIpIHtcbiAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tZXhwbGljaXQtYW55XG4gICAgICBwdWJsaXNoZXIgPSBwdWJsaXNoVGFyZ2V0IGFzIFB1Ymxpc2hlckJhc2U8YW55PjtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3QgcmVzb2x2YWJsZVB1Ymxpc2hUYXJnZXQgPSBwdWJsaXNoVGFyZ2V0IGFzIElGb3JnZVJlc29sdmFibGVQdWJsaXNoZXI7XG4gICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLWV4cGxpY2l0LWFueVxuICAgICAgbGV0IFB1Ymxpc2hlckNsYXNzOiBhbnk7XG4gICAgICBhd2FpdCBhc3luY09yYShgUmVzb2x2aW5nIHB1Ymxpc2ggdGFyZ2V0OiAke2NoYWxrLmN5YW4ocmVzb2x2YWJsZVB1Ymxpc2hUYXJnZXQubmFtZSl9YCwgYXN5bmMgKCkgPT4ge1xuICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIG5vLWxvb3AtZnVuY1xuICAgICAgICBQdWJsaXNoZXJDbGFzcyA9IHJlcXVpcmVTZWFyY2goZGlyLCBbcmVzb2x2YWJsZVB1Ymxpc2hUYXJnZXQubmFtZV0pO1xuICAgICAgICBpZiAoIVB1Ymxpc2hlckNsYXNzKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgICAgYENvdWxkIG5vdCBmaW5kIGEgcHVibGlzaCB0YXJnZXQgd2l0aCB0aGUgbmFtZTogJHtyZXNvbHZhYmxlUHVibGlzaFRhcmdldC5uYW1lfS4gTWFrZSBzdXJlIGl0J3MgbGlzdGVkIGluIHRoZSBkZXZEZXBlbmRlbmNpZXMgb2YgeW91ciBwYWNrYWdlLmpzb25gXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG5cbiAgICAgIHB1Ymxpc2hlciA9IG5ldyBQdWJsaXNoZXJDbGFzcyhyZXNvbHZhYmxlUHVibGlzaFRhcmdldC5jb25maWcgfHwge30sIHJlc29sdmFibGVQdWJsaXNoVGFyZ2V0LnBsYXRmb3Jtcyk7XG4gICAgfVxuXG4gICAgYXdhaXQgcHVibGlzaGVyLnB1Ymxpc2goe1xuICAgICAgZGlyLFxuICAgICAgbWFrZVJlc3VsdHMsXG4gICAgICBmb3JnZUNvbmZpZyxcbiAgICB9KTtcbiAgfVxufTtcblxuZXhwb3J0IGRlZmF1bHQgcHVibGlzaDtcbiJdfQ==
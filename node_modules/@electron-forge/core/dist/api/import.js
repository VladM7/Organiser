"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _asyncOra = require("@electron-forge/async-ora");

var _templateBase = _interopRequireDefault(require("@electron-forge/template-base"));

var _chalk = _interopRequireDefault(require("chalk"));

var _debug = _interopRequireDefault(require("debug"));

var _fsExtra = _interopRequireDefault(require("fs-extra"));

var _lodash = require("lodash");

var _path = _interopRequireDefault(require("path"));

var _initGit = _interopRequireDefault(require("./init-scripts/init-git"));

var _initNpm = require("./init-scripts/init-npm");

var _electronVersion = require("../util/electron-version");

var _forgeConfig = require("../util/forge-config");

var _messages = require("../util/messages");

var _installDependencies = _interopRequireWildcard(require("../util/install-dependencies"));

var _readPackageJson = require("../util/read-package-json");

var _upgradeForgeConfig = _interopRequireWildcard(require("../util/upgrade-forge-config"));

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function (nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const d = (0, _debug.default)('electron-forge:import');

var _default = async ({
  dir = process.cwd(),
  interactive = false,
  confirmImport,
  shouldContinueOnExisting,
  shouldRemoveDependency,
  shouldUpdateScript,
  outDir
}) => {
  const calculatedOutDir = outDir || 'out';
  _asyncOra.asyncOra.interactive = interactive;
  d(`Attempting to import project in: ${dir}`);

  if (!(await _fsExtra.default.pathExists(dir)) || !(await _fsExtra.default.pathExists(_path.default.resolve(dir, 'package.json')))) {
    throw new Error(`We couldn't find a project in: ${dir}`);
  } // eslint-disable-next-line max-len


  if (typeof confirmImport === 'function') {
    if (!(await confirmImport())) {
      // TODO: figure out if we can just return early here
      // eslint-disable-next-line no-process-exit
      process.exit(0);
    }
  }

  await (0, _initGit.default)(dir);
  const importDeps = [].concat(_initNpm.deps);
  let importDevDeps = [].concat(_initNpm.devDeps);
  let importExactDevDeps = [].concat(_initNpm.exactDevDeps);
  let packageJSON = await (0, _readPackageJson.readRawPackageJson)(dir);

  if (packageJSON.config && packageJSON.config.forge) {
    if (packageJSON.config.forge.makers) {
      (0, _messages.warn)(interactive, _chalk.default.green('It looks like this project is already configured for Electron Forge'));

      if (typeof shouldContinueOnExisting === 'function') {
        if (!(await shouldContinueOnExisting())) {
          // TODO: figure out if we can just return early here
          // eslint-disable-next-line no-process-exit
          process.exit(0);
        }
      }
    } else if (typeof packageJSON.config.forge === 'string') {
      (0, _messages.warn)(interactive, _chalk.default.yellow("We can't tell if the Electron Forge config is compatible because it's in an external JavaScript file, not trying to convert it and continuing anyway"));
    } else {
      d('Upgrading an Electron Forge < 6 project');
      packageJSON.config.forge = (0, _upgradeForgeConfig.default)(packageJSON.config.forge);
      importDevDeps = (0, _upgradeForgeConfig.updateUpgradedForgeDevDeps)(packageJSON, importDevDeps);
    }
  }

  packageJSON.dependencies = packageJSON.dependencies || {};
  packageJSON.devDependencies = packageJSON.devDependencies || {};
  [importDevDeps, importExactDevDeps] = (0, _electronVersion.updateElectronDependency)(packageJSON, importDevDeps, importExactDevDeps);
  const keys = Object.keys(packageJSON.dependencies).concat(Object.keys(packageJSON.devDependencies));
  const buildToolPackages = {
    '@electron/get': 'already uses this module as a transitive dependency',
    'electron-builder': 'provides mostly equivalent functionality',
    'electron-download': 'already uses this module as a transitive dependency',
    'electron-forge': 'replaced with @electron-forge/cli',
    'electron-installer-debian': 'already uses this module as a transitive dependency',
    'electron-installer-dmg': 'already uses this module as a transitive dependency',
    'electron-installer-flatpak': 'already uses this module as a transitive dependency',
    'electron-installer-redhat': 'already uses this module as a transitive dependency',
    'electron-osx-sign': 'already uses this module as a transitive dependency',
    'electron-packager': 'already uses this module as a transitive dependency',
    'electron-winstaller': 'already uses this module as a transitive dependency'
  };

  for (const key of keys) {
    if (buildToolPackages[key]) {
      // eslint-disable-next-line @typescript-eslint/no-non-null-assertion
      const explanation = buildToolPackages[key]; // eslint-disable-next-line max-len

      let remove = true;

      if (typeof shouldRemoveDependency === 'function') {
        remove = await shouldRemoveDependency(key, explanation);
      }

      if (remove) {
        delete packageJSON.dependencies[key];
        delete packageJSON.devDependencies[key];
      }
    }
  }

  packageJSON.scripts = packageJSON.scripts || {};
  d('reading current scripts object:', packageJSON.scripts);

  const updatePackageScript = async (scriptName, newValue) => {
    if (packageJSON.scripts[scriptName] !== newValue) {
      // eslint-disable-next-line max-len
      let update = true;

      if (typeof shouldUpdateScript === 'function') {
        update = await shouldUpdateScript(scriptName, newValue);
      }

      if (update) {
        packageJSON.scripts[scriptName] = newValue;
      }
    }
  };

  await updatePackageScript('start', 'electron-forge start');
  await updatePackageScript('package', 'electron-forge package');
  await updatePackageScript('make', 'electron-forge make');
  d('forgified scripts object:', packageJSON.scripts);

  const writeChanges = async () => {
    await (0, _asyncOra.asyncOra)('Writing modified package.json file', async () => {
      await _fsExtra.default.writeJson(_path.default.resolve(dir, 'package.json'), packageJSON, {
        spaces: 2
      });
    });
  };

  await writeChanges();
  await (0, _asyncOra.asyncOra)('Installing dependencies', async () => {
    d('deleting old dependencies forcefully');
    await _fsExtra.default.remove(_path.default.resolve(dir, 'node_modules/.bin/electron'));
    await _fsExtra.default.remove(_path.default.resolve(dir, 'node_modules/.bin/electron.cmd'));
    d('installing dependencies');
    await (0, _installDependencies.default)(dir, importDeps);
    d('installing devDependencies');
    await (0, _installDependencies.default)(dir, importDevDeps, _installDependencies.DepType.DEV);
    d('installing exactDevDependencies');
    await (0, _installDependencies.default)(dir, importExactDevDeps, _installDependencies.DepType.DEV, _installDependencies.DepVersionRestriction.EXACT);
  });
  packageJSON = await (0, _readPackageJson.readRawPackageJson)(dir);

  if (!packageJSON.version) {
    (0, _messages.warn)(interactive, _chalk.default.yellow('Please set the "version" in your application\'s package.json'));
  }

  packageJSON.config = packageJSON.config || {};
  const templatePackageJSON = await (0, _readPackageJson.readRawPackageJson)(_templateBase.default.templateDir);

  if (packageJSON.config.forge) {
    if (typeof packageJSON.config.forge !== 'string') {
      packageJSON.config.forge = (0, _lodash.merge)(templatePackageJSON.config.forge, packageJSON.config.forge);
    }
  } else {
    packageJSON.config.forge = templatePackageJSON.config.forge;
  }

  if (typeof packageJSON.config.forge !== 'string') {
    (0, _forgeConfig.setInitialForgeConfig)(packageJSON);
  }

  await writeChanges();
  await (0, _asyncOra.asyncOra)('Fixing .gitignore', async () => {
    if (await _fsExtra.default.pathExists(_path.default.resolve(dir, '.gitignore'))) {
      const gitignore = await _fsExtra.default.readFile(_path.default.resolve(dir, '.gitignore'));

      if (!gitignore.includes(calculatedOutDir)) {
        await _fsExtra.default.writeFile(_path.default.resolve(dir, '.gitignore'), `${gitignore}\n${calculatedOutDir}/`);
      }
    }
  });
  (0, _messages.info)(interactive, `

We have ATTEMPTED to convert your app to be in a format that electron-forge understands.

Thanks for using ${_chalk.default.green('Electron Forge')}!!!`);
};

exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9hcGkvaW1wb3J0LnRzIl0sIm5hbWVzIjpbImQiLCJkaXIiLCJwcm9jZXNzIiwiY3dkIiwiaW50ZXJhY3RpdmUiLCJjb25maXJtSW1wb3J0Iiwic2hvdWxkQ29udGludWVPbkV4aXN0aW5nIiwic2hvdWxkUmVtb3ZlRGVwZW5kZW5jeSIsInNob3VsZFVwZGF0ZVNjcmlwdCIsIm91dERpciIsImNhbGN1bGF0ZWRPdXREaXIiLCJhc3luY09yYSIsImZzIiwicGF0aEV4aXN0cyIsInBhdGgiLCJyZXNvbHZlIiwiRXJyb3IiLCJleGl0IiwiaW1wb3J0RGVwcyIsImNvbmNhdCIsImRlcHMiLCJpbXBvcnREZXZEZXBzIiwiZGV2RGVwcyIsImltcG9ydEV4YWN0RGV2RGVwcyIsImV4YWN0RGV2RGVwcyIsInBhY2thZ2VKU09OIiwiY29uZmlnIiwiZm9yZ2UiLCJtYWtlcnMiLCJjaGFsayIsImdyZWVuIiwieWVsbG93IiwiZGVwZW5kZW5jaWVzIiwiZGV2RGVwZW5kZW5jaWVzIiwia2V5cyIsIk9iamVjdCIsImJ1aWxkVG9vbFBhY2thZ2VzIiwia2V5IiwiZXhwbGFuYXRpb24iLCJyZW1vdmUiLCJzY3JpcHRzIiwidXBkYXRlUGFja2FnZVNjcmlwdCIsInNjcmlwdE5hbWUiLCJuZXdWYWx1ZSIsInVwZGF0ZSIsIndyaXRlQ2hhbmdlcyIsIndyaXRlSnNvbiIsInNwYWNlcyIsIkRlcFR5cGUiLCJERVYiLCJEZXBWZXJzaW9uUmVzdHJpY3Rpb24iLCJFWEFDVCIsInZlcnNpb24iLCJ0ZW1wbGF0ZVBhY2thZ2VKU09OIiwiYmFzZVRlbXBsYXRlIiwidGVtcGxhdGVEaXIiLCJnaXRpZ25vcmUiLCJyZWFkRmlsZSIsImluY2x1ZGVzIiwid3JpdGVGaWxlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQTs7QUFDQTs7QUFFQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7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MkIsbUJBQU0wQixtQkFBbUIsQ0FBQzNCLE1BQXBCLENBQTJCQyxLQUFqQyxFQUF3Q0YsV0FBVyxDQUFDQyxNQUFaLENBQW1CQyxLQUEzRCxDQUEzQjtBQUNEO0FBQ0YsR0FKRCxNQUlPO0FBQ0xGLElBQUFBLFdBQVcsQ0FBQ0MsTUFBWixDQUFtQkMsS0FBbkIsR0FBMkIwQixtQkFBbUIsQ0FBQzNCLE1BQXBCLENBQTJCQyxLQUF0RDtBQUNEOztBQUVELE1BQUksT0FBT0YsV0FBVyxDQUFDQyxNQUFaLENBQW1CQyxLQUExQixLQUFvQyxRQUF4QyxFQUFrRDtBQUNoRCw0Q0FBc0JGLFdBQXRCO0FBQ0Q7O0FBRUQsUUFBTW9CLFlBQVksRUFBbEI7QUFFQSxRQUFNLHdCQUFTLG1CQUFULEVBQThCLFlBQVk7QUFDOUMsUUFBSSxNQUFNakMsaUJBQUdDLFVBQUgsQ0FBY0MsY0FBS0MsT0FBTCxDQUFhZCxHQUFiLEVBQWtCLFlBQWxCLENBQWQsQ0FBVixFQUEwRDtBQUN4RCxZQUFNdUQsU0FBUyxHQUFHLE1BQU01QyxpQkFBRzZDLFFBQUgsQ0FBWTNDLGNBQUtDLE9BQUwsQ0FBYWQsR0FBYixFQUFrQixZQUFsQixDQUFaLENBQXhCOztBQUNBLFVBQUksQ0FBQ3VELFNBQVMsQ0FBQ0UsUUFBVixDQUFtQmhELGdCQUFuQixDQUFMLEVBQTJDO0FBQ3pDLGNBQU1FLGlCQUFHK0MsU0FBSCxDQUFhN0MsY0FBS0MsT0FBTCxDQUFhZCxHQUFiLEVBQWtCLFlBQWxCLENBQWIsRUFBK0MsR0FBRXVELFNBQVUsS0FBSTlDLGdCQUFpQixHQUFoRixDQUFOO0FBQ0Q7QUFDRjtBQUNGLEdBUEssQ0FBTjtBQVNBLHNCQUNFTixXQURGLEVBRUc7QUFDTDtBQUNBO0FBQ0E7QUFDQSxtQkFBbUJ5QixlQUFNQyxLQUFOLENBQVksZ0JBQVosQ0FBOEIsS0FOL0M7QUFRRCxDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgYXN5bmNPcmEgfSBmcm9tICdAZWxlY3Ryb24tZm9yZ2UvYXN5bmMtb3JhJztcbmltcG9ydCBiYXNlVGVtcGxhdGUgZnJvbSAnQGVsZWN0cm9uLWZvcmdlL3RlbXBsYXRlLWJhc2UnO1xuaW1wb3J0IGNoYWxrIGZyb20gJ2NoYWxrJztcbmltcG9ydCBkZWJ1ZyBmcm9tICdkZWJ1Zyc7XG5pbXBvcnQgZnMgZnJvbSAnZnMtZXh0cmEnO1xuaW1wb3J0IHsgbWVyZ2UgfSBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5cbmltcG9ydCBpbml0R2l0IGZyb20gJy4vaW5pdC1zY3JpcHRzL2luaXQtZ2l0JztcbmltcG9ydCB7IGRlcHMsIGRldkRlcHMsIGV4YWN0RGV2RGVwcyB9IGZyb20gJy4vaW5pdC1zY3JpcHRzL2luaXQtbnBtJztcblxuaW1wb3J0IHsgdXBkYXRlRWxlY3Ryb25EZXBlbmRlbmN5IH0gZnJvbSAnLi4vdXRpbC9lbGVjdHJvbi12ZXJzaW9uJztcbmltcG9ydCB7IHNldEluaXRpYWxGb3JnZUNvbmZpZyB9IGZyb20gJy4uL3V0aWwvZm9yZ2UtY29uZmlnJztcbmltcG9ydCB7IGluZm8sIHdhcm4gfSBmcm9tICcuLi91dGlsL21lc3NhZ2VzJztcbmltcG9ydCBpbnN0YWxsRGVwTGlzdCwgeyBEZXBUeXBlLCBEZXBWZXJzaW9uUmVzdHJpY3Rpb24gfSBmcm9tICcuLi91dGlsL2luc3RhbGwtZGVwZW5kZW5jaWVzJztcbmltcG9ydCB7IHJlYWRSYXdQYWNrYWdlSnNvbiB9IGZyb20gJy4uL3V0aWwvcmVhZC1wYWNrYWdlLWpzb24nO1xuaW1wb3J0IHVwZ3JhZGVGb3JnZUNvbmZpZywgeyB1cGRhdGVVcGdyYWRlZEZvcmdlRGV2RGVwcyB9IGZyb20gJy4uL3V0aWwvdXBncmFkZS1mb3JnZS1jb25maWcnO1xuXG5jb25zdCBkID0gZGVidWcoJ2VsZWN0cm9uLWZvcmdlOmltcG9ydCcpO1xuXG5leHBvcnQgaW50ZXJmYWNlIEltcG9ydE9wdGlvbnMge1xuICAvKipcbiAgICogVGhlIHBhdGggdG8gdGhlIGFwcCB0byBiZSBpbXBvcnRlZFxuICAgKi9cbiAgZGlyPzogc3RyaW5nO1xuICAvKipcbiAgICogV2hldGhlciB0byB1c2Ugc2Vuc2libGUgZGVmYXVsdHMgb3IgcHJvbXB0IHRoZSB1c2VyIHZpc3VhbGx5XG4gICAqL1xuICBpbnRlcmFjdGl2ZT86IGJvb2xlYW47XG4gIC8qKlxuICAgKiBBbiBhc3luYyBmdW5jdGlvbiB0aGF0IHJldHVybnMgdHJ1ZSBvciBmYWxzZSBpbiBvcmRlciB0byBjb25maXJtIHRoZSBzdGFydFxuICAgKiBvZiBpbXBvcnRpbmdcbiAgICovXG4gIGNvbmZpcm1JbXBvcnQ/OiAoKSA9PiBQcm9taXNlPGJvb2xlYW4+O1xuICAvKipcbiAgICogQW4gYXN5bmMgZnVuY3Rpb24gdGhhdCByZXR1cm5zIHdoZXRoZXIgdGhlIGltcG9ydCBzaG91bGQgY29udGludWUgaWYgaXRcbiAgICogbG9va3MgbGlrZSBhIGZvcmdlIHByb2plY3QgYWxyZWFkeVxuICAgKi9cbiAgc2hvdWxkQ29udGludWVPbkV4aXN0aW5nPzogKCkgPT4gUHJvbWlzZTxib29sZWFuPjtcbiAgLyoqXG4gICAqIEFuIGFzeW5jIGZ1bmN0aW9uIHRoYXQgcmV0dXJucyB3aGV0aGVyIHRoZSBnaXZlbiBkZXBlbmRlbmN5IHNob3VsZCBiZSByZW1vdmVkXG4gICAqL1xuICBzaG91bGRSZW1vdmVEZXBlbmRlbmN5PzogKGRlcGVuZGVuY3k6IHN0cmluZywgZXhwbGFuYXRpb246IHN0cmluZykgPT4gUHJvbWlzZTxib29sZWFuPjtcbiAgLyoqXG4gICAqIEFuIGFzeW5jIGZ1bmN0aW9uIHRoYXQgcmV0dXJucyB3aGV0aGVyIHRoZSBnaXZlbiBzY3JpcHQgc2hvdWxkIGJlIG92ZXJyaWRkZW4gd2l0aCBhIGZvcmdlIG9uZVxuICAgKi9cbiAgc2hvdWxkVXBkYXRlU2NyaXB0PzogKHNjcmlwdE5hbWU6IHN0cmluZywgbmV3VmFsdWU6IHN0cmluZykgPT4gUHJvbWlzZTxib29sZWFuPjtcbiAgLyoqXG4gICAqIFRoZSBwYXRoIHRvIHRoZSBkaXJlY3RvcnkgY29udGFpbmluZyBnZW5lcmF0ZWQgZGlzdHJpYnV0YWJsZXNcbiAgICovXG4gIG91dERpcj86IHN0cmluZztcbn1cblxuZXhwb3J0IGRlZmF1bHQgYXN5bmMgKHtcbiAgZGlyID0gcHJvY2Vzcy5jd2QoKSxcbiAgaW50ZXJhY3RpdmUgPSBmYWxzZSxcbiAgY29uZmlybUltcG9ydCxcbiAgc2hvdWxkQ29udGludWVPbkV4aXN0aW5nLFxuICBzaG91bGRSZW1vdmVEZXBlbmRlbmN5LFxuICBzaG91bGRVcGRhdGVTY3JpcHQsXG4gIG91dERpcixcbn06IEltcG9ydE9wdGlvbnMpOiBQcm9taXNlPHZvaWQ+ID0+IHtcbiAgY29uc3QgY2FsY3VsYXRlZE91dERpciA9IG91dERpciB8fCAnb3V0JztcbiAgYXN5bmNPcmEuaW50ZXJhY3RpdmUgPSBpbnRlcmFjdGl2ZTtcblxuICBkKGBBdHRlbXB0aW5nIHRvIGltcG9ydCBwcm9qZWN0IGluOiAke2Rpcn1gKTtcbiAgaWYgKCEoYXdhaXQgZnMucGF0aEV4aXN0cyhkaXIpKSB8fCAhKGF3YWl0IGZzLnBhdGhFeGlzdHMocGF0aC5yZXNvbHZlKGRpciwgJ3BhY2thZ2UuanNvbicpKSkpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYFdlIGNvdWxkbid0IGZpbmQgYSBwcm9qZWN0IGluOiAke2Rpcn1gKTtcbiAgfVxuXG4gIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBtYXgtbGVuXG4gIGlmICh0eXBlb2YgY29uZmlybUltcG9ydCA9PT0gJ2Z1bmN0aW9uJykge1xuICAgIGlmICghKGF3YWl0IGNvbmZpcm1JbXBvcnQoKSkpIHtcbiAgICAgIC8vIFRPRE86IGZpZ3VyZSBvdXQgaWYgd2UgY2FuIGp1c3QgcmV0dXJuIGVhcmx5IGhlcmVcbiAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1wcm9jZXNzLWV4aXRcbiAgICAgIHByb2Nlc3MuZXhpdCgwKTtcbiAgICB9XG4gIH1cblxuICBhd2FpdCBpbml0R2l0KGRpcik7XG5cbiAgY29uc3QgaW1wb3J0RGVwcyA9IChbXSBhcyBzdHJpbmdbXSkuY29uY2F0KGRlcHMpO1xuICBsZXQgaW1wb3J0RGV2RGVwcyA9IChbXSBhcyBzdHJpbmdbXSkuY29uY2F0KGRldkRlcHMpO1xuICBsZXQgaW1wb3J0RXhhY3REZXZEZXBzID0gKFtdIGFzIHN0cmluZ1tdKS5jb25jYXQoZXhhY3REZXZEZXBzKTtcblxuICBsZXQgcGFja2FnZUpTT04gPSBhd2FpdCByZWFkUmF3UGFja2FnZUpzb24oZGlyKTtcbiAgaWYgKHBhY2thZ2VKU09OLmNvbmZpZyAmJiBwYWNrYWdlSlNPTi5jb25maWcuZm9yZ2UpIHtcbiAgICBpZiAocGFja2FnZUpTT04uY29uZmlnLmZvcmdlLm1ha2Vycykge1xuICAgICAgd2FybihpbnRlcmFjdGl2ZSwgY2hhbGsuZ3JlZW4oJ0l0IGxvb2tzIGxpa2UgdGhpcyBwcm9qZWN0IGlzIGFscmVhZHkgY29uZmlndXJlZCBmb3IgRWxlY3Ryb24gRm9yZ2UnKSk7XG4gICAgICBpZiAodHlwZW9mIHNob3VsZENvbnRpbnVlT25FeGlzdGluZyA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICBpZiAoIShhd2FpdCBzaG91bGRDb250aW51ZU9uRXhpc3RpbmcoKSkpIHtcbiAgICAgICAgICAvLyBUT0RPOiBmaWd1cmUgb3V0IGlmIHdlIGNhbiBqdXN0IHJldHVybiBlYXJseSBoZXJlXG4gICAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXByb2Nlc3MtZXhpdFxuICAgICAgICAgIHByb2Nlc3MuZXhpdCgwKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0gZWxzZSBpZiAodHlwZW9mIHBhY2thZ2VKU09OLmNvbmZpZy5mb3JnZSA9PT0gJ3N0cmluZycpIHtcbiAgICAgIHdhcm4oXG4gICAgICAgIGludGVyYWN0aXZlLFxuICAgICAgICBjaGFsay55ZWxsb3coXG4gICAgICAgICAgXCJXZSBjYW4ndCB0ZWxsIGlmIHRoZSBFbGVjdHJvbiBGb3JnZSBjb25maWcgaXMgY29tcGF0aWJsZSBiZWNhdXNlIGl0J3MgaW4gYW4gZXh0ZXJuYWwgSmF2YVNjcmlwdCBmaWxlLCBub3QgdHJ5aW5nIHRvIGNvbnZlcnQgaXQgYW5kIGNvbnRpbnVpbmcgYW55d2F5XCJcbiAgICAgICAgKVxuICAgICAgKTtcbiAgICB9IGVsc2Uge1xuICAgICAgZCgnVXBncmFkaW5nIGFuIEVsZWN0cm9uIEZvcmdlIDwgNiBwcm9qZWN0Jyk7XG4gICAgICBwYWNrYWdlSlNPTi5jb25maWcuZm9yZ2UgPSB1cGdyYWRlRm9yZ2VDb25maWcocGFja2FnZUpTT04uY29uZmlnLmZvcmdlKTtcbiAgICAgIGltcG9ydERldkRlcHMgPSB1cGRhdGVVcGdyYWRlZEZvcmdlRGV2RGVwcyhwYWNrYWdlSlNPTiwgaW1wb3J0RGV2RGVwcyk7XG4gICAgfVxuICB9XG5cbiAgcGFja2FnZUpTT04uZGVwZW5kZW5jaWVzID0gcGFja2FnZUpTT04uZGVwZW5kZW5jaWVzIHx8IHt9O1xuICBwYWNrYWdlSlNPTi5kZXZEZXBlbmRlbmNpZXMgPSBwYWNrYWdlSlNPTi5kZXZEZXBlbmRlbmNpZXMgfHwge307XG5cbiAgW2ltcG9ydERldkRlcHMsIGltcG9ydEV4YWN0RGV2RGVwc10gPSB1cGRhdGVFbGVjdHJvbkRlcGVuZGVuY3kocGFja2FnZUpTT04sIGltcG9ydERldkRlcHMsIGltcG9ydEV4YWN0RGV2RGVwcyk7XG5cbiAgY29uc3Qga2V5cyA9IE9iamVjdC5rZXlzKHBhY2thZ2VKU09OLmRlcGVuZGVuY2llcykuY29uY2F0KE9iamVjdC5rZXlzKHBhY2thZ2VKU09OLmRldkRlcGVuZGVuY2llcykpO1xuICBjb25zdCBidWlsZFRvb2xQYWNrYWdlczogUmVjb3JkPHN0cmluZywgc3RyaW5nIHwgdW5kZWZpbmVkPiA9IHtcbiAgICAnQGVsZWN0cm9uL2dldCc6ICdhbHJlYWR5IHVzZXMgdGhpcyBtb2R1bGUgYXMgYSB0cmFuc2l0aXZlIGRlcGVuZGVuY3knLFxuICAgICdlbGVjdHJvbi1idWlsZGVyJzogJ3Byb3ZpZGVzIG1vc3RseSBlcXVpdmFsZW50IGZ1bmN0aW9uYWxpdHknLFxuICAgICdlbGVjdHJvbi1kb3dubG9hZCc6ICdhbHJlYWR5IHVzZXMgdGhpcyBtb2R1bGUgYXMgYSB0cmFuc2l0aXZlIGRlcGVuZGVuY3knLFxuICAgICdlbGVjdHJvbi1mb3JnZSc6ICdyZXBsYWNlZCB3aXRoIEBlbGVjdHJvbi1mb3JnZS9jbGknLFxuICAgICdlbGVjdHJvbi1pbnN0YWxsZXItZGViaWFuJzogJ2FscmVhZHkgdXNlcyB0aGlzIG1vZHVsZSBhcyBhIHRyYW5zaXRpdmUgZGVwZW5kZW5jeScsXG4gICAgJ2VsZWN0cm9uLWluc3RhbGxlci1kbWcnOiAnYWxyZWFkeSB1c2VzIHRoaXMgbW9kdWxlIGFzIGEgdHJhbnNpdGl2ZSBkZXBlbmRlbmN5JyxcbiAgICAnZWxlY3Ryb24taW5zdGFsbGVyLWZsYXRwYWsnOiAnYWxyZWFkeSB1c2VzIHRoaXMgbW9kdWxlIGFzIGEgdHJhbnNpdGl2ZSBkZXBlbmRlbmN5JyxcbiAgICAnZWxlY3Ryb24taW5zdGFsbGVyLXJlZGhhdCc6ICdhbHJlYWR5IHVzZXMgdGhpcyBtb2R1bGUgYXMgYSB0cmFuc2l0aXZlIGRlcGVuZGVuY3knLFxuICAgICdlbGVjdHJvbi1vc3gtc2lnbic6ICdhbHJlYWR5IHVzZXMgdGhpcyBtb2R1bGUgYXMgYSB0cmFuc2l0aXZlIGRlcGVuZGVuY3knLFxuICAgICdlbGVjdHJvbi1wYWNrYWdlcic6ICdhbHJlYWR5IHVzZXMgdGhpcyBtb2R1bGUgYXMgYSB0cmFuc2l0aXZlIGRlcGVuZGVuY3knLFxuICAgICdlbGVjdHJvbi13aW5zdGFsbGVyJzogJ2FscmVhZHkgdXNlcyB0aGlzIG1vZHVsZSBhcyBhIHRyYW5zaXRpdmUgZGVwZW5kZW5jeScsXG4gIH07XG5cbiAgZm9yIChjb25zdCBrZXkgb2Yga2V5cykge1xuICAgIGlmIChidWlsZFRvb2xQYWNrYWdlc1trZXldKSB7XG4gICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLW5vbi1udWxsLWFzc2VydGlvblxuICAgICAgY29uc3QgZXhwbGFuYXRpb24gPSBidWlsZFRvb2xQYWNrYWdlc1trZXldITtcbiAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBtYXgtbGVuXG4gICAgICBsZXQgcmVtb3ZlID0gdHJ1ZTtcbiAgICAgIGlmICh0eXBlb2Ygc2hvdWxkUmVtb3ZlRGVwZW5kZW5jeSA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICByZW1vdmUgPSBhd2FpdCBzaG91bGRSZW1vdmVEZXBlbmRlbmN5KGtleSwgZXhwbGFuYXRpb24pO1xuICAgICAgfVxuXG4gICAgICBpZiAocmVtb3ZlKSB7XG4gICAgICAgIGRlbGV0ZSBwYWNrYWdlSlNPTi5kZXBlbmRlbmNpZXNba2V5XTtcbiAgICAgICAgZGVsZXRlIHBhY2thZ2VKU09OLmRldkRlcGVuZGVuY2llc1trZXldO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHBhY2thZ2VKU09OLnNjcmlwdHMgPSBwYWNrYWdlSlNPTi5zY3JpcHRzIHx8IHt9O1xuICBkKCdyZWFkaW5nIGN1cnJlbnQgc2NyaXB0cyBvYmplY3Q6JywgcGFja2FnZUpTT04uc2NyaXB0cyk7XG5cbiAgY29uc3QgdXBkYXRlUGFja2FnZVNjcmlwdCA9IGFzeW5jIChzY3JpcHROYW1lOiBzdHJpbmcsIG5ld1ZhbHVlOiBzdHJpbmcpID0+IHtcbiAgICBpZiAocGFja2FnZUpTT04uc2NyaXB0c1tzY3JpcHROYW1lXSAhPT0gbmV3VmFsdWUpIHtcbiAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBtYXgtbGVuXG4gICAgICBsZXQgdXBkYXRlID0gdHJ1ZTtcbiAgICAgIGlmICh0eXBlb2Ygc2hvdWxkVXBkYXRlU2NyaXB0ID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgIHVwZGF0ZSA9IGF3YWl0IHNob3VsZFVwZGF0ZVNjcmlwdChzY3JpcHROYW1lLCBuZXdWYWx1ZSk7XG4gICAgICB9XG4gICAgICBpZiAodXBkYXRlKSB7XG4gICAgICAgIHBhY2thZ2VKU09OLnNjcmlwdHNbc2NyaXB0TmFtZV0gPSBuZXdWYWx1ZTtcbiAgICAgIH1cbiAgICB9XG4gIH07XG5cbiAgYXdhaXQgdXBkYXRlUGFja2FnZVNjcmlwdCgnc3RhcnQnLCAnZWxlY3Ryb24tZm9yZ2Ugc3RhcnQnKTtcbiAgYXdhaXQgdXBkYXRlUGFja2FnZVNjcmlwdCgncGFja2FnZScsICdlbGVjdHJvbi1mb3JnZSBwYWNrYWdlJyk7XG4gIGF3YWl0IHVwZGF0ZVBhY2thZ2VTY3JpcHQoJ21ha2UnLCAnZWxlY3Ryb24tZm9yZ2UgbWFrZScpO1xuXG4gIGQoJ2ZvcmdpZmllZCBzY3JpcHRzIG9iamVjdDonLCBwYWNrYWdlSlNPTi5zY3JpcHRzKTtcblxuICBjb25zdCB3cml0ZUNoYW5nZXMgPSBhc3luYyAoKSA9PiB7XG4gICAgYXdhaXQgYXN5bmNPcmEoJ1dyaXRpbmcgbW9kaWZpZWQgcGFja2FnZS5qc29uIGZpbGUnLCBhc3luYyAoKSA9PiB7XG4gICAgICBhd2FpdCBmcy53cml0ZUpzb24ocGF0aC5yZXNvbHZlKGRpciwgJ3BhY2thZ2UuanNvbicpLCBwYWNrYWdlSlNPTiwgeyBzcGFjZXM6IDIgfSk7XG4gICAgfSk7XG4gIH07XG5cbiAgYXdhaXQgd3JpdGVDaGFuZ2VzKCk7XG5cbiAgYXdhaXQgYXN5bmNPcmEoJ0luc3RhbGxpbmcgZGVwZW5kZW5jaWVzJywgYXN5bmMgKCkgPT4ge1xuICAgIGQoJ2RlbGV0aW5nIG9sZCBkZXBlbmRlbmNpZXMgZm9yY2VmdWxseScpO1xuICAgIGF3YWl0IGZzLnJlbW92ZShwYXRoLnJlc29sdmUoZGlyLCAnbm9kZV9tb2R1bGVzLy5iaW4vZWxlY3Ryb24nKSk7XG4gICAgYXdhaXQgZnMucmVtb3ZlKHBhdGgucmVzb2x2ZShkaXIsICdub2RlX21vZHVsZXMvLmJpbi9lbGVjdHJvbi5jbWQnKSk7XG5cbiAgICBkKCdpbnN0YWxsaW5nIGRlcGVuZGVuY2llcycpO1xuICAgIGF3YWl0IGluc3RhbGxEZXBMaXN0KGRpciwgaW1wb3J0RGVwcyk7XG5cbiAgICBkKCdpbnN0YWxsaW5nIGRldkRlcGVuZGVuY2llcycpO1xuICAgIGF3YWl0IGluc3RhbGxEZXBMaXN0KGRpciwgaW1wb3J0RGV2RGVwcywgRGVwVHlwZS5ERVYpO1xuXG4gICAgZCgnaW5zdGFsbGluZyBleGFjdERldkRlcGVuZGVuY2llcycpO1xuICAgIGF3YWl0IGluc3RhbGxEZXBMaXN0KGRpciwgaW1wb3J0RXhhY3REZXZEZXBzLCBEZXBUeXBlLkRFViwgRGVwVmVyc2lvblJlc3RyaWN0aW9uLkVYQUNUKTtcbiAgfSk7XG5cbiAgcGFja2FnZUpTT04gPSBhd2FpdCByZWFkUmF3UGFja2FnZUpzb24oZGlyKTtcblxuICBpZiAoIXBhY2thZ2VKU09OLnZlcnNpb24pIHtcbiAgICB3YXJuKGludGVyYWN0aXZlLCBjaGFsay55ZWxsb3coJ1BsZWFzZSBzZXQgdGhlIFwidmVyc2lvblwiIGluIHlvdXIgYXBwbGljYXRpb25cXCdzIHBhY2thZ2UuanNvbicpKTtcbiAgfVxuXG4gIHBhY2thZ2VKU09OLmNvbmZpZyA9IHBhY2thZ2VKU09OLmNvbmZpZyB8fCB7fTtcbiAgY29uc3QgdGVtcGxhdGVQYWNrYWdlSlNPTiA9IGF3YWl0IHJlYWRSYXdQYWNrYWdlSnNvbihiYXNlVGVtcGxhdGUudGVtcGxhdGVEaXIpO1xuICBpZiAocGFja2FnZUpTT04uY29uZmlnLmZvcmdlKSB7XG4gICAgaWYgKHR5cGVvZiBwYWNrYWdlSlNPTi5jb25maWcuZm9yZ2UgIT09ICdzdHJpbmcnKSB7XG4gICAgICBwYWNrYWdlSlNPTi5jb25maWcuZm9yZ2UgPSBtZXJnZSh0ZW1wbGF0ZVBhY2thZ2VKU09OLmNvbmZpZy5mb3JnZSwgcGFja2FnZUpTT04uY29uZmlnLmZvcmdlKTtcbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgcGFja2FnZUpTT04uY29uZmlnLmZvcmdlID0gdGVtcGxhdGVQYWNrYWdlSlNPTi5jb25maWcuZm9yZ2U7XG4gIH1cblxuICBpZiAodHlwZW9mIHBhY2thZ2VKU09OLmNvbmZpZy5mb3JnZSAhPT0gJ3N0cmluZycpIHtcbiAgICBzZXRJbml0aWFsRm9yZ2VDb25maWcocGFja2FnZUpTT04pO1xuICB9XG5cbiAgYXdhaXQgd3JpdGVDaGFuZ2VzKCk7XG5cbiAgYXdhaXQgYXN5bmNPcmEoJ0ZpeGluZyAuZ2l0aWdub3JlJywgYXN5bmMgKCkgPT4ge1xuICAgIGlmIChhd2FpdCBmcy5wYXRoRXhpc3RzKHBhdGgucmVzb2x2ZShkaXIsICcuZ2l0aWdub3JlJykpKSB7XG4gICAgICBjb25zdCBnaXRpZ25vcmUgPSBhd2FpdCBmcy5yZWFkRmlsZShwYXRoLnJlc29sdmUoZGlyLCAnLmdpdGlnbm9yZScpKTtcbiAgICAgIGlmICghZ2l0aWdub3JlLmluY2x1ZGVzKGNhbGN1bGF0ZWRPdXREaXIpKSB7XG4gICAgICAgIGF3YWl0IGZzLndyaXRlRmlsZShwYXRoLnJlc29sdmUoZGlyLCAnLmdpdGlnbm9yZScpLCBgJHtnaXRpZ25vcmV9XFxuJHtjYWxjdWxhdGVkT3V0RGlyfS9gKTtcbiAgICAgIH1cbiAgICB9XG4gIH0pO1xuXG4gIGluZm8oXG4gICAgaW50ZXJhY3RpdmUsXG4gICAgYFxuXG5XZSBoYXZlIEFUVEVNUFRFRCB0byBjb252ZXJ0IHlvdXIgYXBwIHRvIGJlIGluIGEgZm9ybWF0IHRoYXQgZWxlY3Ryb24tZm9yZ2UgdW5kZXJzdGFuZHMuXG5cblRoYW5rcyBmb3IgdXNpbmcgJHtjaGFsay5ncmVlbignRWxlY3Ryb24gRm9yZ2UnKX0hISFgXG4gICk7XG59O1xuIl19
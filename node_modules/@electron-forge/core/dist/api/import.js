"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _lodash = require("lodash");

var _asyncOra = require("@electron-forge/async-ora");

var _templateBase = _interopRequireDefault(require("@electron-forge/template-base"));

var _debug = _interopRequireDefault(require("debug"));

var _fsExtra = _interopRequireDefault(require("fs-extra"));

var _path = _interopRequireDefault(require("path"));

var _initGit = _interopRequireDefault(require("./init-scripts/init-git"));

var _initNpm = require("./init-scripts/init-npm");

var _electronVersion = require("../util/electron-version");

var _forgeConfig = require("../util/forge-config");

var _messages = require("../util/messages");

var _installDependencies = _interopRequireWildcard(require("../util/install-dependencies"));

var _readPackageJson = require("../util/read-package-json");

var _upgradeForgeConfig = _interopRequireWildcard(require("../util/upgrade-forge-config"));

function _getRequireWildcardCache() { if (typeof WeakMap !== "function") return null; var cache = new WeakMap(); _getRequireWildcardCache = function () { return cache; }; return cache; }

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const d = (0, _debug.default)('electron-forge:import');

var _default = async ({
  dir = process.cwd(),
  interactive = false,
  confirmImport,
  shouldContinueOnExisting,
  shouldRemoveDependency,
  shouldUpdateScript,
  outDir
}) => {
  const calculatedOutDir = outDir || 'out';
  _asyncOra.asyncOra.interactive = interactive;
  d(`Attempting to import project in: ${dir}`);

  if (!(await _fsExtra.default.pathExists(dir)) || !(await _fsExtra.default.pathExists(_path.default.resolve(dir, 'package.json')))) {
    throw new Error(`We couldn't find a project in: ${dir}`);
  } // eslint-disable-next-line max-len


  if (typeof confirmImport === 'function') {
    if (!(await confirmImport())) {
      process.exit(0);
    }
  }

  await (0, _initGit.default)(dir);
  const importDeps = [].concat(_initNpm.deps);
  let importDevDeps = [].concat(_initNpm.devDeps);
  let importExactDevDeps = [].concat(_initNpm.exactDevDeps);
  let packageJSON = await (0, _readPackageJson.readRawPackageJson)(dir);

  if (packageJSON.config && packageJSON.config.forge) {
    if (packageJSON.config.forge.makers) {
      (0, _messages.warn)(interactive, 'It looks like this project is already configured for Electron Forge'.green);

      if (typeof shouldContinueOnExisting === 'function') {
        if (!(await shouldContinueOnExisting())) {
          process.exit(0);
        }
      }
    } else if (typeof packageJSON.config.forge === 'string') {
      (0, _messages.warn)(interactive, "We can't tell if the Electron Forge config is compatible because it's in an external JavaScript file, not trying to convert it and continuing anyway".yellow);
    } else {
      d('Upgrading an Electron Forge < 6 project');
      packageJSON.config.forge = (0, _upgradeForgeConfig.default)(packageJSON.config.forge);
      importDevDeps = (0, _upgradeForgeConfig.updateUpgradedForgeDevDeps)(packageJSON, importDevDeps);
    }
  }

  packageJSON.dependencies = packageJSON.dependencies || {};
  packageJSON.devDependencies = packageJSON.devDependencies || {};
  [importDevDeps, importExactDevDeps] = (0, _electronVersion.updateElectronDependency)(packageJSON, importDevDeps, importExactDevDeps);
  const keys = Object.keys(packageJSON.dependencies).concat(Object.keys(packageJSON.devDependencies));
  const buildToolPackages = {
    '@electron/get': 'already uses this module as a transitive dependency',
    'electron-builder': 'provides mostly equivalent functionality',
    'electron-download': 'already uses this module as a transitive dependency',
    'electron-forge': 'replaced with @electron-forge/cli',
    'electron-installer-debian': 'already uses this module as a transitive dependency',
    'electron-installer-dmg': 'already uses this module as a transitive dependency',
    'electron-installer-flatpak': 'already uses this module as a transitive dependency',
    'electron-installer-redhat': 'already uses this module as a transitive dependency',
    'electron-osx-sign': 'already uses this module as a transitive dependency',
    'electron-packager': 'already uses this module as a transitive dependency',
    'electron-winstaller': 'already uses this module as a transitive dependency'
  };

  for (const key of keys) {
    if (buildToolPackages[key]) {
      const explanation = buildToolPackages[key]; // eslint-disable-next-line max-len

      let remove = true;

      if (typeof shouldRemoveDependency === 'function') {
        remove = await shouldRemoveDependency(key, explanation);
      }

      if (remove) {
        delete packageJSON.dependencies[key];
        delete packageJSON.devDependencies[key];
      }
    }
  }

  packageJSON.scripts = packageJSON.scripts || {};
  d('reading current scripts object:', packageJSON.scripts);

  const updatePackageScript = async (scriptName, newValue) => {
    if (packageJSON.scripts[scriptName] !== newValue) {
      // eslint-disable-next-line max-len
      let update = true;

      if (typeof shouldUpdateScript === 'function') {
        update = await shouldUpdateScript(scriptName, newValue);
      }

      if (update) {
        packageJSON.scripts[scriptName] = newValue;
      }
    }
  };

  await updatePackageScript('start', 'electron-forge start');
  await updatePackageScript('package', 'electron-forge package');
  await updatePackageScript('make', 'electron-forge make');
  d('forgified scripts object:', packageJSON.scripts);

  const writeChanges = async () => {
    await (0, _asyncOra.asyncOra)('Writing modified package.json file', async () => {
      await _fsExtra.default.writeJson(_path.default.resolve(dir, 'package.json'), packageJSON, {
        spaces: 2
      });
    });
  };

  await writeChanges();
  await (0, _asyncOra.asyncOra)('Installing dependencies', async () => {
    d('deleting old dependencies forcefully');
    await _fsExtra.default.remove(_path.default.resolve(dir, 'node_modules/.bin/electron'));
    await _fsExtra.default.remove(_path.default.resolve(dir, 'node_modules/.bin/electron.cmd'));
    d('installing dependencies');
    await (0, _installDependencies.default)(dir, importDeps);
    d('installing devDependencies');
    await (0, _installDependencies.default)(dir, importDevDeps, _installDependencies.DepType.DEV);
    d('installing exactDevDependencies');
    await (0, _installDependencies.default)(dir, importExactDevDeps, _installDependencies.DepType.DEV, _installDependencies.DepVersionRestriction.EXACT);
  });
  packageJSON = await (0, _readPackageJson.readRawPackageJson)(dir);

  if (!packageJSON.version) {
    (0, _messages.warn)(interactive, 'Please set the "version" in your application\'s package.json'.yellow);
  }

  packageJSON.config = packageJSON.config || {};
  const templatePackageJSON = await (0, _readPackageJson.readRawPackageJson)(_templateBase.default.templateDir);

  if (packageJSON.config.forge) {
    if (typeof packageJSON.config.forge !== 'string') {
      packageJSON.config.forge = (0, _lodash.merge)(templatePackageJSON.config.forge, packageJSON.config.forge);
    }
  } else {
    packageJSON.config.forge = templatePackageJSON.config.forge;
  }

  if (typeof packageJSON.config.forge !== 'string') {
    (0, _forgeConfig.setInitialForgeConfig)(packageJSON);
  }

  await writeChanges();
  await (0, _asyncOra.asyncOra)('Fixing .gitignore', async () => {
    if (await _fsExtra.default.pathExists(_path.default.resolve(dir, '.gitignore'))) {
      const gitignore = await _fsExtra.default.readFile(_path.default.resolve(dir, '.gitignore'));

      if (!gitignore.includes(calculatedOutDir)) {
        await _fsExtra.default.writeFile(_path.default.resolve(dir, '.gitignore'), `${gitignore}\n${calculatedOutDir}/`);
      }
    }
  });
  (0, _messages.info)(interactive, `

We have ATTEMPTED to convert your app to be in a format that electron-forge understands.

Thanks for using ${'"electron-forge"'.green}!!!`);
};

exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9hcGkvaW1wb3J0LnRzIl0sIm5hbWVzIjpbImQiLCJkaXIiLCJwcm9jZXNzIiwiY3dkIiwiaW50ZXJhY3RpdmUiLCJjb25maXJtSW1wb3J0Iiwic2hvdWxkQ29udGludWVPbkV4aXN0aW5nIiwic2hvdWxkUmVtb3ZlRGVwZW5kZW5jeSIsInNob3VsZFVwZGF0ZVNjcmlwdCIsIm91dERpciIsImNhbGN1bGF0ZWRPdXREaXIiLCJhc3luY09yYSIsImZzIiwicGF0aEV4aXN0cyIsInBhdGgiLCJyZXNvbHZlIiwiRXJyb3IiLCJleGl0IiwiaW1wb3J0RGVwcyIsImNvbmNhdCIsImRlcHMiLCJpbXBvcnREZXZEZXBzIiwiZGV2RGVwcyIsImltcG9ydEV4YWN0RGV2RGVwcyIsImV4YWN0RGV2RGVwcyIsInBhY2thZ2VKU09OIiwiY29uZmlnIiwiZm9yZ2UiLCJtYWtlcnMiLCJncmVlbiIsInllbGxvdyIsImRlcGVuZGVuY2llcyIsImRldkRlcGVuZGVuY2llcyIsImtleXMiLCJPYmplY3QiLCJidWlsZFRvb2xQYWNrYWdlcyIsImtleSIsImV4cGxhbmF0aW9uIiwicmVtb3ZlIiwic2NyaXB0cyIsInVwZGF0ZVBhY2thZ2VTY3JpcHQiLCJzY3JpcHROYW1lIiwibmV3VmFsdWUiLCJ1cGRhdGUiLCJ3cml0ZUNoYW5nZXMiLCJ3cml0ZUpzb24iLCJzcGFjZXMiLCJEZXBUeXBlIiwiREVWIiwiRGVwVmVyc2lvblJlc3RyaWN0aW9uIiwiRVhBQ1QiLCJ2ZXJzaW9uIiwidGVtcGxhdGVQYWNrYWdlSlNPTiIsImJhc2VUZW1wbGF0ZSIsInRlbXBsYXRlRGlyIiwiZ2l0aWdub3JlIiwicmVhZEZpbGUiLCJpbmNsdWRlcyIsIndyaXRlRmlsZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUE7O0FBQ0E7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7Ozs7O0FBRUEsTUFB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TUFJTztBQUNMRixJQUFBQSxXQUFXLENBQUNDLE1BQVosQ0FBbUJDLEtBQW5CLEdBQTJCeUIsbUJBQW1CLENBQUMxQixNQUFwQixDQUEyQkMsS0FBdEQ7QUFDRDs7QUFFRCxNQUFJLE9BQU9GLFdBQVcsQ0FBQ0MsTUFBWixDQUFtQkMsS0FBMUIsS0FBb0MsUUFBeEMsRUFBa0Q7QUFDaEQsNENBQXNCRixXQUF0QjtBQUNEOztBQUVELFFBQU1tQixZQUFZLEVBQWxCO0FBRUEsUUFBTSx3QkFBUyxtQkFBVCxFQUE4QixZQUFZO0FBQzlDLFFBQUksTUFBTWhDLGlCQUFHQyxVQUFILENBQWNDLGNBQUtDLE9BQUwsQ0FBYWQsR0FBYixFQUFrQixZQUFsQixDQUFkLENBQVYsRUFBMEQ7QUFDeEQsWUFBTXNELFNBQVMsR0FBRyxNQUFNM0MsaUJBQUc0QyxRQUFILENBQVkxQyxjQUFLQyxPQUFMLENBQWFkLEdBQWIsRUFBa0IsWUFBbEIsQ0FBWixDQUF4Qjs7QUFDQSxVQUFJLENBQUNzRCxTQUFTLENBQUNFLFFBQVYsQ0FBbUIvQyxnQkFBbkIsQ0FBTCxFQUEyQztBQUN6QyxjQUFNRSxpQkFBRzhDLFNBQUgsQ0FBYTVDLGNBQUtDLE9BQUwsQ0FBYWQsR0FBYixFQUFrQixZQUFsQixDQUFiLEVBQStDLEdBQUVzRCxTQUFVLEtBQUk3QyxnQkFBaUIsR0FBaEYsQ0FBTjtBQUNEO0FBQ0Y7QUFDRixHQVBLLENBQU47QUFTQSxzQkFBS04sV0FBTCxFQUFtQjtBQUNyQjtBQUNBO0FBQ0E7QUFDQSxtQkFBbUIsbUJBQW1CeUIsS0FBTSxLQUoxQztBQUtELEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBtZXJnZSB9IGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyBhc3luY09yYSB9IGZyb20gJ0BlbGVjdHJvbi1mb3JnZS9hc3luYy1vcmEnO1xuaW1wb3J0IGJhc2VUZW1wbGF0ZSBmcm9tICdAZWxlY3Ryb24tZm9yZ2UvdGVtcGxhdGUtYmFzZSc7XG5pbXBvcnQgZGVidWcgZnJvbSAnZGVidWcnO1xuaW1wb3J0IGZzIGZyb20gJ2ZzLWV4dHJhJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuXG5pbXBvcnQgaW5pdEdpdCBmcm9tICcuL2luaXQtc2NyaXB0cy9pbml0LWdpdCc7XG5pbXBvcnQgeyBkZXBzLCBkZXZEZXBzLCBleGFjdERldkRlcHMgfSBmcm9tICcuL2luaXQtc2NyaXB0cy9pbml0LW5wbSc7XG5cbmltcG9ydCB7IHVwZGF0ZUVsZWN0cm9uRGVwZW5kZW5jeSB9IGZyb20gJy4uL3V0aWwvZWxlY3Ryb24tdmVyc2lvbic7XG5pbXBvcnQgeyBzZXRJbml0aWFsRm9yZ2VDb25maWcgfSBmcm9tICcuLi91dGlsL2ZvcmdlLWNvbmZpZyc7XG5pbXBvcnQgeyBpbmZvLCB3YXJuIH0gZnJvbSAnLi4vdXRpbC9tZXNzYWdlcyc7XG5pbXBvcnQgaW5zdGFsbERlcExpc3QsIHsgRGVwVHlwZSwgRGVwVmVyc2lvblJlc3RyaWN0aW9uIH0gZnJvbSAnLi4vdXRpbC9pbnN0YWxsLWRlcGVuZGVuY2llcyc7XG5pbXBvcnQgeyByZWFkUmF3UGFja2FnZUpzb24gfSBmcm9tICcuLi91dGlsL3JlYWQtcGFja2FnZS1qc29uJztcbmltcG9ydCB1cGdyYWRlRm9yZ2VDb25maWcsIHsgdXBkYXRlVXBncmFkZWRGb3JnZURldkRlcHMgfSBmcm9tICcuLi91dGlsL3VwZ3JhZGUtZm9yZ2UtY29uZmlnJztcblxuY29uc3QgZCA9IGRlYnVnKCdlbGVjdHJvbi1mb3JnZTppbXBvcnQnKTtcblxuZXhwb3J0IGludGVyZmFjZSBJbXBvcnRPcHRpb25zIHtcbiAgLyoqXG4gICAqIFRoZSBwYXRoIHRvIHRoZSBhcHAgdG8gYmUgaW1wb3J0ZWRcbiAgICovXG4gIGRpcj86IHN0cmluZztcbiAgLyoqXG4gICAqIFdoZXRoZXIgdG8gdXNlIHNlbnNpYmxlIGRlZmF1bHRzIG9yIHByb21wdCB0aGUgdXNlciB2aXN1YWxseVxuICAgKi9cbiAgaW50ZXJhY3RpdmU/OiBib29sZWFuO1xuICAvKipcbiAgICogQW4gYXN5bmMgZnVuY3Rpb24gdGhhdCByZXR1cm5zIHRydWUgb3IgZmFsc2UgaW4gb3JkZXIgdG8gY29uZmlybSB0aGUgc3RhcnRcbiAgICogb2YgaW1wb3J0aW5nXG4gICAqL1xuICBjb25maXJtSW1wb3J0PzogKCkgPT4gUHJvbWlzZTxib29sZWFuPjtcbiAgLyoqXG4gICAqIEFuIGFzeW5jIGZ1bmN0aW9uIHRoYXQgcmV0dXJucyB3aGV0aGVyIHRoZSBpbXBvcnQgc2hvdWxkIGNvbnRpbnVlIGlmIGl0XG4gICAqIGxvb2tzIGxpa2UgYSBmb3JnZSBwcm9qZWN0IGFscmVhZHlcbiAgICovXG4gIHNob3VsZENvbnRpbnVlT25FeGlzdGluZz86ICgpID0+IFByb21pc2U8Ym9vbGVhbj47XG4gIC8qKlxuICAgKiBBbiBhc3luYyBmdW5jdGlvbiB0aGF0IHJldHVybnMgd2hldGhlciB0aGUgZ2l2ZW4gZGVwZW5kZW5jeSBzaG91bGQgYmUgcmVtb3ZlZFxuICAgKi9cbiAgc2hvdWxkUmVtb3ZlRGVwZW5kZW5jeT86IChkZXBlbmRlbmN5OiBzdHJpbmcsIGV4cGxhbmF0aW9uOiBzdHJpbmcpID0+IFByb21pc2U8Ym9vbGVhbj47XG4gIC8qKlxuICAgKiBBbiBhc3luYyBmdW5jdGlvbiB0aGF0IHJldHVybnMgd2hldGhlciB0aGUgZ2l2ZW4gc2NyaXB0IHNob3VsZCBiZSBvdmVycmlkZGVuIHdpdGggYSBmb3JnZSBvbmVcbiAgICovXG4gIHNob3VsZFVwZGF0ZVNjcmlwdD86IChzY3JpcHROYW1lOiBzdHJpbmcsIG5ld1ZhbHVlOiBzdHJpbmcpID0+IFByb21pc2U8Ym9vbGVhbj47XG4gIC8qKlxuICAgKiBUaGUgcGF0aCB0byB0aGUgZGlyZWN0b3J5IGNvbnRhaW5pbmcgZ2VuZXJhdGVkIGRpc3RyaWJ1dGFibGVzXG4gICAqL1xuICBvdXREaXI/OiBzdHJpbmc7XG59XG5cbmV4cG9ydCBkZWZhdWx0IGFzeW5jICh7XG4gIGRpciA9IHByb2Nlc3MuY3dkKCksXG4gIGludGVyYWN0aXZlID0gZmFsc2UsXG4gIGNvbmZpcm1JbXBvcnQsXG4gIHNob3VsZENvbnRpbnVlT25FeGlzdGluZyxcbiAgc2hvdWxkUmVtb3ZlRGVwZW5kZW5jeSxcbiAgc2hvdWxkVXBkYXRlU2NyaXB0LFxuICBvdXREaXIsXG59OiBJbXBvcnRPcHRpb25zKSA9PiB7XG4gIGNvbnN0IGNhbGN1bGF0ZWRPdXREaXIgPSBvdXREaXIgfHwgJ291dCc7XG4gIGFzeW5jT3JhLmludGVyYWN0aXZlID0gaW50ZXJhY3RpdmU7XG5cbiAgZChgQXR0ZW1wdGluZyB0byBpbXBvcnQgcHJvamVjdCBpbjogJHtkaXJ9YCk7XG4gIGlmICghYXdhaXQgZnMucGF0aEV4aXN0cyhkaXIpIHx8ICFhd2FpdCBmcy5wYXRoRXhpc3RzKHBhdGgucmVzb2x2ZShkaXIsICdwYWNrYWdlLmpzb24nKSkpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYFdlIGNvdWxkbid0IGZpbmQgYSBwcm9qZWN0IGluOiAke2Rpcn1gKTtcbiAgfVxuXG4gIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBtYXgtbGVuXG4gIGlmICh0eXBlb2YgY29uZmlybUltcG9ydCA9PT0gJ2Z1bmN0aW9uJykge1xuICAgIGlmICghYXdhaXQgY29uZmlybUltcG9ydCgpKSB7XG4gICAgICBwcm9jZXNzLmV4aXQoMCk7XG4gICAgfVxuICB9XG5cbiAgYXdhaXQgaW5pdEdpdChkaXIpO1xuXG4gIGNvbnN0IGltcG9ydERlcHMgPSAoW10gYXMgc3RyaW5nW10pLmNvbmNhdChkZXBzKTtcbiAgbGV0IGltcG9ydERldkRlcHMgPSAoW10gYXMgc3RyaW5nW10pLmNvbmNhdChkZXZEZXBzKTtcbiAgbGV0IGltcG9ydEV4YWN0RGV2RGVwcyA9IChbXSBhcyBzdHJpbmdbXSkuY29uY2F0KGV4YWN0RGV2RGVwcyk7XG5cbiAgbGV0IHBhY2thZ2VKU09OID0gYXdhaXQgcmVhZFJhd1BhY2thZ2VKc29uKGRpcik7XG4gIGlmIChwYWNrYWdlSlNPTi5jb25maWcgJiYgcGFja2FnZUpTT04uY29uZmlnLmZvcmdlKSB7XG4gICAgaWYgKHBhY2thZ2VKU09OLmNvbmZpZy5mb3JnZS5tYWtlcnMpIHtcbiAgICAgIHdhcm4oaW50ZXJhY3RpdmUsICdJdCBsb29rcyBsaWtlIHRoaXMgcHJvamVjdCBpcyBhbHJlYWR5IGNvbmZpZ3VyZWQgZm9yIEVsZWN0cm9uIEZvcmdlJy5ncmVlbik7XG4gICAgICBpZiAodHlwZW9mIHNob3VsZENvbnRpbnVlT25FeGlzdGluZyA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICBpZiAoIWF3YWl0IHNob3VsZENvbnRpbnVlT25FeGlzdGluZygpKSB7XG4gICAgICAgICAgcHJvY2Vzcy5leGl0KDApO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSBlbHNlIGlmICh0eXBlb2YgcGFja2FnZUpTT04uY29uZmlnLmZvcmdlID09PSAnc3RyaW5nJykge1xuICAgICAgd2FybihpbnRlcmFjdGl2ZSwgXCJXZSBjYW4ndCB0ZWxsIGlmIHRoZSBFbGVjdHJvbiBGb3JnZSBjb25maWcgaXMgY29tcGF0aWJsZSBiZWNhdXNlIGl0J3MgaW4gYW4gZXh0ZXJuYWwgSmF2YVNjcmlwdCBmaWxlLCBub3QgdHJ5aW5nIHRvIGNvbnZlcnQgaXQgYW5kIGNvbnRpbnVpbmcgYW55d2F5XCIueWVsbG93KTtcbiAgICB9IGVsc2Uge1xuICAgICAgZCgnVXBncmFkaW5nIGFuIEVsZWN0cm9uIEZvcmdlIDwgNiBwcm9qZWN0Jyk7XG4gICAgICBwYWNrYWdlSlNPTi5jb25maWcuZm9yZ2UgPSB1cGdyYWRlRm9yZ2VDb25maWcocGFja2FnZUpTT04uY29uZmlnLmZvcmdlKTtcbiAgICAgIGltcG9ydERldkRlcHMgPSB1cGRhdGVVcGdyYWRlZEZvcmdlRGV2RGVwcyhwYWNrYWdlSlNPTiwgaW1wb3J0RGV2RGVwcyk7XG4gICAgfVxuICB9XG5cbiAgcGFja2FnZUpTT04uZGVwZW5kZW5jaWVzID0gcGFja2FnZUpTT04uZGVwZW5kZW5jaWVzIHx8IHt9O1xuICBwYWNrYWdlSlNPTi5kZXZEZXBlbmRlbmNpZXMgPSBwYWNrYWdlSlNPTi5kZXZEZXBlbmRlbmNpZXMgfHwge307XG5cbiAgW2ltcG9ydERldkRlcHMsIGltcG9ydEV4YWN0RGV2RGVwc10gPSB1cGRhdGVFbGVjdHJvbkRlcGVuZGVuY3koXG4gICAgcGFja2FnZUpTT04sXG4gICAgaW1wb3J0RGV2RGVwcyxcbiAgICBpbXBvcnRFeGFjdERldkRlcHMsXG4gICk7XG5cbiAgY29uc3Qga2V5cyA9IE9iamVjdC5rZXlzKHBhY2thZ2VKU09OLmRlcGVuZGVuY2llcylcbiAgICAuY29uY2F0KE9iamVjdC5rZXlzKHBhY2thZ2VKU09OLmRldkRlcGVuZGVuY2llcykpO1xuICBjb25zdCBidWlsZFRvb2xQYWNrYWdlczoge1xuICAgIFtrZXk6IHN0cmluZ106IHN0cmluZyB8IHVuZGVmaW5lZDtcbiAgfSA9IHtcbiAgICAnQGVsZWN0cm9uL2dldCc6ICdhbHJlYWR5IHVzZXMgdGhpcyBtb2R1bGUgYXMgYSB0cmFuc2l0aXZlIGRlcGVuZGVuY3knLFxuICAgICdlbGVjdHJvbi1idWlsZGVyJzogJ3Byb3ZpZGVzIG1vc3RseSBlcXVpdmFsZW50IGZ1bmN0aW9uYWxpdHknLFxuICAgICdlbGVjdHJvbi1kb3dubG9hZCc6ICdhbHJlYWR5IHVzZXMgdGhpcyBtb2R1bGUgYXMgYSB0cmFuc2l0aXZlIGRlcGVuZGVuY3knLFxuICAgICdlbGVjdHJvbi1mb3JnZSc6ICdyZXBsYWNlZCB3aXRoIEBlbGVjdHJvbi1mb3JnZS9jbGknLFxuICAgICdlbGVjdHJvbi1pbnN0YWxsZXItZGViaWFuJzogJ2FscmVhZHkgdXNlcyB0aGlzIG1vZHVsZSBhcyBhIHRyYW5zaXRpdmUgZGVwZW5kZW5jeScsXG4gICAgJ2VsZWN0cm9uLWluc3RhbGxlci1kbWcnOiAnYWxyZWFkeSB1c2VzIHRoaXMgbW9kdWxlIGFzIGEgdHJhbnNpdGl2ZSBkZXBlbmRlbmN5JyxcbiAgICAnZWxlY3Ryb24taW5zdGFsbGVyLWZsYXRwYWsnOiAnYWxyZWFkeSB1c2VzIHRoaXMgbW9kdWxlIGFzIGEgdHJhbnNpdGl2ZSBkZXBlbmRlbmN5JyxcbiAgICAnZWxlY3Ryb24taW5zdGFsbGVyLXJlZGhhdCc6ICdhbHJlYWR5IHVzZXMgdGhpcyBtb2R1bGUgYXMgYSB0cmFuc2l0aXZlIGRlcGVuZGVuY3knLFxuICAgICdlbGVjdHJvbi1vc3gtc2lnbic6ICdhbHJlYWR5IHVzZXMgdGhpcyBtb2R1bGUgYXMgYSB0cmFuc2l0aXZlIGRlcGVuZGVuY3knLFxuICAgICdlbGVjdHJvbi1wYWNrYWdlcic6ICdhbHJlYWR5IHVzZXMgdGhpcyBtb2R1bGUgYXMgYSB0cmFuc2l0aXZlIGRlcGVuZGVuY3knLFxuICAgICdlbGVjdHJvbi13aW5zdGFsbGVyJzogJ2FscmVhZHkgdXNlcyB0aGlzIG1vZHVsZSBhcyBhIHRyYW5zaXRpdmUgZGVwZW5kZW5jeScsXG4gIH07XG5cbiAgZm9yIChjb25zdCBrZXkgb2Yga2V5cykge1xuICAgIGlmIChidWlsZFRvb2xQYWNrYWdlc1trZXldKSB7XG4gICAgICBjb25zdCBleHBsYW5hdGlvbiA9IGJ1aWxkVG9vbFBhY2thZ2VzW2tleV0hO1xuICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG1heC1sZW5cbiAgICAgIGxldCByZW1vdmUgPSB0cnVlO1xuICAgICAgaWYgKHR5cGVvZiBzaG91bGRSZW1vdmVEZXBlbmRlbmN5ID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgIHJlbW92ZSA9IGF3YWl0IHNob3VsZFJlbW92ZURlcGVuZGVuY3koa2V5LCBleHBsYW5hdGlvbik7XG4gICAgICB9XG5cbiAgICAgIGlmIChyZW1vdmUpIHtcbiAgICAgICAgZGVsZXRlIHBhY2thZ2VKU09OLmRlcGVuZGVuY2llc1trZXldO1xuICAgICAgICBkZWxldGUgcGFja2FnZUpTT04uZGV2RGVwZW5kZW5jaWVzW2tleV07XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcGFja2FnZUpTT04uc2NyaXB0cyA9IHBhY2thZ2VKU09OLnNjcmlwdHMgfHwge307XG4gIGQoJ3JlYWRpbmcgY3VycmVudCBzY3JpcHRzIG9iamVjdDonLCBwYWNrYWdlSlNPTi5zY3JpcHRzKTtcblxuICBjb25zdCB1cGRhdGVQYWNrYWdlU2NyaXB0ID0gYXN5bmMgKHNjcmlwdE5hbWU6IHN0cmluZywgbmV3VmFsdWU6IHN0cmluZykgPT4ge1xuICAgIGlmIChwYWNrYWdlSlNPTi5zY3JpcHRzW3NjcmlwdE5hbWVdICE9PSBuZXdWYWx1ZSkge1xuICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG1heC1sZW5cbiAgICAgIGxldCB1cGRhdGUgPSB0cnVlO1xuICAgICAgaWYgKHR5cGVvZiBzaG91bGRVcGRhdGVTY3JpcHQgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgdXBkYXRlID0gYXdhaXQgc2hvdWxkVXBkYXRlU2NyaXB0KHNjcmlwdE5hbWUsIG5ld1ZhbHVlKTtcbiAgICAgIH1cbiAgICAgIGlmICh1cGRhdGUpIHtcbiAgICAgICAgcGFja2FnZUpTT04uc2NyaXB0c1tzY3JpcHROYW1lXSA9IG5ld1ZhbHVlO1xuICAgICAgfVxuICAgIH1cbiAgfTtcblxuICBhd2FpdCB1cGRhdGVQYWNrYWdlU2NyaXB0KCdzdGFydCcsICdlbGVjdHJvbi1mb3JnZSBzdGFydCcpO1xuICBhd2FpdCB1cGRhdGVQYWNrYWdlU2NyaXB0KCdwYWNrYWdlJywgJ2VsZWN0cm9uLWZvcmdlIHBhY2thZ2UnKTtcbiAgYXdhaXQgdXBkYXRlUGFja2FnZVNjcmlwdCgnbWFrZScsICdlbGVjdHJvbi1mb3JnZSBtYWtlJyk7XG5cbiAgZCgnZm9yZ2lmaWVkIHNjcmlwdHMgb2JqZWN0OicsIHBhY2thZ2VKU09OLnNjcmlwdHMpO1xuXG4gIGNvbnN0IHdyaXRlQ2hhbmdlcyA9IGFzeW5jICgpID0+IHtcbiAgICBhd2FpdCBhc3luY09yYSgnV3JpdGluZyBtb2RpZmllZCBwYWNrYWdlLmpzb24gZmlsZScsIGFzeW5jICgpID0+IHtcbiAgICAgIGF3YWl0IGZzLndyaXRlSnNvbihwYXRoLnJlc29sdmUoZGlyLCAncGFja2FnZS5qc29uJyksIHBhY2thZ2VKU09OLCB7IHNwYWNlczogMiB9KTtcbiAgICB9KTtcbiAgfTtcblxuICBhd2FpdCB3cml0ZUNoYW5nZXMoKTtcblxuICBhd2FpdCBhc3luY09yYSgnSW5zdGFsbGluZyBkZXBlbmRlbmNpZXMnLCBhc3luYyAoKSA9PiB7XG4gICAgZCgnZGVsZXRpbmcgb2xkIGRlcGVuZGVuY2llcyBmb3JjZWZ1bGx5Jyk7XG4gICAgYXdhaXQgZnMucmVtb3ZlKHBhdGgucmVzb2x2ZShkaXIsICdub2RlX21vZHVsZXMvLmJpbi9lbGVjdHJvbicpKTtcbiAgICBhd2FpdCBmcy5yZW1vdmUocGF0aC5yZXNvbHZlKGRpciwgJ25vZGVfbW9kdWxlcy8uYmluL2VsZWN0cm9uLmNtZCcpKTtcblxuICAgIGQoJ2luc3RhbGxpbmcgZGVwZW5kZW5jaWVzJyk7XG4gICAgYXdhaXQgaW5zdGFsbERlcExpc3QoZGlyLCBpbXBvcnREZXBzKTtcblxuICAgIGQoJ2luc3RhbGxpbmcgZGV2RGVwZW5kZW5jaWVzJyk7XG4gICAgYXdhaXQgaW5zdGFsbERlcExpc3QoZGlyLCBpbXBvcnREZXZEZXBzLCBEZXBUeXBlLkRFVik7XG5cbiAgICBkKCdpbnN0YWxsaW5nIGV4YWN0RGV2RGVwZW5kZW5jaWVzJyk7XG4gICAgYXdhaXQgaW5zdGFsbERlcExpc3QoZGlyLCBpbXBvcnRFeGFjdERldkRlcHMsIERlcFR5cGUuREVWLCBEZXBWZXJzaW9uUmVzdHJpY3Rpb24uRVhBQ1QpO1xuICB9KTtcblxuICBwYWNrYWdlSlNPTiA9IGF3YWl0IHJlYWRSYXdQYWNrYWdlSnNvbihkaXIpO1xuXG4gIGlmICghcGFja2FnZUpTT04udmVyc2lvbikge1xuICAgIHdhcm4oaW50ZXJhY3RpdmUsICdQbGVhc2Ugc2V0IHRoZSBcInZlcnNpb25cIiBpbiB5b3VyIGFwcGxpY2F0aW9uXFwncyBwYWNrYWdlLmpzb24nLnllbGxvdyk7XG4gIH1cblxuICBwYWNrYWdlSlNPTi5jb25maWcgPSBwYWNrYWdlSlNPTi5jb25maWcgfHwge307XG4gIGNvbnN0IHRlbXBsYXRlUGFja2FnZUpTT04gPSBhd2FpdCByZWFkUmF3UGFja2FnZUpzb24oYmFzZVRlbXBsYXRlLnRlbXBsYXRlRGlyKTtcbiAgaWYgKHBhY2thZ2VKU09OLmNvbmZpZy5mb3JnZSkge1xuICAgIGlmICh0eXBlb2YgcGFja2FnZUpTT04uY29uZmlnLmZvcmdlICE9PSAnc3RyaW5nJykge1xuICAgICAgcGFja2FnZUpTT04uY29uZmlnLmZvcmdlID0gbWVyZ2UodGVtcGxhdGVQYWNrYWdlSlNPTi5jb25maWcuZm9yZ2UsIHBhY2thZ2VKU09OLmNvbmZpZy5mb3JnZSk7XG4gICAgfVxuICB9IGVsc2Uge1xuICAgIHBhY2thZ2VKU09OLmNvbmZpZy5mb3JnZSA9IHRlbXBsYXRlUGFja2FnZUpTT04uY29uZmlnLmZvcmdlO1xuICB9XG5cbiAgaWYgKHR5cGVvZiBwYWNrYWdlSlNPTi5jb25maWcuZm9yZ2UgIT09ICdzdHJpbmcnKSB7XG4gICAgc2V0SW5pdGlhbEZvcmdlQ29uZmlnKHBhY2thZ2VKU09OKTtcbiAgfVxuXG4gIGF3YWl0IHdyaXRlQ2hhbmdlcygpO1xuXG4gIGF3YWl0IGFzeW5jT3JhKCdGaXhpbmcgLmdpdGlnbm9yZScsIGFzeW5jICgpID0+IHtcbiAgICBpZiAoYXdhaXQgZnMucGF0aEV4aXN0cyhwYXRoLnJlc29sdmUoZGlyLCAnLmdpdGlnbm9yZScpKSkge1xuICAgICAgY29uc3QgZ2l0aWdub3JlID0gYXdhaXQgZnMucmVhZEZpbGUocGF0aC5yZXNvbHZlKGRpciwgJy5naXRpZ25vcmUnKSk7XG4gICAgICBpZiAoIWdpdGlnbm9yZS5pbmNsdWRlcyhjYWxjdWxhdGVkT3V0RGlyKSkge1xuICAgICAgICBhd2FpdCBmcy53cml0ZUZpbGUocGF0aC5yZXNvbHZlKGRpciwgJy5naXRpZ25vcmUnKSwgYCR7Z2l0aWdub3JlfVxcbiR7Y2FsY3VsYXRlZE91dERpcn0vYCk7XG4gICAgICB9XG4gICAgfVxuICB9KTtcblxuICBpbmZvKGludGVyYWN0aXZlLCBgXG5cbldlIGhhdmUgQVRURU1QVEVEIHRvIGNvbnZlcnQgeW91ciBhcHAgdG8gYmUgaW4gYSBmb3JtYXQgdGhhdCBlbGVjdHJvbi1mb3JnZSB1bmRlcnN0YW5kcy5cblxuVGhhbmtzIGZvciB1c2luZyAkeydcImVsZWN0cm9uLWZvcmdlXCInLmdyZWVufSEhIWApO1xufTtcbiJdfQ==
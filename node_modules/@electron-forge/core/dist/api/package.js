"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

require("colors");

var _asyncOra = require("@electron-forge/async-ora");

var _debug = _interopRequireDefault(require("debug"));

var _fsExtra = _interopRequireDefault(require("fs-extra"));

var _get = require("@electron/get");

var _glob = _interopRequireDefault(require("glob"));

var _electronPackager = _interopRequireDefault(require("electron-packager"));

var _path = _interopRequireDefault(require("path"));

var _util = require("util");

var _forgeConfig = _interopRequireDefault(require("../util/forge-config"));

var _hook = require("../util/hook");

var _messages = require("../util/messages");

var _readPackageJson = require("../util/read-package-json");

var _rebuild = _interopRequireDefault(require("../util/rebuild"));

var _requireSearch = _interopRequireDefault(require("../util/require-search"));

var _resolveDir = _interopRequireDefault(require("../util/resolve-dir"));

var _outDir = _interopRequireDefault(require("../util/out-dir"));

var _electronVersion = require("../util/electron-version");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const d = (0, _debug.default)('electron-forge:packager');

/**
 * Resolves hooks if they are a path to a file (instead of a `Function`).
 */
function resolveHooks(hooks, dir) {
  if (hooks) {
    return hooks.map(hook => typeof hook === 'string' ? (0, _requireSearch.default)(dir, [hook]) : hook);
  }

  return [];
}
/**
 * Runs given hooks sequentially by mapping them to promises and iterating
 * through while awaiting
 */


function sequentialHooks(hooks) {
  return [async (...args) => {
    const done = args[args.length - 1];
    const passedArgs = args.splice(0, args.length - 1);

    for (const hook of hooks) {
      await (0, _util.promisify)(hook)(...passedArgs);
    }

    done();
  }];
}

var _default = async ({
  dir = process.cwd(),
  interactive = false,
  arch = (0, _get.getHostArch)(),
  platform = process.platform,
  outDir
}) => {
  const ora = interactive ? _asyncOra.ora : _asyncOra.fakeOra;
  let prepareSpinner = ora(`Preparing to Package Application for arch: ${(arch === 'all' ? 'ia32' : arch).cyan}`).start();
  let prepareCounter = 0;
  const resolvedDir = await (0, _resolveDir.default)(dir);

  if (!resolvedDir) {
    throw new Error('Failed to locate compilable Electron application');
  }

  dir = resolvedDir;
  const forgeConfig = await (0, _forgeConfig.default)(dir);
  const packageJSON = await (0, _readPackageJson.readMutatedPackageJson)(dir, forgeConfig);

  if (!packageJSON.main) {
    throw new Error('packageJSON.main must be set to a valid entry point for your Electron app');
  }

  const calculatedOutDir = outDir || (0, _outDir.default)(dir, forgeConfig);
  let packagerSpinner = null;
  const pruneEnabled = !('prune' in forgeConfig.packagerConfig) || forgeConfig.packagerConfig.prune;
  const afterCopyHooks = [async (buildPath, electronVersion, pPlatform, pArch, done) => {
    if (packagerSpinner) {
      packagerSpinner.succeed();
      prepareCounter += 1;
      prepareSpinner = ora(`Preparing to Package Application for arch: ${(prepareCounter === 2 ? 'armv7l' : 'x64').cyan}`).start();
    }

    const bins = await (0, _util.promisify)(_glob.default)(_path.default.join(buildPath, '**/.bin/**/*'));

    for (const bin of bins) {
      await _fsExtra.default.remove(bin);
    }

    done();
  }, async (buildPath, electronVersion, pPlatform, pArch, done) => {
    prepareSpinner.succeed();
    await (0, _hook.runHook)(forgeConfig, 'packageAfterCopy', buildPath, electronVersion, pPlatform, pArch);
    done();
  }, async (buildPath, electronVersion, pPlatform, pArch, done) => {
    await (0, _rebuild.default)(buildPath, electronVersion, pPlatform, pArch, forgeConfig.electronRebuildConfig);
    packagerSpinner = ora('Packaging Application').start();
    done();
  }];
  afterCopyHooks.push(async (buildPath, electronVersion, pPlatform, pArch, done) => {
    const copiedPackageJSON = await (0, _readPackageJson.readMutatedPackageJson)(buildPath, forgeConfig);

    if (copiedPackageJSON.config && copiedPackageJSON.config.forge) {
      delete copiedPackageJSON.config.forge;
    }

    await _fsExtra.default.writeJson(_path.default.resolve(buildPath, 'package.json'), copiedPackageJSON, {
      spaces: 2
    });
    done();
  });
  afterCopyHooks.push(...resolveHooks(forgeConfig.packagerConfig.afterCopy, dir));
  const afterPruneHooks = [];

  if (pruneEnabled) {
    afterPruneHooks.push(...resolveHooks(forgeConfig.packagerConfig.afterPrune, dir));
  }

  afterPruneHooks.push(async (buildPath, electronVersion, pPlatform, pArch, done) => {
    await (0, _hook.runHook)(forgeConfig, 'packageAfterPrune', buildPath, electronVersion, pPlatform, pArch);
    done();
  });
  const afterExtractHooks = [async (buildPath, electronVersion, pPlatform, pArch, done) => {
    await (0, _hook.runHook)(forgeConfig, 'packageAfterExtract', buildPath, electronVersion, pPlatform, pArch);
    done();
  }];
  afterExtractHooks.push(...resolveHooks(forgeConfig.packagerConfig.afterExtract, dir));
  const packageOpts = {
    asar: false,
    overwrite: true,
    ...forgeConfig.packagerConfig,
    dir,
    arch: arch,
    platform,
    afterCopy: sequentialHooks(afterCopyHooks),
    afterExtract: sequentialHooks(afterExtractHooks),
    afterPrune: sequentialHooks(afterPruneHooks),
    out: calculatedOutDir,
    electronVersion: await (0, _electronVersion.getElectronVersion)(dir, packageJSON)
  };
  packageOpts.quiet = true;

  if (packageOpts.all) {
    throw new Error('config.forge.packagerConfig.all is not supported by Electron Forge');
  }

  if (!packageJSON.version && !packageOpts.appVersion) {
    // eslint-disable-next-line max-len
    (0, _messages.warn)(interactive, 'Please set "version" or "config.forge.packagerConfig.appVersion" in your application\'s package.json so auto-updates work properly'.yellow);
  }

  if (packageOpts.prebuiltAsar) {
    throw new Error('config.forge.packagerConfig.prebuiltAsar is not supported by Electron Forge');
  }

  await (0, _hook.runHook)(forgeConfig, 'generateAssets');
  await (0, _hook.runHook)(forgeConfig, 'prePackage');
  d('packaging with options', packageOpts);
  const outputPaths = await (0, _electronPackager.default)(packageOpts);
  await (0, _hook.runHook)(forgeConfig, 'postPackage', {
    arch,
    outputPaths,
    platform,
    spinner: packagerSpinner
  });
  if (packagerSpinner) packagerSpinner.succeed();
};

exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9hcGkvcGFja2FnZS50cyJdLCJuYW1lcyI6WyJkIiwicmVzb2x2ZUhvb2tzIiwiaG9va3MiLCJkaXIiLCJtYXAiLCJob29rIiwic2VxdWVudGlhbEhvb2tzIiwiYXJncyIsImRvbmUiLCJsZW5ndGgiLCJwYXNzZWRBcmdzIiwic3BsaWNlIiwicHJvY2VzcyIsImN3ZCIsImludGVyYWN0aXZlIiwiYXJjaCIsInBsYXRmb3JtIiwib3V0RGlyIiwib3JhIiwicmVhbE9yYSIsImZha2VPcmEiLCJwcmVwYXJlU3Bpbm5lciIsImN5YW4iLCJzdGFydCIsInByZXBhcmVDb3VudGVyIiwicmVzb2x2ZWREaXIiLCJFcnJvciIsImZvcmdlQ29uZmlnIiwicGFja2FnZUpTT04iLCJtYWluIiwiY2FsY3VsYXRlZE91dERpciIsInBhY2thZ2VyU3Bpbm5lciIsInBydW5lRW5hYmxlZCIsInBhY2thZ2VyQ29uZmlnIiwicHJ1bmUiLCJhZnRlckNvcHlIb29rcyIsImJ1aWxkUGF0aCIsImVsZWN0cm9uVmVyc2lvbiIsInBQbGF0Zm9ybSIsInBBcmNoIiwic3VjY2VlZCIsImJpbnMiLCJnbG9iIiwicGF0aCIsImpvaW4iLCJiaW4iLCJmcyIsInJlbW92ZSIsImVsZWN0cm9uUmVidWlsZENvbmZpZyIsInB1c2giLCJjb3BpZWRQYWNrYWdlSlNPTiIsImNvbmZpZyIsImZvcmdlIiwid3JpdGVKc29uIiwicmVzb2x2ZSIsInNwYWNlcyIsImFmdGVyQ29weSIsImFmdGVyUHJ1bmVIb29rcyIsImFmdGVyUHJ1bmUiLCJhZnRlckV4dHJhY3RIb29rcyIsImFmdGVyRXh0cmFjdCIsInBhY2thZ2VPcHRzIiwiYXNhciIsIm92ZXJ3cml0ZSIsIm91dCIsInF1aWV0IiwiYWxsIiwidmVyc2lvbiIsImFwcFZlcnNpb24iLCJ5ZWxsb3ciLCJwcmVidWlsdEFzYXIiLCJvdXRwdXRQYXRocyIsInNwaW5uZXIiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUVB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RDs7QUFFRCxNQUFJLENBQUNFLFdBQVcsQ0FBQ3VDLE9BQWIsSUFBd0IsQ0FBQ04sV0FBVyxDQUFDTyxVQUF6QyxFQUFxRDtBQUNuRDtBQUNBLHdCQUFLdEQsV0FBTCxFQUFrQixxSUFBcUl1RCxNQUF2SjtBQUNEOztBQUVELE1BQUlSLFdBQVcsQ0FBQ1MsWUFBaEIsRUFBOEI7QUFDNUIsVUFBTSxJQUFJNUMsS0FBSixDQUFVLDZFQUFWLENBQU47QUFDRDs7QUFFRCxRQUFNLG1CQUFRQyxXQUFSLEVBQXFCLGdCQUFyQixDQUFOO0FBQ0EsUUFBTSxtQkFBUUEsV0FBUixFQUFxQixZQUFyQixDQUFOO0FBRUEzQixFQUFBQSxDQUFDLENBQUMsd0JBQUQsRUFBMkI2RCxXQUEzQixDQUFEO0FBRUEsUUFBTVUsV0FBVyxHQUFHLE1BQU0sK0JBQVNWLFdBQVQsQ0FBMUI7QUFFQSxRQUFNLG1CQUFRbEMsV0FBUixFQUFxQixhQUFyQixFQUFvQztBQUN4Q1osSUFBQUEsSUFEd0M7QUFFeEN3RCxJQUFBQSxXQUZ3QztBQUd4Q3ZELElBQUFBLFFBSHdDO0FBSXhDd0QsSUFBQUEsT0FBTyxFQUFFekM7QUFKK0IsR0FBcEMsQ0FBTjtBQU9BLE1BQUlBLGVBQUosRUFBcUJBLGVBQWUsQ0FBRVMsT0FBakI7QUFDdEIsQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAnY29sb3JzJztcbmltcG9ydCB7IG9yYSBhcyByZWFsT3JhLCBmYWtlT3JhLCBPcmFJbXBsIH0gZnJvbSAnQGVsZWN0cm9uLWZvcmdlL2FzeW5jLW9yYSc7XG5pbXBvcnQgeyBGb3JnZUFyY2gsIEZvcmdlUGxhdGZvcm0gfSBmcm9tICdAZWxlY3Ryb24tZm9yZ2Uvc2hhcmVkLXR5cGVzJztcbmltcG9ydCBkZWJ1ZyBmcm9tICdkZWJ1Zyc7XG5pbXBvcnQgZnMgZnJvbSAnZnMtZXh0cmEnO1xuaW1wb3J0IHsgZ2V0SG9zdEFyY2ggfSBmcm9tICdAZWxlY3Ryb24vZ2V0JztcbmltcG9ydCBnbG9iIGZyb20gJ2dsb2InO1xuaW1wb3J0IHBhY2thZ2VyIGZyb20gJ2VsZWN0cm9uLXBhY2thZ2VyJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgcHJvbWlzaWZ5IH0gZnJvbSAndXRpbCc7XG5cbmltcG9ydCBnZXRGb3JnZUNvbmZpZyBmcm9tICcuLi91dGlsL2ZvcmdlLWNvbmZpZyc7XG5pbXBvcnQgeyBydW5Ib29rIH0gZnJvbSAnLi4vdXRpbC9ob29rJztcbmltcG9ydCB7IHdhcm4gfSBmcm9tICcuLi91dGlsL21lc3NhZ2VzJztcbmltcG9ydCB7IHJlYWRNdXRhdGVkUGFja2FnZUpzb24gfSBmcm9tICcuLi91dGlsL3JlYWQtcGFja2FnZS1qc29uJztcbmltcG9ydCByZWJ1aWxkSG9vayBmcm9tICcuLi91dGlsL3JlYnVpbGQnO1xuaW1wb3J0IHJlcXVpcmVTZWFyY2ggZnJvbSAnLi4vdXRpbC9yZXF1aXJlLXNlYXJjaCc7XG5pbXBvcnQgcmVzb2x2ZURpciBmcm9tICcuLi91dGlsL3Jlc29sdmUtZGlyJztcbmltcG9ydCBnZXRDdXJyZW50T3V0RGlyIGZyb20gJy4uL3V0aWwvb3V0LWRpcic7XG5pbXBvcnQgeyBnZXRFbGVjdHJvblZlcnNpb24gfSBmcm9tICcuLi91dGlsL2VsZWN0cm9uLXZlcnNpb24nO1xuXG5jb25zdCBkID0gZGVidWcoJ2VsZWN0cm9uLWZvcmdlOnBhY2thZ2VyJyk7XG5cbnR5cGUgRWxlY3Ryb25QYWNrYWdlckFmdGVyQ29weUhvb2sgPSAoXG4gIGJ1aWxkUGF0aDogc3RyaW5nLFxuICBlbGVjdHJvblZlcnNpb246IHN0cmluZyxcbiAgcFBsYXRmb3JtOiBGb3JnZVBsYXRmb3JtLFxuICBwQXJjaDogRm9yZ2VBcmNoLFxuICBkb25lOiAoZXJyPzogRXJyb3IpID0+IHZvaWRcbikgPT4gdm9pZDtcblxuLyoqXG4gKiBSZXNvbHZlcyBob29rcyBpZiB0aGV5IGFyZSBhIHBhdGggdG8gYSBmaWxlIChpbnN0ZWFkIG9mIGEgYEZ1bmN0aW9uYCkuXG4gKi9cbmZ1bmN0aW9uIHJlc29sdmVIb29rcyhob29rczogKHN0cmluZyB8IEVsZWN0cm9uUGFja2FnZXJBZnRlckNvcHlIb29rKVtdIHwgdW5kZWZpbmVkLCBkaXI6IHN0cmluZykge1xuICBpZiAoaG9va3MpIHtcbiAgICByZXR1cm4gaG9va3MubWFwKChob29rKSA9PiAoXG4gICAgICB0eXBlb2YgaG9vayA9PT0gJ3N0cmluZydcbiAgICAgICAgPyByZXF1aXJlU2VhcmNoPEVsZWN0cm9uUGFja2FnZXJBZnRlckNvcHlIb29rPihkaXIsIFtob29rXSkgYXMgRWxlY3Ryb25QYWNrYWdlckFmdGVyQ29weUhvb2tcbiAgICAgICAgOiBob29rXG4gICAgKSk7XG4gIH1cblxuICByZXR1cm4gW107XG59XG5cbi8qKlxuICogUnVucyBnaXZlbiBob29rcyBzZXF1ZW50aWFsbHkgYnkgbWFwcGluZyB0aGVtIHRvIHByb21pc2VzIGFuZCBpdGVyYXRpbmdcbiAqIHRocm91Z2ggd2hpbGUgYXdhaXRpbmdcbiAqL1xuZnVuY3Rpb24gc2VxdWVudGlhbEhvb2tzKGhvb2tzOiBGdW5jdGlvbltdKSB7XG4gIHJldHVybiBbYXN5bmMgKC4uLmFyZ3M6IGFueVtdKSA9PiB7XG4gICAgY29uc3QgZG9uZSA9IGFyZ3NbYXJncy5sZW5ndGggLSAxXTtcbiAgICBjb25zdCBwYXNzZWRBcmdzID0gYXJncy5zcGxpY2UoMCwgYXJncy5sZW5ndGggLSAxKTtcbiAgICBmb3IgKGNvbnN0IGhvb2sgb2YgaG9va3MpIHtcbiAgICAgIGF3YWl0IHByb21pc2lmeShob29rKSguLi5wYXNzZWRBcmdzKTtcbiAgICB9XG4gICAgZG9uZSgpO1xuICB9XSBhcyBbKC4uLmFyZ3M6IGFueVtdKSA9PiBQcm9taXNlPHZvaWQ+XTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBQYWNrYWdlT3B0aW9ucyB7XG4gIC8qKlxuICAgKiBUaGUgcGF0aCB0byB0aGUgYXBwIHRvIHBhY2thZ2VcbiAgICovXG4gIGRpcj86IHN0cmluZztcbiAgLyoqXG4gICAqIFdoZXRoZXIgdG8gdXNlIHNlbnNpYmxlIGRlZmF1bHRzIG9yIHByb21wdCB0aGUgdXNlciB2aXN1YWxseVxuICAgKi9cbiAgaW50ZXJhY3RpdmU/OiBib29sZWFuO1xuICAvKipcbiAgICogVGhlIHRhcmdldCBhcmNoXG4gICAqL1xuICBhcmNoPzogRm9yZ2VBcmNoO1xuICAvKipcbiAgICogVGhlIHRhcmdldCBwbGF0Zm9ybS5cbiAgICovXG4gIHBsYXRmb3JtPzogRm9yZ2VQbGF0Zm9ybTtcbiAgLyoqXG4gICAqIFRoZSBwYXRoIHRvIHRoZSBvdXRwdXQgZGlyZWN0b3J5IGZvciBwYWNrYWdlZCBhcHBzXG4gICAqL1xuICBvdXREaXI/OiBzdHJpbmc7XG59XG5cbmV4cG9ydCBkZWZhdWx0IGFzeW5jICh7XG4gIGRpciA9IHByb2Nlc3MuY3dkKCksXG4gIGludGVyYWN0aXZlID0gZmFsc2UsXG4gIGFyY2ggPSBnZXRIb3N0QXJjaCgpIGFzIEZvcmdlQXJjaCxcbiAgcGxhdGZvcm0gPSBwcm9jZXNzLnBsYXRmb3JtIGFzIEZvcmdlUGxhdGZvcm0sXG4gIG91dERpcixcbn06IFBhY2thZ2VPcHRpb25zKSA9PiB7XG4gIGNvbnN0IG9yYSA9IGludGVyYWN0aXZlID8gcmVhbE9yYSA6IGZha2VPcmE7XG5cbiAgbGV0IHByZXBhcmVTcGlubmVyID0gb3JhKGBQcmVwYXJpbmcgdG8gUGFja2FnZSBBcHBsaWNhdGlvbiBmb3IgYXJjaDogJHsoYXJjaCA9PT0gJ2FsbCcgPyAnaWEzMicgOiBhcmNoKS5jeWFufWApLnN0YXJ0KCk7XG4gIGxldCBwcmVwYXJlQ291bnRlciA9IDA7XG5cbiAgY29uc3QgcmVzb2x2ZWREaXIgPSBhd2FpdCByZXNvbHZlRGlyKGRpcik7XG4gIGlmICghcmVzb2x2ZWREaXIpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ0ZhaWxlZCB0byBsb2NhdGUgY29tcGlsYWJsZSBFbGVjdHJvbiBhcHBsaWNhdGlvbicpO1xuICB9XG4gIGRpciA9IHJlc29sdmVkRGlyO1xuXG4gIGNvbnN0IGZvcmdlQ29uZmlnID0gYXdhaXQgZ2V0Rm9yZ2VDb25maWcoZGlyKTtcbiAgY29uc3QgcGFja2FnZUpTT04gPSBhd2FpdCByZWFkTXV0YXRlZFBhY2thZ2VKc29uKGRpciwgZm9yZ2VDb25maWcpO1xuXG4gIGlmICghcGFja2FnZUpTT04ubWFpbikge1xuICAgIHRocm93IG5ldyBFcnJvcigncGFja2FnZUpTT04ubWFpbiBtdXN0IGJlIHNldCB0byBhIHZhbGlkIGVudHJ5IHBvaW50IGZvciB5b3VyIEVsZWN0cm9uIGFwcCcpO1xuICB9XG5cbiAgY29uc3QgY2FsY3VsYXRlZE91dERpciA9IG91dERpciB8fCBnZXRDdXJyZW50T3V0RGlyKGRpciwgZm9yZ2VDb25maWcpO1xuICBsZXQgcGFja2FnZXJTcGlubmVyOiBPcmFJbXBsIHwgbnVsbCA9IG51bGw7XG5cbiAgY29uc3QgcHJ1bmVFbmFibGVkID0gISgncHJ1bmUnIGluIGZvcmdlQ29uZmlnLnBhY2thZ2VyQ29uZmlnKSB8fCBmb3JnZUNvbmZpZy5wYWNrYWdlckNvbmZpZy5wcnVuZTtcblxuICBjb25zdCBhZnRlckNvcHlIb29rczogRWxlY3Ryb25QYWNrYWdlckFmdGVyQ29weUhvb2tbXSA9IFtcbiAgICBhc3luYyAoYnVpbGRQYXRoLCBlbGVjdHJvblZlcnNpb24sIHBQbGF0Zm9ybSwgcEFyY2gsIGRvbmUpID0+IHtcbiAgICAgIGlmIChwYWNrYWdlclNwaW5uZXIpIHtcbiAgICAgICAgcGFja2FnZXJTcGlubmVyLnN1Y2NlZWQoKTtcbiAgICAgICAgcHJlcGFyZUNvdW50ZXIgKz0gMTtcbiAgICAgICAgcHJlcGFyZVNwaW5uZXIgPSBvcmEoYFByZXBhcmluZyB0byBQYWNrYWdlIEFwcGxpY2F0aW9uIGZvciBhcmNoOiAkeyhwcmVwYXJlQ291bnRlciA9PT0gMiA/ICdhcm12N2wnIDogJ3g2NCcpLmN5YW59YCkuc3RhcnQoKTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IGJpbnMgPSBhd2FpdCBwcm9taXNpZnkoZ2xvYikocGF0aC5qb2luKGJ1aWxkUGF0aCwgJyoqLy5iaW4vKiovKicpKTtcbiAgICAgIGZvciAoY29uc3QgYmluIG9mIGJpbnMpIHtcbiAgICAgICAgYXdhaXQgZnMucmVtb3ZlKGJpbik7XG4gICAgICB9XG4gICAgICBkb25lKCk7XG4gICAgfSwgYXN5bmMgKGJ1aWxkUGF0aCwgZWxlY3Ryb25WZXJzaW9uLCBwUGxhdGZvcm0sIHBBcmNoLCBkb25lKSA9PiB7XG4gICAgICBwcmVwYXJlU3Bpbm5lci5zdWNjZWVkKCk7XG4gICAgICBhd2FpdCBydW5Ib29rKGZvcmdlQ29uZmlnLCAncGFja2FnZUFmdGVyQ29weScsIGJ1aWxkUGF0aCwgZWxlY3Ryb25WZXJzaW9uLCBwUGxhdGZvcm0sIHBBcmNoKTtcbiAgICAgIGRvbmUoKTtcbiAgICB9LFxuICAgIGFzeW5jIChidWlsZFBhdGgsIGVsZWN0cm9uVmVyc2lvbiwgcFBsYXRmb3JtLCBwQXJjaCwgZG9uZSkgPT4ge1xuICAgICAgYXdhaXQgcmVidWlsZEhvb2soXG4gICAgICAgIGJ1aWxkUGF0aCxcbiAgICAgICAgZWxlY3Ryb25WZXJzaW9uLFxuICAgICAgICBwUGxhdGZvcm0sXG4gICAgICAgIHBBcmNoLFxuICAgICAgICBmb3JnZUNvbmZpZy5lbGVjdHJvblJlYnVpbGRDb25maWcsXG4gICAgICApO1xuICAgICAgcGFja2FnZXJTcGlubmVyID0gb3JhKCdQYWNrYWdpbmcgQXBwbGljYXRpb24nKS5zdGFydCgpO1xuICAgICAgZG9uZSgpO1xuICAgIH0sXG4gIF07XG5cbiAgYWZ0ZXJDb3B5SG9va3MucHVzaChhc3luYyAoYnVpbGRQYXRoLCBlbGVjdHJvblZlcnNpb24sIHBQbGF0Zm9ybSwgcEFyY2gsIGRvbmUpID0+IHtcbiAgICBjb25zdCBjb3BpZWRQYWNrYWdlSlNPTiA9IGF3YWl0IHJlYWRNdXRhdGVkUGFja2FnZUpzb24oYnVpbGRQYXRoLCBmb3JnZUNvbmZpZyk7XG4gICAgaWYgKGNvcGllZFBhY2thZ2VKU09OLmNvbmZpZyAmJiBjb3BpZWRQYWNrYWdlSlNPTi5jb25maWcuZm9yZ2UpIHtcbiAgICAgIGRlbGV0ZSBjb3BpZWRQYWNrYWdlSlNPTi5jb25maWcuZm9yZ2U7XG4gICAgfVxuICAgIGF3YWl0IGZzLndyaXRlSnNvbihwYXRoLnJlc29sdmUoYnVpbGRQYXRoLCAncGFja2FnZS5qc29uJyksIGNvcGllZFBhY2thZ2VKU09OLCB7IHNwYWNlczogMiB9KTtcbiAgICBkb25lKCk7XG4gIH0pO1xuXG4gIGFmdGVyQ29weUhvb2tzLnB1c2goLi4ucmVzb2x2ZUhvb2tzKGZvcmdlQ29uZmlnLnBhY2thZ2VyQ29uZmlnLmFmdGVyQ29weSwgZGlyKSk7XG5cbiAgY29uc3QgYWZ0ZXJQcnVuZUhvb2tzID0gW107XG5cbiAgaWYgKHBydW5lRW5hYmxlZCkge1xuICAgIGFmdGVyUHJ1bmVIb29rcy5wdXNoKC4uLnJlc29sdmVIb29rcyhmb3JnZUNvbmZpZy5wYWNrYWdlckNvbmZpZy5hZnRlclBydW5lLCBkaXIpKTtcbiAgfVxuXG4gIGFmdGVyUHJ1bmVIb29rcy5wdXNoKChhc3luYyAoYnVpbGRQYXRoLCBlbGVjdHJvblZlcnNpb24sIHBQbGF0Zm9ybSwgcEFyY2gsIGRvbmUpID0+IHtcbiAgICBhd2FpdCBydW5Ib29rKGZvcmdlQ29uZmlnLCAncGFja2FnZUFmdGVyUHJ1bmUnLCBidWlsZFBhdGgsIGVsZWN0cm9uVmVyc2lvbiwgcFBsYXRmb3JtLCBwQXJjaCk7XG4gICAgZG9uZSgpO1xuICB9KSBhcyBFbGVjdHJvblBhY2thZ2VyQWZ0ZXJDb3B5SG9vayk7XG5cbiAgY29uc3QgYWZ0ZXJFeHRyYWN0SG9va3MgPSBbKGFzeW5jIChidWlsZFBhdGgsIGVsZWN0cm9uVmVyc2lvbiwgcFBsYXRmb3JtLCBwQXJjaCwgZG9uZSkgPT4ge1xuICAgIGF3YWl0IHJ1bkhvb2soZm9yZ2VDb25maWcsICdwYWNrYWdlQWZ0ZXJFeHRyYWN0JywgYnVpbGRQYXRoLCBlbGVjdHJvblZlcnNpb24sIHBQbGF0Zm9ybSwgcEFyY2gpO1xuICAgIGRvbmUoKTtcbiAgfSkgYXMgRWxlY3Ryb25QYWNrYWdlckFmdGVyQ29weUhvb2tdO1xuICBhZnRlckV4dHJhY3RIb29rcy5wdXNoKC4uLnJlc29sdmVIb29rcyhmb3JnZUNvbmZpZy5wYWNrYWdlckNvbmZpZy5hZnRlckV4dHJhY3QsIGRpcikpO1xuXG4gIHR5cGUgUGFja2FnZXJBcmNoID0gRXhjbHVkZTxGb3JnZUFyY2gsICdhcm0nPjtcblxuICBjb25zdCBwYWNrYWdlT3B0czogcGFja2FnZXIuT3B0aW9ucyA9IHtcbiAgICBhc2FyOiBmYWxzZSxcbiAgICBvdmVyd3JpdGU6IHRydWUsXG4gICAgLi4uZm9yZ2VDb25maWcucGFja2FnZXJDb25maWcsXG4gICAgZGlyLFxuICAgIGFyY2g6IGFyY2ggYXMgUGFja2FnZXJBcmNoLFxuICAgIHBsYXRmb3JtLFxuICAgIGFmdGVyQ29weTogc2VxdWVudGlhbEhvb2tzKGFmdGVyQ29weUhvb2tzKSxcbiAgICBhZnRlckV4dHJhY3Q6IHNlcXVlbnRpYWxIb29rcyhhZnRlckV4dHJhY3RIb29rcyksXG4gICAgYWZ0ZXJQcnVuZTogc2VxdWVudGlhbEhvb2tzKGFmdGVyUHJ1bmVIb29rcyksXG4gICAgb3V0OiBjYWxjdWxhdGVkT3V0RGlyLFxuICAgIGVsZWN0cm9uVmVyc2lvbjogYXdhaXQgZ2V0RWxlY3Ryb25WZXJzaW9uKGRpciwgcGFja2FnZUpTT04pLFxuICB9O1xuICBwYWNrYWdlT3B0cy5xdWlldCA9IHRydWU7XG5cbiAgaWYgKHBhY2thZ2VPcHRzLmFsbCkge1xuICAgIHRocm93IG5ldyBFcnJvcignY29uZmlnLmZvcmdlLnBhY2thZ2VyQ29uZmlnLmFsbCBpcyBub3Qgc3VwcG9ydGVkIGJ5IEVsZWN0cm9uIEZvcmdlJyk7XG4gIH1cblxuICBpZiAoIXBhY2thZ2VKU09OLnZlcnNpb24gJiYgIXBhY2thZ2VPcHRzLmFwcFZlcnNpb24pIHtcbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbWF4LWxlblxuICAgIHdhcm4oaW50ZXJhY3RpdmUsICdQbGVhc2Ugc2V0IFwidmVyc2lvblwiIG9yIFwiY29uZmlnLmZvcmdlLnBhY2thZ2VyQ29uZmlnLmFwcFZlcnNpb25cIiBpbiB5b3VyIGFwcGxpY2F0aW9uXFwncyBwYWNrYWdlLmpzb24gc28gYXV0by11cGRhdGVzIHdvcmsgcHJvcGVybHknLnllbGxvdyk7XG4gIH1cblxuICBpZiAocGFja2FnZU9wdHMucHJlYnVpbHRBc2FyKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdjb25maWcuZm9yZ2UucGFja2FnZXJDb25maWcucHJlYnVpbHRBc2FyIGlzIG5vdCBzdXBwb3J0ZWQgYnkgRWxlY3Ryb24gRm9yZ2UnKTtcbiAgfVxuXG4gIGF3YWl0IHJ1bkhvb2soZm9yZ2VDb25maWcsICdnZW5lcmF0ZUFzc2V0cycpO1xuICBhd2FpdCBydW5Ib29rKGZvcmdlQ29uZmlnLCAncHJlUGFja2FnZScpO1xuXG4gIGQoJ3BhY2thZ2luZyB3aXRoIG9wdGlvbnMnLCBwYWNrYWdlT3B0cyk7XG5cbiAgY29uc3Qgb3V0cHV0UGF0aHMgPSBhd2FpdCBwYWNrYWdlcihwYWNrYWdlT3B0cyk7XG5cbiAgYXdhaXQgcnVuSG9vayhmb3JnZUNvbmZpZywgJ3Bvc3RQYWNrYWdlJywge1xuICAgIGFyY2gsXG4gICAgb3V0cHV0UGF0aHMsXG4gICAgcGxhdGZvcm0sXG4gICAgc3Bpbm5lcjogcGFja2FnZXJTcGlubmVyLFxuICB9KTtcblxuICBpZiAocGFja2FnZXJTcGlubmVyKSBwYWNrYWdlclNwaW5uZXIhLnN1Y2NlZWQoKTtcbn07XG4iXX0=
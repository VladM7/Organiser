"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _asyncOra = require("@electron-forge/async-ora");

var _chalk = _interopRequireDefault(require("chalk"));

var _debug = _interopRequireDefault(require("debug"));

var _fsExtra = _interopRequireDefault(require("fs-extra"));

var _get = require("@electron/get");

var _fastGlob = _interopRequireDefault(require("fast-glob"));

var _electronPackager = _interopRequireDefault(require("electron-packager"));

var _path = _interopRequireDefault(require("path"));

var _util = require("util");

var _forgeConfig = _interopRequireDefault(require("../util/forge-config"));

var _hook = require("../util/hook");

var _messages = require("../util/messages");

var _readPackageJson = require("../util/read-package-json");

var _rebuild = _interopRequireDefault(require("../util/rebuild"));

var _requireSearch = _interopRequireDefault(require("../util/require-search"));

var _resolveDir = _interopRequireDefault(require("../util/resolve-dir"));

var _outDir = _interopRequireDefault(require("../util/out-dir"));

var _electronVersion = require("../util/electron-version");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const d = (0, _debug.default)('electron-forge:packager');
/**
 * Resolves hooks if they are a path to a file (instead of a `Function`).
 */

function resolveHooks(hooks, dir) {
  if (hooks) {
    return hooks.map(hook => typeof hook === 'string' ? (0, _requireSearch.default)(dir, [hook]) : hook);
  }

  return [];
}

/**
 * Runs given hooks sequentially by mapping them to promises and iterating
 * through while awaiting
 */
function sequentialHooks(hooks) {
  return [async (buildPath, electronVersion, platform, arch, done) => {
    for (const hook of hooks) {
      await (0, _util.promisify)(hook)(buildPath, electronVersion, platform, arch);
    }

    done();
  }];
}

var _default = async ({
  dir = process.cwd(),
  interactive = false,
  arch = (0, _get.getHostArch)(),
  platform = process.platform,
  outDir
}) => {
  const ora = interactive ? _asyncOra.ora : _asyncOra.fakeOra;
  let prepareSpinner = ora(`Preparing to Package Application for arch: ${_chalk.default.cyan(arch === 'all' ? 'ia32' : arch)}`).start();
  let prepareCounter = 0;
  const resolvedDir = await (0, _resolveDir.default)(dir);

  if (!resolvedDir) {
    throw new Error('Failed to locate compilable Electron application');
  }

  dir = resolvedDir;
  const forgeConfig = await (0, _forgeConfig.default)(dir);
  const packageJSON = await (0, _readPackageJson.readMutatedPackageJson)(dir, forgeConfig);

  if (!packageJSON.main) {
    throw new Error('packageJSON.main must be set to a valid entry point for your Electron app');
  }

  const calculatedOutDir = outDir || (0, _outDir.default)(dir, forgeConfig);
  let packagerSpinner;
  const pruneEnabled = !('prune' in forgeConfig.packagerConfig) || forgeConfig.packagerConfig.prune;
  const afterCopyHooks = [async (buildPath, electronVersion, pPlatform, pArch, done) => {
    if (packagerSpinner) {
      packagerSpinner.succeed();
      prepareCounter += 1;
      prepareSpinner = ora(`Preparing to Package Application for arch: ${_chalk.default.cyan(prepareCounter === 2 ? 'armv7l' : 'x64')}`).start();
    }

    const bins = await (0, _fastGlob.default)(_path.default.join(buildPath, '**/.bin/**/*'));

    for (const bin of bins) {
      await _fsExtra.default.remove(bin);
    }

    done();
  }, async (buildPath, electronVersion, pPlatform, pArch, done) => {
    prepareSpinner.succeed();
    await (0, _hook.runHook)(forgeConfig, 'packageAfterCopy', buildPath, electronVersion, pPlatform, pArch);
    done();
  }, async (buildPath, electronVersion, pPlatform, pArch, done) => {
    await (0, _rebuild.default)(buildPath, electronVersion, pPlatform, pArch, forgeConfig.electronRebuildConfig);
    packagerSpinner = ora('Packaging Application').start();
    done();
  }];
  afterCopyHooks.push(async (buildPath, electronVersion, pPlatform, pArch, done) => {
    const copiedPackageJSON = await (0, _readPackageJson.readMutatedPackageJson)(buildPath, forgeConfig);

    if (copiedPackageJSON.config && copiedPackageJSON.config.forge) {
      delete copiedPackageJSON.config.forge;
    }

    await _fsExtra.default.writeJson(_path.default.resolve(buildPath, 'package.json'), copiedPackageJSON, {
      spaces: 2
    });
    done();
  });
  afterCopyHooks.push(...resolveHooks(forgeConfig.packagerConfig.afterCopy, dir));
  const afterPruneHooks = [];

  if (pruneEnabled) {
    afterPruneHooks.push(...resolveHooks(forgeConfig.packagerConfig.afterPrune, dir));
  }

  afterPruneHooks.push(async (buildPath, electronVersion, pPlatform, pArch, done) => {
    await (0, _hook.runHook)(forgeConfig, 'packageAfterPrune', buildPath, electronVersion, pPlatform, pArch);
    done();
  });
  const afterExtractHooks = [async (buildPath, electronVersion, pPlatform, pArch, done) => {
    await (0, _hook.runHook)(forgeConfig, 'packageAfterExtract', buildPath, electronVersion, pPlatform, pArch);
    done();
  }];
  afterExtractHooks.push(...resolveHooks(forgeConfig.packagerConfig.afterExtract, dir));
  const packageOpts = {
    asar: false,
    overwrite: true,
    ...forgeConfig.packagerConfig,
    dir,
    arch: arch,
    platform,
    afterCopy: sequentialHooks(afterCopyHooks),
    afterExtract: sequentialHooks(afterExtractHooks),
    afterPrune: sequentialHooks(afterPruneHooks),
    out: calculatedOutDir,
    electronVersion: await (0, _electronVersion.getElectronVersion)(dir, packageJSON)
  };
  packageOpts.quiet = true;

  if (packageOpts.all) {
    throw new Error('config.forge.packagerConfig.all is not supported by Electron Forge');
  }

  if (!packageJSON.version && !packageOpts.appVersion) {
    // eslint-disable-next-line max-len
    (0, _messages.warn)(interactive, _chalk.default.yellow('Please set "version" or "config.forge.packagerConfig.appVersion" in your application\'s package.json so auto-updates work properly'));
  }

  if (packageOpts.prebuiltAsar) {
    throw new Error('config.forge.packagerConfig.prebuiltAsar is not supported by Electron Forge');
  }

  await (0, _hook.runHook)(forgeConfig, 'generateAssets', platform, arch);
  await (0, _hook.runHook)(forgeConfig, 'prePackage', platform, arch);
  d('packaging with options', packageOpts);
  const outputPaths = await (0, _electronPackager.default)(packageOpts);
  await (0, _hook.runHook)(forgeConfig, 'postPackage', {
    arch,
    outputPaths,
    platform,
    spinner: packagerSpinner
  }); // eslint-disable-next-line @typescript-eslint/no-non-null-assertion

  if (packagerSpinner) packagerSpinner.succeed();
};

exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9hcGkvcGFja2FnZS50cyJdLCJuYW1lcyI6WyJkIiwicmVzb2x2ZUhvb2tzIiwiaG9va3MiLCJkaXIiLCJtYXAiLCJob29rIiwic2VxdWVudGlhbEhvb2tzIiwiYnVpbGRQYXRoIiwiZWxlY3Ryb25WZXJzaW9uIiwicGxhdGZvcm0iLCJhcmNoIiwiZG9uZSIsInByb2Nlc3MiLCJjd2QiLCJpbnRlcmFjdGl2ZSIsIm91dERpciIsIm9yYSIsInJlYWxPcmEiLCJmYWtlT3JhIiwicHJlcGFyZVNwaW5uZXIiLCJjaGFsayIsImN5YW4iLCJzdGFydCIsInByZXBhcmVDb3VudGVyIiwicmVzb2x2ZWREaXIiLCJFcnJvciIsImZvcmdlQ29uZmlnIiwicGFja2FnZUpTT04iLCJtYWluIiwiY2FsY3VsYXRlZE91dERpciIsInBhY2thZ2VyU3Bpbm5lciIsInBydW5lRW5hYmxlZCIsInBhY2thZ2VyQ29uZmlnIiwicHJ1bmUiLCJhZnRlckNvcHlIb29rcyIsInBQbGF0Zm9ybSIsInBBcmNoIiwic3VjY2VlZCIsImJpbnMiLCJwYXRoIiwiam9pbiIsImJpbiIsImZzIiwicmVtb3ZlIiwiZWxlY3Ryb25SZWJ1aWxkQ29uZmlnIiwicHVzaCIsImNvcGllZFBhY2thZ2VKU09OIiwiY29uZmlnIiwiZm9yZ2UiLCJ3cml0ZUpzb24iLCJyZXNvbHZlIiwic3BhY2VzIiwiYWZ0ZXJDb3B5IiwiYWZ0ZXJQcnVuZUhvb2tzIiwiYWZ0ZXJQcnVuZSIsImFmdGVyRXh0cmFjdEhvb2tzIiwiYWZ0ZXJFeHRyYWN0IiwicGFja2FnZU9wdHMiLCJhc2FyIiwib3ZlcndyaXRlIiwib3V0IiwicXVpZXQiLCJhbGwiLCJ2ZXJzaW9uIiwiYXBwVmVyc2lvbiIsInllbGxvdyIsInByZWJ1aWx0QXNhciIsIm91dHB1dFBhdGhzIiwic3Bpbm5lciJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBQUE7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7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RUFFRU0sZUFBTTZDLE1BQU4sQ0FBYSxvSUFBYixDQUZGO0FBSUQ7O0FBRUQsTUFBSVIsV0FBVyxDQUFDUyxZQUFoQixFQUE4QjtBQUM1QixVQUFNLElBQUl6QyxLQUFKLENBQVUsNkVBQVYsQ0FBTjtBQUNEOztBQUVELFFBQU0sbUJBQVFDLFdBQVIsRUFBcUIsZ0JBQXJCLEVBQXVDakIsUUFBdkMsRUFBaURDLElBQWpELENBQU47QUFDQSxRQUFNLG1CQUFRZ0IsV0FBUixFQUFxQixZQUFyQixFQUFtQ2pCLFFBQW5DLEVBQTZDQyxJQUE3QyxDQUFOO0FBRUFWLEVBQUFBLENBQUMsQ0FBQyx3QkFBRCxFQUEyQnlELFdBQTNCLENBQUQ7QUFFQSxRQUFNVSxXQUFXLEdBQUcsTUFBTSwrQkFBU1YsV0FBVCxDQUExQjtBQUVBLFFBQU0sbUJBQVEvQixXQUFSLEVBQXFCLGFBQXJCLEVBQW9DO0FBQ3hDaEIsSUFBQUEsSUFEd0M7QUFFeEN5RCxJQUFBQSxXQUZ3QztBQUd4QzFELElBQUFBLFFBSHdDO0FBSXhDMkQsSUFBQUEsT0FBTyxFQUFFdEM7QUFKK0IsR0FBcEMsQ0FBTixDQXZIbUMsQ0E4SG5DOztBQUNBLE1BQUlBLGVBQUosRUFBcUJBLGVBQWUsQ0FBRU8sT0FBakI7QUFDdEIsQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IG9yYSBhcyByZWFsT3JhLCBmYWtlT3JhLCBPcmFJbXBsIH0gZnJvbSAnQGVsZWN0cm9uLWZvcmdlL2FzeW5jLW9yYSc7XG5pbXBvcnQgeyBGb3JnZUFyY2gsIEZvcmdlUGxhdGZvcm0gfSBmcm9tICdAZWxlY3Ryb24tZm9yZ2Uvc2hhcmVkLXR5cGVzJztcbmltcG9ydCBjaGFsayBmcm9tICdjaGFsayc7XG5pbXBvcnQgZGVidWcgZnJvbSAnZGVidWcnO1xuaW1wb3J0IGZzIGZyb20gJ2ZzLWV4dHJhJztcbmltcG9ydCB7IGdldEhvc3RBcmNoIH0gZnJvbSAnQGVsZWN0cm9uL2dldCc7XG5pbXBvcnQgZ2xvYiBmcm9tICdmYXN0LWdsb2InO1xuaW1wb3J0IHBhY2thZ2VyLCB7IEhvb2tGdW5jdGlvbiB9IGZyb20gJ2VsZWN0cm9uLXBhY2thZ2VyJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgcHJvbWlzaWZ5IH0gZnJvbSAndXRpbCc7XG5cbmltcG9ydCBnZXRGb3JnZUNvbmZpZyBmcm9tICcuLi91dGlsL2ZvcmdlLWNvbmZpZyc7XG5pbXBvcnQgeyBydW5Ib29rIH0gZnJvbSAnLi4vdXRpbC9ob29rJztcbmltcG9ydCB7IHdhcm4gfSBmcm9tICcuLi91dGlsL21lc3NhZ2VzJztcbmltcG9ydCB7IHJlYWRNdXRhdGVkUGFja2FnZUpzb24gfSBmcm9tICcuLi91dGlsL3JlYWQtcGFja2FnZS1qc29uJztcbmltcG9ydCByZWJ1aWxkSG9vayBmcm9tICcuLi91dGlsL3JlYnVpbGQnO1xuaW1wb3J0IHJlcXVpcmVTZWFyY2ggZnJvbSAnLi4vdXRpbC9yZXF1aXJlLXNlYXJjaCc7XG5pbXBvcnQgcmVzb2x2ZURpciBmcm9tICcuLi91dGlsL3Jlc29sdmUtZGlyJztcbmltcG9ydCBnZXRDdXJyZW50T3V0RGlyIGZyb20gJy4uL3V0aWwvb3V0LWRpcic7XG5pbXBvcnQgeyBnZXRFbGVjdHJvblZlcnNpb24gfSBmcm9tICcuLi91dGlsL2VsZWN0cm9uLXZlcnNpb24nO1xuXG5jb25zdCBkID0gZGVidWcoJ2VsZWN0cm9uLWZvcmdlOnBhY2thZ2VyJyk7XG5cbi8qKlxuICogUmVzb2x2ZXMgaG9va3MgaWYgdGhleSBhcmUgYSBwYXRoIHRvIGEgZmlsZSAoaW5zdGVhZCBvZiBhIGBGdW5jdGlvbmApLlxuICovXG5mdW5jdGlvbiByZXNvbHZlSG9va3MoaG9va3M6IChzdHJpbmcgfCBIb29rRnVuY3Rpb24pW10gfCB1bmRlZmluZWQsIGRpcjogc3RyaW5nKSB7XG4gIGlmIChob29rcykge1xuICAgIHJldHVybiBob29rcy5tYXAoKGhvb2spID0+ICh0eXBlb2YgaG9vayA9PT0gJ3N0cmluZycgPyAocmVxdWlyZVNlYXJjaDxIb29rRnVuY3Rpb24+KGRpciwgW2hvb2tdKSBhcyBIb29rRnVuY3Rpb24pIDogaG9vaykpO1xuICB9XG5cbiAgcmV0dXJuIFtdO1xufVxuXG50eXBlIERvbmVGdW5jdGlvbiA9ICgpID0+IHZvaWQ7XG50eXBlIFByb21pc2lmaWVkSG9va0Z1bmN0aW9uID0gKGJ1aWxkUGF0aDogc3RyaW5nLCBlbGVjdHJvblZlcnNpb246IHN0cmluZywgcGxhdGZvcm06IHN0cmluZywgYXJjaDogc3RyaW5nKSA9PiBQcm9taXNlPHZvaWQ+O1xuXG4vKipcbiAqIFJ1bnMgZ2l2ZW4gaG9va3Mgc2VxdWVudGlhbGx5IGJ5IG1hcHBpbmcgdGhlbSB0byBwcm9taXNlcyBhbmQgaXRlcmF0aW5nXG4gKiB0aHJvdWdoIHdoaWxlIGF3YWl0aW5nXG4gKi9cbmZ1bmN0aW9uIHNlcXVlbnRpYWxIb29rcyhob29rczogSG9va0Z1bmN0aW9uW10pOiBQcm9taXNpZmllZEhvb2tGdW5jdGlvbltdIHtcbiAgcmV0dXJuIFtcbiAgICBhc3luYyAoYnVpbGRQYXRoOiBzdHJpbmcsIGVsZWN0cm9uVmVyc2lvbjogc3RyaW5nLCBwbGF0Zm9ybTogc3RyaW5nLCBhcmNoOiBzdHJpbmcsIGRvbmU6IERvbmVGdW5jdGlvbikgPT4ge1xuICAgICAgZm9yIChjb25zdCBob29rIG9mIGhvb2tzKSB7XG4gICAgICAgIGF3YWl0IHByb21pc2lmeShob29rKShidWlsZFBhdGgsIGVsZWN0cm9uVmVyc2lvbiwgcGxhdGZvcm0sIGFyY2gpO1xuICAgICAgfVxuICAgICAgZG9uZSgpO1xuICAgIH0sXG4gIF0gYXMgUHJvbWlzaWZpZWRIb29rRnVuY3Rpb25bXTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBQYWNrYWdlT3B0aW9ucyB7XG4gIC8qKlxuICAgKiBUaGUgcGF0aCB0byB0aGUgYXBwIHRvIHBhY2thZ2VcbiAgICovXG4gIGRpcj86IHN0cmluZztcbiAgLyoqXG4gICAqIFdoZXRoZXIgdG8gdXNlIHNlbnNpYmxlIGRlZmF1bHRzIG9yIHByb21wdCB0aGUgdXNlciB2aXN1YWxseVxuICAgKi9cbiAgaW50ZXJhY3RpdmU/OiBib29sZWFuO1xuICAvKipcbiAgICogVGhlIHRhcmdldCBhcmNoXG4gICAqL1xuICBhcmNoPzogRm9yZ2VBcmNoO1xuICAvKipcbiAgICogVGhlIHRhcmdldCBwbGF0Zm9ybS5cbiAgICovXG4gIHBsYXRmb3JtPzogRm9yZ2VQbGF0Zm9ybTtcbiAgLyoqXG4gICAqIFRoZSBwYXRoIHRvIHRoZSBvdXRwdXQgZGlyZWN0b3J5IGZvciBwYWNrYWdlZCBhcHBzXG4gICAqL1xuICBvdXREaXI/OiBzdHJpbmc7XG59XG5cbmV4cG9ydCBkZWZhdWx0IGFzeW5jICh7XG4gIGRpciA9IHByb2Nlc3MuY3dkKCksXG4gIGludGVyYWN0aXZlID0gZmFsc2UsXG4gIGFyY2ggPSBnZXRIb3N0QXJjaCgpIGFzIEZvcmdlQXJjaCxcbiAgcGxhdGZvcm0gPSBwcm9jZXNzLnBsYXRmb3JtIGFzIEZvcmdlUGxhdGZvcm0sXG4gIG91dERpcixcbn06IFBhY2thZ2VPcHRpb25zKTogUHJvbWlzZTx2b2lkPiA9PiB7XG4gIGNvbnN0IG9yYSA9IGludGVyYWN0aXZlID8gcmVhbE9yYSA6IGZha2VPcmE7XG5cbiAgbGV0IHByZXBhcmVTcGlubmVyID0gb3JhKGBQcmVwYXJpbmcgdG8gUGFja2FnZSBBcHBsaWNhdGlvbiBmb3IgYXJjaDogJHtjaGFsay5jeWFuKGFyY2ggPT09ICdhbGwnID8gJ2lhMzInIDogYXJjaCl9YCkuc3RhcnQoKTtcbiAgbGV0IHByZXBhcmVDb3VudGVyID0gMDtcblxuICBjb25zdCByZXNvbHZlZERpciA9IGF3YWl0IHJlc29sdmVEaXIoZGlyKTtcbiAgaWYgKCFyZXNvbHZlZERpcikge1xuICAgIHRocm93IG5ldyBFcnJvcignRmFpbGVkIHRvIGxvY2F0ZSBjb21waWxhYmxlIEVsZWN0cm9uIGFwcGxpY2F0aW9uJyk7XG4gIH1cbiAgZGlyID0gcmVzb2x2ZWREaXI7XG5cbiAgY29uc3QgZm9yZ2VDb25maWcgPSBhd2FpdCBnZXRGb3JnZUNvbmZpZyhkaXIpO1xuICBjb25zdCBwYWNrYWdlSlNPTiA9IGF3YWl0IHJlYWRNdXRhdGVkUGFja2FnZUpzb24oZGlyLCBmb3JnZUNvbmZpZyk7XG5cbiAgaWYgKCFwYWNrYWdlSlNPTi5tYWluKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdwYWNrYWdlSlNPTi5tYWluIG11c3QgYmUgc2V0IHRvIGEgdmFsaWQgZW50cnkgcG9pbnQgZm9yIHlvdXIgRWxlY3Ryb24gYXBwJyk7XG4gIH1cblxuICBjb25zdCBjYWxjdWxhdGVkT3V0RGlyID0gb3V0RGlyIHx8IGdldEN1cnJlbnRPdXREaXIoZGlyLCBmb3JnZUNvbmZpZyk7XG4gIGxldCBwYWNrYWdlclNwaW5uZXI6IE9yYUltcGwgfCB1bmRlZmluZWQ7XG5cbiAgY29uc3QgcHJ1bmVFbmFibGVkID0gISgncHJ1bmUnIGluIGZvcmdlQ29uZmlnLnBhY2thZ2VyQ29uZmlnKSB8fCBmb3JnZUNvbmZpZy5wYWNrYWdlckNvbmZpZy5wcnVuZTtcblxuICBjb25zdCBhZnRlckNvcHlIb29rczogSG9va0Z1bmN0aW9uW10gPSBbXG4gICAgYXN5bmMgKGJ1aWxkUGF0aCwgZWxlY3Ryb25WZXJzaW9uLCBwUGxhdGZvcm0sIHBBcmNoLCBkb25lKSA9PiB7XG4gICAgICBpZiAocGFja2FnZXJTcGlubmVyKSB7XG4gICAgICAgIHBhY2thZ2VyU3Bpbm5lci5zdWNjZWVkKCk7XG4gICAgICAgIHByZXBhcmVDb3VudGVyICs9IDE7XG4gICAgICAgIHByZXBhcmVTcGlubmVyID0gb3JhKGBQcmVwYXJpbmcgdG8gUGFja2FnZSBBcHBsaWNhdGlvbiBmb3IgYXJjaDogJHtjaGFsay5jeWFuKHByZXBhcmVDb3VudGVyID09PSAyID8gJ2FybXY3bCcgOiAneDY0Jyl9YCkuc3RhcnQoKTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IGJpbnMgPSBhd2FpdCBnbG9iKHBhdGguam9pbihidWlsZFBhdGgsICcqKi8uYmluLyoqLyonKSk7XG4gICAgICBmb3IgKGNvbnN0IGJpbiBvZiBiaW5zKSB7XG4gICAgICAgIGF3YWl0IGZzLnJlbW92ZShiaW4pO1xuICAgICAgfVxuICAgICAgZG9uZSgpO1xuICAgIH0sXG4gICAgYXN5bmMgKGJ1aWxkUGF0aCwgZWxlY3Ryb25WZXJzaW9uLCBwUGxhdGZvcm0sIHBBcmNoLCBkb25lKSA9PiB7XG4gICAgICBwcmVwYXJlU3Bpbm5lci5zdWNjZWVkKCk7XG4gICAgICBhd2FpdCBydW5Ib29rKGZvcmdlQ29uZmlnLCAncGFja2FnZUFmdGVyQ29weScsIGJ1aWxkUGF0aCwgZWxlY3Ryb25WZXJzaW9uLCBwUGxhdGZvcm0sIHBBcmNoKTtcbiAgICAgIGRvbmUoKTtcbiAgICB9LFxuICAgIGFzeW5jIChidWlsZFBhdGgsIGVsZWN0cm9uVmVyc2lvbiwgcFBsYXRmb3JtLCBwQXJjaCwgZG9uZSkgPT4ge1xuICAgICAgYXdhaXQgcmVidWlsZEhvb2soYnVpbGRQYXRoLCBlbGVjdHJvblZlcnNpb24sIHBQbGF0Zm9ybSwgcEFyY2gsIGZvcmdlQ29uZmlnLmVsZWN0cm9uUmVidWlsZENvbmZpZyk7XG4gICAgICBwYWNrYWdlclNwaW5uZXIgPSBvcmEoJ1BhY2thZ2luZyBBcHBsaWNhdGlvbicpLnN0YXJ0KCk7XG4gICAgICBkb25lKCk7XG4gICAgfSxcbiAgXTtcblxuICBhZnRlckNvcHlIb29rcy5wdXNoKGFzeW5jIChidWlsZFBhdGgsIGVsZWN0cm9uVmVyc2lvbiwgcFBsYXRmb3JtLCBwQXJjaCwgZG9uZSkgPT4ge1xuICAgIGNvbnN0IGNvcGllZFBhY2thZ2VKU09OID0gYXdhaXQgcmVhZE11dGF0ZWRQYWNrYWdlSnNvbihidWlsZFBhdGgsIGZvcmdlQ29uZmlnKTtcbiAgICBpZiAoY29waWVkUGFja2FnZUpTT04uY29uZmlnICYmIGNvcGllZFBhY2thZ2VKU09OLmNvbmZpZy5mb3JnZSkge1xuICAgICAgZGVsZXRlIGNvcGllZFBhY2thZ2VKU09OLmNvbmZpZy5mb3JnZTtcbiAgICB9XG4gICAgYXdhaXQgZnMud3JpdGVKc29uKHBhdGgucmVzb2x2ZShidWlsZFBhdGgsICdwYWNrYWdlLmpzb24nKSwgY29waWVkUGFja2FnZUpTT04sIHsgc3BhY2VzOiAyIH0pO1xuICAgIGRvbmUoKTtcbiAgfSk7XG5cbiAgYWZ0ZXJDb3B5SG9va3MucHVzaCguLi5yZXNvbHZlSG9va3MoZm9yZ2VDb25maWcucGFja2FnZXJDb25maWcuYWZ0ZXJDb3B5LCBkaXIpKTtcblxuICBjb25zdCBhZnRlclBydW5lSG9va3MgPSBbXTtcblxuICBpZiAocHJ1bmVFbmFibGVkKSB7XG4gICAgYWZ0ZXJQcnVuZUhvb2tzLnB1c2goLi4ucmVzb2x2ZUhvb2tzKGZvcmdlQ29uZmlnLnBhY2thZ2VyQ29uZmlnLmFmdGVyUHJ1bmUsIGRpcikpO1xuICB9XG5cbiAgYWZ0ZXJQcnVuZUhvb2tzLnB1c2goKGFzeW5jIChidWlsZFBhdGgsIGVsZWN0cm9uVmVyc2lvbiwgcFBsYXRmb3JtLCBwQXJjaCwgZG9uZSkgPT4ge1xuICAgIGF3YWl0IHJ1bkhvb2soZm9yZ2VDb25maWcsICdwYWNrYWdlQWZ0ZXJQcnVuZScsIGJ1aWxkUGF0aCwgZWxlY3Ryb25WZXJzaW9uLCBwUGxhdGZvcm0sIHBBcmNoKTtcbiAgICBkb25lKCk7XG4gIH0pIGFzIEhvb2tGdW5jdGlvbik7XG5cbiAgY29uc3QgYWZ0ZXJFeHRyYWN0SG9va3MgPSBbXG4gICAgKGFzeW5jIChidWlsZFBhdGgsIGVsZWN0cm9uVmVyc2lvbiwgcFBsYXRmb3JtLCBwQXJjaCwgZG9uZSkgPT4ge1xuICAgICAgYXdhaXQgcnVuSG9vayhmb3JnZUNvbmZpZywgJ3BhY2thZ2VBZnRlckV4dHJhY3QnLCBidWlsZFBhdGgsIGVsZWN0cm9uVmVyc2lvbiwgcFBsYXRmb3JtLCBwQXJjaCk7XG4gICAgICBkb25lKCk7XG4gICAgfSkgYXMgSG9va0Z1bmN0aW9uLFxuICBdO1xuICBhZnRlckV4dHJhY3RIb29rcy5wdXNoKC4uLnJlc29sdmVIb29rcyhmb3JnZUNvbmZpZy5wYWNrYWdlckNvbmZpZy5hZnRlckV4dHJhY3QsIGRpcikpO1xuXG4gIHR5cGUgUGFja2FnZXJBcmNoID0gRXhjbHVkZTxGb3JnZUFyY2gsICdhcm0nPjtcblxuICBjb25zdCBwYWNrYWdlT3B0czogcGFja2FnZXIuT3B0aW9ucyA9IHtcbiAgICBhc2FyOiBmYWxzZSxcbiAgICBvdmVyd3JpdGU6IHRydWUsXG4gICAgLi4uZm9yZ2VDb25maWcucGFja2FnZXJDb25maWcsXG4gICAgZGlyLFxuICAgIGFyY2g6IGFyY2ggYXMgUGFja2FnZXJBcmNoLFxuICAgIHBsYXRmb3JtLFxuICAgIGFmdGVyQ29weTogc2VxdWVudGlhbEhvb2tzKGFmdGVyQ29weUhvb2tzKSxcbiAgICBhZnRlckV4dHJhY3Q6IHNlcXVlbnRpYWxIb29rcyhhZnRlckV4dHJhY3RIb29rcyksXG4gICAgYWZ0ZXJQcnVuZTogc2VxdWVudGlhbEhvb2tzKGFmdGVyUHJ1bmVIb29rcyksXG4gICAgb3V0OiBjYWxjdWxhdGVkT3V0RGlyLFxuICAgIGVsZWN0cm9uVmVyc2lvbjogYXdhaXQgZ2V0RWxlY3Ryb25WZXJzaW9uKGRpciwgcGFja2FnZUpTT04pLFxuICB9O1xuICBwYWNrYWdlT3B0cy5xdWlldCA9IHRydWU7XG5cbiAgaWYgKHBhY2thZ2VPcHRzLmFsbCkge1xuICAgIHRocm93IG5ldyBFcnJvcignY29uZmlnLmZvcmdlLnBhY2thZ2VyQ29uZmlnLmFsbCBpcyBub3Qgc3VwcG9ydGVkIGJ5IEVsZWN0cm9uIEZvcmdlJyk7XG4gIH1cblxuICBpZiAoIXBhY2thZ2VKU09OLnZlcnNpb24gJiYgIXBhY2thZ2VPcHRzLmFwcFZlcnNpb24pIHtcbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbWF4LWxlblxuICAgIHdhcm4oXG4gICAgICBpbnRlcmFjdGl2ZSxcbiAgICAgIGNoYWxrLnllbGxvdygnUGxlYXNlIHNldCBcInZlcnNpb25cIiBvciBcImNvbmZpZy5mb3JnZS5wYWNrYWdlckNvbmZpZy5hcHBWZXJzaW9uXCIgaW4geW91ciBhcHBsaWNhdGlvblxcJ3MgcGFja2FnZS5qc29uIHNvIGF1dG8tdXBkYXRlcyB3b3JrIHByb3Blcmx5JylcbiAgICApO1xuICB9XG5cbiAgaWYgKHBhY2thZ2VPcHRzLnByZWJ1aWx0QXNhcikge1xuICAgIHRocm93IG5ldyBFcnJvcignY29uZmlnLmZvcmdlLnBhY2thZ2VyQ29uZmlnLnByZWJ1aWx0QXNhciBpcyBub3Qgc3VwcG9ydGVkIGJ5IEVsZWN0cm9uIEZvcmdlJyk7XG4gIH1cblxuICBhd2FpdCBydW5Ib29rKGZvcmdlQ29uZmlnLCAnZ2VuZXJhdGVBc3NldHMnLCBwbGF0Zm9ybSwgYXJjaCk7XG4gIGF3YWl0IHJ1bkhvb2soZm9yZ2VDb25maWcsICdwcmVQYWNrYWdlJywgcGxhdGZvcm0sIGFyY2gpO1xuXG4gIGQoJ3BhY2thZ2luZyB3aXRoIG9wdGlvbnMnLCBwYWNrYWdlT3B0cyk7XG5cbiAgY29uc3Qgb3V0cHV0UGF0aHMgPSBhd2FpdCBwYWNrYWdlcihwYWNrYWdlT3B0cyk7XG5cbiAgYXdhaXQgcnVuSG9vayhmb3JnZUNvbmZpZywgJ3Bvc3RQYWNrYWdlJywge1xuICAgIGFyY2gsXG4gICAgb3V0cHV0UGF0aHMsXG4gICAgcGxhdGZvcm0sXG4gICAgc3Bpbm5lcjogcGFja2FnZXJTcGlubmVyLFxuICB9KTtcblxuICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLW5vbi1udWxsLWFzc2VydGlvblxuICBpZiAocGFja2FnZXJTcGlubmVyKSBwYWNrYWdlclNwaW5uZXIhLnN1Y2NlZWQoKTtcbn07XG4iXX0=